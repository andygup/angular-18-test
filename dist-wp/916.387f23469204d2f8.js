"use strict";(self.webpackChunkangular_18_test=self.webpackChunkangular_18_test||[]).push([[916],{20916:(F,g,n)=>{n.r(g),n.d(g,{default:()=>Z});var d=n(10467),r=n(8189),c=n(31178),m=n(5922),u=n(35150),L=n(60797),P=n(39693),D=n(45272),v=n(43085),l=n(85211),C=(n(3248),n(40707),n(17221)),S=n(76576),R=n(50305),h=n(26514),I=n(95478),b=n(44797),y=n(85574),T=n(81308),U=n(25936),j=n(93410),w=n(23e3),K=n(17049),B=n(1151),G=n(33036),W=n(22329),N=n(328),M=n(88135);let o=class extends((0,j.dM)((0,G.j)((0,B.J)((0,U.b)((0,K.q)((0,P.P)((0,w.d)(I.A)))))))){constructor(e){super(e),this._graphTypeLookup=new Map,this._namedTypesModified=!1,this.dataManager=null,this.definitionSetMap=null,this.knowledgeGraph=null,this.layers=new(c.A.ofType(y.A)),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="KnowledgeGraphLayer",this.sublayerIdsCache=new Map,this.tables=new(c.A.ofType(y.A)),this.type="knowledge-graph",this.url=null}load(){return this.addResolvingPromise(this._doLoad()),Promise.resolve(this)}_doLoad(){var e=this;return(0,d.A)(function*(){yield e._fetchMetadata(),yield e._initializeLayerProperties(),e.loadLayerAssumingLocalCache()})()}_fetchMetadata(){var e=this;return(0,d.A)(function*(){if(!e.url)throw new m.A("knowledge-graph:missing-url","KnowledgeGraphLayer must be created with a url");const t=yield(0,N.fetchKnowledgeGraph)(e.url);e.knowledgeGraph=t,e._forEachGraphType(s=>{s.name&&e._graphTypeLookup.set(s.name,s)})})()}_initializeLayerProperties(){var e=this;return(0,d.A)(function*(){e.originIdOf("inclusionModeDefinition")===h.Gr.USER?e._validateInclusionModeDefinition():yield e._initializeInclusionModeDefinition(),e._setMemberTypes(),e.dataManager=new b.PB({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition})})()}_initializeInclusionModeDefinition(){var e=this;return(0,d.A)(function*(){const t=e.definitionSetMap?yield(0,T._s)(e.definitionSetMap,!0):{generateAllSublayers:!0,namedTypeDefinitions:new Map};[...e.layers.toArray(),...e.tables.toArray()].forEach(s=>{const i=e._graphTypeLookup.get(s.graphTypeName);i&&!t.namedTypeDefinitions.has(i.name)&&t.namedTypeDefinitions.set(i.name,{useAllData:!0})}),e.setAtOrigin("inclusionModeDefinition",t,(0,h.OL)(e.originIdOf("definitionSetMap")))})()}_validateInclusionModeDefinition(){const{inclusionModeDefinition:e}=this;if(!e)return;const{namedTypeDefinitions:t}=e;if(t?.size>0)t.forEach((s,i)=>{const a=this._graphTypeLookup.get(i);if(!a)return u.A.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't in the data model and will be removed`),void t.delete(i);"relationship"!==a.type&&"entity"!==a.type&&(u.A.getLogger(this).warn(`A named type, ${i}, was in the inclusion list that wasn't properly modeled and will be removed`),t.delete(i))});else if(!e.generateAllSublayers)throw new m.A("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined")}_setMemberTypes(){let e=[],t=[];const{inclusionModeDefinition:s}=this,i=s?.namedTypeDefinitions;!s||s.generateAllSublayers?(e=this.knowledgeGraph.dataModel?.entityTypes??[],t=this.knowledgeGraph.dataModel?.relationshipTypes??[]):i&&i.size>0&&i.forEach((a,p)=>{const _=this._graphTypeLookup.get(p);switch(_?.type){case"relationship":t.push(_);break;case"entity":e.push(_)}}),this.memberEntityTypes=e,this.memberRelationshipTypes=t}_forEachGraphType(e){[...this.knowledgeGraph.dataModel?.entityTypes??[],...this.knowledgeGraph.dataModel?.relationshipTypes??[]].forEach(t=>{e(t)})}_refreshNamedTypes(){this._namedTypesModified=!0;for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}_handleNewRecords(e){var t=this;return(0,d.A)(function*(){const s=[];t.dataManager.addToLayer(e);for(const i of e)t.sublayerIdsCache.has(i.typeName)||(t.sublayerIdsCache.set(i.typeName,new Set),s.push(i.typeName)),t.sublayerIdsCache.get(i.typeName).add(i.id);for(const i of s){const a=t._graphTypeLookup.get(i);a&&(t._addSublayer(a).title=i,"entity"===a.type?t.dataManager.entityTypeNames.add(i):t.dataManager.relationshipTypeNames.add(i),t.dataManager.sublayerCaches.set(i,new Map))}t._refreshNamedTypes()})()}_createSublayers(e,t,s){e.forEach(i=>{const a=this._createSublayer(i);s(a)&&t.push(a),this._updateSublayerCaches(i)})}_addSublayer(e){const t=this._createSublayer(e);return t.geometryType?this.layers.push(t):this.tables.push(t),t}_createSublayer(e){return new y.A({objectType:e,parentCompositeLayer:this,graphType:e.type,title:e.name})}_updateSublayers(e,t){t.forEach(s=>{s.parentCompositeLayer=this;const i=e.find(a=>a.type===s.graphType&&a.name===s.graphTypeName);i&&(s.objectType=i,s.read({title:i.name},{origin:"service"}),this._updateSublayerCaches(i))})}_updateSublayerCaches(e){const t=this.dataManager.sublayerCaches;t.has(e.name)||t.set(e.name,new Map)}_saveUrlAsNewResource(e,t,s,i){e[t]="<pending>",s.pendingOperations.push(function x(e){return f.apply(this,arguments)}(this.inclusionModeDefinition).then(a=>{const p=function z(e){const t=`definitionSetMap-${(0,v.lk)()}.dat`,s=(0,D.fj)("knowledgeGraphLayer",t);return e.resourceFromPath(s)}(i);e[t]=p.itemRelativeUrl,s.toAdd.push({resource:p,content:{type:"blob",blob:a},compress:!1,finish:_=>{this.definitionSetMap=_.url}})}))}_displaysAllRecords(e){for(const[,{useAllData:t}]of e.namedTypeDefinitions)if(!t)return!1;return!0}readDefinitionSetMap(e,t,s){return(0,M.f)(e,s)}writeDefinitionSetMap(e,t,s,i){const a=i?.portalItem,p=i?.resources,_=(0,h.aB)(i?.origin);if(!a||!p||null==_)return void(e&&(t[s]=(0,M.t)(e,i)));const{inclusionModeDefinition:A}=this;if(!A||this._displaysAllRecords(A))return void(this.definitionSetMap=null);const E=this.originIdOf("inclusionModeDefinition");if(E===h.Gr.USER||this._namedTypesModified||_<E)this._saveUrlAsNewResource(t,s,p,a);else if(_===E&&e){const O=(0,M.t)(e,i);(0,D.oP)(O)?this._saveUrlAsNewResource(t,s,p,a):t[s]=O}}set inclusionModeDefinition(e){"loaded"!==this.loadStatus&&"failed"!==this.loadStatus?this._set("inclusionModeDefinition",e):u.A.getLogger(this).error("#inclusionModeDefinition","inclusionModeDefinition cannot be changed after the layer is loaded.")}loadLayerAssumingLocalCache(){const e=[...this.memberEntityTypes,...this.memberRelationshipTypes];this.originIdOf("layers")===h.Gr.DEFAULTS?this._createSublayers(e,this.layers,t=>!!t.geometryType):this._updateSublayers(e,this.layers),this.originIdOf("tables")===h.Gr.DEFAULTS?this._createSublayers(e,this.tables,t=>!t.geometryType):this._updateSublayers(e,this.tables),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t,s)=>{const i=(0,L.tE)(this.sublayerIdsCache,s,()=>new Set);t.members?.forEach(a=>{i.add(a.id)})})}addRecords(e){var t=this;return(0,d.A)(function*(){yield t._handleNewRecords(e)})()}removeRecords(e){var t=this;return(0,d.A)(function*(){const s=[];for(const i of e)!1===t.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(i.typeName)?.useAllData&&t.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(i.typeName)?.members?.has(i.id)&&s.push(i);t.dataManager.removeFromLayer(s);for(const i of s)t.sublayerIdsCache.get(i.typeName)?.delete(i.id);return t._refreshNamedTypes(),s})()}};(0,r._)([(0,l.MZ)()],o.prototype,"dataManager",void 0),(0,r._)([(0,l.MZ)({json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],o.prototype,"definitionSetMap",void 0),(0,r._)([(0,C.w)("definitionSetMap")],o.prototype,"readDefinitionSetMap",null),(0,r._)([(0,R.K)("definitionSetMap")],o.prototype,"writeDefinitionSetMap",null),(0,r._)([(0,l.MZ)()],o.prototype,"inclusionModeDefinition",null),(0,r._)([(0,l.MZ)()],o.prototype,"knowledgeGraph",void 0),(0,r._)([(0,l.MZ)({type:c.A.ofType(y.A),json:{write:{ignoreOrigin:!0}}})],o.prototype,"layers",void 0),(0,r._)([(0,l.MZ)()],o.prototype,"memberEntityTypes",void 0),(0,r._)([(0,l.MZ)()],o.prototype,"memberRelationshipTypes",void 0),(0,r._)([(0,l.MZ)({type:["KnowledgeGraphLayer"]})],o.prototype,"operationalLayerType",void 0),(0,r._)([(0,l.MZ)()],o.prototype,"sublayerIdsCache",void 0),(0,r._)([(0,l.MZ)({type:c.A.ofType(y.A),json:{write:{ignoreOrigin:!0}}})],o.prototype,"tables",void 0),(0,r._)([(0,l.MZ)({json:{read:!1}})],o.prototype,"type",void 0),(0,r._)([(0,l.MZ)(W.OZ)],o.prototype,"url",void 0),o=(0,r._)([(0,S.$)("esri.layers.KnowledgeGraphLayer")],o);const Z=o;function f(){return(f=(0,d.A)(function*(e){const t=yield(0,T.fe)(e);return new Blob([t],{type:"application/x-protobuf"})})).apply(this,arguments)}}}]);