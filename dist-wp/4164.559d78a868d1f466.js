"use strict";(self.webpackChunkangular_18_test=self.webpackChunkangular_18_test||[]).push([[4164],{24164:(fe,P,p)=>{p.r(P),p.d(P,{ElevationQuery:()=>ee,GeometryDescriptor:()=>g,getFinestLodIndex:()=>_});var d=p(10467),Y=p(89447),T=p(5922),j=p(11432),A=p(56492),I=p(82663),C=p(21870),U=p(1749),H=p(93615),x=p(11817),E=p(51995),G=p(20260);class J{constructor(e,t){this.data=e,this.safeWidth=.99999999*(e.width-1),this.dx=(e.width-1)/(t[2]-t[0]),this.dy=(e.width-1)/(t[3]-t[1]),this.x0=t[0],this.y1=t[3]}}class O{constructor(e,t=null){this.tile=e,null!=t&&null!=e&&(this._samplerData=new J(t,e.extent))}get zmin(){return null!=this._samplerData?this._samplerData.data.minValue:0}get zmax(){return null!=this._samplerData?this._samplerData.data.maxValue:0}get hasNoDataValues(){return!!this._samplerData?.data.hasNoDataValues}sample(e,t){if(null==this._samplerData)return;const{safeWidth:n,data:i,dx:o,dy:l,y1:s,x0:r}=this._samplerData,{width:c,values:u,noDataValue:f}=i,v=b(l*(s-t),0,n),h=b(o*(e-r),0,n),y=Math.floor(v),N=Math.floor(h),S=y*c+N,Q=S+c,V=u[S],L=u[Q],K=u[S+1],W=u[Q+1];if(V!==f&&L!==f&&K!==f&&W!==f){const X=h-N,B=V+(K-V)*X;return B+(L+(W-L)*X-B)*(v-y)}}}function b(a,e,t){return a<e?e:a>t?t:a}var $=p(25858);class ee{queryAll(e,t,n){var i=this;return(0,d.A)(function*(){if(!(e=n?.ignoreInvisibleLayers?e.filter(u=>u.visible):e.slice()).length)throw new T.A("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");const o=g.fromGeometry(t);let l=!1;n?.returnSampleInfo||(l=!0);const s={...R,...n,returnSampleInfo:!0},r=yield i.query(e[e.length-1],o,s),c=yield i._queryAllContinue(e,r,s);return c.geometry=c.geometry.export(),l&&delete c.sampleInfo,c})()}query(e,t,n){var i=this;return(0,d.A)(function*(){if(!e)throw new T.A("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||!(t instanceof g)&&"point"!==t.type&&"multipoint"!==t.type&&"polyline"!==t.type)throw new T.A("elevation-query:invalid-geometry","Only point, polyline and multipoint geometries can be used to query elevation");const o={...R,...n},l=new te(e,t.spatialReference,o),s=o.signal;return yield e.load({signal:s}),yield function ie(a,e,t){return q.apply(this,arguments)}(l,t,s),yield i._selectTiles(l,s),yield D(l,s),function ce(a){a.geometry.coordinates.forEach(e=>{const t=e.elevationTile;let n=a.options.noDataValue;if(t){const i=t.sample(e.x,e.y);null!=i?n=i:e.elevationTile=null}e.z=n})}(l),function ue(a,e){return z.apply(this,arguments)}(l,s)})()}createSampler(e,t,n){var i=this;return(0,d.A)(function*(){if(!e)throw new T.A("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new T.A("elevation-query:invalid-extent","Invalid or undefined extent");const o={...R,...n};return i._createSampler(e,t,o)})()}createSamplerAll(e,t,n){var i=this;return(0,d.A)(function*(){if(!(e=n?.ignoreInvisibleLayers?e.filter(s=>s.visible):e.slice()).length)throw new T.A("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");if(!t||"extent"!==t.type)throw new T.A("elevation-query:invalid-extent","Invalid or undefined extent");const o={...R,...n,returnSampleInfo:!0},l=yield i._createSampler(e[e.length-1],t,o);return i._createSamplerAllContinue(e,t,l,o)})()}_createSampler(e,t,n,i){var o=this;return(0,d.A)(function*(){const l=n.signal;yield e.load({signal:l});const s=t.spatialReference,r=e.tileInfo.spatialReference;s.equals(r)||(yield(0,x.initializeProjection)([{source:s,dest:r}],{signal:l}),t=(0,x.project)(t,r));const c=new ne(e,t,n,i);return yield o._selectTiles(c,l),yield D(c,l),new G.hX(c.elevationTiles,c.layer.tileInfo,c.options.noDataValue)})()}_createSamplerAllContinue(e,t,n,i){var o=this;return(0,d.A)(function*(){if(e.pop(),!e.length)return n;const l=n.samplers.filter(u=>!u.tile.hasNoDataValues).map(u=>(0,E.VY)(u.extent)),s=yield o._createSampler(e[e.length-1],t,i,l);if(0===s.samplers.length)return n;const r=n.samplers.concat(s.samplers),c=new G.hX(r,i.noDataValue);return o._createSamplerAllContinue(e,t,c,i)})()}_queryAllContinue(e,t,n){var i=this;return(0,d.A)(function*(){const o=e.pop(),l=t.geometry.coordinates,s=t.sampleInfo;(0,j.Lw)(s);const r=[],c=[];for(let h=0;h<l.length;h++){const y=s[h];y.demResolution>=0?y.source||(y.source=o):e.length&&(r.push(l[h]),c.push(h))}if(!e.length||0===r.length)return t;const u=t.geometry.clone(r),f=yield i.query(e[e.length-1],u,n),v=f.sampleInfo;if(!v)throw new Error("no sampleInfo");return c.forEach((h,y)=>{l[h].z=f.geometry.coordinates[y].z,s[h].demResolution=v[y].demResolution}),i._queryAllContinue(e,t,n)})()}_selectTiles(e,t){var n=this;return(0,d.A)(function*(){"geometry"===e.type&&function le(a){if(null==a.layer.fullExtent)return;const e=new O(null);e.sample=()=>a.options.noDataValue,a.outsideExtentTile=e;const t=a.layer.fullExtent;a.geometry.coordinates.forEach(n=>{const i=n.x,o=n.y;(i<t.xmin||i>t.xmax||o<t.ymin||o>t.ymax)&&(n.elevationTile=e)})}(e);const i=e.options.demResolution;if("number"==typeof i)!function se(a,e){const t=function oe(a,e){const{tileInfo:t,tilemapCache:n}=a.layer,i=e/(0,I.GA)(t.spatialReference),o=w(t,n);let l=o[0],s=0;for(let r=1;r<o.length;r++){const c=o[r];Math.abs(c.resolution-i)<Math.abs(l.resolution-i)&&(l=c,s=r)}return s}(a,e);a.selectTilesAtLOD(t)}(e,i);else if("finest-contiguous"===i)yield n._selectTilesFinestContiguous(e,t);else{if("auto"!==i)throw new T.A("elevation-query:invalid-dem-resolution",`Invalid dem resolution value '${i}', expected a number, "finest-contiguous" or "auto"`);yield n._selectTilesAuto(e,t)}})()}_selectTilesFinestContiguous(e,t){var n=this;return(0,d.A)(function*(){const{tileInfo:i,tilemapCache:o}=e.layer,l=_(i,o,e.options.minDemResolution);yield n._selectTilesFinestContiguousAt(e,l,t)})()}_selectTilesFinestContiguousAt(e,t,n){var i=this;return(0,d.A)(function*(){const o=e.layer;if(e.selectTilesAtLOD(t),t<0)return;const l=o.tilemapCache,s=e.getTilesToFetch();try{if(l&&!F(l))yield(0,A.qr)(Promise.all(s.map(r=>l.fetchAvailability(r.level,r.row,r.col,{signal:n}))),n);else if(yield D(e,n),!e.allElevationTilesFetched())throw e.clearElevationTiles(),new T.A("elevation-query:has-unavailable-tiles")}catch(r){(0,A.QP)(r),yield i._selectTilesFinestContiguousAt(e,t-1,n)}})()}_selectTilesAuto(e,t){var n=this;return(0,d.A)(function*(){(function ae(a){const{tileInfo:e,tilemapCache:t}=a.layer,n=_(e,t,a.options.minDemResolution);a.selectTilesAtLOD(n,a.options.maximumAutoTileRequests)})(e),function re(a){const e=a.layer.tileInfo;let t=0;const n={},i=s=>{null!=s.id&&(s.id in n?n[s.id]++:(n[s.id]=1,t++))},o=s=>{if(null==s.id)return;const r=n[s.id];1===r?(delete n[s.id],t--):n[s.id]=r-1};a.forEachTileToFetch(i,o);let l=!0;for(;l&&(l=!1,a.forEachTileToFetch(s=>{t<=a.options.maximumAutoTileRequests||(o(s),e.upsampleTile(s)&&(l=!0),i(s))},o),l););}(e);const i=e.layer.tilemapCache;if(!i||F(i))return n._selectTilesAutoPrefetchUpsample(e,t);const o=e.getTilesToFetch(),l={},s=o.map(function(){var r=(0,d.A)(function*(c){const u=new $.U(null,0,0,0,(0,E.vt)()),f=yield(0,Y.Ke)(i.fetchAvailabilityUpsample(c.level,c.row,c.col,u,{signal:t}));!1!==f.ok?null!=c.id&&(l[c.id]=u):(0,A.QP)(f.error)});return function(c){return r.apply(this,arguments)}}());yield(0,A.qr)(Promise.all(s),t),e.remapTiles(l)})()}_selectTilesAutoPrefetchUpsample(e,t){var n=this;return(0,d.A)(function*(){const i=e.layer.tileInfo;yield D(e,t);let o=!1;e.forEachTileToFetch((l,s)=>{i.upsampleTile(l)?o=!0:s()}),o&&(yield n._selectTilesAutoPrefetchUpsample(e,t))})()}}class g{export(){return this._exporter(this.coordinates,this.spatialReference)}clone(e){const t=new g;return t.geometry=this.geometry,t.spatialReference=this.spatialReference,t.coordinates=e||this.coordinates.map(n=>n.clone()),t._exporter=this._exporter,t}project(e,t){var n=this;return(0,d.A)(function*(){if(n.spatialReference.equals(e))return n.clone();yield(0,x.initializeProjection)([{source:n.spatialReference,dest:e}],{signal:t});const i=new C.A({spatialReference:n.spatialReference,points:n.coordinates.map(r=>[r.x,r.y])}),o=(0,x.project)(i,e);if(!o)return null;const l=n.coordinates.map((r,c)=>{const u=r.clone(),f=o.points[c];return u.x=f[0],u.y=f[1],u}),s=n.clone(l);return s.spatialReference=e,s})()}static fromGeometry(e){const t=new g;if(t.geometry=e,t.spatialReference=e.spatialReference,e instanceof g)t.coordinates=e.coordinates.map(n=>n.clone()),t._exporter=(n,i)=>{const o=e.clone(n);return o.spatialReference=i,o};else switch(e.type){case"point":{const n=e,{hasZ:i,hasM:o}=n;t.coordinates=i&&o?[new m(n.x,n.y,n.z,n.m)]:i?[new m(n.x,n.y,n.z)]:o?[new m(n.x,n.y,null,n.m)]:[new m(n.x,n.y)],t._exporter=(l,s)=>e.hasM?new U.A(l[0].x,l[0].y,l[0].z,l[0].m,s):new U.A(l[0].x,l[0].y,l[0].z,s);break}case"multipoint":{const n=e,{hasZ:i,hasM:o}=n;t.coordinates=n.points.map(i&&o?l=>new m(l[0],l[1],l[2],l[3]):i?l=>new m(l[0],l[1],l[2]):o?l=>new m(l[0],l[1],null,l[2]):l=>new m(l[0],l[1])),t._exporter=(l,s)=>e.hasM?new C.A({points:l.map(r=>[r.x,r.y,r.z,r.m]),hasZ:!0,hasM:!0,spatialReference:s}):new C.A(l.map(r=>[r.x,r.y,r.z]),s);break}case"polyline":{const n=e,i=[],o=[],{hasZ:l,hasM:s}=e;let r=0;for(const c of n.paths)if(o.push([r,r+c.length]),r+=c.length,l&&s)for(const u of c)i.push(new m(u[0],u[1],u[2],u[3]));else if(l)for(const u of c)i.push(new m(u[0],u[1],u[2]));else if(s)for(const u of c)i.push(new m(u[0],u[1],null,u[2]));else for(const u of c)i.push(new m(u[0],u[1]));t.coordinates=i,t._exporter=(c,u)=>{const f=c.map(e.hasM?h=>[h.x,h.y,h.z,h.m]:h=>[h.x,h.y,h.z]),v=o.map(h=>f.slice(h[0],h[1]));return new H.A({paths:v,hasM:e.hasM,hasZ:!0,spatialReference:u})};break}}return t}}class m{constructor(e,t,n=null,i=null,o=null,l=null){this.x=e,this.y=t,this.z=n,this.m=i,this.tile=o,this.elevationTile=l}clone(){return new m(this.x,this.y,this.z,this.m)}}class Z{constructor(e,t){this.layer=e,this.options=t}}class te extends Z{constructor(e,t,n){super(e,n),this.outSpatialReference=t,this.type="geometry"}selectTilesAtLOD(e){if(e<0)this.geometry.coordinates.forEach(t=>t.tile=null);else{const{tileInfo:t,tilemapCache:n}=this.layer,i=w(t,n)[e].level;this.geometry.coordinates.forEach(o=>o.tile=t.tileAt(i,o.x,o.y))}}allElevationTilesFetched(){return!this.geometry.coordinates.some(e=>!e.elevationTile)}clearElevationTiles(){for(const e of this.geometry.coordinates)e.elevationTile!==this.outsideExtentTile&&(e.elevationTile=null)}populateElevationTiles(e){for(const t of this.geometry.coordinates)!t.elevationTile&&t.tile?.id&&(t.elevationTile=e[t.tile.id])}remapTiles(e){for(const t of this.geometry.coordinates){const n=t.tile?.id;t.tile=n?e[n]:null}}getTilesToFetch(){const e={},t=[];for(const n of this.geometry.coordinates){const i=n.tile;if(!i)continue;const o=n.tile?.id;n.elevationTile||!o||e[o]||(e[o]=i,t.push(i))}return t}forEachTileToFetch(e){for(const t of this.geometry.coordinates)t.tile&&!t.elevationTile&&e(t.tile,()=>{t.tile=null})}}class ne extends Z{constructor(e,t,n,i){super(e,n),this.type="extent",this.elevationTiles=[],this._candidateTiles=[],this._fetchedCandidates=new Set,this.extent=t.clone().intersection(e.fullExtent),this.maskExtents=i}selectTilesAtLOD(e,t){const n=this._maximumLodForRequests(t),i=Math.min(n,e);i<0?this._candidateTiles.length=0:this._selectCandidateTilesCoveringExtentAt(i)}_maximumLodForRequests(e){const{tileInfo:t,tilemapCache:n}=this.layer,i=w(t,n);if(!e)return i.length-1;const o=this.extent;if(null==o)return-1;for(let l=i.length-1;l>=0;l--){const s=i[l],c=s.resolution*t.size[1];if(Math.ceil(o.width/(s.resolution*t.size[0]))*Math.ceil(o.height/c)<=e)return l}return-1}allElevationTilesFetched(){return this._candidateTiles.length===this.elevationTiles.length}clearElevationTiles(){this.elevationTiles.length=0,this._fetchedCandidates.clear()}populateElevationTiles(e){for(const t of this._candidateTiles){const n=t.id&&e[t.id];n&&(this._fetchedCandidates.add(t),this.elevationTiles.push(n))}}remapTiles(e){this._candidateTiles=k(this._candidateTiles.map(t=>e[t.id]))}getTilesToFetch(){return this._candidateTiles}forEachTileToFetch(e,t){const n=this._candidateTiles;this._candidateTiles=[],n.forEach(i=>{if(this._fetchedCandidates.has(i))return void(t&&t(i));let o=!1;e(i,()=>o=!0),o?t&&t(i):this._candidateTiles.push(i)}),this._candidateTiles=k(this._candidateTiles,t)}_selectCandidateTilesCoveringExtentAt(e){this._candidateTiles.length=0;const t=this.extent;if(null==t)return;const{tileInfo:n,tilemapCache:i}=this.layer,o=w(n,i)[e],l=n.tileAt(o.level,t.xmin,t.ymin),s=l.extent;if(null==s)return;const c=o.resolution*n.size[1],u=Math.ceil((t.xmax-s[0])/(o.resolution*n.size[0])),f=Math.ceil((t.ymax-s[1])/c);for(let v=0;v<f;v++)for(let h=0;h<u;h++){const y=new $.U(null,l.level,l.row-v,l.col+h);n.updateTileInfo(y),this._tileIsMasked(y)||this._candidateTiles.push(y)}}_tileIsMasked(e){return!!this.maskExtents&&this.maskExtents.some(t=>e.extent&&(0,E.gR)(t,e.extent))}}function _(a,e,t=0){const n=w(a,e);let i=n.length-1;if(t>0){const o=t/(0,I.GA)(a.spatialReference),l=n.findIndex(s=>s.resolution<o);0===l?i=0:l>0&&(i=l-1)}return i}const R={maximumAutoTileRequests:20,noDataValue:0,returnSampleInfo:!1,demResolution:"auto",minDemResolution:0};function q(){return(q=(0,d.A)(function*(a,e,t){let n;const i=a.layer.tileInfo.spatialReference;if(e instanceof g?n=yield e.project(i,t):(yield(0,x.initializeProjection)([{source:e.spatialReference,dest:i}],{signal:t}),n=(0,x.project)(e,i)),!n)throw new T.A("elevation-query:spatial-reference-mismatch",`Cannot query elevation in '${e.spatialReference.wkid}' on an elevation service in '${i.wkid}'`);a.geometry=g.fromGeometry(n)})).apply(this,arguments)}function w(a,e){const t=a.lods;if(F(e)){const{effectiveMinLOD:n,effectiveMaxLOD:i}=e;return t.filter(o=>o.level>=n&&o.level<=i)}return t}function D(a,e){return M.apply(this,arguments)}function M(){return M=(0,d.A)(function*(a,e){const t=a.getTilesToFetch(),n={},i=a.options.cache,o=a.options.noDataValue,l=t.map(function(){var s=(0,d.A)(function*(r){if(null==r.id)return;const c=`${a.layer.uid}:${r.id}:${o}`,f=(null!=i?i.get(c):null)??(yield a.layer.fetchTile(r.level,r.row,r.col,{noDataValue:o,signal:e}));i?.put(c,f),n[r.id]=new O(r,f)});return function(r){return s.apply(this,arguments)}}());yield(0,A.qr)(Promise.allSettled(l),e),a.populateElevationTiles(n)}),M.apply(this,arguments)}function k(a,e){const t={},n=[];for(const o of a){const l=o.id;l&&!t[l]?(t[l]=o,n.push(o)):e&&e(o)}const i=n.sort((o,l)=>o.level-l.level);return i.filter((o,l)=>{for(let s=0;s<l;s++){const r=i[s].extent;if(r&&o.extent&&(0,E.gR)(r,o.extent))return e&&e(o),!1}return!0})}function z(){return(z=(0,d.A)(function*(a,e){const t=yield a.geometry.project(a.outSpatialReference,e);(0,j.Lw)(t);const n={geometry:t.export(),noDataValue:a.options.noDataValue};return a.options.returnSampleInfo&&(n.sampleInfo=function he(a){const e=a.layer.tileInfo,t=(0,I.GA)(e.spatialReference);return a.geometry.coordinates.map(n=>{let i=-1;return n.elevationTile&&n.elevationTile!==a.outsideExtentTile&&(i=e.lodAt(n.elevationTile.tile.level).resolution*t),{demResolution:i}})}(a)),a.geometry.coordinates.forEach(i=>{i.tile=null,i.elevationTile=null}),n})).apply(this,arguments)}function F(a){return null!=a?.tileInfo}}}]);