"use strict";(self.webpackChunkangular_18_test=self.webpackChunkangular_18_test||[]).push([[6580],{3567:(pt,G,h)=>{h.d(G,{w:()=>A});var F=h(89952),$=(h(3248),h(12438)),k=h(17694);class A{constructor(r=9,l){this._compareMinX=z,this._compareMinY=W,this._toBBox=a=>a,this._maxEntries=Math.max(4,r||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),l&&("function"==typeof l?this._toBBox=l:this._initFormat(l)),this.clear()}destroy(){this.clear(),J.prune(),nt.prune(),U.prune(),rt.prune()}all(r){T(this._data,r)}search(r,l){let a=this._data;const g=this._toBBox;if(K(r,a))for(J.clear();a;){for(let c=0,m=a.children.length;c<m;c++){const E=a.children[c],b=a.leaf?g(E):E;K(r,b)&&(a.leaf?l(E):V(r,b)?T(E,l):J.push(E))}a=J.pop()}}collides(r){let l=this._data;const a=this._toBBox;if(!K(r,l))return!1;for(J.clear();l;){for(let g=0,c=l.children.length;g<c;g++){const m=l.children[g],E=l.leaf?a(m):m;if(K(r,E)){if(l.leaf||V(r,E))return!0;J.push(m)}}l=J.pop()}return!1}load(r){if(!r.length)return this;if(r.length<this._minEntries){for(let a=0,g=r.length;a<g;a++)this.insert(r[a]);return this}let l=this._build(r.slice(0,r.length),0,r.length-1,0);if(this._data.children.length)if(this._data.height===l.height)this._splitRoot(this._data,l);else{if(this._data.height<l.height){const a=this._data;this._data=l,l=a}this._insert(l,this._data.height-l.height-1,!0)}else this._data=l;return this}insert(r){return r&&this._insert(r,this._data.height-1),this}clear(){return this._data=new ot([]),this}remove(r){if(!r)return this;let l,a=this._data,g=null,c=0,m=!1;const E=this._toBBox(r);for(U.clear(),rt.clear();a||U.length>0;){if(a||(a=U.pop(),g=U.data[U.length-1],c=rt.pop()??0,m=!0),a.leaf&&(l=(0,F.qh)(a.children,r,a.children.length,a.indexHint),-1!==l))return a.children.splice(l,1),U.push(a),this._condense(U),this;m||a.leaf||!V(a,E)?g?(c++,a=g.children[c],m=!1):a=null:(U.push(a),rt.push(c),c=0,g=a,a=a.children[0])}return this}toJSON(){return this._data}fromJSON(r){return this._data=r,this}_build(r,l,a,g){const c=a-l+1;let m=this._maxEntries;if(c<=m){const B=new ot(r.slice(l,a+1));return w(B,this._toBBox),B}g||(g=Math.ceil(Math.log(c)/Math.log(m)),m=Math.ceil(c/m**(g-1)));const E=new at([]);E.height=g;const b=Math.ceil(c/m),D=b*Math.ceil(Math.sqrt(m));dt(r,l,a,D,this._compareMinX);for(let B=l;B<=a;B+=D){const Y=Math.min(B+D-1,a);dt(r,B,Y,b,this._compareMinY);for(let tt=B;tt<=Y;tt+=b){const ft=Math.min(tt+b-1,Y);E.children.push(this._build(r,tt,ft,g-1))}}return w(E,this._toBBox),E}_insert(r,l,a){const c=a?r:(0,this._toBBox)(r);U.clear();const m=function L(d,r,l,a){for(;a.push(r),!0!==r.leaf&&a.length-1!==l;){let g,c=1/0,m=1/0;for(let E=0,b=r.children.length;E<b;E++){const D=r.children[E],B=_(D),Y=M(d,D)-B;Y<m?(m=Y,c=B<c?B:c,g=D):Y===m&&B<c&&(c=B,g=D)}r=g||r.children[0]}return r}(c,this._data,l,U);for(m.children.push(r),S(m,c);l>=0&&U.data[l].children.length>this._maxEntries;)this._split(U,l),l--;!function it(d,r,l){for(let a=l;a>=0;a--)S(r.data[a],d)}(c,U,l)}_split(r,l){const a=r.data[l],g=a.children.length,c=this._minEntries;this._chooseSplitAxis(a,c,g);const m=this._chooseSplitIndex(a,c,g);if(!m)return;const E=a.children.splice(m,a.children.length-m),b=a.leaf?new ot(E):new at(E);b.height=a.height,w(a,this._toBBox),w(b,this._toBBox),l?r.data[l-1].children.push(b):this._splitRoot(a,b)}_splitRoot(r,l){this._data=new at([r,l]),this._data.height=r.height+1,w(this._data,this._toBBox)}_chooseSplitIndex(r,l,a){let g,c,m;g=c=1/0;for(let E=l;E<=a-l;E++){const b=v(r,0,E,this._toBBox),D=v(r,E,a,this._toBBox),B=R(b,D),Y=_(b)+_(D);B<g?(g=B,m=E,c=Y<c?Y:c):B===g&&Y<c&&(c=Y,m=E)}return m}_chooseSplitAxis(r,l,a){const g=r.leaf?this._compareMinX:z,c=r.leaf?this._compareMinY:W;this._allDistMargin(r,l,a,g)<this._allDistMargin(r,l,a,c)&&r.children.sort(g)}_allDistMargin(r,l,a,g){r.children.sort(g);const c=this._toBBox,m=v(r,0,l,c),E=v(r,a-l,a,c);let b=y(m)+y(E);for(let D=l;D<a-l;D++){const B=r.children[D];S(m,r.leaf?c(B):B),b+=y(m)}for(let D=a-l-1;D>=l;D--){const B=r.children[D];S(E,r.leaf?c(B):B),b+=y(E)}return b}_condense(r){for(let l=r.length-1;l>=0;l--){const a=r.data[l];if(0===a.children.length)if(l>0){const g=r.data[l-1],c=g.children;c.splice((0,F.qh)(c,a,c.length,g.indexHint),1)}else this.clear();else w(a,this._toBBox)}}_initFormat(r){const l=["return a"," - b",";"];this._compareMinX=new Function("a","b",l.join(r[0])),this._compareMinY=new Function("a","b",l.join(r[1])),this._toBBox=new Function("a","return {minX: a"+r[0]+", minY: a"+r[1]+", maxX: a"+r[2]+", maxY: a"+r[3]+"};")}}function T(d,r){let l=d;for(nt.clear();l;){if(!0===l.leaf)for(const a of l.children)r(a);else nt.pushArray(l.children);l=nt.pop()??null}}function w(d,r){v(d,0,d.children.length,r,d)}function v(d,r,l,a,g){g||(g=new ot([])),g.minX=1/0,g.minY=1/0,g.maxX=-1/0,g.maxY=-1/0;for(let c,m=r;m<l;m++)c=d.children[m],S(g,d.leaf?a(c):c);return g}function S(d,r){d.minX=Math.min(d.minX,r.minX),d.minY=Math.min(d.minY,r.minY),d.maxX=Math.max(d.maxX,r.maxX),d.maxY=Math.max(d.maxY,r.maxY)}function z(d,r){return d.minX-r.minX}function W(d,r){return d.minY-r.minY}function _(d){return(d.maxX-d.minX)*(d.maxY-d.minY)}function y(d){return d.maxX-d.minX+(d.maxY-d.minY)}function M(d,r){return(Math.max(r.maxX,d.maxX)-Math.min(r.minX,d.minX))*(Math.max(r.maxY,d.maxY)-Math.min(r.minY,d.minY))}function R(d,r){const l=Math.max(d.minX,r.minX),a=Math.max(d.minY,r.minY),g=Math.min(d.maxX,r.maxX),c=Math.min(d.maxY,r.maxY);return Math.max(0,g-l)*Math.max(0,c-a)}function V(d,r){return d.minX<=r.minX&&d.minY<=r.minY&&r.maxX<=d.maxX&&r.maxY<=d.maxY}function K(d,r){return r.minX<=d.maxX&&r.minY<=d.maxY&&r.maxX>=d.minX&&r.maxY>=d.minY}function dt(d,r,l,a,g){const c=[r,l];for(;c.length;){const m=c.pop(),E=c.pop();if(m-E<=a)continue;const b=E+Math.ceil((m-E)/a/2)*a;(0,k.q)(d,b,E,m,g),c.push(E,b,b,m)}}const J=new $.A,nt=new $.A,U=new $.A,rt=new $.A({deallocator:void 0});class yt{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class ct extends yt{constructor(){super(...arguments),this.height=1,this.indexHint=new F.vW}}class ot extends ct{constructor(r){super(),this.children=r,this.leaf=!0}}class at extends ct{constructor(r){super(),this.children=r,this.leaf=!1}}},59894:(pt,G,h)=>{h.d(G,{F:()=>it});var F=h(3248),C=h(3567),$=h(51995);const A={minX:0,minY:0,maxX:0,maxY:0};class it{constructor(){this._indexInvalid=!1,this._boundsToLoad=[],this._boundsById=new Map,this._idByBounds=new Map,this._index=new C.w(9,(0,F.A)("esri-csp-restrictions")?v=>({minX:v[0],minY:v[1],maxX:v[2],maxY:v[3]}):["[0]","[1]","[2]","[3]"]),this._loadIndex=()=>{if(this._indexInvalid){const v=new Array(this._idByBounds.size);let S=0;this._idByBounds.forEach((z,W)=>{v[S++]=W}),this._indexInvalid=!1,this._index.clear(),this._index.load(v)}else this._boundsToLoad.length&&(this._index.load(Array.from(new Set(this._boundsToLoad.filter(v=>this._idByBounds.has(v))))),this._boundsToLoad.length=0)}}get fullBounds(){if(!this._boundsById.size)return null;const v=(0,$.Ie)();for(const S of this._boundsById.values())S&&(v[0]=Math.min(S[0],v[0]),v[1]=Math.min(S[1],v[1]),v[2]=Math.max(S[2],v[2]),v[3]=Math.max(S[3],v[3]));return v}get valid(){return!this._indexInvalid}clear(){this._indexInvalid=!1,this._boundsToLoad.length=0,this._boundsById.clear(),this._idByBounds.clear(),this._index.clear()}delete(v){const S=this._boundsById.get(v);this._boundsById.delete(v),S&&(this._idByBounds.delete(S),this._indexInvalid||this._index.remove(S))}forEachInBounds(v,S){this._loadIndex(),function T(w,v,S){(function L(w){A.minX=w[0],A.minY=w[1],A.maxX=w[2],A.maxY=w[3]})(v),w.search(A,S)}(this._index,v,z=>S(this._idByBounds.get(z)))}get(v){return this._boundsById.get(v)}has(v){return this._boundsById.has(v)}invalidateIndex(){this._indexInvalid||(this._indexInvalid=!0,this._boundsToLoad.length=0)}set(v,S){if(!this._indexInvalid){const z=this._boundsById.get(v);z&&(this._index.remove(z),this._idByBounds.delete(z))}this._boundsById.set(v,S),S&&(this._idByBounds.set(S,v),this._indexInvalid||(this._boundsToLoad.push(S),this._boundsToLoad.length>5e4&&this._loadIndex()))}}},64373:(pt,G,h)=>{h.d(G,{A:()=>z});var F=h(89952),C=h(5922),$=h(42425),k=h(35150),A=h(2296),L=h(51995),T=h(31732),it=h(59894),w=h(95985),v=h(50690);const S=(0,A.vt)();class z{constructor(_){this.geometryInfo=_,this._boundsStore=new it.F,this._featuresById=new Map,this._markedIds=new Set,this.events=new $.A,this.featureAdapter=v.T}get geometryType(){return this.geometryInfo.geometryType}get hasM(){return this.geometryInfo.hasM}get hasZ(){return this.geometryInfo.hasZ}get numFeatures(){return this._featuresById.size}get fullBounds(){return this._boundsStore.fullBounds}get storeStatistics(){let _=0;return this._featuresById.forEach(y=>{null!=y.geometry&&y.geometry.coords&&(_+=y.geometry.coords.length)}),{featureCount:this._featuresById.size,vertexCount:_/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}}getFullExtent(_){if(null==this.fullBounds)return null;const[y,M,R,V]=this.fullBounds;return{xmin:y,ymin:M,xmax:R,ymax:V,spatialReference:(0,w.ag)(_)}}add(_){this._add(_),this._emitChanged()}addMany(_){for(const y of _)this._add(y);this._emitChanged()}upsertMany(_){const y=_.map(M=>this._upsert(M));return this._emitChanged(),y.filter(F.Ru)}clear(){this._featuresById.clear(),this._boundsStore.clear(),this._emitChanged()}removeById(_){const y=this._featuresById.get(_);return y?(this._remove(y),this._emitChanged(),y):null}removeManyById(_){this._boundsStore.invalidateIndex();for(const y of _){const M=this._featuresById.get(y);M&&this._remove(M)}this._emitChanged()}forEachBounds(_,y){for(const M of _){const R=this._boundsStore.get(M.objectId);R&&y((0,A.Jt)(S,R))}}getFeature(_){return this._featuresById.get(_)}has(_){return this._featuresById.has(_)}forEach(_){this._featuresById.forEach(y=>_(y))}forEachInBounds(_,y){this._boundsStore.forEachInBounds(_,M=>{y(this._featuresById.get(M))})}startMarkingUsedFeatures(){this._boundsStore.invalidateIndex(),this._markedIds.clear()}sweep(){let _=!1;this._featuresById.forEach((y,M)=>{this._markedIds.has(M)||(_=!0,this._remove(y))}),this._markedIds.clear(),_&&this._emitChanged()}_emitChanged(){this.events.emit("changed",void 0)}_add(_){if(!_)return;const y=_.objectId;if(null==y)return void k.A.getLogger("esri.layers.graphics.data.FeatureStore").error(new C.A("featurestore:invalid-feature","feature id is missing",{feature:_}));const M=this._featuresById.get(y);let R;if(this._markedIds.add(y),M?(_.displayId=M.displayId,R=this._boundsStore.get(y),this._boundsStore.delete(y)):null!=this.onFeatureAdd&&this.onFeatureAdd(_),!_.geometry?.coords?.length)return this._boundsStore.set(y,null),void this._featuresById.set(y,_);R=(0,T.jQ)(R??(0,L.vt)(),_.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),null!=R&&this._boundsStore.set(y,R),this._featuresById.set(y,_)}_upsert(_){const y=_?.objectId;if(null==y)return k.A.getLogger("esri.layers.graphics.data.FeatureStore").error(new C.A("featurestore:invalid-feature","feature id is missing",{feature:_})),null;const M=this._featuresById.get(y);if(!M)return this._add(_),_;this._markedIds.add(y);const{geometry:R,attributes:V}=_;for(const K in V)M.attributes[K]=V[K];return R&&(M.geometry=R,this._boundsStore.set(y,(0,T.jQ)((0,L.vt)(),R,this.geometryInfo.hasZ,this.geometryInfo.hasM)??null)),M}_remove(_){null!=this.onFeatureRemove&&this.onFeatureRemove(_);const y=_.objectId;return this._markedIds.delete(y),this._boundsStore.delete(y),this._featuresById.delete(y),_}}},26580:(pt,G,h)=>{h.r(G),h.d(G,{default:()=>qt});var F=h(10467),C=h(8189),k=(h(21152),h(42425)),A=h(56492),L=h(48900),T=h(85211),w=(h(3248),h(35150)),S=(h(40707),h(76576)),z=h(56985),W=h(32034),_=h(64373),y=h(33594),M=h(11333),R=h(87086),V=h(88485),K=h(33087),dt=h(60797),J=h(82663),nt=h(82575);function U(t=!1,e){if(t){const{elevationInfo:s,alignPointsInFeatures:i}=e;return new ct(s,i)}return new rt}class rt{alignCandidates(e,s,i){return(0,F.A)(function*(){return e})()}notifyElevationSourceChange(){}}class ct{constructor(e,s){this._elevationInfo=e,this._alignPointsInFeatures=s,this._alignmentsCache=new K.q(1024),this._cacheVersion=0}alignCandidates(e,s,i){var n=this;return(0,F.A)(function*(){const o=n._elevationInfo;return null==o||"absolute-height"!==o.mode||o.featureExpressionInfo?n._alignComputedElevationCandidates(e,s,i):(function d(t,e,s){const{offset:i,unit:n}=s;if(null==i)return;const o=(0,J.G9)(e),u=i*((0,nt.Ao)(n??"meters")/o);for(const f of t)switch(f.type){case"edge":f.start.z+=u,f.end.z+=u;continue;case"vertex":f.target.z+=u;continue}}(e,s,o),e)})()}notifyElevationSourceChange(){this._alignmentsCache.clear(),this._cacheVersion++}_alignComputedElevationCandidates(e,s,i){var n=this;return(0,F.A)(function*(){const o=new Map;for(const j of e)(0,dt.tE)(o,j.objectId,r).push(j);const[u,f,p]=n._prepareQuery(o,s),x=yield n._alignPointsInFeatures(u,i);if((0,A.Te)(i),p!==n._cacheVersion)return n._alignComputedElevationCandidates(e,s,i);n._applyCacheAndResponse(u,x,f);const{drapedObjectIds:O,failedObjectIds:N}=x,H=[];for(const j of e){const{objectId:q}=j;O.has(q)&&"edge"===j.type&&(j.draped=!0),N.has(q)||H.push(j)}return H})()}_prepareQuery(e,s){const i=[],n=[];for(const[o,u]of e){const f=[];for(const p of u)this._addToQueriesOrCachedResult(o,p.target,f,n),"edge"===p.type&&(this._addToQueriesOrCachedResult(o,p.start,f,n),this._addToQueriesOrCachedResult(o,p.end,f,n));0!==f.length&&i.push({objectId:o,points:f})}return[{spatialReference:s.toJSON(),pointsInFeatures:i},n,this._cacheVersion]}_addToQueriesOrCachedResult(e,s,i,n){const o=at(e,s),u=this._alignmentsCache.get(o);null==u?i.push(s):n.push(new ot(s,u))}_applyCacheAndResponse(e,{elevations:s,drapedObjectIds:i,failedObjectIds:n},o){for(const p of o)p.apply();let u=0;const f=this._alignmentsCache;for(const{objectId:p,points:x}of e.pointsInFeatures){if(n.has(p)){u+=x.length;continue}const O=!i.has(p);for(const N of x){const H=at(p,N),j=s[u++];N.z=j,O&&f.put(H,j,1)}}}}class ot{constructor(e,s){this.point=e,this.z=s}apply(){this.point.z=this.z}}function at(t,{x:e,y:s,z:i,spatialReference:n}){return`${t}-${e}-${s}-${i??0}}-wkid:${n?.wkid}`}function r(){return[]}class l{filter(e,s){return s}notifyElevationSourceChange(){}}class a{filter(e,s){const{point:i,distance:n}=e,{z:o}=i;if(null==o||0===s.length)return s;const u=function D(t){return"number"==typeof t?{x:t,y:t,z:t}:t}(n),f=this._updateCandidatesTo3D(s,i,u).filter(g);return f.sort(B),f}_updateCandidatesTo3D(e,s,i){for(const n of e)switch(n.type){case"edge":m(n,s,i);continue;case"vertex":b(n,s,i);continue}return e}}function g(t){return t.distance<=1}function c(t=!1){return t?new a:new l}function m(t,e,{x:s,y:i,z:n}){const{start:o,end:u,target:f}=t;t.draped||function E(t,e,s,i){const n=i.x-s.x,o=i.y-s.y,u=i.z-s.z,x=Math.min(1,Math.max(0,((e.x-s.x)*n+(e.y-s.y)*o+u*(e.z-s.z))/(n*n+o*o+u*u))),N=s.y+o*x,H=s.z+u*x;t.x=s.x+n*x,t.y=N,t.z=H}(f,e,o,u);const p=(e.x-f.x)/s,x=(e.y-f.y)/i,O=(e.z-f.z)/n;t.distance=Math.sqrt(p*p+x*x+O*O)}function b(t,e,{x:s,y:i,z:n}){const{target:o}=t,u=(e.x-o.x)/s,f=(e.y-o.y)/i,p=(e.z-o.z)/n,x=Math.sqrt(u*u+f*f+p*p);t.distance=x}function B(t,e){return t.distance-e.distance}var Y=h(77806),tt=h(1119);function ft(t=!1,e){return t?new Mt(e):new St}class St{fetch(){return(0,F.A)(function*(){return[]})()}notifySymbologyChange(){}}class Mt{constructor(e){this._getSymbologyCandidates=e,this._candidatesCache=new K.q(1024),this._cacheVersion=0}fetch(e,s){var i=this;return(0,F.A)(function*(){if(0===e.length)return[];const n=[],o=[],u=i._candidatesCache;for(const H of e){const j=Tt(H),q=u.get(j);if(q)for(const ht of q)o.push((0,Y.o8)(ht));else n.push(H),u.put(j,[],1)}if(0===n.length)return o;const f=i._cacheVersion,{candidates:p,sourceCandidateIndices:x}=yield i._getSymbologyCandidates(n,s);if((0,A.Te)(s),f!==i._cacheVersion)return i.fetch(e,s);const O=[],{length:N}=p;for(let H=0;H<N;++H){const j=p[H],q=Tt(n[x[H]]),ht=u.get(q);ht.push(j),u.put(q,ht,ht.length),O.push((0,Y.o8)(j))}return o.concat(O)})()}notifySymbologyChange(){this._candidatesCache.clear(),this._cacheVersion++}}function Tt(t){switch(t.type){case"vertex":{const{objectId:e,target:s}=t;return(0,tt.Wm)(`${e}-vertex-${s.x}-${s.y}-${s.z??0}`).toString()}case"edge":{const{objectId:e,start:s,end:i}=t;return(0,tt.Wm)(`${e}-edge-${s.x}-${s.y}-${s.z??0}-to-${i.x}-${i.y}-${i.z??0}`).toString()}default:return""}}var mt=h(98877),bt=h(89952);let _t=class extends mt.A{constructor(){super(...arguments),this.updating=!1,this._pending=[]}push(t,e){this._pending.push({promise:t,callback:e}),1===this._pending.length&&this._process()}_process(){if(!this._pending.length)return void(this.updating=!1);this.updating=!0;const t=this._pending[0];t.promise.then(e=>t.callback(e)).catch(()=>{}).then(()=>{this._pending.shift(),this._process()})}};(0,C._)([(0,T.MZ)()],_t.prototype,"updating",void 0),_t=(0,C._)([(0,S.$)("esri.core.AsyncSequence")],_t);var I,t,ut=h(89447),Bt=h(17715),Q=h(17435),Ot=h(28067),X=h(51995),vt=h(31732),Pt=h(68438),Rt=h(42122),gt=h(1277);class Dt{constructor(e,s){this.data=e,this.resolution=s,this.state={type:I.CREATED},this.alive=!0}process(e){switch(this.state.type){case I.CREATED:return this.state=this._gotoFetchCount(this.state,e),this.state.task.promise.then(e.resume,e.resume);case I.FETCH_COUNT:break;case I.FETCHED_COUNT:return this.state=this._gotoFetchFeatures(this.state,e),this.state.task.promise.then(e.resume,e.resume);case I.FETCH_FEATURES:break;case I.FETCHED_FEATURES:this.state=this._goToDone(this.state,e)}return null}get debugInfo(){return{data:this.data,featureCount:this._featureCount,state:this._stateToString}}get _featureCount(){switch(this.state.type){case I.CREATED:case I.FETCH_COUNT:return 0;case I.FETCHED_COUNT:return this.state.featureCount;case I.FETCH_FEATURES:return this.state.previous.featureCount;case I.FETCHED_FEATURES:return this.state.features.length;case I.DONE:return this.state.previous.features.length}}get _stateToString(){switch(this.state.type){case I.CREATED:return"created";case I.FETCH_COUNT:return"fetch-count";case I.FETCHED_COUNT:return"fetched-count";case I.FETCH_FEATURES:return"fetch-features";case I.FETCHED_FEATURES:return"fetched-features";case I.DONE:return"done"}}_gotoFetchCount(e,s){var i=this;return{type:I.FETCH_COUNT,previous:e,task:(0,ut.UT)(function(){var n=(0,F.A)(function*(o){const u=yield(0,ut.DZ)(s.fetchCount(i,o));i.state.type===I.FETCH_COUNT&&(i.state=function wt(t,e){return{type:I.FETCHED_COUNT,featureCount:e,previous:t}}(i.state,u.ok?u.value:1/0))});return function(o){return n.apply(this,arguments)}}())}}_gotoFetchFeatures(e,s){var i=this;return{type:I.FETCH_FEATURES,previous:e,task:(0,ut.UT)(function(){var n=(0,F.A)(function*(o){const u=yield(0,ut.DZ)(s.fetchFeatures(i,e.featureCount,o));i.state.type===I.FETCH_FEATURES&&(i.state=function Ut(t,e){return{type:I.FETCHED_FEATURES,previous:t,features:e}}(i.state,u.ok?u.value:[]))});return function(o){return n.apply(this,arguments)}}())}}_goToDone(e,s){return s.finish(this,e.features),{type:I.DONE,previous:e}}reset(){const e=this.state;switch(this.state={type:I.CREATED},e.type){case I.CREATED:case I.FETCHED_COUNT:case I.FETCHED_FEATURES:case I.DONE:break;case I.FETCH_COUNT:case I.FETCH_FEATURES:e.task.abort()}}intersects(e){return null==e||!this.data.extent||((0,X.VY)(e,It),(0,X.HY)(this.data.extent,It))}}(t=I||(I={}))[t.CREATED=0]="CREATED",t[t.FETCH_COUNT=1]="FETCH_COUNT",t[t.FETCHED_COUNT=2]="FETCHED_COUNT",t[t.FETCH_FEATURES=3]="FETCH_FEATURES",t[t.FETCHED_FEATURES=4]="FETCHED_FEATURES",t[t.DONE=5]="DONE";const It=(0,X.vt)();let P=class extends mt.A{get _minimumVerticesPerFeature(){switch(this.store?.featureStore.geometryType){case"esriGeometryPoint":case"esriGeometryMultipoint":return 1;case"esriGeometryPolygon":return 4;case"esriGeometryPolyline":return 2}}get _mandatoryOutFields(){const t=new Set;return this.objectIdField&&t.add(this.objectIdField),this.globalIdField&&t.add(this.globalIdField),t}set outFields(t){const e=this._get("outFields"),s=(0,Q.KC)(t,this._mandatoryOutFields);(0,Q.aI)(s,e)||(this._set("outFields",s),(0,Q.Yy)(s,e)||this.refresh())}get outFields(){return this._get("outFields")??this._mandatoryOutFields}set filter(t){const e=this._get("filter"),s=this._filterProperties(t);JSON.stringify(e)!==JSON.stringify(s)&&this._set("filter",s)}set customParameters(t){const e=this._get("customParameters");JSON.stringify(e)!==JSON.stringify(t)&&this._set("customParameters",t)}get _configuration(){return{filter:this.filter,customParameters:this.customParameters,tileInfo:this.tileInfo,tileSize:this.tileSize}}set tileInfo(t){const e=this._get("tileInfo");e!==t&&(null!=t&&null!=e&&JSON.stringify(t)===JSON.stringify(e)||(this._set("tileInfo",t),this.store.tileInfo=t))}set tileSize(t){this._get("tileSize")!==t&&this._set("tileSize",t)}get updating(){return this.updatingExcludingEdits||this._pendingEdits.updating}get updatingExcludingEdits(){return this._updatingHandles.updating}get hasZ(){return this.store.featureStore.hasZ}constructor(t){super(t),this.suspended=!0,this.tilesOfInterest=[],this.availability=0,this._pendingTiles=new Map,this._updatingHandles=new z.U,this._pendingEdits=new _t,this._pendingEditsAbortController=new AbortController}initialize(){this._initializeFetchExtent(),this._updatingHandles.add(()=>this._configuration,()=>this.refresh()),this._updatingHandles.add(()=>this.tilesOfInterest,(t,e)=>{(0,bt.aI)(t,e,({id:s},{id:i})=>s===i)||this._process()},L.OH),this.addHandles((0,L.z7)(()=>!this.suspended,()=>this._process()))}destroy(){this._pendingTiles.forEach(t=>this._deletePendingTile(t)),this._pendingTiles.clear(),this.store.destroy(),this.tilesOfInterest.length=0,this._pendingEditsAbortController.abort(),this._pendingEditsAbortController=null,this._updatingHandles.destroy()}refresh(){this.store.refresh(),this._pendingTiles.forEach(t=>this._deletePendingTile(t)),this._process()}applyEdits(t){var e=this;this._pendingEdits.push(t,function(){var s=(0,F.A)(function*(i){if(0===i.addedFeatures.length&&0===i.updatedFeatures.length&&0===i.deletedFeatures.length)return;for(const[,o]of e._pendingTiles)o.reset();const n={...i,deletedFeatures:i.deletedFeatures.map(({objectId:o,globalId:u})=>o&&-1!==o?o:e._lookupObjectIdByGlobalId(u))};yield e._updatingHandles.addPromise(e.store.processEdits(n,(o,u)=>e._queryFeaturesById(o,u),e._pendingEditsAbortController.signal)),e._processPendingTiles()});return function(i){return s.apply(this,arguments)}}())}_initializeFetchExtent(){var t=this;if(!this.capabilities.query.supportsExtent||!(0,Pt.Wo)(this.url))return;const e=(0,ut.UT)(function(){var s=(0,F.A)(function*(i){try{const n=yield(0,gt.Jf)(t.url,new R.A({where:"1=1",outSpatialReference:t.spatialReference,cacheHint:t.capabilities.query.supportsCacheHint??void 0}),{query:t._configuration.customParameters,signal:i});t.store.extent=Ot.A.fromJSON(n.data?.extent)}catch(n){(0,A.QP)(n),w.A.getLogger(t).warn("Failed to fetch data extent",n)}});return function(i){return s.apply(this,arguments)}}());this._updatingHandles.addPromise(e.promise.then(()=>this._process())),this.addHandles((0,Bt.hA)(()=>e.abort()))}get debugInfo(){return{numberOfFeatures:this.store.featureStore.numFeatures,tilesOfInterest:this.tilesOfInterest,pendingTiles:Array.from(this._pendingTiles.values()).map(t=>t.debugInfo),storedTiles:this.store.debugInfo}}_process(){this._markTilesNotAlive(),this._createPendingTiles(),this._deletePendingTiles(),this._processPendingTiles()}_markTilesNotAlive(){for(const[,t]of this._pendingTiles)t.alive=!1}_createPendingTiles(){if(this.suspended)return;const t=this._collectMissingTilesInfo();if(this._setAvailability(null==t?1:t.coveredArea/t.fullArea),null!=t)for(const{data:e,resolution:s}of t.missingTiles){const i=this._pendingTiles.get(e.id);i?(i.resolution=s,i.alive=!0):this._createPendingTile(e,s)}}_collectMissingTilesInfo(){let t=null;for(let e=this.tilesOfInterest.length-1;e>=0;e--){const i=this.store.process(this.tilesOfInterest[e],(n,o)=>this._verifyTileComplexity(n,o),this.outFields);null==t?t=i:t.prepend(i)}return t}_deletePendingTiles(){for(const[,t]of this._pendingTiles)t.alive||this._deletePendingTile(t)}_processPendingTiles(){const t={fetchCount:(e,s)=>this._fetchCount(e,s),fetchFeatures:(e,s,i)=>this._fetchFeatures(e,s,i),finish:(e,s)=>this._finishPendingTile(e,s),resume:()=>this._processPendingTiles()};if(this._ensureFetchAllCounts(t))for(const[,e]of this._pendingTiles)this._verifyTileComplexity(this.store.getFeatureCount(e.data),e.resolution)&&this._updatingHandles.addPromise(e.process(t))}_verifyTileComplexity(t,e){return this._verifyVertexComplexity(t)&&this._verifyFeatureDensity(t,e)}_verifyVertexComplexity(t){return t*this._minimumVerticesPerFeature<jt}_verifyFeatureDensity(t,e){if(null==this.tileInfo)return!1;const s=this.tileSize*e;return t*(zt/(s*s))<Yt}_ensureFetchAllCounts(t){let e=!0;for(const[,s]of this._pendingTiles)s.state.type<I.FETCHED_COUNT&&this._updatingHandles.addPromise(s.process(t)),s.state.type<=I.FETCH_COUNT&&(e=!1);return e}_finishPendingTile(t,e){this.store.add(t.data,e),this._deletePendingTile(t),this._updateAvailability()}_updateAvailability(){const t=this._collectMissingTilesInfo();this._setAvailability(null==t?1:t.coveredArea/t.fullArea)}_setAvailability(t){this._set("availability",t)}_createPendingTile(t,e){const s=new Dt(t,e);return this._pendingTiles.set(t.id,s),s}_deletePendingTile(t){t.reset(),this._pendingTiles.delete(t.data.id)}_fetchCount(t,e){var s=this;return(0,F.A)(function*(){return s.store.fetchCount(t.data,s.url,s._createCountQuery(t),{query:s.customParameters,timeout:Et,signal:e})})()}_fetchFeatures(t,e,s){var i=this;return(0,F.A)(function*(){let n=0;const o=[];let u=0,f=e;for(;;){const p=i._createFeaturesQuery(t),x=i._setPagingParameters(p,n,f),{features:O,exceededTransferLimit:N}=yield i._queryFeatures(p,s);x&&(n+=p.num),u+=O.length;for(const H of O)o.push(H);if(f=e-u,!x||!N||f<=0)return o}})()}_filterProperties(t){return null==t?{where:"1=1",gdbVersion:void 0,timeExtent:void 0}:{where:t.where||"1=1",timeExtent:t.timeExtent,gdbVersion:t.gdbVersion}}_lookupObjectIdByGlobalId(t){const e=this.globalIdField,s=this.objectIdField;if(null==e)throw new Error("Expected globalIdField to be defined");let i=null;if(this.store.featureStore.forEach(n=>{t===n.attributes[e]&&(i=n.objectId??n.attributes[s])}),null==i)throw new Error(`Expected to find a feature with globalId ${t}`);return i}_queryFeaturesById(t,e){const s=this._createFeaturesQuery();return s.objectIds=t,this._queryFeatures(s,e)}_queryFeatures(t,e){return this.capabilities.query.supportsFormatPBF?this._queryFeaturesPBF(t,e):this._queryFeaturesJSON(t,e)}_queryFeaturesPBF(t,e){var s=this;return(0,F.A)(function*(){const{sourceSpatialReference:i}=s,{data:n}=yield(0,gt.IJ)(s.url,t,new Rt.S({sourceSpatialReference:i}),{query:s._configuration.customParameters,timeout:Et,signal:e});return(0,vt.eY)(n)})()}_queryFeaturesJSON(t,e){var s=this;return(0,F.A)(function*(){const{sourceSpatialReference:i}=s,{data:n}=yield(0,gt.eW)(s.url,t,i,{query:s._configuration.customParameters,timeout:Et,signal:e});return(0,vt.q3)(n,s.objectIdField)})()}_createCountQuery(t){const e=this._createBaseQuery(t);return this.capabilities.query.supportsCacheHint&&(e.cacheHint=!0),e}_createFeaturesQuery(t=null){const e=this._createBaseQuery(t),s=null!=t?.data?this.store.getAttributesForTile(t?.data?.id):null,i=(0,Q.KC)((0,Q.iv)(this.outFields,s??new Set),this._mandatoryOutFields);return e.outFields=Array.from(i),e.returnGeometry=!0,null!=t&&(this.capabilities.query.supportsResultType?e.resultType="tile":this.capabilities.query.supportsCacheHint&&(e.cacheHint=!0)),e}_createBaseQuery(t){const e=new R.A({returnZ:this.hasZ,returnM:!1,geometry:null!=this.tileInfo&&null!=t?(0,X.w1)(t.data.extent,this.tileInfo.spatialReference):void 0}),s=this._configuration.filter;return null!=s&&(e.where=s.where,e.gdbVersion=s.gdbVersion,e.timeExtent=s.timeExtent),e.outSpatialReference=this.spatialReference,e}_setPagingParameters(t,e,s){if(!this.capabilities.query.supportsPagination)return!1;const{supportsMaxRecordCountFactor:i,supportsCacheHint:n,tileMaxRecordCount:o,maxRecordCount:u,supportsResultType:f}=this.capabilities.query,p=i?R.A.MAX_MAX_RECORD_COUNT_FACTOR:1,x=p*((f||n)&&o?o:u||Ht);return t.start=e,i?(t.maxRecordCountFactor=Math.min(p,Math.ceil(s/x)),t.num=Math.min(s,t.maxRecordCountFactor*x)):t.num=Math.min(s,x),!0}};(0,C._)([(0,T.MZ)({constructOnly:!0})],P.prototype,"url",void 0),(0,C._)([(0,T.MZ)({constructOnly:!0})],P.prototype,"objectIdField",void 0),(0,C._)([(0,T.MZ)({constructOnly:!0})],P.prototype,"globalIdField",void 0),(0,C._)([(0,T.MZ)({constructOnly:!0})],P.prototype,"capabilities",void 0),(0,C._)([(0,T.MZ)({constructOnly:!0})],P.prototype,"sourceSpatialReference",void 0),(0,C._)([(0,T.MZ)({constructOnly:!0})],P.prototype,"spatialReference",void 0),(0,C._)([(0,T.MZ)({constructOnly:!0})],P.prototype,"store",void 0),(0,C._)([(0,T.MZ)({readOnly:!0})],P.prototype,"_minimumVerticesPerFeature",null),(0,C._)([(0,T.MZ)()],P.prototype,"_mandatoryOutFields",null),(0,C._)([(0,T.MZ)()],P.prototype,"outFields",null),(0,C._)([(0,T.MZ)()],P.prototype,"suspended",void 0),(0,C._)([(0,T.MZ)()],P.prototype,"filter",null),(0,C._)([(0,T.MZ)()],P.prototype,"customParameters",null),(0,C._)([(0,T.MZ)({readOnly:!0})],P.prototype,"_configuration",null),(0,C._)([(0,T.MZ)()],P.prototype,"tileInfo",null),(0,C._)([(0,T.MZ)()],P.prototype,"tileSize",null),(0,C._)([(0,T.MZ)()],P.prototype,"tilesOfInterest",void 0),(0,C._)([(0,T.MZ)({readOnly:!0})],P.prototype,"updating",null),(0,C._)([(0,T.MZ)({readOnly:!0})],P.prototype,"updatingExcludingEdits",null),(0,C._)([(0,T.MZ)({readOnly:!0})],P.prototype,"availability",void 0),(0,C._)([(0,T.MZ)()],P.prototype,"hasZ",null),P=(0,C._)([(0,S.$)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTiledFetcher")],P);const Ht=2e3,Et=6e5,jt=1e6,zt=25,Yt=1;var Ft=h(4277),Nt=h(63583),Lt=h(59894),Xt=h(25858);class Zt{constructor(){this._store=new Map,this._byteSize=0}set(e,s){this.delete(e),this._store.set(e,s),this._byteSize+=s.byteSize}delete(e){const s=this._store.get(e);return!!this._store.delete(e)&&(null!=s&&(this._byteSize-=s.byteSize),!0)}get(e){return this._used(e),this._store.get(e)}has(e){return this._used(e),this._store.has(e)}clear(){this._store.clear()}applyByteSizeLimit(e,s){for(const[i,n]of this._store){if(this._byteSize<=e)break;this.delete(i),s(n)}}values(){return this._store.values()}[Symbol.iterator](){return this._store[Symbol.iterator]()}_used(e){const s=this._store.get(e);s&&(this._store.delete(e),this._store.set(e,s))}}let et=class extends mt.A{constructor(t){super(t),this.tileInfo=null,this.extent=null,this.maximumByteSize=10*Nt.u.MEGABYTES,this._tileBounds=new Lt.F,this._tiles=new Zt,this._refCounts=new Map,this._tileFeatureCounts=new Map,this._tmpBoundingRect=(0,X.vt)()}add(t,e){for(const n of e)this._referenceFeature(n.objectId);const s=this.featureStore.upsertMany(e),i=s.map(n=>new Set(Object.keys(n.attributes))).reduce((n,o)=>(0,Q.E$)(n,o),new Set(Object.keys(s[0]?.attributes??[])));this._addTileStorage(t,new Set(s.map(n=>n.objectId)),function Vt(t){return t.reduce((e,s)=>e+function Kt(t){return 32+function $t(t){if(null==t)return 0;const e=(0,Ft.zd)(t.lengths,4);return 32+(0,Ft.zd)(t.coords,8)+e}(t.geometry)+(0,Ft.eY)(t.attributes)}(s),0)}(s),i),this._tiles.applyByteSizeLimit(this.maximumByteSize,n=>this._removeTileStorage(n))}getAttributesForTile(t){return t?this._tiles.get(t)?.attributeKeys:null}destroy(){this.clear(),this._tileFeatureCounts.clear()}clear(){this.featureStore.clear(),this._tileBounds.clear(),this._tiles.clear(),this._refCounts.clear()}refresh(){this.clear(),this._tileFeatureCounts.clear()}processEdits(t,e,s){return this._processEditsDelete(t.deletedFeatures.concat(t.updatedFeatures)),this._processEditsRefetch(t.addedFeatures.concat(t.updatedFeatures),e,s)}_addTileStorage(t,e,s,i){const n=t.id;this._tiles.set(n,new Jt(t,e,s,i)),this._tileBounds.set(n,t.extent),this._tileFeatureCounts.set(n,e.size)}_remove({id:t}){const e=this._tiles.get(t);e&&this._removeTileStorage(e)}_removeTileStorage(t){const e=[];for(const i of t.objectIds)this._unreferenceFeature(i)===st.REMOVED&&e.push(i);this.featureStore.removeManyById(e);const s=t.data.id;this._tiles.delete(s),this._tileBounds.delete(s)}_processEditsDelete(t){this.featureStore.removeManyById(t);for(const[,e]of this._tiles){for(const s of t)e.objectIds.delete(s);this._tileFeatureCounts.set(e.data.id,e.objectIds.size)}for(const e of t)this._refCounts.delete(e)}_processEditsRefetch(t,e,s){var i=this;return(0,F.A)(function*(){const n=(yield e(t,s)).features,{hasZ:o,hasM:u}=i.featureStore;for(const f of n){const p=(0,vt.jQ)(i._tmpBoundingRect,f.geometry,o,u);null!=p&&i._tileBounds.forEachInBounds(p,x=>{const O=i._tiles.get(x);i.featureStore.add(f);const N=f.objectId;O.objectIds.has(N)||(O.objectIds.add(N),i._referenceFeature(N),i._tileFeatureCounts.set(O.data.id,O.objectIds.size))})}})()}process(t,e=(()=>!0),s){if(null==this.tileInfo||!t.extent||null!=this.extent&&!(0,X.HY)((0,X.VY)(this.extent,this._tmpBoundingRect),t.extent))return new Ct(t);const i=this.getAttributesForTile(t.id);if((0,Q.Yy)(s,i))return new Ct(t);const n=this._createTileTree(t,this.tileInfo);return this._simplify(n,e,null,0,1),this._collectMissingTiles(t,n,this.tileInfo,s)}get debugInfo(){return Array.from(this._tiles.values()).map(({data:t})=>({data:t,featureCount:this._tileFeatureCounts.get(t.id)||0}))}getFeatureCount(t){return this._tileFeatureCounts.get(t.id)??0}fetchCount(t,e,s,i){var n=this;return(0,F.A)(function*(){const o=n._tileFeatureCounts.get(t.id);if(null!=o)return o;const u=yield(0,gt.gW)(e,s,i);return n._tileFeatureCounts.set(t.id,u.data.count),u.data.count})()}_createTileTree(t,e){const s=new xt(t.level,t.row,t.col);return e.updateTileInfo(s,M.A.ExtrapolateOptions.POWER_OF_TWO),this._tileBounds.forEachInBounds(t.extent,i=>{const n=this._tiles.get(i)?.data;n&&function Wt(t,e){if(!t||!e)return!1;if(t.level===e.level)return t.row===e.row&&t.col===e.col;const s=t.level<e.level,i=s?t:e,n=s?e:t,o=1<<n.level-i.level;return Math.floor(n.row/o)===i.row&&Math.floor(n.col/o)===i.col}(t,n)&&this._populateChildren(s,n,e,this._tileFeatureCounts.get(n.id)||0)}),s}_populateChildren(t,e,s,i){const n=e.level-t.level-1;if(n<0)return void(t.isLeaf=!0);const o=e.row>>n,u=e.col>>n,p=u-(t.col<<1)+(o-(t.row<<1)<<1),x=t.children[p];if(null!=x)this._populateChildren(x,e,s,i);else{const O=new xt(t.level+1,o,u);s.updateTileInfo(O,M.A.ExtrapolateOptions.POWER_OF_TWO),t.children[p]=O,this._populateChildren(O,e,s,i)}}_simplify(t,e,s,i,n){const o=n*n;if(t.isLeaf)return e(this.getFeatureCount(t),n)?0:(this._remove(t),null!=s&&(s.children[i]=null),o);const u=n/2,f=u*u;let p=0;for(let x=0;x<t.children.length;x++){const O=t.children[x];p+=null!=O?this._simplify(O,e,t,x,u):f}return 0===p?this._mergeChildren(t):1-p/o<Gt&&(this._purge(t),null!=s&&(s.children[i]=null),p=o),p}_mergeChildren(t){const e=new Set;let s,i=0;this._forEachLeaf(t,n=>{const o=this._tiles.get(n.id);if(o){s=s?(0,Q.E$)(s,o.attributeKeys):new Set(o.attributeKeys),i+=o.byteSize;for(const u of o.objectIds)e.has(u)||(e.add(u),this._referenceFeature(u));this._remove(n)}}),this._addTileStorage(t,e,i,s??new Set),t.isLeaf=!0,t.children[0]=t.children[1]=t.children[2]=t.children[3]=null,this._tileFeatureCounts.set(t.id,e.size)}_forEachLeaf(t,e){for(const s of t.children)null!=s&&(s.isLeaf?e(s):this._forEachLeaf(s,e))}_purge(t){if(null!=t)if(t.isLeaf)this._remove(t);else for(let e=0;e<t.children.length;e++)this._purge(t.children[e]),t.children[e]=null}_collectMissingTiles(t,e,s,i){const n=new Qt(s,t,this.extent);return this._collectMissingTilesRecurse(e,n,1,i),n.info}_collectMissingTilesRecurse(t,e,s,i){const n=this.getAttributesForTile(t.id),o=n&&!(0,Q.Yy)(i,n);if(o&&e.addMissing(t.level,t.row,t.col,s),t.isLeaf)return;if(!t.hasChildren)return void(o||e.addMissing(t.level,t.row,t.col,s));const u=s/2;for(let f=0;f<t.children.length;f++){const p=t.children[f];null==p?e.addMissing(t.level+1,(t.row<<1)+((2&f)>>1),(t.col<<1)+(1&f),u):this._collectMissingTilesRecurse(p,e,u,i)}}_referenceFeature(t){const e=(this._refCounts.get(t)||0)+1;return this._refCounts.set(t,e),1===e?st.ADDED:st.UNCHANGED}_unreferenceFeature(t){const e=(this._refCounts.get(t)||0)-1;return 0===e?(this._refCounts.delete(t),st.REMOVED):(e>0&&this._refCounts.set(t,e),st.UNCHANGED)}get test(){}};(0,C._)([(0,T.MZ)({constructOnly:!0})],et.prototype,"featureStore",void 0),(0,C._)([(0,T.MZ)()],et.prototype,"tileInfo",void 0),(0,C._)([(0,T.MZ)()],et.prototype,"extent",void 0),(0,C._)([(0,T.MZ)()],et.prototype,"maximumByteSize",void 0),et=(0,C._)([(0,S.$)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceTileStore")],et);class Jt{constructor(e,s,i,n){this.data=e,this.objectIds=s,this.byteSize=i,this.attributeKeys=n}}class xt{constructor(e,s,i){this.level=e,this.row=s,this.col=i,this.isLeaf=!1,this.extent=null,this.children=[null,null,null,null]}get hasChildren(){return!this.isLeaf&&(null!=this.children[0]||null!=this.children[1]||null!=this.children[2]||null!=this.children[3])}}class Ct{constructor(e,s=[]){this.missingTiles=s,this.fullArea=0,this.coveredArea=0,this.fullArea=(0,X.Wc)(e.extent),this.coveredArea=this.fullArea}prepend(e){this.missingTiles=e.missingTiles.concat(this.missingTiles),this.coveredArea+=e.coveredArea,this.fullArea+=e.fullArea}}class Qt{constructor(e,s,i){this._tileInfo=e,this._extent=null,this.info=new Ct(s),null!=i&&(this._extent=(0,X.VY)(i))}addMissing(e,s,i,n){const o=new Xt.U(null,e,s,i);this._tileInfo.updateTileInfo(o,M.A.ExtrapolateOptions.POWER_OF_TWO),null==o.extent||null!=this._extent&&!(0,X.HY)(this._extent,o.extent)||(this.info.missingTiles.push({data:o,resolution:n}),this.info.coveredArea-=(0,X.Wc)(o.extent))}}const Gt=.18751;var st;!function(t){t[t.ADDED=0]="ADDED",t[t.REMOVED=1]="REMOVED",t[t.UNCHANGED=2]="UNCHANGED"}(st||(st={}));var kt=h(61320);let lt=class extends k.A.EventedAccessor{constructor(){var t;super(...arguments),t=this,this._isInitializing=!0,this.remoteClient=null,this._whenSetup=(0,A.Tw)(),this._elevationAligner=U(),this._elevationFilter=c(),this._symbologyCandidatesFetcher=ft(),this._updatingHandles=new z.U,this._editsUpdatingHandles=new z.U,this._pendingApplyEdits=new Map,this._alignPointsInFeatures=function(){var e=(0,F.A)(function*(s,i){const n={query:s},o=yield t.remoteClient.invoke("alignElevation",n,{signal:i});return(0,A.Te)(i),o});return function(s,i){return e.apply(this,arguments)}}(),this._getSymbologyCandidates=function(){var e=(0,F.A)(function*(s,i){const n={candidates:s,spatialReference:t._spatialReference.toJSON()},o=yield t.remoteClient.invoke("getSymbologyCandidates",n,{signal:i});return(0,A.Te)(i),o});return function(s,i){return e.apply(this,arguments)}}()}get updating(){return this.updatingExcludingEdits||this._editsUpdatingHandles.updating||this._featureFetcher.updating}get updatingExcludingEdits(){return this._featureFetcher.updatingExcludingEdits||this._isInitializing||this._updatingHandles.updating}destroy(){this._featureFetcher?.destroy(),this._queryEngine?.destroy(),this._featureStore?.clear()}setup(t){var e=this;return(0,F.A)(function*(){if(e.destroyed)return{result:{}};const{geometryType:s,objectIdField:i,timeInfo:n,fieldsIndex:o}=t.serviceInfo,{hasZ:u}=t,f=W.A.fromJSON(t.spatialReference);e._spatialReference=f,e._featureStore=new _.A({...t.serviceInfo,hasZ:u,hasM:!1}),e._queryEngine=new y.d({spatialReference:t.spatialReference,featureStore:e._featureStore,geometryType:s,fieldsIndex:o,hasZ:u,hasM:!1,objectIdField:i,timeInfo:n}),e._featureFetcher=new P({store:new et({featureStore:e._featureStore}),url:t.serviceInfo.url,objectIdField:t.serviceInfo.objectIdField,globalIdField:t.serviceInfo.globalIdField,capabilities:t.serviceInfo.capabilities,spatialReference:f,sourceSpatialReference:W.A.fromJSON(t.serviceInfo.spatialReference),customParameters:t.configuration.customParameters});const p="3d"===t.configuration.viewType;return e._elevationAligner=U(p,{elevationInfo:null!=t.elevationInfo?V.A.fromJSON(t.elevationInfo):null,alignPointsInFeatures:e._alignPointsInFeatures}),e._elevationFilter=c(p),e.addHandles([(0,L.wB)(()=>e._featureFetcher.availability,x=>e.emit("notify-availability",{availability:x}),L.OH),(0,L.wB)(()=>e.updating,()=>e._notifyUpdating())]),e._whenSetup.resolve(),e._isInitializing=!1,e.configure(t.configuration)})()}configure(t){var e=this;return(0,F.A)(function*(){return yield e._updatingHandles.addPromise(e._whenSetup.promise),e._updateFeatureFetcherConfiguration(t),Z})()}setSuspended(t,e){var s=this;return(0,F.A)(function*(){return yield s._updatingHandles.addPromise(s._whenSetup.promise),(0,A.Te)(e),s._featureFetcher.suspended=t,Z})()}updateOutFields(t,e){var s=this;return(0,F.A)(function*(){return yield s._updatingHandles.addPromise(s._whenSetup.promise),(0,A.Te)(e),s._featureFetcher.outFields=new Set(t??[]),Z})()}fetchCandidates(t,e){var s=this;return(0,F.A)(function*(){yield s._whenSetup.promise,(0,A.Te)(e);const i=function te(t){if(!t.filter)return{...t,query:{where:"1=1"}};const{distance:e,units:s,spatialRel:i,where:n,timeExtent:o,objectIds:u}=t.filter,f={geometry:t.filter.geometry?(0,kt.rS)(t.filter.geometry):void 0,distance:e,units:s,spatialRel:i,timeExtent:o,objectIds:u,where:n??"1=1"};return{...t,query:f}}(t),n=e?.signal,o=yield s._queryEngine.executeQueryForSnapping(i,n);(0,A.Te)(n);const u=yield s._elevationAligner.alignCandidates(o.candidates,W.A.fromJSON(t.point.spatialReference)??W.A.WGS84,n);(0,A.Te)(n);const f=yield s._symbologyCandidatesFetcher.fetch(u,n);(0,A.Te)(n);const p=0===f.length?u:u.concat(f);return{result:{candidates:s._elevationFilter.filter(i,p)}}})()}updateTiles(t,e){var s=this;return(0,F.A)(function*(){return yield s._updatingHandles.addPromise(s._whenSetup.promise),(0,A.Te)(e),s._featureFetcher.tileSize=t.tileSize,s._featureFetcher.tilesOfInterest=t.tiles,s._featureFetcher.tileInfo=null!=t.tileInfo?M.A.fromJSON(t.tileInfo):null,Z})()}refresh(t,e){var s=this;return(0,F.A)(function*(){return yield s._updatingHandles.addPromise(s._whenSetup.promise),(0,A.Te)(e),s._featureFetcher.refresh(),Z})()}whenNotUpdating(t,e){var s=this;return(0,F.A)(function*(){return yield s._updatingHandles.addPromise(s._whenSetup.promise),(0,A.Te)(e),yield(0,L.C_)(()=>!s.updatingExcludingEdits,e),(0,A.Te)(e),Z})()}getDebugInfo(t,e){var s=this;return(0,F.A)(function*(){return(0,A.Te)(e),{result:s._featureFetcher.debugInfo}})()}beginApplyEdits(t,e){var s=this;return(0,F.A)(function*(){s._updatingHandles.addPromise(s._whenSetup.promise),(0,A.Te)(e);const i=(0,A.Tw)();return s._pendingApplyEdits.set(t.id,i),s._featureFetcher.applyEdits(i.promise),s._editsUpdatingHandles.addPromise(i.promise),Z})()}endApplyEdits(t,e){var s=this;return(0,F.A)(function*(){const i=s._pendingApplyEdits.get(t.id);return i&&i.resolve(t.edits),(0,A.Te)(e),Z})()}notifyElevationSourceChange(t,e){var s=this;return(0,F.A)(function*(){return s._elevationAligner.notifyElevationSourceChange(),Z})()}notifySymbologyChange(t,e){var s=this;return(0,F.A)(function*(){return s._symbologyCandidatesFetcher.notifySymbologyChange(),Z})()}setSymbologySnappingSupported(t){var e=this;return(0,F.A)(function*(){return e._symbologyCandidatesFetcher=ft(t,e._getSymbologyCandidates),Z})()}_updateFeatureFetcherConfiguration(t){this._featureFetcher.filter=null!=t.filter?R.A.fromJSON(t.filter):null,this._featureFetcher.customParameters=t.customParameters}_notifyUpdating(){this.emit("notify-updating",{updating:this.updating})}};(0,C._)([(0,T.MZ)({readOnly:!0})],lt.prototype,"updating",null),(0,C._)([(0,T.MZ)({readOnly:!0})],lt.prototype,"updatingExcludingEdits",null),(0,C._)([(0,T.MZ)()],lt.prototype,"_isInitializing",void 0),lt=(0,C._)([(0,S.$)("esri.views.interactive.snapping.featureSources.featureServiceSource.FeatureServiceSnappingSourceWorker")],lt);const qt=lt,Z={result:{}}}}]);