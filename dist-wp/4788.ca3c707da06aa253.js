"use strict";(self.webpackChunkangular_18_test=self.webpackChunkangular_18_test||[]).push([[4788],{86468:(pt,it,y)=>{y.d(it,{T:()=>W,U:()=>Z});var I=y(69287);function Z(U,u,f=0){const o=(0,I.qE)(U,0,Y);for(let l=0;l<4;l++)u[f+l]=Math.floor(256*rt(o*G[l]))}function W(U,u=0){let f=0;for(let o=0;o<4;o++)f+=U[u+o]*K[o];return f}const G=[1,256,65536,16777216],K=[1/256,1/65536,1/16777216,1/4294967296],Y=W(new Uint8ClampedArray([255,255,255,255]));function rt(U){return U-Math.floor(U)}},3567:(pt,it,y)=>{y.d(it,{w:()=>K});var I=y(89952),W=(y(3248),y(12438)),G=y(17694);class K{constructor(_=9,w){this._compareMinX=l,this._compareMinY=m,this._toBBox=v=>v,this._maxEntries=Math.max(4,_||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),w&&("function"==typeof w?this._toBBox=w:this._initFormat(w)),this.clear()}destroy(){this.clear(),et.prune(),J.prune(),X.prune(),C.prune()}all(_){rt(this._data,_)}search(_,w){let v=this._data;const P=this._toBBox;if(D(_,v))for(et.clear();v;){for(let R=0,F=v.children.length;R<F;R++){const j=v.children[R],Q=v.leaf?P(j):j;D(_,Q)&&(v.leaf?w(j):O(_,Q)?rt(j,w):et.push(j))}v=et.pop()}}collides(_){let w=this._data;const v=this._toBBox;if(!D(_,w))return!1;for(et.clear();w;){for(let P=0,R=w.children.length;P<R;P++){const F=w.children[P],j=w.leaf?v(F):F;if(D(_,j)){if(w.leaf||O(_,j))return!0;et.push(F)}}w=et.pop()}return!1}load(_){if(!_.length)return this;if(_.length<this._minEntries){for(let v=0,P=_.length;v<P;v++)this.insert(_[v]);return this}let w=this._build(_.slice(0,_.length),0,_.length-1,0);if(this._data.children.length)if(this._data.height===w.height)this._splitRoot(this._data,w);else{if(this._data.height<w.height){const v=this._data;this._data=w,w=v}this._insert(w,this._data.height-w.height-1,!0)}else this._data=w;return this}insert(_){return _&&this._insert(_,this._data.height-1),this}clear(){return this._data=new E([]),this}remove(_){if(!_)return this;let w,v=this._data,P=null,R=0,F=!1;const j=this._toBBox(_);for(X.clear(),C.clear();v||X.length>0;){if(v||(v=X.pop(),P=X.data[X.length-1],R=C.pop()??0,F=!0),v.leaf&&(w=(0,I.qh)(v.children,_,v.children.length,v.indexHint),-1!==w))return v.children.splice(w,1),X.push(v),this._condense(X),this;F||v.leaf||!O(v,j)?P?(R++,v=P.children[R],F=!1):v=null:(X.push(v),C.push(R),R=0,P=v,v=v.children[0])}return this}toJSON(){return this._data}fromJSON(_){return this._data=_,this}_build(_,w,v,P){const R=v-w+1;let F=this._maxEntries;if(R<=F){const st=new E(_.slice(w,v+1));return u(st,this._toBBox),st}P||(P=Math.ceil(Math.log(R)/Math.log(F)),F=Math.ceil(R/F**(P-1)));const j=new tt([]);j.height=P;const Q=Math.ceil(R/F),at=Q*Math.ceil(Math.sqrt(F));ht(_,w,v,at,this._compareMinX);for(let st=w;st<=v;st+=at){const ut=Math.min(st+at-1,v);ht(_,st,ut,Q,this._compareMinY);for(let gt=st;gt<=ut;gt+=Q){const Dt=Math.min(gt+Q-1,ut);j.children.push(this._build(_,gt,Dt,P-1))}}return u(j,this._toBBox),j}_insert(_,w,v){const R=v?_:(0,this._toBBox)(_);X.clear();const F=function Y(M,_,w,v){for(;v.push(_),!0!==_.leaf&&v.length-1!==w;){let P,R=1/0,F=1/0;for(let j=0,Q=_.children.length;j<Q;j++){const at=_.children[j],st=g(at),ut=T(M,at)-st;ut<F?(F=ut,R=st<R?st:R,P=at):ut===F&&st<R&&(R=st,P=at)}_=P||_.children[0]}return _}(R,this._data,w,X);for(F.children.push(_),o(F,R);w>=0&&X.data[w].children.length>this._maxEntries;)this._split(X,w),w--;!function U(M,_,w){for(let v=w;v>=0;v--)o(_.data[v],M)}(R,X,w)}_split(_,w){const v=_.data[w],P=v.children.length,R=this._minEntries;this._chooseSplitAxis(v,R,P);const F=this._chooseSplitIndex(v,R,P);if(!F)return;const j=v.children.splice(F,v.children.length-F),Q=v.leaf?new E(j):new tt(j);Q.height=v.height,u(v,this._toBBox),u(Q,this._toBBox),w?_.data[w-1].children.push(Q):this._splitRoot(v,Q)}_splitRoot(_,w){this._data=new tt([_,w]),this._data.height=_.height+1,u(this._data,this._toBBox)}_chooseSplitIndex(_,w,v){let P,R,F;P=R=1/0;for(let j=w;j<=v-w;j++){const Q=f(_,0,j,this._toBBox),at=f(_,j,v,this._toBBox),st=k(Q,at),ut=g(Q)+g(at);st<P?(P=st,F=j,R=ut<R?ut:R):st===P&&ut<R&&(R=ut,F=j)}return F}_chooseSplitAxis(_,w,v){const P=_.leaf?this._compareMinX:l,R=_.leaf?this._compareMinY:m;this._allDistMargin(_,w,v,P)<this._allDistMargin(_,w,v,R)&&_.children.sort(P)}_allDistMargin(_,w,v,P){_.children.sort(P);const R=this._toBBox,F=f(_,0,w,R),j=f(_,v-w,v,R);let Q=A(F)+A(j);for(let at=w;at<v-w;at++){const st=_.children[at];o(F,_.leaf?R(st):st),Q+=A(F)}for(let at=v-w-1;at>=w;at--){const st=_.children[at];o(j,_.leaf?R(st):st),Q+=A(j)}return Q}_condense(_){for(let w=_.length-1;w>=0;w--){const v=_.data[w];if(0===v.children.length)if(w>0){const P=_.data[w-1],R=P.children;R.splice((0,I.qh)(R,v,R.length,P.indexHint),1)}else this.clear();else u(v,this._toBBox)}}_initFormat(_){const w=["return a"," - b",";"];this._compareMinX=new Function("a","b",w.join(_[0])),this._compareMinY=new Function("a","b",w.join(_[1])),this._toBBox=new Function("a","return {minX: a"+_[0]+", minY: a"+_[1]+", maxX: a"+_[2]+", maxY: a"+_[3]+"};")}}function rt(M,_){let w=M;for(J.clear();w;){if(!0===w.leaf)for(const v of w.children)_(v);else J.pushArray(w.children);w=J.pop()??null}}function u(M,_){f(M,0,M.children.length,_,M)}function f(M,_,w,v,P){P||(P=new E([])),P.minX=1/0,P.minY=1/0,P.maxX=-1/0,P.maxY=-1/0;for(let R,F=_;F<w;F++)R=M.children[F],o(P,M.leaf?v(R):R);return P}function o(M,_){M.minX=Math.min(M.minX,_.minX),M.minY=Math.min(M.minY,_.minY),M.maxX=Math.max(M.maxX,_.maxX),M.maxY=Math.max(M.maxY,_.maxY)}function l(M,_){return M.minX-_.minX}function m(M,_){return M.minY-_.minY}function g(M){return(M.maxX-M.minX)*(M.maxY-M.minY)}function A(M){return M.maxX-M.minX+(M.maxY-M.minY)}function T(M,_){return(Math.max(_.maxX,M.maxX)-Math.min(_.minX,M.minX))*(Math.max(_.maxY,M.maxY)-Math.min(_.minY,M.minY))}function k(M,_){const w=Math.max(M.minX,_.minX),v=Math.max(M.minY,_.minY),P=Math.min(M.maxX,_.maxX),R=Math.min(M.maxY,_.maxY);return Math.max(0,P-w)*Math.max(0,R-v)}function O(M,_){return M.minX<=_.minX&&M.minY<=_.minY&&_.maxX<=M.maxX&&_.maxY<=M.maxY}function D(M,_){return _.minX<=M.maxX&&_.minY<=M.maxY&&_.maxX>=M.minX&&_.maxY>=M.minY}function ht(M,_,w,v,P){const R=[_,w];for(;R.length;){const F=R.pop(),j=R.pop();if(F-j<=v)continue;const Q=j+Math.ceil((F-j)/v/2)*v;(0,G.q)(M,Q,j,F,P),R.push(j,Q,Q,F)}}const et=new W.A,J=new W.A,X=new W.A,C=new W.A({deallocator:void 0});class V{constructor(){this.minX=1/0,this.minY=1/0,this.maxX=-1/0,this.maxY=-1/0}}class L extends V{constructor(){super(...arguments),this.height=1,this.indexHint=new I.vW}}class E extends L{constructor(_){super(),this.children=_,this.leaf=!0}}class tt extends L{constructor(_){super(),this.children=_,this.leaf=!1}}},55912:(pt,it,y)=>{y.d(it,{A:()=>rt});var W,U,I=y(3248),Z=y(61591);(U=W||(W={}))[U.varint=0]="varint",U[U.fixed64=1]="fixed64",U[U.delimited=2]="delimited",U[U.fixed32=5]="fixed32",U[U.unknown=99]="unknown";const G=4294967296,K=new TextDecoder("utf-8"),Y=(0,I.A)("safari")||(0,I.A)("ios")?6:(0,I.A)("ff")?12:32;class rt{constructor(u,f,o=0,l=(u?u.byteLength:0)){this._tag=0,this._dataType=W.unknown,this._init(u,f,o,l)}_init(u,f,o,l){this._data=u,this._dataView=f,this._pos=o,this._end=l}asUnsafe(){return this}clone(){return new rt(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(u){this._pos=u}nextTag(u){for(;;){if(this._pos===this._end)return!1;const f=this._decodeVarint();if(this._tag=f>>3,this._dataType=7&f,!u||u===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const u=this._decodeVarint();return this._tag=u>>3,this._dataType=7&u,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let u=4294967295;if(u=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128||(u=(u|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128)||(u=(u|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128)||(u=(u|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128)||(u=(u|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128))return u;throw new Error("Varint overflow")}getUInt64(){return this._decodeVarint()}getSInt32(){const u=this.getUInt32();return u>>>1^-(1&u)}getSInt64(){return this._decodeSVarint()}getBool(){const u=0!==this._data[this._pos];return this._skip(1),u}getEnum(){return this._decodeVarint()}getFixed64(){const u=this._dataView,f=this._pos,o=u.getUint32(f,!0)+u.getUint32(f+4,!0)*G;return this._skip(8),o}getSFixed64(){const u=this._dataView,f=this._pos,o=u.getUint32(f,!0)+u.getInt32(f+4,!0)*G;return this._skip(8),o}getDouble(){const u=this._dataView.getFloat64(this._pos,!0);return this._skip(8),u}getFixed32(){const u=this._dataView.getUint32(this._pos,!0);return this._skip(4),u}getSFixed32(){const u=this._dataView.getInt32(this._pos,!0);return this._skip(4),u}getFloat(){const u=this._dataView.getFloat32(this._pos,!0);return this._skip(4),u}getString(){const u=this._getLength(),f=this._pos,o=this._toString(this._data,f,f+u);return this._skip(u),o}getBytes(){const u=this._getLength(),f=this._pos,o=this._toBytes(this._data,f,f+u);return this._skip(u),o}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(u,f,o,l){const m=this.getMessage(),g=u(m,f,o,l);return m.release(),g}processMessage(u){const f=this.getMessage(),o=u(f);return f.release(),o}getMessage(){const u=this._getLength(),f=rt.pool.acquire();return f._init(this._data,this._dataView,this._pos,this._pos+u),this._skip(u),f}release(){rt.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case W.varint:this._decodeVarint();break;case W.fixed64:this._skip(8);break;case W.delimited:this._skip(this._getLength());break;case W.fixed32:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(u){this._skip(u)}_skip(u){if(this._pos+u>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=u}_decodeVarint(){const u=this._data;let f=this._pos,o=0,l=0;if(this._end-f>=10)do{if(l=u[f++],o|=127&l,!(128&l&&(l=u[f++],o|=(127&l)<<7,128&l)&&(l=u[f++],o|=(127&l)<<14,128&l)&&(l=u[f++],o|=(127&l)<<21,128&l)&&(l=u[f++],o+=268435456*(127&l),128&l)&&(l=u[f++],o+=34359738368*(127&l),128&l)&&(l=u[f++],o+=4398046511104*(127&l),128&l)&&(l=u[f++],o+=562949953421312*(127&l),128&l)&&(l=u[f++],o+=72057594037927940*(127&l),128&l)&&(l=u[f++],o+=0x8000000000000000*(127&l),128&l)))break;throw new Error("Varint too long!")}while(0);else{let m=1;for(;f!==this._end&&(l=u[f],128&l);)++f,o+=(127&l)*m,m*=128;if(f===this._end)throw new Error("Varint overrun!");++f,o+=l*m}return this._pos=f,o}_decodeSVarint(){const u=this._data;let f,o=0,l=0;const m=1&u[this._pos];if(l=u[this._pos++],o|=127&l,!(128&l&&(l=u[this._pos++],o|=(127&l)<<7,128&l)&&(l=u[this._pos++],o|=(127&l)<<14,128&l)&&(l=u[this._pos++],o|=(127&l)<<21,128&l)&&(l=u[this._pos++],o+=268435456*(127&l),128&l)&&(l=u[this._pos++],o+=34359738368*(127&l),128&l)&&(l=u[this._pos++],o+=4398046511104*(127&l),128&l)))return m?-(o+1)/2:o/2;if(f=BigInt(o),l=u[this._pos++],f+=0x2000000000000n*BigInt(127&l),!(128&l&&(l=u[this._pos++],f+=0x100000000000000n*BigInt(127&l),128&l)&&(l=u[this._pos++],f+=0x8000000000000000n*BigInt(127&l),128&l)))return Number(m?-(f+1n)/2n:f/2n);throw new Error("Varint too long!")}_getLength(){if(this._dataType!==W.delimited)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(u,f,o){if((o=Math.min(this._end,o))-f>Y){const g=u.subarray(f,o);return K.decode(g)}let l="",m="";for(let g=f;g<o;++g){const A=u[g];128&A?m+="%"+A.toString(16):(l+=decodeURIComponent(m)+String.fromCharCode(A),m="")}return m.length&&(l+=decodeURIComponent(m)),l}_toBytes(u,f,o){return o=Math.min(this._end,o),new Uint8Array(u.buffer,f,o-f)}}rt.pool=new Z.A(rt,void 0,U=>{U._data=null,U._dataView=null})},91766:(pt,it,y)=>{var Z,W,f;y.d(it,{O3:()=>Y,Ox:()=>rt,bR:()=>G,dC:()=>Z}),(f=Z||(Z={}))[f.Unknown=0]="Unknown",f[f.Point=1]="Point",f[f.LineString=2]="LineString",f[f.Polygon=3]="Polygon";class G{constructor(o,l){this.x=o,this.y=l}clone(){return new G(this.x,this.y)}equals(o,l){return o===this.x&&l===this.y}isEqual(o){return o.x===this.x&&o.y===this.y}setCoords(o,l){return this.x=o,this.y=l,this}normalize(){const o=this.x,l=this.y,m=Math.sqrt(o*o+l*l);return this.x/=m,this.y/=m,this}rightPerpendicular(){const o=this.x;return this.x=this.y,this.y=-o,this}leftPerpendicular(){const o=this.x;return this.x=-this.y,this.y=o,this}move(o,l){return this.x+=o,this.y+=l,this}assign(o){return this.x=o.x,this.y=o.y,this}assignAdd(o,l){return this.x=o.x+l.x,this.y=o.y+l.y,this}assignSub(o,l){return this.x=o.x-l.x,this.y=o.y-l.y,this}rotate(o,l){const m=this.x,g=this.y;return this.x=m*o-g*l,this.y=m*l+g*o,this}scale(o){return this.x*=o,this.y*=o,this}length(){const o=this.x,l=this.y;return Math.sqrt(o*o+l*l)}sub(o){return this.x-=o.x,this.y-=o.y,this}add(o){return this.x+=o.x,this.y+=o.y,this}static distance(o,l){const m=l.x-o.x,g=l.y-o.y;return Math.sqrt(m*m+g*g)}static add(o,l){return new G(o.x+l.x,o.y+l.y)}static sub(o,l){return new G(o.x-l.x,o.y-l.y)}}class K{constructor(o,l,m){this.ratio=o,this.x=l,this.y=m}}class Y{constructor(o,l,m,g=8,A=8){this._lines=[],this._starts=[],this.validateTessellation=!0,this._pixelRatio=g,this._pixelMargin=A,this._tileSize=512*g,this._dz=o,this._yPos=l,this._xPos=m}setPixelMargin(o){o!==this._pixelMargin&&(this._pixelMargin=o,this.setExtent(this._extent))}setExtent(o){this._extent=o,this._finalRatio=this._tileSize/o*(1<<this._dz);let l=this._pixelRatio*this._pixelMargin;l/=this._finalRatio;const m=o>>this._dz;l>m&&(l=m),this._margin=l,this._xmin=m*this._xPos-l,this._ymin=m*this._yPos-l,this._xmax=this._xmin+m+2*l,this._ymax=this._ymin+m+2*l}reset(o){this._type=o,this._lines=[],this._starts=[],this._line=null,this._start=0}moveTo(o,l){this._pushLine(),this._prevIsIn=this._isIn(o,l),this._moveTo(o,l,this._prevIsIn),this._prevPt=new G(o,l),this._firstPt=new G(o,l),this._dist=0}lineTo(o,l){const m=this._isIn(o,l),g=new G(o,l),A=G.distance(this._prevPt,g);let T,k,O,D,ht,et,J,X;if(m)this._prevIsIn?this._lineTo(o,l,!0):(T=this._prevPt,k=g,O=this._intersect(k,T),this._start=this._dist+A*(1-this._r),this._lineTo(O.x,O.y,!0),this._lineTo(k.x,k.y,!0));else if(this._prevIsIn)k=this._prevPt,T=g,O=this._intersect(k,T),this._lineTo(O.x,O.y,!0),this._lineTo(T.x,T.y,!1);else{const C=this._prevPt,V=g;if(C.x<=this._xmin&&V.x<=this._xmin||C.x>=this._xmax&&V.x>=this._xmax||C.y<=this._ymin&&V.y<=this._ymin||C.y>=this._ymax&&V.y>=this._ymax)this._lineTo(V.x,V.y,!1);else{const L=[];if((C.x<this._xmin&&V.x>this._xmin||C.x>this._xmin&&V.x<this._xmin)&&(D=(this._xmin-C.x)/(V.x-C.x),X=C.y+D*(V.y-C.y),X<=this._ymin?et=!1:X>=this._ymax?et=!0:L.push(new K(D,this._xmin,X))),(C.x<this._xmax&&V.x>this._xmax||C.x>this._xmax&&V.x<this._xmax)&&(D=(this._xmax-C.x)/(V.x-C.x),X=C.y+D*(V.y-C.y),X<=this._ymin?et=!1:X>=this._ymax?et=!0:L.push(new K(D,this._xmax,X))),(C.y<this._ymin&&V.y>this._ymin||C.y>this._ymin&&V.y<this._ymin)&&(D=(this._ymin-C.y)/(V.y-C.y),J=C.x+D*(V.x-C.x),J<=this._xmin?ht=!1:J>=this._xmax?ht=!0:L.push(new K(D,J,this._ymin))),(C.y<this._ymax&&V.y>this._ymax||C.y>this._ymax&&V.y<this._ymax)&&(D=(this._ymax-C.y)/(V.y-C.y),J=C.x+D*(V.x-C.x),J<=this._xmin?ht=!1:J>=this._xmax?ht=!0:L.push(new K(D,J,this._ymax))),0===L.length)this._lineTo(ht?this._xmax:this._xmin,et?this._ymax:this._ymin,!0);else if(L.length>1&&L[0].ratio>L[1].ratio)this._start=this._dist+A*L[1].ratio,this._lineTo(L[1].x,L[1].y,!0),this._lineTo(L[0].x,L[0].y,!0);else{this._start=this._dist+A*L[0].ratio;for(let E=0;E<L.length;E++)this._lineTo(L[E].x,L[E].y,!0)}this._lineTo(V.x,V.y,!1)}}this._dist+=A,this._prevIsIn=m,this._prevPt=g}close(){if(this._line.length>2){const o=this._firstPt,l=this._prevPt;o.x===l.x&&o.y===l.y||this.lineTo(o.x,o.y);const m=this._line;let g=m.length;for(;g>=4&&(m[0].x===m[1].x&&m[0].x===m[g-2].x||m[0].y===m[1].y&&m[0].y===m[g-2].y);)m.pop(),m[0].x=m[g-2].x,m[0].y=m[g-2].y,--g}}result(o=!0){return this._pushLine(),0===this._lines.length?null:(this._type===Z.Polygon&&o&&U.simplify(this._tileSize,this._margin*this._finalRatio,this._lines),this._lines)}resultWithStarts(){if(this._type!==Z.LineString)throw new Error("Only valid for lines");this._pushLine();const o=this._lines,l=o.length;if(0===l)return null;const m=[];for(let g=0;g<l;g++)m.push({line:o[g],start:this._starts[g]||0});return m}_isIn(o,l){return o>=this._xmin&&o<=this._xmax&&l>=this._ymin&&l<=this._ymax}_intersect(o,l){let m,g,A;if(l.x>=this._xmin&&l.x<=this._xmax)g=l.y<=this._ymin?this._ymin:this._ymax,A=(g-o.y)/(l.y-o.y),m=o.x+A*(l.x-o.x);else if(l.y>=this._ymin&&l.y<=this._ymax)m=l.x<=this._xmin?this._xmin:this._xmax,A=(m-o.x)/(l.x-o.x),g=o.y+A*(l.y-o.y);else{g=l.y<=this._ymin?this._ymin:this._ymax,m=l.x<=this._xmin?this._xmin:this._xmax;const T=(m-o.x)/(l.x-o.x),k=(g-o.y)/(l.y-o.y);T<k?(A=T,g=o.y+T*(l.y-o.y)):(A=k,m=o.x+k*(l.x-o.x))}return this._r=A,new G(m,g)}_pushLine(){this._line&&(this._type===Z.Point?this._line.length>0&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===Z.LineString?this._line.length>1&&(this._lines.push(this._line),this._starts.push(this._start)):this._type===Z.Polygon&&this._line.length>3&&(this._lines.push(this._line),this._starts.push(this._start))),this._line=[],this._start=0}_moveTo(o,l,m){this._type!==Z.Polygon?m&&(o=Math.round((o-(this._xmin+this._margin))*this._finalRatio),l=Math.round((l-(this._ymin+this._margin))*this._finalRatio),this._line.push(new G(o,l))):(m||(o<this._xmin&&(o=this._xmin),o>this._xmax&&(o=this._xmax),l<this._ymin&&(l=this._ymin),l>this._ymax&&(l=this._ymax)),o=Math.round((o-(this._xmin+this._margin))*this._finalRatio),l=Math.round((l-(this._ymin+this._margin))*this._finalRatio),this._line.push(new G(o,l)),this._isH=!1,this._isV=!1)}_lineTo(o,l,m){let g,A;if(this._type!==Z.Polygon)if(m){if(o=Math.round((o-(this._xmin+this._margin))*this._finalRatio),l=Math.round((l-(this._ymin+this._margin))*this._finalRatio),this._line.length>0&&(g=this._line[this._line.length-1],g.equals(o,l)))return;this._line.push(new G(o,l))}else this._line&&this._line.length>0&&this._pushLine();else if(m||(o<this._xmin&&(o=this._xmin),o>this._xmax&&(o=this._xmax),l<this._ymin&&(l=this._ymin),l>this._ymax&&(l=this._ymax)),o=Math.round((o-(this._xmin+this._margin))*this._finalRatio),l=Math.round((l-(this._ymin+this._margin))*this._finalRatio),this._line&&this._line.length>0){g=this._line[this._line.length-1];const T=g.x===o,k=g.y===l;if(T&&k)return;this._isH&&T||this._isV&&k?(g.x=o,g.y=l,A=this._line[this._line.length-2],A.x===o&&A.y===l?(this._line.pop(),this._line.length<=1?(this._isH=!1,this._isV=!1):(A=this._line[this._line.length-2],this._isH=A.x===o,this._isV=A.y===l)):(this._isH=A.x===o,this._isV=A.y===l)):(this._line.push(new G(o,l)),this._isH=T,this._isV=k)}else this._line.push(new G(o,l))}}class rt{setExtent(o){this._ratio=4096===o?1:4096/o}get validateTessellation(){return this._ratio<1}reset(o){this._lines=[],this._line=null}moveTo(o,l){this._line&&this._lines.push(this._line),this._line=[];const m=this._ratio;this._line.push(new G(o*m,l*m))}lineTo(o,l){const m=this._ratio;this._line.push(new G(o*m,l*m))}close(){const o=this._line;o&&!o[0].isEqual(o[o.length-1])&&o.push(o[0])}result(){return this._line&&this._lines.push(this._line),0===this._lines.length?null:this._lines}}!function(f){f[f.sideLeft=0]="sideLeft",f[f.sideRight=1]="sideRight",f[f.sideTop=2]="sideTop",f[f.sideBottom=3]="sideBottom"}(W||(W={}));class U{static simplify(o,l,m){if(!m)return;const g=-l,A=o+l,T=-l,k=o+l,O=[],D=[],ht=m.length;for(let J=0;J<ht;++J){const X=m[J];if(!X||X.length<2)continue;let C,V=X[0];const L=X.length;for(let E=1;E<L;++E)C=X[E],V.x===C.x&&(V.x<=g&&(V.y>C.y?(O.push(J),O.push(E),O.push(W.sideLeft),O.push(-1)):(D.push(J),D.push(E),D.push(W.sideLeft),D.push(-1))),V.x>=A&&(V.y<C.y?(O.push(J),O.push(E),O.push(W.sideRight),O.push(-1)):(D.push(J),D.push(E),D.push(W.sideRight),D.push(-1)))),V.y===C.y&&(V.y<=T&&(V.x<C.x?(O.push(J),O.push(E),O.push(W.sideTop),O.push(-1)):(D.push(J),D.push(E),D.push(W.sideTop),D.push(-1))),V.y>=k&&(V.x>C.x?(O.push(J),O.push(E),O.push(W.sideBottom),O.push(-1)):(D.push(J),D.push(E),D.push(W.sideBottom),D.push(-1)))),V=C}if(0===O.length||0===D.length)return;U.fillParent(m,D,O),U.fillParent(m,O,D);const et=[];U.calcDeltas(et,D,O),U.calcDeltas(et,O,D),U.addDeltas(et,m)}static fillParent(o,l,m){const g=m.length,A=l.length;for(let T=0;T<A;T+=4){const k=l[T],O=l[T+1],D=l[T+2],ht=o[k][O-1],et=o[k][O];let J=8092,X=-1;for(let C=0;C<g;C+=4){if(m[C+2]!==D)continue;const V=m[C],L=m[C+1],E=o[V][L-1],tt=o[V][L];switch(D){case W.sideLeft:case W.sideRight:if(u(ht.y,E.y,tt.y)&&u(et.y,E.y,tt.y)){const M=Math.abs(tt.y-E.y);M<J&&(J=M,X=C)}break;case W.sideTop:case W.sideBottom:if(u(ht.x,E.x,tt.x)&&u(et.x,E.x,tt.x)){const M=Math.abs(tt.x-E.x);M<J&&(J=M,X=C)}}}l[T+3]=X}}static calcDeltas(o,l,m){const g=l.length;for(let A=0;A<g;A+=4){const k=U.calcDelta(A,l,m,[]);o.push(l[A]),o.push(l[A+1]),o.push(l[A+2]),o.push(k)}}static calcDelta(o,l,m,g){const A=l[o+3];if(-1===A)return 0;const T=g.length;return T>1&&g[T-2]===A?0:(g.push(A),U.calcDelta(A,m,l,g)+1)}static addDeltas(o,l){const m=o.length;let g=0;for(let A=0;A<m;A+=4){const T=o[A+3];T>g&&(g=T)}for(let A=0;A<m;A+=4){const T=l[o[A]],k=o[A+1],O=g-o[A+3];switch(o[A+2]){case W.sideLeft:T[k-1].x-=O,T[k].x-=O,1===k&&(T[T.length-1].x-=O),k===T.length-1&&(T[0].x-=O);break;case W.sideRight:T[k-1].x+=O,T[k].x+=O,1===k&&(T[T.length-1].x+=O),k===T.length-1&&(T[0].x+=O);break;case W.sideTop:T[k-1].y-=O,T[k].y-=O,1===k&&(T[T.length-1].y-=O),k===T.length-1&&(T[0].y-=O);break;case W.sideBottom:T[k-1].y+=O,T[k].y+=O,1===k&&(T[T.length-1].y+=O),k===T.length-1&&(T[0].y+=O)}}}}const u=(f,o,l)=>f>=o&&f<=l||f>=l&&f<=o},84289:(pt,it,y)=>{y.d(it,{$:()=>I,s:()=>Z});const I=15.5,Z=1024},4139:(pt,it,y)=>{y.d(it,{GW:()=>A,IU:()=>ht,Jo:()=>G,MG:()=>W,Wh:()=>f,cP:()=>C,os:()=>U,p6:()=>m,pJ:()=>K,ru:()=>J,s3:()=>et,w4:()=>X,wV:()=>l,yM:()=>V,z0:()=>o});var I=y(15268),Z=y(91766);const W=Number.POSITIVE_INFINITY,G=Math.PI,K=2*G,Y=128/G,rt=256/360,U=G/180,u=1/Math.LN2;function f(L,E){return(L%=E)>=0?L:L+E}function o(L){return f(L*Y,256)}function l(L){return f(L*rt,256)}function m(L){return Math.log(L)*u}function A(L,E,tt){return L*(1-tt)+E*tt}const k=8,O=14,D=16;function ht(L){return k+Math.max((L-O)*D,0)}function et(L,E,tt){let M,_,w,v=0;for(const P of tt){M=P.length;for(let R=1;R<M;++R)_=P[R-1],w=P[R],_.y>E!=w.y>E&&((w.x-_.x)*(E-_.y)-(w.y-_.y)*(L-_.x)>0?v++:v--)}return 0!==v}function J(L,E,tt,M){let _,w,v,P;const R=M*M;for(const F of tt){const j=F.length;if(!(j<2)){_=F[0].x,w=F[0].y;for(let Q=1;Q<j;++Q){if(v=F[Q].x,P=F[Q].y,(0,I.Ng)(L,E,_,w,v,P)<R)return!0;_=v,w=P}}}return!1}function X(L,E,tt,M,_,w,v){const P=Math.max(M,Math.min(E,w))-E,R=Math.max(_,Math.min(tt,v))-tt;return P*P+R*R<=L*L}function C(L,E){if(0===E||Number.isNaN(E))return L;const tt=[],M=new Z.bR(0,0),_=new Z.bR(0,0),w=new Z.bR(0,0);for(let v=0;v<L.length;v++){const P=L[v],R=[];for(let F=0;F<P.length;F++){const j=P[F-1],Q=P[F],at=P[F+1];0===F?M.setCoords(0,0):M.assignSub(Q,j).normalize().rightPerpendicular(),F===P.length-1?_.setCoords(0,0):_.assignSub(at,Q).normalize().rightPerpendicular(),w.assignAdd(M,_).normalize();const st=w.x*_.x+w.y*_.y;0!==st&&w.scale(1/st),R.push(Z.bR.add(Q,w.scale(E)))}tt.push(R)}return tt}function V(L,E,tt,M){const _=new Z.bR(L[0],L[1]);if(_.scale(M),"viewport"===E){const w=-tt*(Math.PI/180),v=Math.cos(w),P=Math.sin(w);_.rotate(v,P)}return _}},68973:(pt,it,y)=>{y.d(it,{A:()=>I});class I{constructor(W=0,G=0,K=0,Y=0){this.x=W,this.y=G,this.width=K,this.height=Y}get isEmpty(){return this.width<=0||this.height<=0}union(W){this.x=Math.min(this.x,W.x),this.y=Math.min(this.y,W.y),this.width=Math.max(this.width,W.width),this.height=Math.max(this.height,W.height)}}},37188:(pt,it,y)=>{y.d(it,{A:()=>rt});var I=y(3248),Z=y(69473),W=y(54382),G=y(89298),K=y(99065);const Y=(U,u)=>U.key.level-u.key.level!=0?U.key.level-u.key.level:U.key.row-u.key.row!=0?U.key.row-u.key.row:U.key.col-u.key.col;class rt extends W.A{constructor(u){super(),this._tileInfoView=u}renderChildren(u){this.sortChildren(Y),this.setStencilReference(u),super.renderChildren(u)}createRenderParams(u){const{state:f}=u,o=super.createRenderParams(u);return o.requiredLevel=this._tileInfoView.getClosestInfoForScale(f.scale).level,o.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(f.scale),o}prepareRenderPasses(u){const f=super.prepareRenderPasses(u);return f.push(u.registerRenderPass({name:"stencil",brushes:[G.A],drawPhase:Z.S5.DEBUG|Z.S5.MAP|Z.S5.HIGHLIGHT|Z.S5.LABEL,target:()=>this.getStencilTarget()})),(0,I.A)("esri-tiles-debug")&&f.push(u.registerRenderPass({name:"tileInfo",brushes:[K.A],drawPhase:Z.S5.DEBUG,target:()=>this.children})),f}getStencilTarget(){return this.children}setStencilReference(u){let f=1;for(const o of this.children)o.stencilRef=f++}}},29459:(pt,it,y)=>{y.d(it,{e:()=>J});var g,I=y(8189),Z=y(31178),W=y(5605),G=y(5922),K=y(48900),Y=y(85211),f=(y(3248),y(35150),y(40707),y(76576)),o=y(88766),l=y(60746),m=y(66727);let A=g=class extends m.A{constructor(X){super(X),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new g({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}commitVersionProperties(){this.commitProperty("left"),this.commitProperty("right"),this.commitProperty("top"),this.commitProperty("bottom")}};(0,I._)([(0,Y.MZ)({type:[Number,String],json:{write:!0}})],A.prototype,"left",void 0),(0,I._)([(0,Y.MZ)({type:[Number,String],json:{write:!0}})],A.prototype,"right",void 0),(0,I._)([(0,Y.MZ)({type:[Number,String],json:{write:!0}})],A.prototype,"top",void 0),(0,I._)([(0,Y.MZ)({type:[Number,String],json:{write:!0}})],A.prototype,"bottom",void 0),A=g=(0,I._)([(0,f.$)("esri.views.layers.support.ClipRect")],A);const T=A;var k=y(75644);let O=class extends m.A{constructor(X){super(X),this.type="path",this.path=[]}commitVersionProperties(){this.commitProperty("path")}};(0,I._)([(0,Y.MZ)({type:[[[Number]]],json:{write:!0}})],O.prototype,"path",void 0),O=(0,I._)([(0,f.$)("esri.views.layers.support.Path")],O);const D=O;var ht=y(6558);const et=Z.A.ofType({key:"type",base:null,typeMap:{rect:T,path:D,geometry:k.A}}),J=X=>{let C=class extends X{constructor(){super(...arguments),this.attached=!1,this.clips=new et,this.highlightOptions=null,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1,this._visibleAtCurrentScale=!0}initialize(){const V=this.view?.spatialReferenceLocked??!0;this.view?.spatialReference&&V&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new G.A("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new o.m),this.container.fadeTransitionEnabled=!0,this.container.visible=!1,this.container.endTransitions(),this.addHandles([(0,K.wB)(()=>this.suspended,E=>{this.container&&(this.container.visible=!E)},K.pc),(0,K.wB)(()=>this.updateSuspended,E=>{this.view&&!E&&this.updateRequested&&this.view.requestUpdate()},K.pc),(0,K.wB)(()=>this.layer?.opacity??1,E=>{this.container&&(this.container.opacity=E)},K.pc),(0,K.wB)(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",E=>{this.container&&(this.container.blendMode=E)},K.pc),(0,K.wB)(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,E=>{this.container&&(this.container.effect=E)},K.pc),(0,K.wB)(()=>this.highlightOptions,E=>this.container.highlightOptions=E,K.pc),(0,K.on)(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)},K.pc),(0,K.wB)(()=>({scale:this.view?.scale,scaleRange:this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null}),({scale:E,scaleRange:tt})=>{const M=(0,ht.E5)(tt,E);M!==this._visibleAtCurrentScale&&(this._visibleAtCurrentScale=M)},K.pc)],"constructor"),this.view?.whenLayerView?this.view.whenLayerView(this.layer).then(E=>{E===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get spatialReferenceSupported(){const V=this.view?.spatialReference;return null==V||this.supportsSpatialReference(V)}get updating(){return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!!this._updatingHandles?.updating)}get visibleAtCurrentScale(){return this._visibleAtCurrentScale}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.removeHandles("attach"),this.detach(),this.updateRequested=!1)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.updateSuspended||this.view.requestUpdate())}processUpdate(V){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",V),this.updateRequested&&!this.updateSuspended&&(this.updateRequested=!1,this.update(V))):this.updateRequested=!1}hitTest(V,L){return Promise.resolve(null)}supportsSpatialReference(V){return!0}canResume(){return!!this.spatialReferenceSupported&&!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const V=super.getSuspendInfo(),L=!this.spatialReferenceSupported;return L&&(V.spatialReferenceNotSupported=L),V}addAttachHandles(V){this.addHandles(V,"attach")}};return(0,I._)([(0,Y.MZ)()],C.prototype,"attached",void 0),(0,I._)([(0,Y.MZ)({type:et,set(V){const L=(0,W.V)(V,this._get("clips"),et);this._set("clips",L)}})],C.prototype,"clips",void 0),(0,I._)([(0,Y.MZ)()],C.prototype,"container",void 0),(0,I._)([(0,Y.MZ)({type:l.A})],C.prototype,"highlightOptions",void 0),(0,I._)([(0,Y.MZ)()],C.prototype,"moving",void 0),(0,I._)([(0,Y.MZ)({readOnly:!0})],C.prototype,"spatialReferenceSupported",null),(0,I._)([(0,Y.MZ)({readOnly:!0})],C.prototype,"updateParameters",void 0),(0,I._)([(0,Y.MZ)()],C.prototype,"updateRequested",void 0),(0,I._)([(0,Y.MZ)()],C.prototype,"updating",null),(0,I._)([(0,Y.MZ)()],C.prototype,"view",void 0),(0,I._)([(0,Y.MZ)()],C.prototype,"_visibleAtCurrentScale",void 0),(0,I._)([(0,Y.MZ)({readOnly:!0})],C.prototype,"visibleAtCurrentScale",null),C=(0,I._)([(0,f.$)("esri.views.2d.layers.LayerView2D")],C),C}},90143:(pt,it,y)=>{y.r(it),y.d(it,{default:()=>Be});var I=y(10467),Z=y(8189),W=y(77806),G=y(35150),K=y(11432),Y=y(56492),rt=y(85211),u=(y(3248),y(76576)),f=y(48237),o=y(1749),l=y(51995),m=y(58701),g=y(20904),A=y(45272),T=y(19284),k=y(68973);class O{constructor(t,e){this._width=0,this._height=0,this._free=[],this._width=t,this._height=e,this._free.push(new k.A(0,0,t,e))}get width(){return this._width}get height(){return this._height}allocate(t,e){if(t>this._width||e>this._height)return new k.A;let s=null,i=-1;for(let r=0;r<this._free.length;++r){const n=this._free[r];t<=n.width&&e<=n.height&&(null===s||n.y<=s.y&&n.x<=s.x)&&(s=n,i=r)}return null===s?new k.A:(this._free.splice(i,1),s.width<s.height?(s.width>t&&this._free.push(new k.A(s.x+t,s.y,s.width-t,e)),s.height>e&&this._free.push(new k.A(s.x,s.y+e,s.width,s.height-e))):(s.width>t&&this._free.push(new k.A(s.x+t,s.y,s.width-t,s.height)),s.height>e&&this._free.push(new k.A(s.x,s.y+e,t,s.height-e))),new k.A(s.x,s.y,t,e))}release(t){for(let e=0;e<this._free.length;++e){const s=this._free[e];if(s.y===t.y&&s.height===t.height&&s.x+s.width===t.x)s.width+=t.width;else if(s.x===t.x&&s.width===t.width&&s.y+s.height===t.y)s.height+=t.height;else if(t.y===s.y&&t.height===s.height&&t.x+t.width===s.x)s.x=t.x,s.width+=t.width;else{if(t.x!==s.x||t.width!==s.width||t.y+t.height!==s.y)continue;s.y=t.y,s.height+=t.height}this._free.splice(e,1),this.release(t)}this._free.push(t)}}var D=y(50915),ht=y(26136),et=y(4931);class J{constructor(t,e,s){this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphIndex={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=e,this._glyphSource=s,this._binPack=new O(t-4,e-4),this._glyphData.push(new Uint8Array(t*e)),this._dirties.push(!0),this._textures.push(void 0)}getGlyphItems(t,e){const s=[],i=this._glyphSource,r=new Set,n=1/256;for(const c of e){const d=Math.floor(c*n);r.add(d)}const a=[];return r.forEach(c=>{const d=t+c;if(this._rangePromises.has(d))a.push(this._rangePromises.get(d));else{const p=i.getRange(t,c).then(()=>{this._rangePromises.delete(d)},()=>{this._rangePromises.delete(d)});this._rangePromises.set(d,p),a.push(p)}}),Promise.all(a).then(()=>{let c=this._glyphIndex[t];c||(c={},this._glyphIndex[t]=c);for(const d of e){const p=c[d];if(p){s[d]={sdf:!0,rect:p.rect,metrics:p.metrics,page:p.page,code:d};continue}const S=i.getGlyph(t,d);if(!S?.metrics)continue;const b=S.metrics;let x;if(0===b.width)x=new k.A(0,0,0,0);else{const z=b.width+6,N=b.height+6;let H=z%4?4-z%4:4,$=N%4?4-N%4:4;1===H&&(H=5),1===$&&($=5),x=this._binPack.allocate(z+H,N+$),x.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(void 0),this._binPack=new O(this.width-4,this.height-4),x=this._binPack.allocate(z+H,N+$));const q=this._glyphData[this._currentPage],lt=S.bitmap;let _t,ot;if(lt)for(let ct=0;ct<N;ct++){_t=z*ct,ot=this.width*(x.y+ct+1)+x.x;for(let ft=0;ft<z;ft++)q[ot+ft+1]=lt.at(_t+ft)}}c[d]={rect:x,metrics:b,tileIDs:null,page:this._currentPage},s[d]={sdf:!0,rect:x,metrics:b,page:this._currentPage,code:d},this._dirties[this._currentPage]=!0}return s})}removeGlyphs(t){for(const e in this._glyphIndex){const s=this._glyphIndex[e];if(!s)continue;let i;for(const r in s)if(i=s[r],i.tileIDs.delete(t),0===i.tileIDs.size){const n=this._glyphData[i.page],a=i.rect;let c,d;for(let p=0;p<a.height;p++)for(c=this.width*(a.y+p)+a.x,d=0;d<a.width;d++)n[c+d]=0;delete s[r],this._dirties[i.page]=!0}}}bind(t,e,s,i=0){if(!this._textures[s]){const n=new et.R;n.pixelFormat=D.Ab.ALPHA,n.wrapMode=D.pF.CLAMP_TO_EDGE,n.width=this.width,n.height=this.height,this._textures[s]=new ht.g(t,n,new Uint8Array(this.width*this.height))}const r=this._textures[s];r.setSamplingMode(e),this._dirties[s]&&r.setData(this._glyphData[s]),t.bindTexture(r,i),this._dirties[s]=!1}destroy(){this.dispose()}dispose(){this._glyphData.length=0,this._binPack=null;for(const t of this._textures)t&&t.dispose();this._textures.length=0}}var X=y(89563),C=y(55912);class V{constructor(t){if(this._metrics=[],!t)return void(this._allBitmaps=null);const e=new Map;let s=0;for(;t.next();)switch(t.tag()){case 1:{const n=t.getMessage();for(;n.next();)switch(n.tag()){case 3:{const a=n.getMessage();let c,d,p,S,b,x,B;for(;a.next();)switch(a.tag()){case 1:c=a.getUInt32();break;case 2:d=a.getBytes();break;case 3:p=a.getUInt32();break;case 4:S=a.getUInt32();break;case 5:b=a.getSInt32();break;case 6:x=a.getSInt32();break;case 7:B=a.getUInt32();break;default:a.skip()}if(a.release(),c){const z=d?.length??0;this._metrics[c]={width:p,height:S,left:b,top:x,advance:B,startOffset:s,length:z},e.set(c,d),s+=z}break}default:n.skip()}n.release();break}default:t.skip()}const i=new Uint8Array(s),r=this._metrics;for(const[n,a]of e){const{startOffset:c,length:d}=r[n];if(a)for(let p=0;p<d;++p)i[c+p]=a[p]}this._allBitmaps=i}getMetrics(t){return this._metrics[t]}getBitmap(t){if(!this._allBitmaps)return;const e=this._metrics[t];if(void 0===e)return;const{startOffset:s,length:i}=e;return 0!==i?new tt(this._allBitmaps,s,i):void 0}}class L{constructor(){this._ranges=[]}get ranges(){return this._ranges}getRange(t){return this._ranges[t]}addRange(t,e){this._ranges[t]=e}}class E{constructor(t){this._glyphInfo={},this._baseURL=t}getRange(t,e){const s=this._getFontStack(t);if(s.getRange(e))return Promise.resolve();const i=256*e,r=i+255;if(this._baseURL){const n=this._baseURL.replace("{fontstack}",t).replace("{range}",i+"-"+r);return(0,X.A)(n,{responseType:"array-buffer"}).then(a=>{s.addRange(e,new V(new C.A(new Uint8Array(a.data),new DataView(a.data))))}).catch(()=>{s.addRange(e,new V)})}return s.addRange(e,new V),Promise.resolve()}getGlyph(t,e){const s=this._getFontStack(t);if(!s)return;const i=Math.floor(e/256),r=s.getRange(i);return r?{metrics:r.getMetrics(e),bitmap:r.getBitmap(e)}:void 0}_getFontStack(t){let e=this._glyphInfo[t];return e||(e=this._glyphInfo[t]=new L),e}}class tt{constructor(t,e,s){this._array=t,this._start=e,this.length=s}at(t){return 0<=t&&t<this.length?this._array[this._start+t]:void 0}}var M=y(28685);class w{constructor(t,e,s=0){this._size=[],this._mosaicsData=[],this._textures=[],this._dirties=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects={},this.pixelRatio=1,e<=0&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=t,this._pageHeight=e,s>0&&(this._maxItemSize=s),this._binPack=new O(t-4,e-4)}destroy(){this.dispose()}dispose(){this._binPack=null,this._mosaicsData.length=0,this._mosaicRects={};for(const t of this._textures)t&&t.dispose();this._textures.length=0}getWidth(t){return t>=this._size.length?-1:this._size[t][0]}getHeight(t){return t>=this._size.length?-1:this._size[t][1]}getPageSize(t){return t>=this._size.length?null:this._size[t]}setSpriteSource(t){if(this.dispose(),this.pixelRatio=t.devicePixelRatio,0===this._mosaicsData.length){this._binPack=new O(this._pageWidth-4,this._pageHeight-4);const e=Math.floor(this._pageWidth),s=Math.floor(this._pageHeight),i=new Uint32Array(e*s);this._mosaicsData[0]=i,this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0)}this._sprites=t}getSpriteItem(t,e=!1){let s,i,r=this._mosaicRects[t];if(r)return r;if(!this._sprites||"loaded"!==this._sprites.loadStatus||(t&&t.startsWith("dasharray-")?([s,i]=this._rasterizeDash(t),e=!0):s=this._sprites.getSpriteInfo(t),!s?.width||!s.height||s.width<0||s.height<0))return null;const n=s.width,a=s.height,[c,d,p]=this._allocateImage(n,a);return c.width<=0?null:(this._copy(c,s,d,p,e,i),r={type:"sprite",rect:c,width:n,height:a,sdf:s.sdf,simplePattern:!1,rasterizationScale:s.pixelRatio,page:d},this._mosaicRects[t]=r,r)}getSpriteItems(t){const e={};for(const s of t)e[s.name]=this.getSpriteItem(s.name,s.repeat);return e}getMosaicItemPosition(t,e){const s=this.getSpriteItem(t,e),i=s?.rect;return i?(i.width=s.width,i.height=s.height,{tl:[i.x+2,i.y+2],br:[i.x+2+s.width,i.y+2+s.height],page:s.page}):null}bind(t,e,s=0,i=0){if(s>=this._size.length||s>=this._mosaicsData.length)return;if(!this._textures[s]){const n=new et.R;n.wrapMode=D.pF.CLAMP_TO_EDGE,n.width=this._size[s][0],n.height=this._size[s][1],this._textures[s]=new ht.g(t,n,new Uint8Array(this._mosaicsData[s].buffer))}const r=this._textures[s];r.setSamplingMode(e),this._dirties[s]&&r.setData(new Uint8Array(this._mosaicsData[s].buffer)),t.bindTexture(r,i),this._dirties[s]=!1}static _copyBits(t,e,s,i,r,n,a,c,d,p,S){let b=i*e+s,x=c*n+a;if(S){x-=n;for(let B=-1;B<=p;B++,b=((B+p)%p+i)*e+s,x+=n)for(let z=-1;z<=d;z++)r[x+z]=t[b+(z+d)%d]}else for(let B=0;B<p;B++){for(let z=0;z<d;z++)r[x+z]=t[b+z];b+=e,x+=n}}_copy(t,e,s,i,r,n){if(!this._sprites||"loaded"!==this._sprites.loadStatus||s>=this._mosaicsData.length)return;const a=new Uint32Array(n?n.buffer:this._sprites.image.buffer);w._copyBits(a,n?e.width:this._sprites.width,e.x,e.y,this._mosaicsData[s],i[0],t.x+2,t.y+2,e.width,e.height,r),this._dirties[s]=!0}_allocateImage(t,e){t+=2,e+=2;const s=Math.max(t,e);if(this._maxItemSize&&this._maxItemSize<s){const a=new k.A(0,0,t,e);return this._mosaicsData.push(new Uint32Array(t*e)),this._dirties.push(!0),this._size.push([t,e]),this._textures.push(void 0),[a,this._mosaicsData.length-1,[t,e]]}let i=t%4?4-t%4:4,r=e%4?4-e%4:4;1===i&&(i=5),1===r&&(r=5);const n=this._binPack.allocate(t+i,e+r);return n.width<=0?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new O(this._pageWidth-4,this._pageHeight-4),this._allocateImage(t,e)):[n,this._currentPage,[this._pageWidth,this._pageHeight]]}_rasterizeDash(t){const s=t.match(/\[(.*?)\]/);if(!s)return null;const i=s[1].split(",").map(Number),r=t.slice(t.lastIndexOf("-")+1),[n,a,c]=(0,M.k)(i,r);return[{x:0,y:0,width:a,height:c,sdf:!0,pixelRatio:1},new Uint8Array(n.buffer)]}}var v=y(74847);class P{constructor(t,e,s,i){this._layer=t,this._styleRepository=e,this.devicePixelRatio=s,this._sourceDataMaxLOD=i,this._spriteMosaic=null,this._glyphMosaic=null,this._connection=null,this._spriteSourceAbortController=null,this._startOptionsInputSignal=null,this._inputSignalEventListener=null}destroy(){this._connection?.close(),this._connection=null,this._styleRepository=null,this._layer=null,this._spriteMosaic?.destroy(),this._spriteMosaic=null,this._glyphMosaic=null,this._spriteSourceAbortController=(0,K.DC)(this._spriteSourceAbortController),this._spriteSourcePromise=null,this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,this._inputSignalEventListener=null}get spriteMosaic(){return this._spriteSourcePromise.then(()=>this._spriteMosaic)}get glyphMosaic(){return this._glyphMosaic}start(t){var e=this;return(0,I.A)(function*(){e._requestSprite(t);const s=e._layer.currentStyleInfo.glyphsUrl,i=new E(s?(0,A.a6)(s,{...e._layer.customParameters,token:e._layer.apiKey}):null);e._glyphMosaic=new J(1024,1024,i),e._broadcastPromise=(0,T.ho)("WorkerTileHandler",{client:e,schedule:t.schedule,signal:t.signal}).then(r=>{if(e._layer&&(e._connection?.close(),e._connection=r,e._layer&&!e._connection.closed)){const n=r.broadcast("setStyle",{style:e._layer.currentStyleInfo.style,sourceDataMaxLOD:e._sourceDataMaxLOD},t);Promise.all(n).catch(a=>(0,Y.jH)(a))}})})()}_requestSprite(t){this._spriteSourceAbortController?.abort();const e=new AbortController;this._spriteSourceAbortController=e;const s=t?.signal;this._inputSignalEventListener&&this._startOptionsInputSignal?.removeEventListener("abort",this._inputSignalEventListener),this._startOptionsInputSignal=null,s&&(this._inputSignalEventListener=function R(h){return()=>h.abort()}(e),s.addEventListener("abort",this._inputSignalEventListener,{once:!0}));const{signal:i}=e,r={...t,signal:i};this._spriteSourcePromise=this._layer.loadSpriteSource(this.devicePixelRatio,r),this._spriteSourcePromise.then(n=>{(0,Y.QP)(i),this._spriteMosaic=new w(1024,1024,250),this._spriteMosaic.setSpriteSource(n)})}updateStyle(t){var e=this;return(0,I.A)(function*(){return yield e._broadcastPromise,e._broadcastPromise=Promise.all(e._connection.broadcast("updateStyle",t)),e._broadcastPromise})()}setSpriteSource(t){const e=new w(1024,1024,250);return e.setSpriteSource(t),this._spriteMosaic=e,this._spriteSourcePromise=Promise.resolve(t),this._spriteSourceAbortController=null,e}setStyle(t,e,s){var i=this;return(0,I.A)(function*(){yield i._broadcastPromise,i._styleRepository=t,i._sourceDataMaxLOD=s,i._requestSprite();const r=new E(i._layer.currentStyleInfo.glyphsUrl?(0,A.a6)(i._layer.currentStyleInfo.glyphsUrl,{...i._layer.customParameters,token:i._layer.apiKey}):null);return i._glyphMosaic=new J(1024,1024,r),i._broadcastPromise=Promise.all(i._connection.broadcast("setStyle",{style:e,sourceDataMaxLOD:i._sourceDataMaxLOD})),i._broadcastPromise})()}fetchTileData(t,e){var s=this;return(0,I.A)(function*(){const i=yield s._getRefKeys(t,e);return s._getSourcesData(Object.keys(s._layer.sourceNameToSource),i,e)})()}fetchTilePBFs(t){var e=this;return(0,I.A)(function*(){const s=Object.keys(e._layer.sourceNameToSource),i={},r=yield e._getRefKeys(t,i),n=[],a=[];for(let c=0;c<r.length;c++)if(null==r[c].value||null==s[c])a.push(null);else{const d=r[c].value,p=e._getTilePayload(d,s[c],i);p.then(S=>{n.push({...S,key:d})}),a.push(p)}return Promise.all(a).then(()=>n)})()}parseTileData(t,e){var s=this;return(0,I.A)(function*(){const i=t&&t.data;if(!i)return null;const{sourceName2DataAndRefKey:r,transferList:n}=i;return 0===Object.keys(r).length?null:s._broadcastPromise.then(()=>s._connection.invoke("createTileAndParse",{key:t.key.id,sourceName2DataAndRefKey:r,styleLayerUIDs:t.styleLayerUIDs},{...e,transferList:n}))})()}getSprites(t){var e=this;return(0,I.A)(function*(){return yield e._spriteSourcePromise,e._spriteMosaic.getSpriteItems(t)})()}getGlyphs(t){return this._glyphMosaic.getGlyphItems(t.font,t.codePoints)}_getTilePayload(t,e,s){var i=this;return(0,I.A)(function*(){const r=v.A.pool.acquire(t.id),n=i._layer.sourceNameToSource[e],{level:a,row:c,col:d}=r;v.A.pool.release(r);try{return{protobuff:yield n.requestTile(a,c,d,s),sourceName:e}}catch(p){if((0,Y.zf)(p))throw p;return{protobuff:null,sourceName:e}}})()}_getRefKeys(t,e){var s=this;return(0,I.A)(function*(){const i=s._layer.sourceNameToSource,r=new Array;for(const n in i){const a=i[n].getRefKey(t,e);r.push(a)}return(0,Y.Lx)(r)})()}_getSourcesData(t,e,s){const i=[];for(let r=0;r<e.length;r++)if(null==e[r].value||null==t[r])i.push(null);else{const a=this._getTilePayload(e[r].value,t[r],s);i.push(a)}return(0,Y.Lx)(i).then(r=>{const n={},a=[];for(let c=0;c<r.length;c++){const d=r[c].value;d&&d.protobuff&&d.protobuff.byteLength>0&&(n[d.sourceName]={refKey:e[c].value.id,protobuff:d.protobuff},a.push(d.protobuff))}return{sourceName2DataAndRefKey:n,transferList:a}})}}var F=y(33087),j=y(75324);const st=(h,t)=>h+1/(1<<2*t);class ut{constructor(t,e){this._tiles=new Map,this._tileCache=new F.q(40,s=>s.dispose()),this._viewSize=[0,0],this._visibleTiles=new Map,this.acquireTile=t.acquireTile,this.releaseTile=t.releaseTile,this.tileInfoView=t.tileInfoView,this._container=e}destroy(){for(const[t,e]of this._tiles)e.dispose();this._tiles=null,this._tileCache.clear(),this._tileCache=null}update(t){this._updateCacheSize(t);const e=this.tileInfoView,s=e.getTileCoverage(t.state,0,!0,"smallest");if(!s)return!0;const{spans:i,lodInfo:r}=s,{level:n}=r,a=this._tiles,c=new Set,d=new Set;for(const{row:S,colFrom:b,colTo:x}of i)for(let B=b;B<=x;B++){const z=v.A.getId(n,S,r.normalizeCol(B),r.getWorldForColumn(B)),N=this._getOrAcquireTile(z);c.add(z),N.processed()?this._addToContainer(N):d.add(new v.A(z))}for(const[S,b]of a)b.isCoverage=c.has(S);for(const S of d)this._findPlaceholdersForMissingTiles(S,c);let p=!1;for(const[S,b]of a)b.neededForCoverage=c.has(S),b.neededForCoverage||b.isHoldingForFade&&e.intersects(s,b.key)&&c.add(S),b.isFading&&(p=!0);for(const[S,b]of this._tiles)c.has(S)||this._releaseTile(S);return j.A.pool.release(s),!p}clear(){this._tiles.clear(),this._tileCache.clear(),this._visibleTiles.clear()}clearCache(){this._tileCache.clear()}getIntersectingTiles(t,e,s,i,r){const n=[0,0],a=[0,0];i.toMap(n,t-s,e+s),i.toMap(a,t+s,e-s);const c=Math.min(n[0],a[0]),d=Math.min(n[1],a[1]),p=Math.max(n[0],a[0]),S=Math.max(n[1],a[1]),b=(0,l.fA)(c,d,p,S),x=(0,l.vt)(),B=[];for(const[z,N]of this._visibleTiles)this.tileInfoView.getTileBounds(x,N.key),(0,l.HY)(b,x)&&B.push(N);if(null!=r&&r.length>0){const z=new Set(B.map(H=>H.id)),N=r.filter(H=>!z.has(H.tileKey.id)).map(H=>this._visibleTiles.get(H.tileKey.id)).filter(H=>void 0!==H);B.push(...N)}return B}_findPlaceholdersForMissingTiles(t,e){const s=[];for(const[r,n]of this._tiles)this._addPlaceholderChild(s,n,t,e);const i=s.reduce(st,0);Math.abs(1-i)<1e-6||this._addPlaceholderParent(t.id,e)}_addPlaceholderChild(t,e,s,i){e.key.level<=s.level||!e.hasData()||function Dt(h,t){const e=t.level-h.level;return h.row===t.row>>e&&h.col===t.col>>e&&h.world===t.world}(s,e.key)&&(this._addToContainer(e),i.add(e.id),t.push(e.key.level-s.level))}_addPlaceholderParent(t,e){const s=this._tiles;let i=t;for(;;){if(i=gt(i),!i||e.has(i))return;const r=s.get(i);if(r?.hasData())return this._addToContainer(r),void e.add(r.id)}}_getOrAcquireTile(t){let e=this._tiles.get(t);return e||(e=this._tileCache.pop(t),e||(e=this.acquireTile(new v.A(t))),this._tiles.set(t,e),e)}_releaseTile(t){const e=this._tiles.get(t);this.releaseTile(e),this._removeFromContainer(e),this._tiles.delete(t),e.hasData()?this._tileCache.put(t,e,1):e.dispose()}_addToContainer(t){let e;const s=[],i=this._container;if(i.contains(t))return;const r=this._visibleTiles;for(const[n,a]of r)this._canConnectDirectly(t,a)&&s.push(a),null==e&&this._canConnectDirectly(a,t)&&(e=a);if(null!=e){for(const n of s)e.childrenTiles.delete(n),t.childrenTiles.add(n),n.parentTile=t;e.childrenTiles.add(t),t.parentTile=e}else for(const n of s)t.childrenTiles.add(n),n.parentTile=t;r.set(t.id,t),i.addChild(t)}_removeFromContainer(t){if(this._visibleTiles.delete(t.id),this._container.removeChild(t),null!=t.parentTile){t.parentTile.childrenTiles.delete(t);for(const e of t.childrenTiles)null!=t.parentTile&&t.parentTile.childrenTiles.add(e)}for(const e of t.childrenTiles)e.parentTile=t.parentTile;t.parentTile=null,t.childrenTiles.clear()}_canConnectDirectly(t,e){const s=t.key;let{level:i,row:r,col:n,world:a}=e.key;const c=this._visibleTiles;for(;i>0;){if(i--,r>>=1,n>>=1,s.level===i&&s.row===r&&s.col===n&&s.world===a)return!0;if(c.has(`${i}/${r}/${n}/${a}`))return!1}return!1}_updateCacheSize(t){const e=t.state.size;if(e[0]===this._viewSize[0]&&e[1]===this._viewSize[1])return;const s=Math.ceil(e[0]/512)+1,i=Math.ceil(e[1]/512)+1;this._viewSize[0]=e[0],this._viewSize[1]=e[1],this._tileCache.maxSize=5*s*i}}function gt(h){const[t,e,s,i]=h.split("/"),r=parseInt(t,10);return 0===r?null:`${r-1}/${parseInt(e,10)>>1}/${parseInt(s,10)>>1}/${parseInt(i,10)}`}var bt=y(31610),mt=y(12273),Lt=y(79139),qt=y(54290),Et=y(67347),Ot=(y(77031),y(4139));class te{constructor(t,e){this.sourceTile=e,this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.featureIndex=0,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t}}class ee{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function Ut(h,t,e,s,i,r){const n=e-i;if(n>=0)return(t>>n)+(s-(r<<n))*(h>>n);const a=-n;return t-(r-(s<<a))*(h>>a)<<a}class Bt{constructor(t,e,s){this._rows=Math.ceil(e/s),this._columns=Math.ceil(t/s),this._cellSize=s,this.cells=new Array(this._rows);for(let i=0;i<this._rows;i++){this.cells[i]=new Array(this._columns);for(let r=0;r<this._columns;r++)this.cells[i][r]=[]}}getCell(t,e){const s=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._rows-1),i=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._columns-1);return this.cells[s]&&this.cells[s][i]||null}getCellSpan(t,e,s,i){return[Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(e/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function re(h,t,e,s,i){const r=h.layerData.get(i);if(r.type===g.NP.SYMBOL){for(const n of s){const a=n.unique;let c;if(n.selectedForRendering){const d=a.parts[0],p=d.startOpacity,S=d.targetOpacity;h.allSymbolsFadingOut=h.allSymbolsFadingOut&&0===S;const b=e?Math.floor(127*p)|S<<7:S?255:0;c=b<<24|b<<16|b<<8|b}else c=0;for(const[d,p]of n.iconVertexRanges)for(let S=d;S<d+p;S+=4)r.iconOpacity[S/4]=c;if(n.selectedForRendering){const d=a.parts[1],p=d.startOpacity,S=d.targetOpacity;h.allSymbolsFadingOut=h.allSymbolsFadingOut&&0===S;const b=e?Math.floor(127*p)|S<<7:S?255:0;c=b<<24|b<<16|b<<8|b}else c=0;for(const[d,p]of n.textVertexRanges)for(let S=d;S<d+p;S+=4)r.textOpacity[S/4]=c}r.lastOpacityUpdate=t,r.opacityChanged=!0}}function ne(h,t,e,s){const i=h.colliders;let r,n,a,c;for(const d of i)if(h.unique.show&&h.unique.parts[d.partIndex].show&&(r=d.xScreen-s[0]+d.dxScreen,n=d.yScreen-s[1]+d.dyScreen,a=r+d.width,c=n+d.height,(0,Ot.w4)(e,t.x,t.y,r,n,a,c)))return!0;return!1}var dt=y(32788),xt=y(45513);class wt{constructor(t,e){this.layerUIDs=[],this.isDestroyed=!1,this._data=t;let s=1;const i=new Uint32Array(t);this.layerUIDs=[];const r=i[s++];for(let n=0;n<r;n++)this.layerUIDs[n]=i[s++];this.bufferDataOffset=s,e&&(this.layer=e.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return null==this._data}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this._data=null,this.isDestroyed=!0)}prepareForRendering(t){null!=this._data&&(this.doPrepareForRendering(t,this._data,this.bufferDataOffset),this._data=null)}}class oe extends wt{constructor(t,e){super(t,e),this.type=g.NP.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const s=new Uint32Array(t);let i=this.bufferDataOffset;this.lineIndexStart=s[i++],this.lineIndexCount=s[i++];const r=s[i++];if(r>0){this.patternMap=new Map;for(let n=0;n<r;n++){const a=s[i++],c=s[i++],d=s[i++];this.patternMap.set(a,[c,d])}}this.bufferDataOffset=i}get memoryUsed(){return(this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=(0,K.WD)(this.vao)}doPrepareForRendering(t,e,s){const i=new Uint32Array(e),r=new Int32Array(i.buffer),n=i[s++],a=dt.g.createVertex(t,D._U.STATIC_DRAW,new Int32Array(r.buffer,4*s,n));s+=n;const c=i[s++],d=dt.g.createIndex(t,D._U.STATIC_DRAW,new Uint32Array(i.buffer,4*s,c));s+=c;const p=this.layer.lineMaterial;this.vao=new xt.Z(t,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:a},d)}}class ae extends wt{constructor(t,e){super(t,e),this.type=g.NP.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const s=new Uint32Array(t);let i=this.bufferDataOffset;this.fillIndexStart=s[i++],this.fillIndexCount=s[i++],this.outlineIndexStart=s[i++],this.outlineIndexCount=s[i++];const r=s[i++];if(r>0){this.patternMap=new Map;for(let n=0;n<r;n++){const a=s[i++],c=s[i++],d=s[i++];this.patternMap.set(a,[c,d])}}this.bufferDataOffset=i}get memoryUsed(){return(this.data?.byteLength??0)+(this.fillVAO?.usedMemory??0)+(this.outlineVAO?.usedMemory??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=(0,K.WD)(this.fillVAO),this.outlineVAO=(0,K.WD)(this.outlineVAO)}doPrepareForRendering(t,e,s){const i=new Uint32Array(e),r=new Int32Array(i.buffer),n=i[s++],a=dt.g.createVertex(t,D._U.STATIC_DRAW,new Int32Array(r.buffer,4*s,n));s+=n;const c=i[s++],d=dt.g.createIndex(t,D._U.STATIC_DRAW,new Uint32Array(i.buffer,4*s,c));s+=c;const p=i[s++],S=dt.g.createVertex(t,D._U.STATIC_DRAW,new Int32Array(r.buffer,4*s,p));s+=p;const b=i[s++],x=dt.g.createIndex(t,D._U.STATIC_DRAW,new Uint32Array(i.buffer,4*s,b));s+=b;const B=this.layer,z=B.fillMaterial,N=B.outlineMaterial;this.fillVAO=new xt.Z(t,z.getAttributeLocations(),z.getLayoutInfo(),{geometry:a},d),this.outlineVAO=new xt.Z(t,N.getAttributeLocations(),N.getLayoutInfo(),{geometry:S},x)}}class le extends wt{constructor(t,e,s){super(t,e),this.type=g.NP.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const i=new Uint32Array(t),r=new Int32Array(t),n=new Float32Array(t);let a=this.bufferDataOffset;this.isIconSDF=!!i[a++];const c=i[a++],d=i[a++],p=i[a++],S=new v.A(c,d,p,0),b=i[a++];for(let N=0;N<b;N++){const H=i[a++],$=i[a++],q=i[a++];this.iconPerPageElementsMap.set(H,[$,q])}const x=i[a++];for(let N=0;N<x;N++){const H=i[a++],$=i[a++],q=i[a++];this.glyphPerPageElementsMap.set(H,[$,q])}const B=i[a++],z=i[a++];this.iconOpacity=new Int32Array(B),this.textOpacity=new Int32Array(z),a=function se(h,t,e,s,i,r,n){const a=t[s++];for(let c=0;c<a;c++){const d=new te(r,n);d.xTile=t[s++],d.yTile=t[s++],d.hash=t[s++],d.priority=t[s++],d.featureIndex=t[s++];const p=t[s++];for(let x=0;x<p;x++){const B=t[s++],z=t[s++],N=t[s++],H=t[s++],$=!!t[s++],q=t[s++],lt=e[s++],_t=e[s++],ot=t[s++],ct=t[s++];d.colliders.push({xTile:B,yTile:z,dxPixels:N,dyPixels:H,hard:$,partIndex:q,width:ot,height:ct,minLod:lt,maxLod:_t})}const S=h[s++];for(let x=0;x<S;x++)d.textVertexRanges.push([h[s++],h[s++]]);const b=h[s++];for(let x=0;x<b;x++)d.iconVertexRanges.push([h[s++],h[s++]]);i.push(d)}return s}(i,r,n,a,this.symbols,s,S),this.bufferDataOffset=a}get memoryUsed(){return(this.data?.byteLength??0)+(this.iconVAO?.usedMemory??0)+(this.textVAO?.usedMemory??0)+(0,Lt.Ek)(this.iconOpacity)+(0,Lt.Ek)(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let t=0;for(const[e,s]of this.iconPerPageElementsMap)t+=s[1];for(const[e,s]of this.glyphPerPageElementsMap)t+=s[1];return t/3}doDestroy(){this.iconVAO=(0,K.WD)(this.iconVAO),this.textVAO=(0,K.WD)(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const t=this.iconOpacity,e=this.iconVAO.vertexBuffers.opacity;t.length>0&&t.byteLength===e.usedMemory&&e.setSubData(t,0,0,t.length);const s=this.textOpacity,i=this.textVAO.vertexBuffers.opacity;s.length>0&&s.byteLength===i.usedMemory&&i.setSubData(s,0,0,s.length)}doPrepareForRendering(t,e,s){const i=new Uint32Array(e),r=new Int32Array(i.buffer),n=i[s++],a=dt.g.createVertex(t,D._U.STATIC_DRAW,new Int32Array(r.buffer,4*s,n));s+=n;const c=i[s++],d=dt.g.createIndex(t,D._U.STATIC_DRAW,new Uint32Array(i.buffer,4*s,c));s+=c;const p=i[s++],S=dt.g.createVertex(t,D._U.STATIC_DRAW,new Int32Array(r.buffer,4*s,p));s+=p;const b=i[s++],x=dt.g.createIndex(t,D._U.STATIC_DRAW,new Uint32Array(i.buffer,4*s,b));s+=b;const B=dt.g.createVertex(t,D._U.STATIC_DRAW,this.iconOpacity.buffer),z=dt.g.createVertex(t,D._U.STATIC_DRAW,this.textOpacity.buffer),N=this.layer,H=N.iconMaterial,$=N.textMaterial;this.iconVAO=new xt.Z(t,H.getAttributeLocations(),H.getLayoutInfo(),{geometry:a,opacity:B},d),this.textVAO=new xt.Z(t,$.getAttributeLocations(),$.getLayoutInfo(),{geometry:S,opacity:z},x)}}class he extends wt{constructor(t,e){super(t,e),this.type=g.NP.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const s=new Uint32Array(t);let i=this.bufferDataOffset;this.circleIndexStart=s[i++],this.circleIndexCount=s[i++],this.bufferDataOffset=i}get memoryUsed(){return(this.data?.byteLength??0)+(this.vao?.usedMemory??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=(0,K.WD)(this.vao)}doPrepareForRendering(t,e,s){const i=new Uint32Array(e),r=new Int32Array(i.buffer),n=i[s++],a=dt.g.createVertex(t,D._U.STATIC_DRAW,new Int32Array(r.buffer,4*s,n));s+=n;const c=i[s++],d=dt.g.createIndex(t,D._U.STATIC_DRAW,new Uint32Array(i.buffer,4*s,c));s+=c;const p=this.layer.circleMaterial;this.vao=new xt.Z(t,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:a},d)}}var vt=y(24505),Vt=y(15442);class Pt extends Vt.Y{constructor(t,e,s,i,r,n,a,c=null){super(t,e,s,i,r,n,4096,4096),this.styleRepository=a,this._memCache=c,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.parentTile=null,this.childrenTiles=new Set,this.featureIndex=null,this.triangleCount=0,this._processed=!1,this._referenced=1,this.id=t.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<vt.zk}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<vt.zk)}get wasRequested(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status}setData(t){this.changeDataImpl(t),this.requestRender(),this.ready(),this._processed=!0}deleteLayerData(t){let e=!1;for(const s of t){const i=this.layerData.get(s);i&&(this._memoryUsedByLayerData-=i.memoryUsed,i.type===g.NP.SYMBOL&&this.symbols.delete(s)&&(e=!0),i.destroy(),this.layerData.delete(s))}this._memCache?.updateSize(this.key.id,this,this._memoryUsedByLayerData),e&&(this.featureIndex?.clear(),this.emit("symbols-changed")),this.requestRender()}processed(){return this._processed}hasData(){return this.layerData.size>0}dispose(){"unloaded"!==this.status&&(this.featureIndex=null,kt.delete(this),Pt._destroyRenderBuckets(this.layerData),this.layerData.clear(),this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return 0==--this._referenced&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get usedMemory(){return this._memoryUsedByLayerData+256}changeDataImpl(t){this.featureIndex?.clear();let e=!1;if(t){const{bucketsWithData:s,emptyBuckets:i}=t,r=this._createRenderBuckets(s);if(i&&i.byteLength>0){const n=new Uint32Array(i);for(const a of n)this._deleteLayerData(a)}for(const[n,a]of r)this._deleteLayerData(n),a.type===g.NP.SYMBOL&&(this.symbols.set(n,a.symbols),e=!0),this._memoryUsedByLayerData+=a.memoryUsed,this.layerData.set(n,a);this._memCache?.updateSize(this.key.id,this,this.usedMemory)}this._hasSymbolBuckets=!1;for(const[s,i]of this.layerData)i.type===g.NP.SYMBOL&&(this._hasSymbolBuckets=!0);e&&this.emit("symbols-changed")}attachWithContext(t){this.stage={context:t,trashDisplayObject(e){e.processDetach()},untrashDisplayObject:()=>!1}}setTransform(t){super.setTransform(t);const e=this.resolution/(t.resolution*t.pixelRatio),s=this.width/this.rangeX*e,i=this.height/this.rangeY*e,r=[0,0];t.toScreen(r,[this.x,this.y]);const n=this.transforms.tileUnitsToPixels;(0,bt.D_)(n),(0,bt.Tl)(n,n,r),(0,bt.e$)(n,n,Math.PI*t.rotation/180),(0,bt.hs)(n,n,[s,i,1])}_createTransforms(){return{displayViewScreenMat3:(0,mt.vt)(),tileMat3:(0,mt.vt)(),tileUnitsToPixels:(0,mt.vt)()}}static _destroyRenderBuckets(t){if(!t)return;const e=new Set;for(const s of t.values())e.has(s)||(s.destroy(),e.add(s));t.clear()}_createRenderBuckets(t){const e=new Map,s=new Map;for(const i of t){const r=this._deserializeBucket(i,s);for(const n of r.layerUIDs)e.set(n,r)}return e}_deserializeBucket(t,e){let s=e.get(t);if(s)return s;switch(new Uint32Array(t)[0]){case g.NP.FILL:s=new ae(t,this.styleRepository);break;case g.NP.LINE:s=new oe(t,this.styleRepository);break;case g.NP.SYMBOL:s=new le(t,this.styleRepository,this);break;case g.NP.CIRCLE:s=new he(t,this.styleRepository)}return e.set(t,s),s}_deleteLayerData(t){if(!this.layerData.has(t))return;const e=this.layerData.get(t);this._memoryUsedByLayerData-=e.memoryUsed,e.destroy(),this.layerData.delete(t)}}const kt=new Map;var zt=y(11333),ce=y(54029),nt=y(54e3);function ue(h,t,e,s,i,r){const{iconRotationAlignment:n,textRotationAlignment:a,iconTranslate:c,iconTranslateAnchor:d,textTranslate:p,textTranslateAnchor:S}=s;let b=0;for(const x of h.colliders){const[B,z]=0===x.partIndex?c:p,N=0===x.partIndex?d:S,H=x.minLod<=r&&r<=x.maxLod;b+=H?0:1,x.enabled=H,x.xScreen=x.xTile*i[0]+x.yTile*i[3]+i[6],x.yScreen=x.xTile*i[1]+x.yTile*i[4]+i[7],N===nt.Cq.MAP?(x.xScreen+=e*B-t*z,x.yScreen+=t*B+e*z):(x.xScreen+=B,x.yScreen+=z),nt.I5.VIEWPORT===(0===x.partIndex?n:a)?(x.dxScreen=x.dxPixels,x.dyScreen=x.dyPixels):(x.dxScreen=e*(x.dxPixels+x.width/2)-t*(x.dyPixels+x.height/2)-x.width/2,x.dyScreen=t*(x.dxPixels+x.width/2)+e*(x.dyPixels+x.height/2)-x.height/2)}h.colliders.length>0&&b===h.colliders.length&&(h.unique.show=!1)}class de{constructor(t,e,s,i,r,n){this._symbols=t,this._styleRepository=i,this._zoom=r,this._currentLayerCursor=0,this._currentSymbolCursor=0,this._styleProps=new Map,this._allNeededMatrices=new Map,this._gridIndex=new Bt(e,s,vt.o2),this._si=Math.sin(Math.PI*n/180),this._co=Math.cos(Math.PI*n/180);for(const a of t)for(const c of a.symbols)this._allNeededMatrices.has(c.tile)||this._allNeededMatrices.set(c.tile,(0,mt.o8)(c.tile.transforms.tileUnitsToPixels))}work(t){const e=this._gridIndex;function s(r){const n=r.xScreen+r.dxScreen,a=r.yScreen+r.dyScreen,c=n+r.width,d=a+r.height,[p,S,b,x]=e.getCellSpan(n,a,c,d);for(let B=S;B<=x;B++)for(let z=p;z<=b;z++){const N=e.cells[B][z];for(const H of N){const $=H.xScreen+H.dxScreen,q=H.yScreen+H.dyScreen;if(!(c<$||n>$+H.width||d<q||a>q+H.height))return!0}}return!1}const i=performance.now();for(;this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0){const r=this._symbols[this._currentLayerCursor],n=this._getProperties(r.styleLayerUID);for(;this._currentSymbolCursor<r.symbols.length;this._currentSymbolCursor++){if(this._currentSymbolCursor%100==99&&performance.now()-i>t)return!1;const a=r.symbols[this._currentSymbolCursor];if(!a.unique.show)continue;ue(a,this._si,this._co,n,this._allNeededMatrices.get(a.tile),this._zoom);const c=a.unique;if(!c.show)continue;const{iconAllowOverlap:d,iconIgnorePlacement:p,textAllowOverlap:S,textIgnorePlacement:b}=n;for(const x of a.colliders){if(!x.enabled)continue;const B=c.parts[x.partIndex];B.show&&!(x.partIndex?S:d)&&s(x)&&(x.hard?c.show=!1:B.show=!1)}if(c.show)for(const x of a.colliders){if(!x.enabled||(x.partIndex?b:p)||!c.parts[x.partIndex].show)continue;const B=x.xScreen+x.dxScreen,z=x.yScreen+x.dyScreen,N=B+x.width,H=z+x.height,[$,q,lt,_t]=this._gridIndex.getCellSpan(B,z,N,H);for(let ot=q;ot<=_t;ot++)for(let ct=$;ct<=lt;ct++)this._gridIndex.cells[ot][ct].push(x)}}}return!0}_getProperties(t){const e=this._styleProps.get(t);if(e)return e;const s=this._zoom,i=this._styleRepository.getStyleLayerByUID(t),r=i.getLayoutValue("symbol-placement",s)!==nt.kt.POINT;let n=i.getLayoutValue("icon-rotation-alignment",s);n===nt.I5.AUTO&&(n=r?nt.I5.MAP:nt.I5.VIEWPORT);let a=i.getLayoutValue("text-rotation-alignment",s);a===nt.I5.AUTO&&(a=r?nt.I5.MAP:nt.I5.VIEWPORT);const c=i.getPaintValue("icon-translate",s),d=i.getPaintValue("icon-translate-anchor",s),p=i.getPaintValue("text-translate",s),S=i.getPaintValue("text-translate-anchor",s),b={iconAllowOverlap:i.getLayoutValue("icon-allow-overlap",s),iconIgnorePlacement:i.getLayoutValue("icon-ignore-placement",s),textAllowOverlap:i.getLayoutValue("text-allow-overlap",s),textIgnorePlacement:i.getLayoutValue("text-ignore-placement",s),iconRotationAlignment:n,textRotationAlignment:a,iconTranslateAnchor:d,iconTranslate:c,textTranslateAnchor:S,textTranslate:p};return this._styleProps.set(t,b),b}}function _e(h,t){if(h.priority-t.priority)return h.priority-t.priority;const e=h.tile.key,s=t.tile.key;return e.world-s.world?e.world-s.world:e.level-s.level?e.level-s.level:e.row-s.row?e.row-s.row:e.col-s.col?e.col-s.col:h.xTile-t.xTile?h.xTile-t.xTile:h.yTile-t.yTile}class ye{get running(){return this._running}constructor(t,e,s,i,r,n){this._visibleTiles=t,this._symbolRepository=e,this._createCollisionJob=s,this._assignTileSymbolsOpacity=i,this._symbolLayerSorter=r,this._isLayerVisible=n,this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}setScreenSize(t,e){this._screenWidth===t&&this._screenHeight===e||this.restart(),this._screenWidth=t,this._screenHeight=e}restart(){this._selectionJob=null,this._selectionJobCompleted=!1,this._collisionJob=null,this._collisionJobCompleted=!1,this._opacityJob=null,this._opacityJobCompleted=!1,this._running=!0}continue(t){if(this._selectionJob||(this._selectionJob=this._createSelectionJob()),!this._selectionJobCompleted){const e=performance.now();if(!this._selectionJob.work(t)||(this._selectionJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-e)))))return!1}if(this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight)),!this._collisionJobCompleted){const e=performance.now();if(!this._collisionJob.work(t)||(this._collisionJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-e)))))return!1}if(this._opacityJob||(this._opacityJob=this._createOpacityJob()),!this._opacityJobCompleted){const e=performance.now();if(!this._opacityJob.work(t)||(this._opacityJobCompleted=!0,0===(t=Math.max(0,t-(performance.now()-e)))))return!1}return this._running=!1,!0}_createSelectionJob(){const t=this._symbolRepository.uniqueSymbols;for(let c=0;c<t.length;c++){const d=t[c];for(let p=0;p<d.uniqueSymbols.length;p++){const S=d.uniqueSymbols[p];for(const b of S.tileSymbols)b.selectedForRendering=!1}}const e=[];let s=0,i=0;const r=this._isLayerVisible,a=this._symbolLayerSorter;return{work:function n(c){let d;const p=performance.now();for(;i<t.length;i++,s=0){const S=t[i],b=S.styleLayerUID;if(!r(b)){e[i]||(e[i]={styleLayerUID:b,symbols:[]});continue}e[i]=e[i]||{styleLayerUID:b,symbols:[]};const x=e[i];for(;s<S.uniqueSymbols.length;s++){if(d=S.uniqueSymbols[s],s%100==99&&performance.now()-p>c)return!1;let B=null,z=!1,N=!1;for(const H of d.tileSymbols)if(!N||!z){const $=H.tile;(!B||$.isCoverage||$.neededForCoverage&&!z)&&(B=H,($.neededForCoverage||$.isCoverage)&&(N=!0),$.isCoverage&&(z=!0))}if(B.selectedForRendering=!0,N){x.symbols.push(B),d.show=!0;for(const H of d.parts)H.show=!0}else d.show=!1}}for(const S of e)S.symbols.sort(_e);return!0},get sortedSymbols(){return e.sort(a)}}}_createOpacityJob(){const t=this._assignTileSymbolsOpacity,e=this._visibleTiles;let s=0;function i(r,n){const a=r.symbols;for(const[c,d]of a)pe(d,n);t(r,n);for(const c of r.childrenTiles)i(c,n)}return{work(r){const n=performance.now();for(;s<e.length;s++){if(performance.now()-n>r)return!1;const a=e[s];null==a.parentTile&&i(a,performance.now())}return!0}}}}function pe(h,t){for(const e of h){const s=e.unique;for(const i of s.parts)i.startOpacity+=(t-i.startTime)/vt.zk*(i.targetOpacity>.5?1:-1),i.startOpacity=Math.min(Math.max(i.startOpacity,0),1),i.startTime=t,i.targetOpacity=s.show&&i.show?1:0}}class ve{constructor(t,e,s){this.tileCoordRange=t,this._visibleTiles=e,this._createUnique=s,this._tiles=new Map,this._uniqueSymbolsReferences=new Map}get uniqueSymbols(){return null==this._uniqueSymbolLayerArray&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray()),this._uniqueSymbolLayerArray}get uniqueSymbolsReferences(){return this._uniqueSymbolsReferences}add(t,e){this._uniqueSymbolLayerArray=null;let s=this._tiles.get(t.id);s||(s={symbols:new Map},this._tiles.set(t.id,s));const i=new Map;if(e)for(const a of e)s.symbols.has(a)&&(i.set(a,s.symbols.get(a)),s.symbols.delete(a));else for(const[a,c]of t.layerData)s.symbols.has(a)&&(i.set(a,s.symbols.get(a)),s.symbols.delete(a));this._removeSymbols(i);const r=t.symbols,n=new Map;for(const[a,c]of r){let d=c.length;if(d>=32){let p=this.tileCoordRange;do{p/=2,d/=4}while(d>8&&p>64);const S=new Bt(this.tileCoordRange,this.tileCoordRange,p);n.set(a,{flat:c,index:S}),s.symbols.set(a,{flat:c,index:S});for(const b of c)S.getCell(b.xTile,b.yTile).push(b)}else n.set(a,{flat:c}),s.symbols.set(a,{flat:c})}this._addSymbols(t.key,r)}deleteStyleLayers(t){this._uniqueSymbolLayerArray=null;for(const[e,s]of this._tiles){const i=new Map;for(const r of t)s.symbols.has(r)&&(i.set(r,s.symbols.get(r)),s.symbols.delete(r));this._removeSymbols(i),0===s.symbols.size&&this._tiles.delete(e)}}removeTile(t){this._uniqueSymbolLayerArray=null;const e=this._tiles.get(t.id);if(!e)return;const s=new Map;for(const[i,r]of t.symbols)e.symbols.has(i)&&(s.set(i,e.symbols.get(i)),e.symbols.delete(i));this._removeSymbols(s),0===e.symbols.size&&this._tiles.delete(t.id)}querySymbols(t,e,s,i){const r=[],n=this.uniqueSymbols;for(const a of n){const c=a.styleLayerUID,d=a.uniqueSymbols;for(const p of d){const S=p.tileSymbols.find(b=>b.selectedForRendering);S&&ne(S,t,e*(window.devicePixelRatio||1),s)&&r.push({vtlSymbol:S,styleLayerUID:c,tileKey:S.tile.key})}}return r}_removeSymbols(t){for(const[e,{flat:s}]of t)for(const i of s){const r=i.unique,n=r.tileSymbols,a=n.length-1;for(let c=0;c<a;c++)if(n[c]===i){n[c]=n[a];break}if(n.length=a,0===a){const c=this._uniqueSymbolsReferences.get(e);c.delete(r),0===c.size&&this._uniqueSymbolsReferences.delete(e)}i.unique=null}}_addSymbols(t,e){if(0===e.size)return;const s=this._visibleTiles;for(const i of s)i.parentTile||i.key.world!==t.world||i.key.level===t.level&&!i.key.equals(t)||this._matchSymbols(i,t,e);for(const[i,r]of e)for(const n of r)if(null==n.unique){const a=this._createUnique();n.unique=a,a.tileSymbols.push(n);let c=this._uniqueSymbolsReferences.get(i);c||(c=new Set,this._uniqueSymbolsReferences.set(i,c)),c.add(a)}}_matchSymbols(t,e,s){if(t.key.level>e.level){const r=t.key.level-e.level;if(t.key.row>>r!==e.row||t.key.col>>r!==e.col)return}if(e.level>t.key.level){const r=e.level-t.key.level;if(e.row>>r!==t.key.row||e.col>>r!==t.key.col)return}if(e.equals(t.key)){for(const r of t.childrenTiles)this._matchSymbols(r,e,s);return}const i=new Map;for(const[r,n]of s){const a=[];for(const S of n){const b=Ut(this.tileCoordRange,S.xTile,e.level,e.col,t.key.level,t.key.col),x=Ut(this.tileCoordRange,S.yTile,e.level,e.row,t.key.level,t.key.row);b>=0&&b<this.tileCoordRange&&x>=0&&x<this.tileCoordRange&&a.push({symbol:S,xTransformed:b,yTransformed:x})}const c=[],d=20+(t.key.level<e.level?1:1<<t.key.level-e.level),p=this._tiles.get(t.id).symbols.get(r);if(p){const S=p.flat;for(const b of a){let x,B=!1;const z=b.xTransformed,N=b.yTransformed;x=null!=p.index?p.index.getCell(z,N):S;const H=b.symbol,$=H.hash;for(const q of x)if($===q.hash&&Math.abs(z-q.xTile)<=d&&Math.abs(N-q.yTile)<=d){const lt=q.unique;H.unique=lt,lt.tileSymbols.push(H),B=!0;break}B||c.push(H)}}c.length>0&&i.set(r,c)}for(const r of t.childrenTiles)this._matchSymbols(r,e,i)}_createUniqueSymbolLayerArray(){const t=this._uniqueSymbolsReferences,e=new Array(t.size);let s,i=0;for(const[r,n]of t){const a=new Array(n.size);s=0;for(const c of n)a[s++]=c;e[i]={styleLayerUID:r,uniqueSymbols:a},i++}return e}}class we{constructor(t,e){this.styleRepository=t,this._tileToHandle=new Map,this._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]},this._offsetFromScreenCenter=[0,0],this._completed=!1,this._fading=(0,ce.v)(!1),this._symbolRepository=new ve(4096,e,()=>new ee),this._symbolDeclutterer=new ye(e,this._symbolRepository,(s,i,r)=>this._createCollisionJob(s,i,r),(s,i)=>{s.allSymbolsFadingOut=!0,s.lastOpacityUpdate=i,function ie(h,t,e){for(const[s,i]of h.symbols)re(h,t,e,i,s)}(s,i,!0),s.decluttered=!0,s.requestRender()},(s,i)=>this.styleRepository.getStyleLayerByUID(s.styleLayerUID).z-this.styleRepository.getStyleLayerByUID(i.styleLayerUID).z,s=>{const i=this.styleRepository.getStyleLayerByUID(s);if(this._zoom+1e-6<i.minzoom||this._zoom-1e-6>=i.maxzoom)return!1;const r=i.getLayoutProperty("visibility");return!r||r.getValue()!==nt.bv.NONE})}get symbolRepository(){return this._symbolRepository}_createCollisionJob(t,e,s){return this.updateDecluttererViewState(),new de(t,e,s,this.styleRepository,this._zoom,this._viewState.rotation)}get fading(){return this._fading.value}get decluttererOffset(){return this._offsetFromScreenCenter}addTile(t){t.decluttered=!1,this._tileToHandle.set(t,t.on("symbols-changed",()=>{this._symbolRepository.add(t),this.restartDeclutter()})),this._symbolRepository.add(t),this.restartDeclutter()}removeTile(t){const e=this._tileToHandle.get(t);e&&(this._symbolRepository.removeTile(t),this.restartDeclutter(),e.remove(),this._tileToHandle.delete(t))}update(t,e){this._zoom=t,this._viewState={scale:e.scale,rotation:e.rotation,center:[e.center[0],e.center[1]],size:[e.size[0],e.size[1]]};const s=[0,0];e.toScreen(s,e.center);const i=[0,0];return e.toScreen(i,this._declutterViewState.center),this._offsetFromScreenCenter[0]=s[0]-i[0],this._offsetFromScreenCenter[1]=s[1]-i[1],this._continueDeclutter(),this._completed}restartDeclutter(){this._completed=!1,this._symbolDeclutterer.restart(),this._notifyUnstable()}clear(){this._completed=!1,this._symbolRepository=null,this._symbolDeclutterer.restart(),this._tileToHandle.forEach(t=>t.remove()),this._tileToHandle.clear()}get stale(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||this._viewState.rotation!==this._declutterViewState.rotation}deleteStyleLayers(t){this._symbolRepository.deleteStyleLayers(t)}_continueDeclutter(){this._completed&&!this.stale||(this._symbolDeclutterer.running||(this.updateDecluttererViewState(),this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),this._completed=this._symbolDeclutterer.continue(vt.av),this._completed&&this._scheduleNotifyStable())}_scheduleNotifyStable(){null!=this._stableNotificationHandle&&clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=setTimeout(()=>{this._stableNotificationHandle=null,this._fading.value=!1},1.5*vt.zk)}_notifyUnstable(){null!=this._stableNotificationHandle&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null),this._fading.value=!0}updateDecluttererViewState(){this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],this._declutterViewState.size[1]=this._viewState.size[1],this._offsetFromScreenCenter[0]=0,this._offsetFromScreenCenter[1]=0}}var St=y(69473);class Se extends Vt.Y{_createTransforms(){return{displayViewScreenMat3:(0,mt.vt)(),tileMat3:(0,mt.vt)()}}}var Me=y(37188);const Mt=1e-6;function Ht(h,t){if(h){const e=h.getLayoutProperty("visibility");if(!e||e.getValue()!==nt.bv.NONE&&(void 0===h.minzoom||h.minzoom<t+Mt)&&(void 0===h.maxzoom||h.maxzoom>=t-Mt))return!0}return!1}class Te extends Me.A{constructor(t){super(t),this._backgroundTiles=[],this._computeDisplayInfoView(t)}destroy(){this.removeAllChildren(),this._spriteMosaic?.dispose(),this._spriteMosaic=null,this._glyphMosaic?.dispose(),this._glyphMosaic=null,null!=this._symbolFader&&(this._symbolFader.clear(),this._symbolFader=null),this._styleRepository=null,this._backgroundTiles=[]}get fading(){return this._symbolFader?.fading??!1}get symbolFader(){return this._symbolFader}get symbolRepository(){return this._symbolFader?.symbolRepository}setStyleResources(t,e,s,i){this._spriteMosaic=t,this._glyphMosaic=e,this._styleRepository=s,this._tileInfoView=i,this._computeDisplayInfoView(i),null==this._symbolFader&&(this._symbolFader=new we(this._styleRepository,this.children)),this._symbolFader.styleRepository=s}setSpriteMosaic(t){this._spriteMosaic?.dispose(),this._spriteMosaic=t}deleteStyleLayers(t){null!=this._symbolFader&&this._symbolFader.deleteStyleLayers(t)}createRenderParams(t){return{...super.createRenderParams(t),renderPass:null,styleLayer:null,styleLayerUID:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos}}doRender(t){!this.visible||t.drawPhase!==St.S5.MAP&&t.drawPhase!==St.S5.DEBUG||void 0===this._spriteMosaic||super.doRender(t)}addChild(t){return super.addChild(t),null!=this._symbolFader?this._symbolFader.addTile(t):t.decluttered=!0,this.requestRender(),t}removeChild(t){return null!=this._symbolFader&&this._symbolFader.removeTile(t),this.requestRender(),super.removeChild(t)}renderChildren(t){const{drawPhase:e}=t;e!==St.S5.DEBUG?this._doRender(t):super.renderChildren(t)}removeAllChildren(){for(let t=0;t<this.children.length;t++){const e=this.children[t];null!=this._symbolFader&&this._symbolFader.removeTile(e),e.dispose()}super.removeAllChildren()}getStencilTarget(){return this.children.filter(t=>t.neededForCoverage&&t.hasData())}restartDeclutter(){null!=this._symbolFader&&this._symbolFader.restartDeclutter()}_doRender(t){const{context:e,state:s}=t,i=this._styleRepository;if(!i)return;const r=i.layers,n=this._displayInfo.scaleToZoom(s.scale);i.backgroundBucketIds.length>0&&(t.renderPass="background",this._renderBackgroundLayers(t,i.backgroundBucketIds,n)),super.renderChildren(t),t.drawPhase===St.S5.MAP&&this._fade(n,s);const a=this.children.filter(c=>c.visible&&c.hasData());if(!a||0===a.length)return e.bindVAO(),e.setStencilTestEnabled(!0),void e.setBlendingEnabled(!0);for(const c of a)c.triangleCount=0;e.setStencilWriteMask(0),e.setColorMask(!0,!0,!0,!0),e.setStencilOp(D.eA.KEEP,D.eA.KEEP,D.eA.REPLACE),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setDepthTestEnabled(!0),e.setDepthWriteEnabled(!0),e.setDepthFunction(D.MT.LEQUAL),e.setClearDepth(1),e.clear(e.gl.DEPTH_BUFFER_BIT),t.renderPass="opaque";for(let c=r.length-1;c>=0;c--)this._renderStyleLayer(r[c],t,a);e.setDepthWriteEnabled(!1),e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(D.dn.ONE,D.dn.ONE_MINUS_SRC_ALPHA,D.dn.ONE,D.dn.ONE_MINUS_SRC_ALPHA),t.renderPass="translucent";for(let c=0;c<r.length;c++)this._renderStyleLayer(r[c],t,a);e.bindVAO(),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!0);for(const c of a)c.debugInfo.display.triangleCount=c.triangleCount}_fade(t,e){null!=this._symbolFader&&(this._symbolFader.update(t,e)||this.requestRender())}_renderStyleLayer(t,e,s){const{displayLevel:i,painter:r,renderPass:n}=e;if(void 0===t)return;const a=t.getLayoutProperty("visibility");if(a&&a.getValue()===nt.bv.NONE)return;let c;switch(t.type){case nt.Dc.BACKGROUND:return;case nt.Dc.FILL:if("opaque"!==n&&"translucent"!==e.renderPass)return;c="vtlFill";break;case nt.Dc.LINE:if("translucent"!==n)return;c="vtlLine";break;case nt.Dc.CIRCLE:if("translucent"!==n)return;c="vtlCircle";break;case nt.Dc.SYMBOL:if("translucent"!==n)return;c="vtlSymbol"}if(s=s.filter(t.type===nt.Dc.SYMBOL?p=>p.decluttered:p=>p.neededForCoverage),"vtlSymbol"!==c&&(0===s.length||void 0!==t.minzoom&&t.minzoom>=i+Mt||void 0!==t.maxzoom&&t.maxzoom<i-Mt))return;const d=t.uid;e.styleLayerUID=d,e.styleLayer=t;for(const p of s)if(p.layerData.has(d)){r.renderObjects(e,s,c);break}}_renderBackgroundLayers(t,e,s){const{context:i,painter:r,state:n}=t,a=this._styleRepository;let c=!1;for(const q of e)if(a.getLayerById(q).type===nt.Dc.BACKGROUND&&Ht(a.getLayerById(q),s)){c=!0;break}if(!c)return;const d=this._tileInfoView,p=d.getTileCoverage(t.state,0,!0,"smallest"),{spans:S,lodInfo:b}=p,{level:x}=b,B=(0,l.vt)(),z=[];if(this._renderPasses){const q=this._renderPasses[0];null!=this._clippingInfos&&(q.brushes[0].prepareState(t),q.brushes[0].drawMany(t,this._clippingInfos))}const N=this._backgroundTiles;let H,$=0;for(const{row:q,colFrom:lt,colTo:_t}of S)for(let ot=lt;ot<=_t;ot++){if($<N.length)H=N[$],H.key.set(x,q,b.normalizeCol(ot),b.getWorldForColumn(ot)),d.getTileBounds(B,H.key,!1),H.x=B[0],H.y=B[3],H.resolution=d.getTileResolution(x);else{const ct=new v.A(x,q,b.normalizeCol(ot),b.getWorldForColumn(ot)),ft=d.getTileBounds((0,l.vt)(),ct),It=d.getTileResolution(x);H=new Se(ct,It,ft[0],ft[3],512,512,4096,4096),N.push(H)}H.setTransform(n),z.push(H),$++}i.setStencilWriteMask(0),i.setColorMask(!0,!0,!0,!0),i.setStencilOp(D.eA.KEEP,D.eA.KEEP,D.eA.REPLACE),i.setStencilFunction(D.MT.EQUAL,0,255),i.setStencilTestEnabled(!0);for(const q of e){const lt=a.getLayerById(q);lt.type===nt.Dc.BACKGROUND&&Ht(lt,s)&&(t.styleLayerUID=lt.uid,t.styleLayer=lt,r.renderObjects(t,z,"vtlBackground"))}j.A.pool.release(p)}_computeDisplayInfoView(t){let e=t.tileInfo.lods[0].scale;const s=Math.max(25,t.tileInfo.lods.length),i=[];for(let r=0;r<=s;r++)i.push(e),e/=2;this._displayInfo=zt.A.create({scales:i,size:512,spatialReference:t.spatialReference,numLODs:s})}}var Wt=y(81098),Ie=y(60797),Ae=y(3567),Nt=y(20788),Kt=y(97944),De=y(53220);const Ce=(h,t)=>{const e=h.vtlSymbol.sourceTile,s=t.vtlSymbol.sourceTile;return e.level!==s.level?e.level-s.level:e.row!==s.row?e.row-s.row:e.col!==s.col?e.col-s.col:h.styleLayerUID-t.styleLayerUID};class Rt{constructor(t,e,s,i,r){this.tileKey=t,this._index=null,this._styleRepository=null,this._tileHandler=null,this._tileKeyToPBF=new Map,this._tileLayerData=e,this._styleRepository=s,this._tileHandler=i,this._parentLayer=r}static create(t,e,s,i,r){return new Rt(t,e,s,i,r)}clear(){this._index?.clear(),this._tileKeyToPBF.clear()}queryAttributes(t,e,s,i,r){var n=this;return(0,I.A)(function*(){if(0===n._tileLayerData.size||!n._styleRepository||!n._tileHandler)return[];null===n._index&&(n._index=new Ae.w(100,Le),yield n._indexLayers());const a=[];return n._queryIndex(a,t,e,s,n.tileKey.level,i),r&&r?.length>0&&(yield n._getSymbolsAttributes(a,r)),a})()}_indexLayers(){var t=this;return(0,I.A)(function*(){const e=t.tileKey,s=t._styleRepository.layers,i=yield t._getTilePayload(e);for(const[r,n]of t._tileLayerData){const a=s[r],c=i.find(S=>S.sourceName===a.source);if(!c)continue;const{protobuff:d,key:p}=c;if(n.type!==g.NP.SYMBOL){const S=1<<e.level-p.level;t._indexLayer(a,d,e.level,S,e.row-p.row*S,e.col-p.col*S)}}})()}_indexLayer(t,e,s,i,r,n){const a=t.sourceLayer,c=t.getFeatureFilter(),d=s,p=s+1,S=(0,Ot.IU)(d),b=new C.A(new Uint8Array(e),new DataView(e));for(;b.next();)switch(b.tag()){case 3:{const x=b.getMessage(),B=new Kt.A(x);if(x.release(),B.name!==a)continue;const z=B.getData(),N=B.extent/i,H=N*n-S,$=N*r-S,q=H+N+2*S,lt=$+N+2*S,_t=N/512,ot=4096/N,ct=N*n,ft=N*r;for(;z.nextTag(2);){const It=z.getMessage(),At=new Nt.A(It,B);if(It.release(),c&&!c.filter(At,s))continue;const Jt=At.values||{},Qt=Jt._minzoom,$t=Jt._maxzoom;if(Qt&&Qt>=10*p||$t&&$t<=10*d)continue;const yt=t.getFeatureInflatedBounds(At,d,B.extent,_t);null==yt||yt[0]>q||yt[1]>lt||yt[2]<H||yt[3]<$||(yt[0]=(yt[0]-ct)*ot,yt[1]=(yt[1]-ft)*ot,yt[2]=(yt[2]-ct)*ot,yt[3]=(yt[3]-ft)*ot,this._index.insert(new De.e4(t,At,yt,ot,ct,ft)))}break}default:b.skip()}}_getSymbolsAttributes(t,e){var s=this;return(0,I.A)(function*(){if(!e||0===e.length)return t;const i=[];e.sort(Ce);let r=e[0].styleLayerUID,n=0;for(let p=0;p<e.length;p++)r!==e[p].styleLayerUID&&(i.push({from:n,to:p,styleLayerUID:r,sourceTileKey:e[p].vtlSymbol.sourceTile}),n=p,r=e[p].styleLayerUID);i.push({from:n,to:e.length,styleLayerUID:r,sourceTileKey:e[e.length-1].vtlSymbol.sourceTile});const a=s._styleRepository.layers;let c,d=null;for(const p of i){const S=yield s._getTilePayload(p.sourceTileKey);c=a[p.styleLayerUID],d=!!c&&S.find(b=>b.sourceName===c.source),d&&s._addSymbolsAttributes(t,e.slice(p.from,p.to).map(b=>b.vtlSymbol),r,d)}return t})()}_addSymbolsAttributes(t,e,s,i){const r=this._styleRepository.layers,n=i.key,a=this.tileKey,c=1<<a.level-n.level;this._getSymbolAttributes(i.protobuff,e,s,c,a.row-n.row*c,a.col-n.col*c).forEach(S=>{const{attributes:b,tilePoint:x}=S;t.push({layerId:r[s].id,layerIndex:s,graphic:new Wt.A({attributes:b,origin:{type:"vector-tile",layerId:r[s].id,layerIndex:s,layer:this._parentLayer}}),tilePoint:x})})}_getSymbolAttributes(t,e,s,i,r,n){const a=[],c=this._styleRepository.layers;let d=0;e.sort((S,b)=>S.featureIndex-b.featureIndex);const p=new C.A(new Uint8Array(t),new DataView(t));for(;p.next();)switch(p.tag()){case 3:{const S=p.getMessage(),b=new Kt.A(S);if(S.release(),b.name!==c[s].sourceLayer)continue;const x=b.getData(),B=b.extent/i,z=4096/B,N=B*n,H=B*r;let $=0;for(;x.nextTag(2);){const q=x.getMessage();if($++===e[d].featureIndex){const lt=new Nt.A(q,b),_t=lt.values,ot=lt.getGeometry();a.push({attributes:_t,tilePoint:null!=ot?[z*(ot[0][0].x-N),z*(ot[0][0].y-H)]:null}),d++}if(q.release(),d===e.length)return a}break}default:p.skip()}return a}_queryIndex(t,e,s,i,r,n){const a=8*i*(window.devicePixelRatio||1);return this._index?.search({minX:e-a,minY:s-a,maxX:e+a,maxY:s+a},c=>{const{layer:d,feature:p}=c;d.isIntersectingFeature(e,s,i,p,r,n,c)&&t.push({layerId:d.id,layerIndex:d.uid,tilePoint:null,graphic:new Wt.A({attributes:p.values,origin:{type:"vector-tile",layerId:c.layer.id,layerIndex:c.layer.uid,layer:this._parentLayer}})})}),t}_getTilePayload(t){var e=this;return(0,I.A)(function*(){return(0,Ie.tE)(e._tileKeyToPBF,t.id,()=>e._tileHandler.fetchTilePBFs(t)).then(s=>s)})()}}const Le=h=>({minX:h.bounds[0],minY:h.bounds[1],maxX:h.bounds[2],maxY:h.bounds[3]});var Yt=y(6517),Ee=y(29459);class Gt extends qt.A{constructor(){super(...arguments),this._fullCacheLodInfos=null,this._levelByScale={}}getTileParentId(t){const e=v.A.pool.acquire(t),s=0===e.level?null:v.A.getId(e.level-1,e.row>>1,e.col>>1,e.world);return v.A.pool.release(e),s}getTileCoverage(t,e,s=!0,i){const r=super.getTileCoverage(t,e,s,i);if(!r)return r;const n=1<<r.lodInfo.level;return r.spans=r.spans.filter(a=>a.row>=0&&a.row<n),r}scaleToLevel(t){if(this._fullCacheLodInfos||this._initializeFullCacheLODs(this._lodInfos),this._levelByScale[t])return this._levelByScale[t];{const e=this._fullCacheLodInfos;if(t>e[0].scale)return e[0].level;let s,i;for(let r=0;r<e.length-1;r++)if(i=e[r+1],t>i.scale)return s=e[r],s.level+(s.scale-t)/(s.scale-i.scale);return e[e.length-1].level}}_initializeFullCacheLODs(t){let e;e=0===t[0].level?t.map(s=>({level:s.level,resolution:s.resolution,scale:s.scale})):zt.A.create({size:this.tileInfo.size[0],spatialReference:this.tileInfo.spatialReference}).lods.map(r=>({level:r.level,resolution:r.resolution,scale:r.scale}));for(let s=0;s<e.length;s++)this._levelByScale[e[s].scale]=e[s].level;this._fullCacheLodInfos=e}}var Oe=y(41474);let Tt=class extends((0,Ee.e)(Oe.A)){constructor(){super(...arguments),this._styleChanges=[],this._fetchQueue=null,this._parseQueue=null,this._tileHandlerPromise=null,this._isTileHandlerReady=!1}get fading(){return this._vectorTileContainer?.fading??!1}hitTest(h,t){var e=this;return(0,I.A)(function*(){const s=e._tileHandlerPromise,i=e._vectorTileContainer?.symbolFader;if(!s||!e._isTileHandlerReady||!i)return;yield s;let r=null;const n=e._vectorTileContainer?.symbolRepository;n&&(r=n.querySymbols(t,2,i.decluttererOffset,{}));const c=e._tileManager.getIntersectingTiles(t.x,t.y,2,e.view.state,r);if((!c||0===c.length)&&0===r?.length)return null;h=h.clone().normalize();const d=[],p=[];for(const S of c)d.push(e._queryTile(p,h,2,e.view.state.rotation,S,r?.filter(b=>b.tileKey.id===S.id)));return yield Promise.all(d),p})()}update(h){if(this._tileHandlerPromise&&this._isTileHandlerReady)return h.pixelRatio!==this._tileHandler.devicePixelRatio?(this._start(),void(this._tileHandler.devicePixelRatio=h.pixelRatio)):void(this._styleChanges.length>0?this._tileHandlerPromise=this._applyStyleChanges():(this._fetchQueue.pause(),this._parseQueue.pause(),this._fetchQueue.state=h.state,this._parseQueue.state=h.state,this._tileManager.update(h)||this.requestUpdate(),this._parseQueue.resume(),this._fetchQueue.resume()))}attach(){const{style:h}=this.layer.currentStyleInfo;this._styleRepository=new Yt.A(h),this._tileInfoView=new Gt(this.layer.tileInfo,this.layer.fullExtent),this._vectorTileContainer=new Te(this._tileInfoView),this._tileHandler=new P(this.layer,this._styleRepository,window.devicePixelRatio||1,this.layer.tileInfo.lods.length-1),this.container.addChild(this._vectorTileContainer),this._start(),this.addAttachHandles([this.layer.on("paint-change",t=>{if(t.isDataDriven)this._styleChanges.push({type:g.$q.PAINTER_CHANGED,data:t}),this.requestUpdate();else{const e=this._styleRepository,s=e.getLayerById(t.layer);if(!s)return;const i=s.type===nt.Dc.SYMBOL;e.setPaintProperties(t.layer,t.paint),i&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender()}}),this.layer.on("layout-change",t=>{const e=this._styleRepository,s=e.getLayerById(t.layer);if(!s)return;const i=(0,f.Ui)(s.layout,t.layout);if(null!=i){if((0,f.EB)(i,"visibility")&&1===function Ue(h){if(null==h)return 0;switch(h.type){case"partial":return Object.keys(h.diff).length;case"complete":return Math.max(Object.keys(h.oldValue).length,Object.keys(h.newValue).length);case"collection":return Object.keys(h.added).length+Object.keys(h.changed).length+Object.keys(h.removed).length}}(i))return e.setLayoutProperties(t.layer,t.layout),s.type===nt.Dc.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),void this._vectorTileContainer?.requestRender();this._styleChanges.push({type:g.$q.LAYOUT_CHANGED,data:t}),this.requestUpdate()}}),this.layer.on("style-layer-visibility-change",t=>{const e=this._styleRepository,s=e.getLayerById(t.layer);s&&(e.setStyleLayerVisibility(t.layer,t.visibility),s.type===nt.Dc.SYMBOL&&this._vectorTileContainer?.restartDeclutter(),this._vectorTileContainer?.requestRender())}),this.layer.on("style-layer-change",t=>{this._styleChanges.push({type:g.$q.LAYER_CHANGED,data:t}),this.requestUpdate()}),this.layer.on("delete-style-layer",t=>{this._styleChanges.push({type:g.$q.LAYER_REMOVED,data:t}),this.requestUpdate()}),this.layer.on("load-style",()=>this._loadStyle()),this.layer.on("spriteSource-change",t=>{this._styleChanges.push({type:g.$q.SPRITES_CHANGED,data:t});const e=this._styleRepository.layers;for(const s of e)switch(s.type){case nt.Dc.SYMBOL:s.getLayoutProperty("icon-image")&&this._styleChanges.push({type:g.$q.LAYOUT_CHANGED,data:{layer:s.id,layout:s.layout}});break;case nt.Dc.LINE:s.getPaintProperty("line-pattern")&&this._styleChanges.push({type:g.$q.PAINTER_CHANGED,data:{layer:s.id,paint:s.paint,isDataDriven:s.isPainterDataDriven()}});break;case nt.Dc.FILL:s.getLayoutProperty("fill-pattern")&&this._styleChanges.push({type:g.$q.PAINTER_CHANGED,data:{layer:s.id,paint:s.paint,isDataDriven:s.isPainterDataDriven()}})}this.requestUpdate()})])}detach(){this._stop(),this.container.removeAllChildren(),this._vectorTileContainer=(0,K.pR)(this._vectorTileContainer),this._tileHandler=(0,K.pR)(this._tileHandler)}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}supportsSpatialReference(h){return(0,m.aI)(this.layer.tileInfo?.spatialReference,h)}canResume(){let h=super.canResume();const{currentStyleInfo:t}=this.layer;if(h&&t?.layerDefinition){const e=this.view.scale,{minScale:s,maxScale:i}=t.layerDefinition;t?.layerDefinition&&(s&&s<e&&(h=!1),i&&i>e&&(h=!1))}return h}isUpdating(){return this.fading}acquireTile(h){const t=this._createVectorTile(h);return this._updatingHandles.addPromise(this._fetchQueue.push(t.key).then(e=>this._parseQueue.push({key:t.key,data:e})).then(e=>{t.once("attach",()=>this.requestUpdate()),t.setData(e),this.requestUpdate()}).catch(e=>{(0,Y.zf)(e)||G.A.getLogger(this).error(e)})),t}releaseTile(h){const t=h.key.id;this._fetchQueue.abort(t),this._parseQueue.abort(t),this.requestUpdate()}_start(){if(this._stop(),this._tileManager=new ut({acquireTile:e=>this.acquireTile(e),releaseTile:e=>this.releaseTile(e),tileInfoView:this._tileInfoView},this._vectorTileContainer),!this.layer.currentStyleInfo)return;const h=new AbortController,t=this._tileHandler.start({signal:h.signal}).then(()=>{this._fetchQueue=new Et.A({tileInfoView:this._tileInfoView,process:(e,s)=>this._getTileData(e,s),concurrency:15}),this._parseQueue=new Et.A({tileInfoView:this._tileInfoView,process:(e,s)=>this._parseTileData(e,s),concurrency:8}),this.requestUpdate(),this._isTileHandlerReady=!0});this._tileHandler.spriteMosaic.then(e=>{this._vectorTileContainer.setStyleResources(e,this._tileHandler.glyphMosaic,this._styleRepository,this._tileInfoView),this.requestUpdate()}),this._tileHandlerAbortController=h,this._tileHandlerPromise=t}_stop(){if(!this._tileHandlerAbortController||!this._vectorTileContainer)return;const h=this._tileHandlerAbortController;h&&h.abort(),this._tileHandlerPromise=null,this._isTileHandlerReady=!1,this._fetchQueue=(0,K.pR)(this._fetchQueue),this._parseQueue=(0,K.pR)(this._parseQueue),this._tileManager=(0,K.pR)(this._tileManager),this._vectorTileContainer.removeAllChildren()}_getTileData(h,t){var e=this;return(0,I.A)(function*(){return e._tileHandler.fetchTileData(h,t)})()}_parseTileData(h,t){var e=this;return(0,I.A)(function*(){return e._tileHandler.parseTileData(h,t)})()}_applyStyleChanges(){var h=this;return(0,I.A)(function*(){h._isTileHandlerReady=!1,h._fetchQueue.pause(),h._parseQueue.pause(),h._fetchQueue.clear(),h._parseQueue.clear(),h._tileManager.clearCache();const t=h._styleChanges;try{yield h._tileHandler.updateStyle(t)}catch(n){G.A.getLogger(h).error("error applying vector-tiles style update",n.message),h._fetchQueue.resume(),h._parseQueue.resume(),h._isTileHandlerReady=!0}const e=h._styleRepository,s=new Set;t.forEach(n=>{if(n.type!==g.$q.LAYER_REMOVED)return;const c=e.getLayerById(n.data.layer);c&&s.add(c.uid)});const i=new Set;t.forEach(n=>{let a;switch(n.type){case g.$q.PAINTER_CHANGED:e.setPaintProperties(n.data.layer,n.data.paint),a=n.data.layer;break;case g.$q.LAYOUT_CHANGED:e.setLayoutProperties(n.data.layer,n.data.layout),a=n.data.layer;break;case g.$q.LAYER_REMOVED:return void e.deleteStyleLayer(n.data.layer);case g.$q.LAYER_CHANGED:e.setStyleLayer(n.data.layer,n.data.index),a=n.data.layer.id;break;case g.$q.SPRITES_CHANGED:h._vectorTileContainer.setSpriteMosaic(h._tileHandler.setSpriteSource(n.data.spriteSource))}if(a){const c=e.getLayerById(a);c&&i.add(c.uid)}});const r=h._vectorTileContainer.children;if(s.size>0){const n=Array.from(s);h._vectorTileContainer.deleteStyleLayers(n);for(const a of r)a.deleteLayerData(n)}if(h._fetchQueue.resume(),h._parseQueue.resume(),i.size>0){const n=Array.from(i),a=[];for(const c of r){const d=h._updatingHandles.addPromise(h._fetchQueue.push(c.key).then(p=>h._parseQueue.push({key:c.key,data:p,styleLayerUIDs:n})).then(p=>c.setData(p)));a.push(d)}yield Promise.all(a)}h._styleChanges=[],h._isTileHandlerReady=!0,h.requestUpdate()})()}_loadStyle(){var h=this;return(0,I.A)(function*(){const{style:t}=h.layer.currentStyleInfo,e=(0,W.o8)(t);h._isTileHandlerReady=!1,h._fetchQueue.pause(),h._parseQueue.pause(),h._fetchQueue.clear(),h._parseQueue.clear(),h._styleRepository=new Yt.A(e),h._vectorTileContainer.destroy(),h._tileManager.clear(),h._tileHandlerAbortController.abort(),h._tileHandlerAbortController=new AbortController;const{signal:s}=h._tileHandlerAbortController;try{h._tileHandlerPromise=h._tileHandler.setStyle(h._styleRepository,e,h.layer.tileInfo.lods.length-1),yield h._tileHandlerPromise}catch(n){if(!(0,Y.zf)(n))throw n}if(s.aborted)return h._fetchQueue.resume(),h._parseQueue.resume(),h._isTileHandlerReady=!0,void h.requestUpdate();const i=yield h._tileHandler.spriteMosaic,r=h._vectorTileContainer;h._tileInfoView=new Gt(h.layer.tileInfo,h.layer.fullExtent),r.setStyleResources(i,h._tileHandler.glyphMosaic,h._styleRepository,h._tileInfoView),h._tileManager=new ut({acquireTile:n=>h.acquireTile(n),releaseTile:n=>h.releaseTile(n),tileInfoView:h._tileInfoView},h._vectorTileContainer),h._fetchQueue.resume(),h._parseQueue.resume(),h._isTileHandlerReady=!0,h.requestUpdate()})()}_createVectorTile(h){const t=this._tileInfoView.getTileBounds((0,l.vt)(),h),e=this._tileInfoView.getTileResolution(h.level);return new Pt(h,e,t[0],t[3],512,512,this._styleRepository)}_queryTile(h,t,e,s,i,r){var n=this;return(0,I.A)(function*(){if(0===i.layerData.size)return;const a=n._ensureTileIndex(i),c=n._tileInfoView.getTileBounds((0,l.vt)(),i.key,!0),d=(t.x-c[0])/(c[2]-c[0])*4096,p=4096*(1-(t.y-c[1])/(c[3]-c[1])),S=yield a.queryAttributes(d,p,e,s,r);for(const b of S)b.graphic.geometry=n._tileToMapPoint(b.tilePoint,i.transforms.tileUnitsToPixels),h.push({type:"graphic",layer:n.layer,graphic:b.graphic,mapPoint:t.clone()});h.sort((b,x)=>x.graphic.origin.layerIndex-b.graphic.origin.layerIndex)})()}_tileToMapPoint(h,t){if(!h)return null;const i=this.view.state,r=[0,0];return i.toMap(r,[h[0]*t[0]+h[1]*t[3]+t[6],h[0]*t[1]+h[1]*t[4]+t[7]]),new o.A({x:r[0],y:r[1],spatialReference:i.spatialReference})}_ensureTileIndex(h){let t=h.featureIndex;return t||(t=Rt.create(h.key,h.layerData,this._styleRepository,this._tileHandler,this.layer),h.featureIndex=t),t}};(0,Z._)([(0,rt.MZ)()],Tt.prototype,"_isTileHandlerReady",void 0),Tt=(0,Z._)([(0,u.$)("esri.views.2d.layers.VectorTileLayerView2D")],Tt);const Be=Tt},41474:(pt,it,y)=>{y.d(it,{A:()=>A});var I=y(8189),Z=y(98877),W=y(42425),G=y(3046),K=y(35150),Y=y(11432),rt=y(64261),U=y(85211),o=(y(3248),y(40707),y(76576)),l=y(56985),m=y(6558);let g=class extends((0,G.sA)((0,rt.g)(W.A.EventedMixin(Z.A)))){constructor(T){super(T),this._updatingHandles=new l.U,this.layer=null,this.parent=null}initialize(){this.when().catch(T=>{if("layerview:create-error"!==T.name){const k=this.layer&&this.layer.id||"no id",O=this.layer?.title||"no title";K.A.getLogger(this).error("#resolve()",`Failed to resolve layer view (layer title: '${O}', id: '${k}')`,T)}})}destroy(){this._updatingHandles=(0,Y.pR)(this._updatingHandles)}get fullOpacity(){return(this.layer?.opacity??1)*(this.parent?.fullOpacity??1)}get suspended(){return this.destroyed||!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){return!this.suspended&&!0===this.layer?.legendEnabled}get updating(){return!(!this._updatingHandles?.updating&&!this.isUpdating())}get updatingProgress(){return this.updating?0:1}get updateSuspended(){return this.suspended}get visible(){return!0===this.layer?.visible}set visible(T){this._overrideIfSome("visible",T)}get visibleAtCurrentScale(){return!0}get visibleAtCurrentTimeExtent(){const T=this.view.timeExtent,k=this.layer?.visibilityTimeExtent;return!T||!k||!T.intersection(k).isEmpty}canResume(){const T=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;return this.visible&&this.layer?.loaded&&!this.parent?.suspended&&this.view?.ready&&(0,m.g7)(T)&&this.visibleAtCurrentScale&&this.visibleAtCurrentTimeExtent||!1}getSuspendInfo(){const T=this.parent?.suspended?this.parent.suspendInfo:{};return this.view?.ready||(T.viewNotReady=!0),this.layer&&this.layer.loaded||(T.layerNotLoaded=!0),(0,m.g7)(this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null)&&this.visibleAtCurrentScale||(T.outsideScaleRange=!0),this.visibleAtCurrentTimeExtent||(T.outsideVisibilityTimeExtent=!0),this.visible||(T.layerInvisible=!0),T}isUpdating(){return!1}};(0,I._)([(0,U.MZ)()],g.prototype,"view",void 0),(0,I._)([(0,U.MZ)()],g.prototype,"fullOpacity",null),(0,I._)([(0,U.MZ)()],g.prototype,"layer",void 0),(0,I._)([(0,U.MZ)()],g.prototype,"parent",void 0),(0,I._)([(0,U.MZ)({readOnly:!0})],g.prototype,"suspended",null),(0,I._)([(0,U.MZ)({readOnly:!0})],g.prototype,"suspendInfo",null),(0,I._)([(0,U.MZ)({readOnly:!0})],g.prototype,"legendEnabled",null),(0,I._)([(0,U.MZ)({type:Boolean,readOnly:!0})],g.prototype,"updating",null),(0,I._)([(0,U.MZ)({readOnly:!0})],g.prototype,"updatingProgress",null),(0,I._)([(0,U.MZ)()],g.prototype,"updateSuspended",null),(0,I._)([(0,U.MZ)()],g.prototype,"visible",null),(0,I._)([(0,U.MZ)({readOnly:!0})],g.prototype,"visibleAtCurrentScale",null),(0,I._)([(0,U.MZ)({readOnly:!0})],g.prototype,"visibleAtCurrentTimeExtent",null),g=(0,I._)([(0,o.$)("esri.views.layers.LayerView")],g);const A=g},66727:(pt,it,y)=>{y.d(it,{A:()=>u});var I=y(8189),Z=y(71065),W=y(85211),rt=(y(3248),y(35150),y(40707),y(76576));let U=class extends Z.oY{get version(){return this.commitVersionProperties(),(this._get("version")||0)+1}};(0,I._)([(0,W.MZ)({readOnly:!0})],U.prototype,"version",null),U=(0,I._)([(0,rt.$)("esri.views.layers.support.ClipArea")],U);const u=U},75644:(pt,it,y)=>{y.d(it,{A:()=>T});var m,I=y(8189),W=(y(21152),y(85211)),rt=(y(3248),y(35150),y(40707),y(76576)),U=y(68643),u=y(61320),f=y(66727),o=y(28067),l=y(55861);const g={base:U.A,key:"type",typeMap:{extent:o.A,polygon:l.A}};let A=m=class extends f.A{constructor(k){super(k),this.type="geometry",this.geometry=null}clone(){return new m({geometry:this.geometry?.clone()??null})}commitVersionProperties(){this.commitProperty("geometry")}};(0,I._)([(0,W.MZ)({types:g,json:{read:u.rS,write:!0}})],A.prototype,"geometry",void 0),A=m=(0,I._)([(0,rt.$)("esri.views.layers.support.Geometry")],A);const T=A},6558:(pt,it,y)=>{function I(u){return u&&"function"==typeof u.highlight}function G(u,f){if(f&&u){const{minScale:o,maxScale:l}=u;if(function K(u,f){return null!=u&&u>0||null!=f&&f>0}(o,l))return function W(u,f,o){return null==u||u>=o&&(0===f||u<=f)}(f,o,l)}return!0}function Y(u){return!u?.minScale||!u.maxScale||u.minScale>=u.maxScale}y.d(it,{E5:()=>G,Of:()=>I,g7:()=>Y})}}]);