"use strict";(self.webpackChunkangular_18_test=self.webpackChunkangular_18_test||[]).push([[2137],{52137:(T,I,y)=>{y.r(I),y.d(I,{default:()=>F});var P=y(8189),J=y(89563),R=y(98877),w=y(35150),L=y(56492),M=y(48900),V=y(3804),U=y(85211),W=(y(3248),y(40707),y(76576)),_=y(48600),D=y(94542);class j extends D.B{constructor(s){super("Lyr3DWorker","process",{process:o=>o.inputs},s,{hasInitialize:!0})}destroyWasm(){return this.broadcast({},"destroyWasm")}}var g,h,t,S=y(62200),x=y(73812);(t=g||(g={}))[t.Lifetime=0]="Lifetime",t[t.Jobs=1]="Jobs",t[t.Renderables=2]="Renderables",function(t){t[t.Critical=0]="Critical",t[t.Error=1]="Error",t[t.Warning=2]="Warning",t[t.Info=3]="Info"}(h||(h={}));let p=class extends R.A{constructor(t){super(t),this._lyr3DMainPromise=null,this._lyr3DMain=null,this._layers=new Map,this._debugFlags=new Set,this._debugLevel=h.Critical,this._wasmNotLoaded="method requiring WASM was called when WASM isn't loaded",this._pulseTaskHandle=null,this._session=null,this._debugFlags.add(g.Lifetime),this._debugFlags.add(g.Jobs),this._debugFlags.add(g.Renderables)}_debugLog(t,s,o,d=!0){if(this._debugFlags.has(t)&&this._debugLevel>=s){const u=d?`[js] ${o}`:`${o}`;s===h.Critical||s===h.Error?w.A.getLogger(this).error(u):s===h.Warning&&w.A.getLogger(this).warn(u),w.A.getLogger(this).info(u)}}initialize(){this._debugLevel>h.Warning&&(w.A.getLogger(this).level="info"),this._debugLog(g.Lifetime,h.Info,"Lyr3DWasmPerSceneView.initialize()"),this.addHandles([(0,M.wB)(()=>this.view.state?.contentCamera,()=>this._updateWasmCamera())]),this._pulseTaskHandle=(0,V.mg)({preRender:()=>this._pulseTask()})}destroy(){this._debugLog(g.Lifetime,h.Info,"Lyr3DWasmPerSceneView.destroy()"),this._lyr3DMain&&(this._layers.forEach(s=>{s.abortController.abort()}),this._lyr3DMain.uninitialize_lyr3d_wasm(),this._lyr3DMain=null);const t=this._worker;t&&t.destroyWasm().then(()=>{this._worker?.destroy(),this._worker=null}),this._pulseTaskHandle?.remove(),this._pulseTaskHandle=null}add3DTilesLayerView(t){return this._lyr3DMain?this._add3DTilesLayerView(t):(this._debugLog(g.Lifetime,h.Error,"Lyr3DWasmPerSceneView.add3DTilesLayerView() called when WASM wasn't initialized"),_.vE)}remove3DTilesLayerView(t){if(!this._lyr3DMain)return this._debugLog(g.Lifetime,h.Error,this._wasmNotLoaded),0;this._doRemoveLayerView(t);const s=this._layers.size;return 0===s&&(this._debugLog(g.Lifetime,h.Info,"Lyr3DWasmPerSceneView.remove3DTilesLayerView() no Lyr3D layers left after removing a layer, destroying"),this.destroy()),s}setEnabled(t,s){if(!this._lyr3DMain)return void this._debugLog(g.Lifetime,h.Error,this._wasmNotLoaded);const o=this._layers.get(t.wasmLayerId);o&&(this._lyr3DMain.set_enabled(t.wasmLayerId,s),o.needMemoryUsageUpdate=!0,o.needFrame=!0,o.layerView.updatingFlagChanged())}setLayerOffset(t,s){this._lyr3DMain?this._layers.get(t.wasmLayerId)&&this._lyr3DMain.set_carto_offset_z(t.wasmLayerId,s):this._debugLog(g.Lifetime,h.Error,this._wasmNotLoaded)}getAttributionText(){return this._lyr3DMain?this._lyr3DMain.get_current_attribution_text().split("|"):(this._debugLog(g.Lifetime,h.Error,this._wasmNotLoaded),[])}onRenderableEvicted(t,s,o){this._lyr3DMain?this._layers.get(t.wasmLayerId)&&this._lyr3DMain.on_renderable_evicted(t.wasmLayerId,s,o):this._debugLog(g.Lifetime,h.Error,this._wasmNotLoaded)}isUpdating(t){if(!this._lyr3DMain&&this._lyr3DMainPromise)return!0;const s=this._layers.get(t);return!!s&&(s.outstandingJobCount>0||s.outstandingRenderableCount>0||s.needFrame)}initializeWasm(){return this._lyr3DMain?Promise.resolve():(this._debugLog(g.Lifetime,h.Info,"Lyr3DWasmPerSceneView.initializeWasm()"),this._lyr3DMainPromise||(this._lyr3DMainPromise=(0,S.a)().then(t=>{this._lyr3DMain=t,this._lyr3DMainPromise=null;const s=this._lyr3DMain.addFunction(this._onNewJob.bind(this),"v"),o=this._lyr3DMain.addFunction(this._onNewRenderable.bind(this),"v"),d=this._lyr3DMain.addFunction(this._freeRenderables.bind(this),"viii"),u=this._lyr3DMain.addFunction(this._setRenderableVisibility.bind(this),"viiii"),f=this._lyr3DMain.addFunction(this._onWasmError.bind(this),"viiii"),i="global"===this.view.viewingMode,r=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1,a=this.view.heightModelInfo?.heightModel;return this._lyr3DMain.initialize_lyr3d_wasm(f,s,o,d,u,i,!a||"gravity-related-height"===a,r,this._debugLevel)?(this._worker=new j(function E(t){return s=>{if(t.immediate)return t.immediate.schedule(s);const o="No immediate scheduler";throw console.error(o),new Error(o)}}(this.view.resourceController)),this._worker.promise?this._worker.promise:void 0):(this._lyr3DMain=null,void this._debugLog(g.Lifetime,h.Critical,"Lyr3d Main WASM failed to initialize",!1))}).catch(t=>{this._debugLog(g.Lifetime,h.Critical,`Lyr3d WASM failed to download error = ${t}`,!1)})),this._lyr3DMainPromise)}_pulseTask(){if(this._lyr3DMain){let t=0,s=0;this._layers.forEach(u=>{t+=u.layerView.usedMemory,s+=u.layerView.unloadedMemory}),t/=1048576,s/=1048576;const o=this.view.resourceController.memoryController;this._lyr3DMain.frame_pulse(o.memoryFactor,t,s,o.usedMemory*o.maxMemory-t,o.maxMemory),this._layers.forEach(u=>{!0===u.needFrame&&(u.needFrame=!1,u.layerView.updatingFlagChanged())})}}_incrementJobCount(t){t.outstandingJobCount+=1,1===t.outstandingJobCount&&t.outstandingRenderableCount<1&&t.layerView.updatingFlagChanged()}_decrementJobCount(t){t.outstandingJobCount-=1,0===t.outstandingJobCount&&t.outstandingRenderableCount<1&&t.layerView.updatingFlagChanged()}_incrementRenderableCount(t){t.outstandingRenderableCount+=1,t.outstandingJobCount<1&&1===t.outstandingRenderableCount&&t.layerView.updatingFlagChanged()}_decrementRenderableCount(t){t.outstandingRenderableCount-=1,t.outstandingJobCount<1&&0===t.outstandingRenderableCount&&t.layerView.updatingFlagChanged()}_onJobFailed(t,s,o){s.error.length&&this._debugLog(g.Jobs,h.Error,s.error,!1),this._lyr3DMain&&this._lyr3DMain.on_job_failed(o.jobId,o.desc),this._decrementJobCount(t)}_onJobSucceeded(t,s,o){if(this._lyr3DMain){const d=s.data.byteLength,u=this._lyr3DMain._malloc(d);new Uint8Array(this._lyr3DMain.HEAPU8.buffer,u,d).set(s.data),this._lyr3DMain.on_job_completed(o.jobId,s.jobDescJson,u,d),this._lyr3DMain._free(u)}this._decrementJobCount(t)}_getRequestPromises(t,s,o){const d=[];for(const u of t){const f=new URL(u),i=f.searchParams.get("session");i?this._session=i:!this._session||f.origin===o.origin&&f.pathname===o.pathname||f.searchParams.append("session",this._session),d.push((0,J.A)(f.toString(),s).then(r=>r.data))}return d}_onNewJob(){const t=this._lyr3DMain.get_next_job(),s=this._layers.get(t.layerId);if(!s)return;this._incrementJobCount(s);const o=s.abortController.signal,d={responseType:"array-buffer",signal:o,query:{...s.customParameters,token:s.apiKey}},u={inputs:[],jobDescJson:t.desc,isMissingResourceCase:!1},f=new URL(s.layerView.layer.url),i=this._getRequestPromises(t.urls,d,f);Promise.all(i).then(r=>(u.inputs=r,this._worker.invoke(u,o))).then(r=>r).catch(r=>((0,L.zf)(r)?this._debugLog(g.Jobs,h.Warning,`job ${t.jobId} was cancelled.`):this._debugLog(g.Jobs,h.Error,`job ${t.jobId} failed with error ${r}.`),{status:_.Qg.Failed,error:"",jobDescJson:"",data:new Uint8Array(0),missingInputUrls:[],inputs:[]})).then(r=>{if(r.status===_.Qg.Failed)this._onJobFailed(s,r,t);else if(r.status===_.Qg.Succeeded)this._onJobSucceeded(s,r,t);else if(r.status===_.Qg.MissingInputs){const a=this._getRequestPromises(r.missingInputUrls,d,f);Promise.all(a).then(l=>{u.jobDescJson=r.jobDescJson,u.inputs=r.originalInputs?r.originalInputs:[],u.isMissingResourceCase=!0;for(const c of l)u.inputs.push(c);return this._worker.invoke(u,o)}).then(l=>{l.status===_.Qg.Failed?this._onJobFailed(s,l,t):l.status===_.Qg.Succeeded&&this._onJobSucceeded(s,l,t)}).catch(l=>{this._decrementJobCount(s),(0,L.zf)(l)?this._debugLog(g.Jobs,h.Warning,`job ${t.jobId} was cancelled.`):this._debugLog(g.Jobs,h.Error,`job ${t.jobId} failed with error2 ${l}.`),this._lyr3DMain&&this._lyr3DMain.on_job_failed(t.jobId,t.desc)})}})}_onNewRenderable(){const t=this._lyr3DMain.get_next_renderable(),s=t.meshData;if(s.data&&s.data.byteLength>0){const d=s.data.slice();s.data=d}const o=this._layers.get(t.layerId);o&&(this._incrementRenderableCount(o),o.layerView.createRenderable(t).then(d=>{this._lyr3DMain&&this._lyr3DMain.on_renderable_created(!0,t.layerId,t.handle,d.memUsageBytes),this._decrementRenderableCount(o)}).catch(d=>{(0,L.zf)(d)||this._debugLog(g.Renderables,h.Error,`createRenderable failed with error ${d}.`),this._lyr3DMain&&this._lyr3DMain.on_renderable_created(!1,t.layerId,t.handle,0),this._decrementRenderableCount(o)}))}_freeRenderables(t,s,o){if(o<1)return;const d=this._layers.get(t);if(!d)return;const u=d.layerView,f=[],i=new Uint32Array(this._lyr3DMain.HEAPU32.buffer,s,o);for(let r=0;r<o;++r)f.push(i[r]);for(let r=0;r<o;++r)u.freeRenderable(f[r])}_setRenderableVisibility(t,s,o,d){if(d<1)return;const u=this._layers.get(t);if(!u)return;const f=u.layerView,i=[],r=[],a=new Uint32Array(this._lyr3DMain.HEAPU32.buffer,s,d),l=new Uint8Array(this._lyr3DMain.HEAPU8.buffer,o,d);for(let c=0;c<d;++c)i.push(a[c]),r.push(1===l[c]);f.setRenderableVisibility(i,r,d)}_onWasmError(t,s,o,d){this._lyr3DMain&&this._debugLog(o,d,this._lyr3DMain.UTF8ToString(t,s),!1)}_doRemoveLayerView(t){const s=this._layers.get(t.wasmLayerId);return!!s&&(s.abortController.abort(),this._lyr3DMain.remove_layer(t.wasmLayerId),this._layers.delete(t.wasmLayerId),!0)}_add3DTilesLayerView(t){const s=t.layer;if(!s.url)return _.Pl;const o=this._lyr3DMain.get_next_layer_id(),d=new AbortController;this._layers.set(o,{layerView:t,abortController:d,needMemoryUsageUpdate:!1,outstandingJobCount:0,outstandingRenderableCount:0,customParameters:s.customParameters,apiKey:s.apiKey,needFrame:!1});const u=(0,x.M7)(s.elevationInfo);return this._lyr3DMain.add_layer(s.url,o,u)?(this._updateWasmCamera(),o):(this._layers.delete(o),_.Pl)}_updateWasmCamera(){const t=this.view.state?.contentCamera;if(!t||!this._lyr3DMain)return;const{eye:s,center:o,up:d,near:u,far:f,fovY:i}=t;this._lyr3DMain.set_camera_parameters({eye:s,center:o,up:d,near:u,far:f,fov:i,aspectRatio:t.width/t.height,viewport:[t.viewport[2],t.viewport[3]]})}};(0,P._)([(0,U.MZ)({constructOnly:!0})],p.prototype,"view",void 0),p=(0,P._)([(0,W.$)("esri.layers.Lyr3DWasmPerSceneView")],p);const F=p},73812:(T,I,y)=>{y.d(I,{$7:()=>t,B:()=>F,M7:()=>d,XF:()=>o,tW:()=>s,w7:()=>M}),y(82663);var J=y(82575);function M(i,r){return function w(i,r){return r?.mode?r.mode:function R(i){return i?u:f}(i).mode}(null!=i&&i.hasZ,r)}function F(i,r,a){return a&&a.mode!==r?`${i} only support ${r} elevation mode`:null}function t(i,r,a){return a?.mode===r?`${i} do not support ${r} elevation mode`:null}function s(i,r){return null!=r?.featureExpressionInfo&&"0"!==r.featureExpressionInfo.expression?`${i} do not support featureExpressionInfo`:null}function o(i,r){r&&i.warn(".elevationInfo=",r)}function d(i){return(i?.offset??0)*(0,J.Ao)(i?.unit)}const u={mode:"absolute-height",offset:0},f={mode:"on-the-ground",offset:null}}}]);