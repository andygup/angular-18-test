"use strict";(self.webpackChunkangular_18_test=self.webpackChunkangular_18_test||[]).push([[497],{10497:(Ke,ke,m)=>{m.r(ke),m.d(ke,{default:()=>Qe});var oe,e,G=m(10467),H=m(8189),be=(m(21152),m(31178)),re=m(5922),Y=m(35150),Ge=m(60797),He=m(56492),Z=m(85211),Ue=(m(3248),m(40707),m(76576)),Ze=m(95478),_=m(31732),Ae=m(13682);(e=oe||(oe={})).MULTIPLIER="multiplier",e.ABSOLUTE="absoluteValue";var c=m(44797),le=m(85574),Se=m(81308),Fe=m(93410),Be=m(33036),Oe=m(90261);let he,h=null;var Q,se,ue,de,ye,ce,pe,ge,De,xe,Ne;function q(e,t,n,a,i,r){const o=n.length,y=i.length,f=Float64Array.BYTES_PER_ELEMENT,M=Uint32Array.BYTES_PER_ELEMENT,E=Uint8Array.BYTES_PER_ELEMENT,D=h._malloc(16+o*(E+2*f)+y*(2*M));try{const C=D+16-D%16,u=C+o*f,v=u+o*f,k=v+y*M,T=k+y*M,w=()=>[h.HEAPF64.subarray(C>>3,(C>>3)+o),h.HEAPF64.subarray(u>>3,(u>>3)+o),h.HEAPU32.subarray(v>>2,(v>>2)+y),h.HEAPU32.subarray(k>>2,(k>>2)+y),h.HEAPU8.subarray(T,T+o)],[g,x,S,U,F]=w();g.set(n),x.set(a),S.set(i),U.set(r),F.set(t);let N=e(o,T,C,u,y,v,k),B=null,A=null;if(N){const d=h.getLayoutLinksTypes(),l=h.getLayoutLinksVerticesEndIndices(),I=h.getLayoutLinksVertices(),j=h.countLayoutLinksVertices();!y||d&&l?j&&!I?N=!1:(B={types:new Uint8Array(h.HEAPU8.subarray(d,d+y)),vertexEndIndex:new Uint32Array(h.HEAPU32.subarray(l>>2,(l>>2)+y)),vertices:new Float64Array(h.HEAPF64.subarray(I>>3,(I>>3)+2*j))},A=h.getAuxiliaryGraphicElements()):N=!1}const[z,V,$,W,s]=w();return n.set(z),a.set(V),i.set($),r.set(W),t.set(s),{success:N,links:B,graphics:A}}finally{h._free(D),h.cleanupLayout()}}(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"})(Q||(Q={})),function(e){e[e.Regular=0]="Regular",e[e.Orthogonal=1]="Orthogonal",e[e.Curved=2]="Curved",e[e.Recursive=3]="Recursive"}(se||(se={})),function(e){e.getMinIdealEdgeLength=function t(){return h.getMinIdealEdgeLength()},e.apply=function n(a,i,r,o,y,f=2,M=1,E=-1){return q((p,L,D,C,u,v,k)=>h.applyForceDirectedLayout(p,L,D,C,u,v,k,f,M,E),a,i,r,o,y)}}(ue||(ue={})),function(e){e.apply=function t(n,a,i,r,o,y=2,f=1,M=-1){return q((E,p,L,D,C,u,v)=>h.applyCommunityLayout(E,p,L,D,C,u,v,y,f,M),n,a,i,r,o)}}(de||(de={})),function(e){e.apply=function t(n,a,i,r,o){return q(h.applySimpleLayout,n,a,i,r,o)}}(ye||(ye={})),function(e){e.apply=function t(n,a,i,r,o){return q(h.applyHierarchicalLayout,n,a,i,r,o)}}(ce||(ce={})),function(e){e.apply=function t(n,a,i,r,o){return q(h.applyRadialTreeLayout,n,a,i,r,o)}}(pe||(pe={})),function(e){e.apply=function t(n,a,i,r,o){return q(h.applySmartTreeLayout,n,a,i,r,o)}}(ge||(ge={})),function(e){e.apply=function t(n,a,i,r,o,y,f,M,E){return q((p,L,D,C,u,v,k)=>{if(r.length!==p||o.length!==p||M.length!==u||E.length!==u)return!1;const T=Float64Array.BYTES_PER_ELEMENT,w=16,g=h._malloc(w+p*T),x=h._malloc(w+p*T),S=h._malloc(w+u*T),U=h._malloc(w+u*T),F=g+w-g%w,N=x+w-x%w,B=S+w-S%w,A=U+w-U%w;try{return h.HEAPF64.subarray(F>>3,(F>>3)+p).set(r),h.HEAPF64.subarray(N>>3,(N>>3)+p).set(o),h.HEAPF64.subarray(B>>3,(B>>3)+u).set(M),h.HEAPF64.subarray(A>>3,(A>>3)+u).set(E),h.applyChronologicalLayout(p,L,D,C,F,N,u,v,k,B,A)}finally{h._free(g),h._free(x),h._free(S),h._free(U)}},n,a,i,y,f)}}(De||(De={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(xe||(xe={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(Ne||(Ne={}));var Ye=m(328),Re=m(28067),Ie=m(1749),Pe=m(93615);let R=class extends((0,Fe.dM)((0,Be.j)(Ze.A))){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new be.A,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new Re.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new be.A,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new re.A("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){if(!this.title&&this.url){const r=this.url.split("/");this.title=r[r.length-2]}const t=new Set;let n=[],a=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new re.A("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");e.knowledgeGraph.dataModel.entityTypes?.forEach(r=>{r.name&&this._graphTypeLookup.set(r.name,r)}),e.knowledgeGraph.dataModel.relationshipTypes?.forEach(r=>{r.name&&this._graphTypeLookup.set(r.name,r)}),e.inclusionModeDefinition?.generateAllSublayers?(n=e.knowledgeGraph.dataModel.entityTypes??[],a=e.knowledgeGraph.dataModel.relationshipTypes??[]):e.inclusionModeDefinition?.namedTypeDefinitions&&e.inclusionModeDefinition?.namedTypeDefinitions.size>0?e.inclusionModeDefinition?.namedTypeDefinitions.forEach((r,o)=>{const y=this._graphTypeLookup.get(o);if(!y)return Y.A.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't in the data model and will be removed`),void e.inclusionModeDefinition?.namedTypeDefinitions.delete(o);"relationship"===y.type?t.has(o)||(t.add(o),a.push(y)):"entity"===y.type?t.has(o)||(t.add(o),n.push(y)):(Y.A.getLogger(this).warn(`A named type, ${o}, was in the inclusion list that wasn't properly modeled and will be removed`),e.inclusionModeDefinition?.namedTypeDefinitions.delete(o))}):(n=e.knowledgeGraph.dataModel.entityTypes??[],a=e.knowledgeGraph.dataModel.relationshipTypes??[]);const i=new c.PB({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=n,this.memberRelationshipTypes=a,this.dataManager=i}load(e){var t=this;return this.addResolvingPromise(new Promise(n=>{(0,Ye.fetchKnowledgeGraph)(this.url).then(a=>{this._initializeLayerProperties({knowledgeGraph:a,inclusionModeDefinition:this._originalInclusionList}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},this.dataManager.knowledgeGraph.dataModel.entityTypes?.forEach(i=>{i.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(i.name,{useAllData:!0})}),this.dataManager.knowledgeGraph.dataModel.relationshipTypes?.forEach(i=>{i.name&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.set(i.name,{useAllData:!0})})),this.dataPreloadedInLocalCache?(this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach(i=>{i.useAllData=!1,i.members?.forEach(r=>{let o;o=r.linkChartLocation instanceof Ae.A?r.linkChartLocation:r.linkChartLocation?(0,_.Ux)(r.linkChartLocation):null,o&&2===o.coords.length&&0===o.lengths.length?this.entityLinkChartDiagramLookup.set(r.id,o):this.relationshipLinkChartDiagramLookup.set(r.id,o)}),this.addResolvingPromise(this._initializeDiagram().then((0,G.A)(function*(){t.layers.forEach(function(){var r=(0,G.A)(function*(o){yield o.refreshCachedQueryEngine()});return function(o){return r.apply(this,arguments)}}()),t.tables.forEach(function(){var r=(0,G.A)(function*(o){yield o.refreshCachedQueryEngine()});return function(o){return r.apply(this,arguments)}}())})))})):this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,"GEOGRAPHIC"===this.defaultLinkChartConfig?.layoutMode,!0).then((0,G.A)(function*(){(0,He.Te)(e);const r=[],o=[];t.loadLayerAssumingLocalCache(),t.dataManager.inclusionModeDefinition&&(t.dataManager.inclusionModeDefinition.generateAllSublayers=!1,t.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach(y=>{y.useAllData=!1})),yield t._initializeDiagram(),t.layers.forEach(y=>{o.push(y.refreshCachedQueryEngine()),r.push(new Promise(f=>{y.on("layerview-create",()=>{f(null)})}))}),t.tables.forEach(y=>{o.push(y.refreshCachedQueryEngine())}),yield Promise.all(o)}))),n(null)})})),Promise.resolve(this)}addRecords(e,t){var n=this;return(0,G.A)(function*(){let a=[];t?.cascadeAddRelationshipEndNodes&&n.dataManager.knowledgeGraph.dataModel&&(a=yield(0,Se.aq)(e,n.dataManager.knowledgeGraph));const i=e.concat(a).filter(r=>!n.sublayerIdsCache.get(r.typeName)?.has(r.id));yield n._handleNewRecords(i)})()}removeRecords(e,{cascadeRemoveRelationships:t=!0,recalculateLayout:n=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){var a=this;return(0,G.A)(function*(){let i=[];for(const o of e)!1===a.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(o.typeName)?.useAllData&&a.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(o.typeName)?.members?.has(o.id)&&i.push(o);if(t){const o=new Set,y=[];for(const f of i)if(a.dataManager.nodeConnectionsLookup.has(f.id))for(const M of a.dataManager.nodeConnectionsLookup.get(f.id))o.add(M);for(const f of o)if(a.dataManager.memberIdTypeLookup.has(f))for(const M of a.dataManager.memberIdTypeLookup.get(f))a.dataManager.relationshipTypeNames.has(M)&&y.push({id:f,typeName:M});i=i.concat(y)}a.dataManager.removeFromLayer(i);for(const o of i)a.sublayerIdsCache.get(o.typeName)?.delete(o.id),a.dataManager.relationshipTypeNames.has(o.typeName)?a.relationshipLinkChartDiagramLookup.delete(o.id):a.entityLinkChartDiagramLookup.delete(o.id);n&&(yield a.calculateLinkChartLayout(a._currentLinkChartConfig.layoutMode,a._currentLinkChartConfig.layoutOptions));const r=[];return a.layers.forEach(o=>{r.push(o.refreshCachedQueryEngine())}),yield Promise.all(r),a._refreshNamedTypes(),i})()}expand(e,t){var n=this;return(0,G.A)(function*(){const a=yield n.dataManager.getConnectedRecordIds(e,t),i=a.filter(r=>!n.sublayerIdsCache.get(r.typeName)?.has(r.id));return yield n._handleNewRecords(a),{records:i}})()}loadLayerAssumingLocalCache(){this.memberRelationshipTypes.forEach(e=>{const t=new le.A({objectType:e,parentCompositeLayer:this,graphType:"relationship",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.memberEntityTypes.forEach(e=>{const t=new le.A({objectType:e,parentCompositeLayer:this,graphType:"entity",title:e.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(e.name)||this.dataManager.sublayerCaches.set(e.name,new Map)}),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((e,t)=>{const n=(0,Ge.tE)(this.sublayerIdsCache,t,()=>new Set);e.members?.forEach(a=>{if(n.add(a.id),a.linkChartLocation)if(a.linkChartLocation instanceof Ae.A)this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(a.id,a.linkChartLocation):this.entityLinkChartDiagramLookup.set(a.id,a.linkChartLocation);else{const i=(0,_.Ux)(a.linkChartLocation);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(a.id,a.linkChartLocation?i:null):this.entityLinkChartDiagramLookup.set(a.id,a.linkChartLocation?i:null)}})})}calculateLinkChartLayout(e="RADIAL_TREE",t){var n=this;return(0,G.A)(function*(){const a=[],i=[],r=[];n.dataManager.sublayerCaches.forEach((s,d)=>{n.dataManager.entityTypeNames.has(d)?s.forEach(l=>{a.push({typeName:d,feature:l})}):n.dataManager.relationshipTypeNames.has(d)&&s.forEach(l=>{i.push({typeName:d,feature:l})})}),n.entityLinkChartDiagramLookup=new Map,n.relationshipLinkChartDiagramLookup=new Map;const o=new Map,y=new Map,f=new Map,M=new Map,E=new Uint8Array(a.length),p=new Float64Array(a.length),L=new Float64Array(a.length),D=new Uint32Array(i.length),C=new Uint32Array(i.length),u=[],k=new Re.A({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let T,w="FORCE_DIRECTED",g=0,x=0;switch(w="GEOGRAPHIC"===e?"FORCE_DIRECTED":e,w){case"FORCE_DIRECTED":T=ue.apply;break;case"COMMUNITY":T=de.apply;break;case"HIERARCHICAL":T=ce.apply;break;case"RADIAL_TREE":T=pe.apply;break;case"SMART_TREE":T=ge.apply;break;default:T=ye.apply}a.forEach(({typeName:s,feature:d})=>{if(t?.lockedNodeLocations?.has(d.attributes[c.yC])){E[g]="GEOGRAPHIC"===e&&n.dataManager.geographicLookup.has(s)?Q.IsGeographic:Q.None;const l=t.lockedNodeLocations.get(d.attributes[c.yC]);p[g]=l.x,L[g]=l.y}else if("GEOGRAPHIC"===e&&n.dataManager.geographicLookup.has(s)){E[g]=Q.IsGeographic;let l=null;const I=d.attributes[n.dataManager.geographicLookup.get(s).name];switch(n.dataManager.geographicLookup.get(s)?.geometryType){case"esriGeometryPoint":p[g]=I?.x,L[g]=I?.y;break;case"esriGeometryPolygon":l=I?.centroid,null!=l?.x&&null!=l?.y?(p[g]=l.x,L[g]=l.y):E[g]=Q.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":l=I?.extent?.center,null!=l?.x&&null!=l?.y?(p[g]=l.x,L[g]=l.y):E[g]=Q.IsMovable;break;default:E[g]=Q.IsMovable}(null==p[g]||null==L[g]||Number.isNaN(p[g])||Number.isNaN(L[g]))&&(E[g]=Q.IsMovable,p[g]=0,L[g]=0)}else E[g]=Q.IsMovable,p[g]=0,L[g]=0;M.set(d.attributes[c.yC],g),u[g]={feature:d,typeName:s},g++});let S=!1;const U=new Map;i.forEach(s=>{const d=s.feature.attributes[c.Vr],l=s.feature.attributes[c.ZL],I=M.get(d),j=M.get(l);if(void 0!==I&&void 0!==j){const P=d+"-"+l,O=U.get(P);O?.has(s.typeName)||(D[x]=I,C[x]=j,void 0===O?U.set(P,new Map([[s.typeName,x]])):O.set(s.typeName,x),x++),r.push(s)}else S=!0,n.relationshipLinkChartDiagramLookup.set(d,null)}),S&&Y.A.getLogger(n).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");const F=n._validateLayoutSettings(e,t),N=n._convertLayoutSettingsToCalculationSettings(F);yield function ze(){return he||(he=m.e(1538).then(m.bind(m,71538)).then(e=>e.l).then(({default:e})=>e({locateFile:t=>(0,Oe.s)(`esri/libs/linkchartlayout/${t}`)})).then(e=>{!function je(e){h=e}(e)}),he)}();const{success:B,links:A}=T(E,p,L,D.subarray(0,x),C.subarray(0,x),N.computationBudgetTime,N.idealEdgeLengthMultiplier,N.repulsionRadiusMultiplier);if(!B)throw new re.A("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let s=0;s<u.length;s++){if(L[s]>84.9999?L[s]=84.9999:L[s]<-84.9999&&(L[s]=-84.9999),p[s]>179.9999?p[s]=179.9999:p[s]<-179.9999&&(p[s]=-179.9999),u[s].feature.attributes[c.sZ]=new Ie.A(p[s],L[s]),o.has(u[s].typeName))o.get(u[s].typeName)?.set(u[s].feature.attributes[c.yC],u[s].feature);else{const l=new Map;l.set(u[s].feature.attributes[c.yC],u[s].feature),o.set(u[s].typeName,l)}f.set(u[s].feature.attributes[c.yC],u[s].feature);const d=(0,_.Ux)(u[s].feature.attributes[c.sZ]);n.entityLinkChartDiagramLookup.set(u[s].feature.attributes[c.yC],u[s].feature.attributes[c.sZ]?d:null),u[s].feature.attributes[c.sZ].x<k.xmin&&(k.xmin=u[s].feature.attributes[c.sZ].x),u[s].feature.attributes[c.sZ].x>k.xmax&&(k.xmax=u[s].feature.attributes[c.sZ].x),u[s].feature.attributes[c.sZ].y<k.ymin&&(k.ymin=u[s].feature.attributes[c.sZ].y),u[s].feature.attributes[c.sZ].y>k.ymax&&(k.ymax=u[s].feature.attributes[c.sZ].y)}if(n.linkChartExtent.xmin=k.xmin,n.linkChartExtent.xmax=k.xmax,n.linkChartExtent.ymin=k.ymin,n.linkChartExtent.ymax=k.ymax,!A)throw new re.A("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const z=new Map,V=new Map,$=new Map,W=new Set;for(let s=0;s<r.length;s++){const d=[],l=r[s],I=l.feature.attributes[c.Vr],j=l.feature.attributes[c.ZL],P=I+"-"+j,O=U.get(P).get(l.typeName),J=0===O?0:A?.vertexEndIndex[O-1];if(!W.has(O)){if(W.add(O),A.types[O]===se.Recursive){const b=[A.vertices[2*J],A.vertices[2*J+1]],ie=[A.vertices[2*(J+1)],A.vertices[2*(J+1)+1]],X=[.5*(b[0]+ie[0]),.5*(b[1]+ie[1])],te=[X[0]-b[0],X[1]-b[1]],Me=[X[0]+te[1],X[1]-te[0]],Ee=[X[0]-te[1],X[1]+te[0]];d.push(b),d.push(Me),d.push(ie),d.push(Ee),d.push(b)}else{if(A.types[O]!==se.Regular){Y.A.getLogger(n).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let b=J;b<A.vertexEndIndex[O];b++)d.push([A.vertices[2*b],A.vertices[2*b+1]])}const K=u[M.get(I)]?.feature.attributes[c.sZ],ee=u[M.get(j)]?.feature.attributes[c.sZ];d[0][0]===K.x&&d[0][1]===K.y||(d[0]=[K.x,K.y]),d[d.length-1][0]===ee.x&&d[d.length-1][1]===ee.y||(d[d.length-1]=[ee.x,ee.y]);for(let b=1;b<d.length-1;b++)d[b][1]>85.5?d[b][1]=85.5:d[b][1]<-85.5&&(d[b][1]=-85.5),d[b][0]>179.9999?d[b][0]=179.9999:d[b][0]<-179.9999&&(d[b][0]=-179.9999);z.has(P)?z.get(P).push(d):z.set(P,[d])}const fe=z.get(P);V.has(P)||(V.set(P,new Map),$.set(P,new Map));const ae=V.get(P),ne=$.get(P);ae.has(l.typeName)||(ae.set(l.typeName,fe.shift()),ne.set(l.typeName,0));const me=ae.get(l.typeName);ne.set(l.typeName,ne.get(l.typeName)+1);const Le=new Pe.A({paths:me});if(l.feature.attributes[c.sZ]=Le,y.has(l.typeName))y.get(l.typeName)?.set(l.feature.attributes[c.yC],l.feature);else{const K=new Map;K.set(l.feature.attributes[c.yC],l.feature),y.set(l.typeName,K)}f.set(l.feature.attributes[c.yC],l.feature);const Ce=(0,_.Ux)(l.feature.attributes[c.sZ]);n.relationshipLinkChartDiagramLookup.set(l.feature.attributes[c.yC],l.feature.attributes[c.sZ]?Ce:null)}for(const s of r)s.feature.attributes[c.d4]=$.get(s.feature.attributes[c.Vr]+"-"+s.feature.attributes[c.ZL])?.get(s.typeName)??null;return n._currentLinkChartConfig={layoutMode:e,layoutOptions:F},{nodes:o,links:y,idMap:f}})()}applyNewLinkChartLayout(e="RADIAL_TREE",t){var n=this;return(0,G.A)(function*(){const a=[];yield n.calculateLinkChartLayout(e,t),n.layers.forEach(i=>{a.push(i.refreshCachedQueryEngine())}),yield Promise.all(a),n._refreshNamedTypes()})()}getCurrentNodeLocations(){const e=new Map;return this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach(t=>{t?.members?.forEach(n=>{const a=n.linkChartLocation;let i;a&&(i="x"in a?{x:a.x,y:a.y}:{x:a.coords[0],y:a.coords[1]},e.set(n.id,new Ie.A({x:i.x,y:i.y})))})}),e}synchronizeInclusionListWithCache(){var e=this;return(0,G.A)(function*(){return new Promise(t=>{e.dataManager.inclusionModeDefinition?.namedTypeDefinitions.forEach((n,a)=>{if(n.useAllData=!1,n.members&&n.members.size>0){if(!e.dataManager.sublayerCaches.get(a))return;const i=new Set(Array.from(e.dataManager.sublayerCaches.get(a).keys()));Array.from(n.members.keys()).filter(r=>!i.has(r)).forEach(r=>{n.members?.delete(r)})}}),t()})})()}refreshLinkChartCache(e){var t=this;return(0,G.A)(function*(){yield t.dataManager.refreshCacheContent(e);const n=[];t.layers.forEach(a=>{n.push(a.refreshCachedQueryEngine())}),yield Promise.all(n),t._refreshNamedTypes()})()}connectEntities(e){var t=this;return(0,G.A)(function*(){let n=[];for(const i of t.dataManager.relationshipTypeNames){const r=t.sublayerIdsCache.get(i);r&&(n=n.concat(Array.from(r.keys())))}const a=yield t.dataManager.getAttachedRelationships(e,n);return yield t._handleNewRecords(a),{records:a}})()}_handleNewRecords(e){var t=this;return(0,G.A)(function*(){const n=[];t.dataManager.addToLayer(e);for(const i of e)t.sublayerIdsCache.has(i.typeName)||(t.sublayerIdsCache.set(i.typeName,new Set),n.push(i.typeName)),t.sublayerIdsCache.get(i.typeName).add(i.id);for(const i of n){const r=t._graphTypeLookup.get(i);if(r){const o=new le.A({objectType:r,parentCompositeLayer:t,graphType:r.type,title:i});"entity"===r.type?t.dataManager.entityTypeNames.add(i):t.dataManager.relationshipTypeNames.add(i),o.geometryType?t.layers.push(o):t.tables.push(o),t.dataManager.sublayerCaches.set(i,new Map)}}yield t.dataManager.refreshCacheContent(e.map(i=>i.id));const a=Object.assign({},t._currentLinkChartConfig.layoutOptions);a.lockedNodeLocations=t.getCurrentNodeLocations(),yield t.applyNewLinkChartLayout(t._currentLinkChartConfig.layoutMode,a)})()}_initializeDiagram(){var e=this;return(0,G.A)(function*(){e.defaultLinkChartConfig?e.defaultLinkChartConfig.doNotRecalculateLayout?(e.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((t,n)=>{t?.members?.forEach(a=>{const i=a.linkChartLocation;let r;const o=a.id;if(!i)return;r="x"in i?{x:i.x,y:i.y}:{x:i.coords[0],y:i.coords[1]};const y=(0,_.Ux)(r);e.dataManager.relationshipTypeNames.has(n)?e.relationshipLinkChartDiagramLookup.set(o,y):e.entityLinkChartDiagramLookup.set(o,y),e.linkChartExtent.xmin>r.x&&(e.linkChartExtent.xmin=r.x),e.linkChartExtent.xmax<r.x&&(e.linkChartExtent.xmax=r.x),e.linkChartExtent.ymin>r.y&&(e.linkChartExtent.ymin=r.y),e.linkChartExtent.ymax<r.y&&(e.linkChartExtent.ymax=r.y)})}),e.memberRelationshipTypes.forEach(t=>{t.name&&e.dataManager.sublayerCaches.get(t.name)?.forEach(n=>{const a=e.relationshipLinkChartDiagramLookup.get(n.attributes[c.Vr]),i=e.relationshipLinkChartDiagramLookup.get(n.attributes[c.ZL]);if(a&&i){const r=(0,_.Ux)(new Pe.A({paths:[[a.coords[0],a.coords[1]],[i.coords[0],i.coords[1]]]}));e.relationshipLinkChartDiagramLookup.set(n.attributes[c.yC],r)}else e.relationshipLinkChartDiagramLookup.set(n.attributes[c.yC],null)})})):yield e.calculateLinkChartLayout(e.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:e.getCurrentNodeLocations(),...e.defaultLinkChartConfig.layoutOptions||{}}):yield e.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:e.getCurrentNodeLocations()})})()}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateLayoutSettings(e,t){const n=C=>"number"==typeof C&&!isNaN(C),y=new Set(["FORCE_DIRECTED","COMMUNITY","GEOGRAPHIC"]),f={};if(!y.has(e)||!t)return!y.has(e)&&t&&Y.A.getLogger(this).warn("Layout mode options were given for a layout mode that does not utilize them, settings will be ignored"),f;const{computationBudgetTime:M,repulsionRadiusMultiplier:E,idealEdgeLength:p,idealEdgeLengthType:L}=t;var C;n(C=M)&&C>=1?f.computationBudgetTime=M:void 0!==M&&Y.A.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),(C=>n(C)&&C>=1)(E)?f.repulsionRadiusMultiplier=E:void 0!==E&&Y.A.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting");const D=void 0!==p||void 0!==L;return"GEOGRAPHIC"!==e&&D?Y.A.getLogger(this).warn("Ideal edge length settings were specified for an incompatible layout mode, and will be ignored"):"GEOGRAPHIC"===e&&D&&((C=>Object.values(oe).includes(C))(L)?f.idealEdgeLengthType=L:void 0!==L&&Y.A.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),(C=>n(C)&&C>=0)(p)?f.idealEdgeLength=p:void 0!==p&&Y.A.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),f}_convertLayoutSettingsToCalculationSettings(e){let t=e.idealEdgeLength;return e.idealEdgeLengthType===oe.ABSOLUTE&&(void 0===t?t=-1:t*=-1),{computationBudgetTime:e.computationBudgetTime,repulsionRadiusMultiplier:e.repulsionRadiusMultiplier,idealEdgeLengthMultiplier:t}}};(0,H._)([(0,Z.MZ)()],R.prototype,"dataPreloadedInLocalCache",void 0),(0,H._)([(0,Z.MZ)()],R.prototype,"defaultLinkChartConfig",void 0),(0,H._)([(0,Z.MZ)()],R.prototype,"dataManager",void 0),(0,H._)([(0,Z.MZ)()],R.prototype,"knowledgeGraph",void 0),(0,H._)([(0,Z.MZ)()],R.prototype,"layers",void 0),(0,H._)([(0,Z.MZ)()],R.prototype,"entityLinkChartDiagramLookup",void 0),(0,H._)([(0,Z.MZ)()],R.prototype,"relationshipLinkChartDiagramLookup",void 0),(0,H._)([(0,Z.MZ)()],R.prototype,"linkChartExtent",void 0),(0,H._)([(0,Z.MZ)()],R.prototype,"memberEntityTypes",void 0),(0,H._)([(0,Z.MZ)()],R.prototype,"memberRelationshipTypes",void 0),(0,H._)([(0,Z.MZ)()],R.prototype,"sublayerIdsCache",void 0),(0,H._)([(0,Z.MZ)()],R.prototype,"tables",void 0),(0,H._)([(0,Z.MZ)({json:{read:!1}})],R.prototype,"type",void 0),R=(0,H._)([(0,Ue.$)("esri.layers.LinkChartLayer")],R);const Qe=R}}]);