"use strict";(self.webpackChunkangular_18_test=self.webpackChunkangular_18_test||[]).push([[2403],{22403:(Vt,G,c)=>{c.r(G),c.d(G,{uploadAssets:()=>Pt});var u=c(10467),m=c(89563),K=c(3248),ot=c(35150),f=c(56492),x=c(82595),d=c(45272),at=c(43085),A=c(33019),g=c(63758);const F={upload:{createFromFiles:.8,loadMesh:.2},uploadAssetBlobs:{prepareAssetItems:.9,uploadAssetItems:.1},uploadConvertibleSource:{uploadEditSource:.5,serviceAssetsToGlb:.5},uploadLocalMesh:{meshToAssetBlob:.5,uploadAssetBlobs:.5}};var it=c(68438),ut=c(17715),lt=c(60797);function T(s,e=(n=>{}),t){return new pt(s,e,t)}class pt{constructor(e,t=(r=>{}),n){if(this.onProgress=t,this.taskName=n,this._progressMap=new Map,this._startTime=void 0,this._timingsMap=new Map,"number"==typeof e){this._weights={};for(let r=0;r<e;r++){const o=r;this._weights[o]=1/e,this._progressMap.set(o,0)}}else this._weights=e;this.emitProgress()}emitProgress(){let e=0;for(const[t,n]of this._progressMap.entries())e+=n*this._weights[t];if(1===e&&(0,K.A)("enable-feature:esri-3dofl-upload-timings")){const t=Math.round(performance.now()-(this._startTime??0))/1e3;console.log(`${this.taskName} done in ${t} sec`);for(const[n,r]of this._timingsMap){const o=Math.round(r.end-r.start)/1e3,a=Math.round(o/t*100);console.log(this.taskName??"Task",{stepKey:n,stepTime:o,relativeTime:a})}}this.onProgress(e)}setProgress(e,t){if(this._progressMap.set(e,t),(0,K.A)("enable-feature:esri-3dofl-upload-timings")){const n=performance.now();this._startTime??=n;const r=(0,lt.tE)(this._timingsMap,e,()=>({start:n,end:0}));1===t&&(r.end=n)}this.emitProgress()}simulate(e,t){return k(n=>this.setProgress(e,n),t)}makeOnProgress(e){return t=>this.setProgress(e,t)}}function k(s=(t=>{}),e=ht){const t=performance.now();s(0);const n=setInterval(()=>{const r=performance.now()-t,o=1-Math.exp(-r/e);s(o)},gt);return(0,ut.hA)(()=>{clearInterval(n),s(1)})}function ct(s,e=mt){return(0,x.gr)((0,x.Kp)(s*J/e))}const mt=10,dt=10,J=8e-6,gt=(0,x.l5)(50),ht=(0,x.l5)(1e3),Q=1e6,Y=20*Q,yt=2e9,xt=3;function b(){return b=(0,u.A)(function*({data:s,name:e,description:t},n,r){let o=null;try{const a=(0,d.fj)(n,"uploads"),i=(0,d.fj)(a,"info"),{data:l}=yield(0,m.A)(i,{query:{f:"json"},responseType:"json"});(0,f.Te)(r);const p=(0,it.Wo)(n),h=l.maxUploadFileSize*Q,v=p?yt:h,W=p?Math.min(Y,h):Y;if(s.size>v)throw new Error("Data too large");const Ht=(0,d.fj)(a,"register"),{data:tt}=yield(0,m.A)(Ht,{query:{f:"json",itemName:Tt(e),description:t},responseType:"json",method:"post"});if((0,f.Te)(r),!tt.success)throw new Error("Registration failed");const{itemID:Wt}=tt.item;o=(0,d.fj)(a,Wt);const Gt=(0,d.fj)(o,"uploadPart"),et=Math.ceil(s.size/W),j=new Array;for(let y=0;y<et;++y)j.push(s.slice(y*W,Math.min((y+1)*W,s.size)));const M=j.slice().reverse(),st=new Array,Kt=T(et,r?.onProgress,"uploadItem"),kt=function(){var y=(0,u.A)(function*(){for(;0!==M.length;){const P=j.length-M.length,rt=M.pop(),_=new FormData,Qt=Kt.simulate(P,ct(rt.size));try{_.append("f","json"),_.append("file",rt),_.append("partId",`${P}`);const{data:Yt}=yield(0,m.A)(Gt,{timeout:0,body:_,responseType:"json",method:"post"});if((0,f.Te)(r),!Yt.success)throw new Error("Part upload failed")}finally{Qt.remove()}}});return function(){return y.apply(this,arguments)}}();for(let y=0;y<xt&&0!==M.length;++y)st.push(kt());yield Promise.all(st);const Jt=(0,d.fj)(o,"commit"),{data:nt}=yield(0,m.A)(Jt,{query:{f:"json",parts:j.map((y,P)=>P).join(",")},responseType:"json",method:"post"});if((0,f.Te)(r),!nt.success)throw new Error("Commit failed");return nt.item}catch(a){if(null!=o){const i=(0,d.fj)(o,"delete");yield(0,m.A)(i,{query:{f:"json"},responseType:"json",method:"post"})}throw a}}),b.apply(this,arguments)}function Tt(s){return s.replaceAll("/","_").replaceAll("\\","_")}var w=c(6829);function Pt(s,e,t){return E.apply(this,arguments)}function E(){return E=(0,u.A)(function*(s,e,t){const n=s.length;if(!n)return t?.onProgress?.(1),[];const r=T(n,t?.onProgress,"uploadAssets");return Promise.all(s.map((o,a)=>function wt(s,e,t){return U.apply(this,arguments)}(o,e,{...t,onProgress:r.makeOnProgress(a)})))}),E.apply(this,arguments)}function U(){return U=(0,u.A)(function*(s,{layer:e,ongoingUploads:t},n){const r=t.get(s);if(r)return r;if(!function Lt(s){return!!s.infoFor3D&&!!s.url}(e))throw new g.Wt;if(function vt(s,e){const{parsedUrl:t}=e;return null!=t&&s.metadata.externalSources.some(n=>(0,A.eN)(n,t))}(s,e))return n?.onProgress?.(1),s;const o=function jt(s,e,t){return N.apply(this,arguments)}(s,e,n);t.set(s,o);try{yield o}finally{t.delete(s)}return s}),U.apply(this,arguments)}function N(){return N=(0,u.A)(function*(s,e,t){const{metadata:n}=s,{displaySource:r}=n,o=V(r?.source,e),i=n.externalSources.length>0,l=o?function Mt(s,e,t){return S.apply(this,arguments)}(o,e,t):i?function _t(s,e,t){return I.apply(this,arguments)}(s,e,t):function Ft(s,e,t){return B.apply(this,arguments)}(s,e,t),p=yield l;return(0,f.Te)(t),s.addExternalSources([p]),s}),N.apply(this,arguments)}function S(){return(S=(0,u.A)(function*(s,e,t){return{source:yield X(s,e,t),original:!0}})).apply(this,arguments)}function I(){return(I=(0,u.A)(function*(s,e,t){const n=q(e),{externalSources:r}=s.metadata,o=function Et(s,e){for(const t of s){const n=V(t.source,e);if(n)return n}return null}(r,e);if(!o)throw new g.xY;const a=T(F.uploadConvertibleSource,t?.onProgress,"uploadConvertibleSource"),i=yield X(o,e,{onProgress:a.makeOnProgress("uploadEditSource")});s.addExternalSources([{source:i,original:!0}]);const l=o.reduce((h,{asset:v})=>v instanceof File?h+v.size:h,0),p=a.simulate("serviceAssetsToGlb",function ft(s,e=dt){return(0,x.gr)((0,x.Kp)(s*J/e))}(l));try{return{source:yield Ct(i,e,n)}}finally{p.remove()}})).apply(this,arguments)}function B(){return B=(0,u.A)(function*(s,e,t){const n=T(F.uploadLocalMesh,t?.onProgress,"uploadLocalMesh"),r=function bt(s,e,t){return D.apply(this,arguments)}(s,e,{...t,onProgress:n.makeOnProgress("meshToAssetBlob")});return{source:yield Z([r],e,{...t,onProgress:n.makeOnProgress("uploadAssetBlobs")}),extent:s.extent.clone(),original:!0}}),B.apply(this,arguments)}function D(){return(D=(0,u.A)(function*(s,e,t){const n=q(e),r=yield s.load(t),o=yield r.toBinaryGLTF({origin:r.origin,signal:t?.signal,ignoreLocalTransform:!0});return(0,f.Te)(t),{blob:new Blob([o],{type:"model/gltf-binary"}),assetName:`${(0,at.yS)()}.glb`,assetType:n}})).apply(this,arguments)}function V(s,e){if(!s)return null;const{infoFor3D:{supportedFormats:t,editFormats:n}}=e,r=(0,A.WN)(s),o=new Array;let a=!1;for(let i=0;i<r.length;++i){const l=Ut(r[i],t);if(!l)return null;n.includes(l.assetType)&&(a=!0),o.push(l)}return a?o:null}function Ut(s,e){const t=(0,A.fH)(s,e);return t?{asset:s,assetType:t}:null}function X(s,e,t){return C.apply(this,arguments)}function C(){return C=(0,u.A)(function*(s,e,t){return Z(s.map(n=>function Nt(s,e){return R.apply(this,arguments)}(n,t)),e,t)}),C.apply(this,arguments)}function Z(s,e,t){return O.apply(this,arguments)}function O(){return O=(0,u.A)(function*(s,e,t){const n=T(F.uploadAssetBlobs,t?.onProgress,"uploadAssetBlobs"),r=yield function It(s,e,t){const n=T(s.length,t?.onProgress,"prepareAssetItems");return Promise.all(s.map(function(){var r=(0,u.A)(function*(o,a){const i=function St(s,e,t){return L.apply(this,arguments)}(yield o,e,{...t,onProgress:n.makeOnProgress(a)});return(0,f.Te)(t),i});return function(o,a){return r.apply(this,arguments)}}()))}(s,e,{...t,onProgress:n.makeOnProgress("prepareAssetItems")});(0,f.Te)(t);const o=r.map(({item:i})=>i),{uploadResults:a}=yield function Bt(s,e,t){return $.apply(this,arguments)}(o,e,{...t,onProgress:n.makeOnProgress("uploadAssetItems")});return(0,f.Te)(t),s.map((i,l)=>function Dt(s,e,t){const{success:n}=e;if(!n){const{error:p}=e;throw new g.hK(s.assetName,p)}const{assetHash:r}=e,{assetName:o,item:{assetType:a}}=s,{infoFor3D:{supportedFormats:i}}=t,l=(0,w.Fm)(a,i);if(!l)throw new g.H2(a);return new A.Qp(o,l,[new A.Bq(`${t.parsedUrl.path}/assets/${r}`,r)])}(r[l],a[l],e))}),O.apply(this,arguments)}function R(){return(R=(0,u.A)(function*(s,e){const{asset:t,assetType:n}=s;if(t instanceof File)return{blob:t,assetName:t.name,assetType:n};const r=yield t.toBlob(e);return(0,f.Te)(e),{blob:r,assetName:t.assetName,assetType:n}})).apply(this,arguments)}function L(){return L=(0,u.A)(function*(s,e,t){const{blob:n,assetType:r,assetName:o}=s;let a=null;try{const i=yield function At(s,e,t){return b.apply(this,arguments)}({data:n,name:o},e.url,t);(0,f.Te)(t),a={assetType:r,assetUploadId:i.itemID}}catch(i){(0,f.QP)(i),function $t(){return ot.A.getLogger("esri.layers.graphics.sources.support.uploadAssets")}().warnOnce(`Service ${e.url} does not support the REST Uploads API.`)}if(!a){const i=yield(0,d._0)(n);if((0,f.Te)(t),!i.isBase64)throw new g.$1;a={assetType:r,assetData:i.data}}if(!a)throw new g.WF;return{item:a,assetName:o}}),L.apply(this,arguments)}function $(){return($=(0,u.A)(function*(s,e,t){const n=k(t?.onProgress);try{const r=yield(0,m.A)((0,d.fj)(e.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(s)},method:"post",responseType:"json"});if((0,f.Te)(t),r.data.uploadResults.length!==s.length)throw new g.nS(s.length,r.data.uploadResults.length);return r.data}finally{n.remove()}})).apply(this,arguments)}function Ct(s,e,t){return z.apply(this,arguments)}function z(){return(z=(0,u.A)(function*(s,e,t){const n=s.map(({assetName:p,parts:h})=>({assetName:p,assetHash:h[0].partHash})),r=e.capabilities?.operations.supportsAsyncConvert3D,o={f:"json",assets:JSON.stringify(n),transportType:"esriTransportTypeUrl",targetFormat:t,async:r},a=(0,d.fj)(e.parsedUrl.path,"convert3D");let i;try{i=(yield(r?Rt:Ot)(a,{query:o,responseType:"json",timeout:0})).data}catch{throw new g.MT}const{supportedFormats:l}=e.infoFor3D;return i.assets.map(p=>{const h=(0,w.R_)(p.contentType,l);if(!h)throw new g.H2(h);return new A.Qp(p.assetName,p.contentType,[new A.Bq(p.assetURL,p.assetHash)])})})).apply(this,arguments)}function Ot(s,e){return(0,m.A)(s,e)}function Rt(s,e){return H.apply(this,arguments)}function H(){return(H=(0,u.A)(function*(s,e){const t=(yield(0,m.A)(s,e)).data.statusUrl;for(;;){const n=(yield(0,m.A)(t,{query:{f:"json"},responseType:"json"})).data;switch(n.status){case"Completed":return(0,m.A)(n.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new Error(n.status);case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new Error}yield(0,f.Pl)(zt)}})).apply(this,arguments)}function q(s){const{infoFor3D:e}=s,t=(0,w.R_)("model/gltf-binary",e.supportedFormats)??(0,w.E1)("glb",e.supportedFormats);if(!t)throw new g.uh;return t}const zt=(0,x.l5)(1e3)}}]);