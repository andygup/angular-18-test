"use strict";(self.webpackChunkangular_18_test=self.webpackChunkangular_18_test||[]).push([[9285],{15590:(oe,k,u)=>{u.d(k,{A:()=>b});class b{constructor(z){this.size=0,this._start=0,this.maxSize=z,this._buffer=new Array(z)}get entries(){return this._buffer}enqueue(z){if(this.size===this.maxSize){const f=this._buffer[this._start];return this._buffer[this._start]=z,this._start=(this._start+1)%this.maxSize,f}return this._buffer[(this._start+this.size++)%this.maxSize]=z,null}dequeue(){if(0===this.size)return null;const z=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,z}peek(){return 0===this.size?null:this._buffer[this._start]}find(z){if(0===this.size)return null;for(const f of this._buffer)if(null!=f&&z(f))return f;return null}clear(z){let f=this.dequeue();for(;null!=f;)z&&z(f),f=this.dequeue()}}},86468:(oe,k,u)=>{u.d(k,{T:()=>z,U:()=>S});var b=u(69287);function S(C,P,J=0){const Q=(0,b.qE)(C,0,M);for(let se=0;se<4;se++)P[J+se]=Math.floor(256*A(Q*f[se]))}function z(C,P=0){let J=0;for(let Q=0;Q<4;Q++)J+=C[P+Q]*V[Q];return J}const f=[1,256,65536,16777216],V=[1/256,1/65536,1/16777216,1/4294967296],M=z(new Uint8ClampedArray([255,255,255,255]));function A(C){return C-Math.floor(C)}},14916:(oe,k,u)=>{function b(f){const V=f.layer;return"floorInfo"in V&&V.floorInfo?.floorField&&"floors"in f.view?z(f.view.floors,V.floorInfo.floorField):null}function S(f,V){return"floorInfo"in V&&V.floorInfo?.floorField?z(f,V.floorInfo.floorField):null}function z(f,V){if(!f?.length)return null;const M=f.filter(A=>""!==A).map(A=>`'${A}'`);return M.push("''"),`${V} IN (${M.join(",")}) OR ${V} IS NULL`}u.d(k,{E:()=>b,f:()=>S})},54935:(oe,k,u)=>{u.d(k,{Fj:()=>J,Z7:()=>P,ce:()=>Q,eR:()=>V});var b=u(86468),S=u(61320),z=u(9792),f=u(47669);function V(I){switch(I.type){case"CIMPointSymbol":{const x=I.symbolLayers;if(!x||1!==x.length)return null;const c=x[0];return"CIMVectorMarker"!==c.type?null:V(c)}case"CIMVectorMarker":{const x=I.markerGraphics;if(!x||1!==x.length)return null;const c=x[0];if(!c)return null;const m=c.geometry;if(!m)return null;const g=c.symbol;return!g||"CIMPolygonSymbol"!==g.type&&"CIMLineSymbol"!==g.type||g.symbolLayers?.some(_=>!!_.effects)?null:{type:"sdf",geom:m,asFill:"CIMPolygonSymbol"===g.type}}}}function C(I){let x=1/0,c=-1/0,m=1/0,g=-1/0;for(const _ of I)for(const F of _)F[0]<x&&(x=F[0]),F[0]>c&&(c=F[0]),F[1]<m&&(m=F[1]),F[1]>g&&(g=F[1]);return[x,m,c,g]}function P(I){return I?I.rings?C(I.rings):I.paths?C(I.paths):(0,S.ZC)(I)?[I.xmin,I.ymin,I.xmax,I.ymax]:null:null}function J(I,x,c,m,g){const[_,F,O,w]=I;if(O<_||w<F)return[0,0,0,1];const U=O-_,D=w-F,L=f.p,T=f.hM,q=Math.floor(.5*(.5*L-T)),N=(L-2*(q+T))/Math.max(U,D),G=Math.round(U*N)+2*q,X=Math.round(D*N)+2*q;let ne=1;x&&(ne=X/N/(x.ymax-x.ymin));let j=0,Z=0,K=1;m&&(g?x&&c&&x.ymax-x.ymin>0&&(K=(x.xmax-x.xmin)/(x.ymax-x.ymin),j=m.x/(c*K),Z=m.y/c):(j=m.x,Z=m.y)),x&&(j=.5*(x.xmax+x.xmin)+j*(x.xmax-x.xmin),Z=.5*(x.ymax+x.ymin)+Z*(x.ymax-x.ymin)),j-=_,Z-=F,j*=N,Z*=N,j+=q,Z+=q;let $=j/G-.5,Ie=Z/X-.5;return g&&c&&($*=c*K,Ie*=c),[ne,$,Ie,K]}function Q(I){const x=function M(I){return I?I.rings?I.rings:I.paths?I.paths:void 0!==I.xmin&&void 0!==I.ymin&&void 0!==I.xmax&&void 0!==I.ymax?[[[I.xmin,I.ymin],[I.xmin,I.ymax],[I.xmax,I.ymax],[I.xmax,I.ymin],[I.xmin,I.ymin]]]:null:null}(I.geom),c=function A(I){let x=1/0,c=-1/0,m=1/0,g=-1/0;for(const _ of I)for(const F of _)F[0]<x&&(x=F[0]),F[0]>c&&(c=F[0]),F[1]<m&&(m=F[1]),F[1]>g&&(g=F[1]);return new z.A(x,m,c-x,g-m)}(x),m=f.p,g=f.hM,_=Math.floor(.5*(.5*m-g)),F=(m-2*(_+g))/Math.max(c.width,c.height),O=Math.round(c.width*F)+2*_,w=Math.round(c.height*F)+2*_,U=[];for(const L of x)if(L&&L.length>1){const T=[];for(const q of L){let[N,G]=q;N-=c.x,G-=c.y,N*=F,G*=F,N+=_-.5,G+=_-.5,T.push(I.asFill?[N,G]:[Math.round(N),Math.round(G)])}if(I.asFill){const q=T.length-1;T[0][0]===T[q][0]&&T[0][1]===T[q][1]||T.push(T[0])}U.push(T)}const D=function se(I,x,c,m){const g=x*c,_=new Array(g),F=m*m+1;for(let O=0;O<g;++O)_[O]=F;for(const O of I){const w=O.length;for(let U=1;U<w;++U){const D=O[U-1],L=O[U];let T,q,N,G;D[0]<L[0]?(T=D[0],q=L[0]):(T=L[0],q=D[0]),D[1]<L[1]?(N=D[1],G=L[1]):(N=L[1],G=D[1]);let X=Math.floor(T)-m,ne=Math.floor(q)+m,j=Math.floor(N)-m,Z=Math.floor(G)+m;X<0&&(X=0),ne>x&&(ne=x),j<0&&(j=0),Z>c&&(Z=c);const K=L[0]-D[0],$=L[1]-D[1],Ie=K*K+$*$;for(let Re=X;Re<ne;Re++)for(let Me=j;Me<Z;Me++){const ee=Re+.5,De=Me+.5;let me,ge,Ve=(ee-D[0])*K+(De-D[1])*$;Ve<0?(me=D[0],ge=D[1]):Ve>Ie?(me=L[0],ge=L[1]):(Ve/=Ie,me=D[0]+Ve*K,ge=D[1]+Ve*$);const qe=(ee-me)*(ee-me)+(De-ge)*(De-ge),Je=(c-Me-1)*x+Re;qe<_[Je]&&(_[Je]=qe)}}}for(let O=0;O<g;++O)_[O]=Math.sqrt(_[O]);return _}(U,O,w,_);return I.asFill&&function ue(I,x,c,m,g){for(const _ of I){const F=_.length;for(let O=1;O<F;++O){const w=_[O-1],U=_[O];let D,L,T,q;w[0]<U[0]?(D=w[0],L=U[0]):(D=U[0],L=w[0]),w[1]<U[1]?(T=w[1],q=U[1]):(T=U[1],q=w[1]);let N=Math.floor(D),G=Math.floor(L)+1,X=Math.floor(T),ne=Math.floor(q)+1;N<m&&(N=m),G>x-m&&(G=x-m),X<m&&(X=m),ne>c-m&&(ne=c-m);for(let j=X;j<ne;++j){if(w[1]>j==U[1]>j)continue;const Z=j+.5,K=(c-j-1)*x;for(let $=N;$<G;++$)$+.5<(U[0]-w[0])*(Z-w[1])/(U[1]-w[1])+w[0]&&(g[K+$]=-g[K+$]);for(let $=m;$<N;++$)g[K+$]=-g[K+$]}}}}(U,O,w,_,D),[ye(D,_),O,w]}function ye(I,x){const c=2*x,m=I.length,g=new Uint8Array(4*m);for(let _=0;_<m;++_)(0,b.U)(.5-I[_]/c,g,4*_);return g}},66803:(oe,k,u)=>{u.d(k,{j:()=>I});var b=u(5922),S=u(3248),z=u(35150),f=u(47669),V=u(53212),M=u(24370),A=u(50915),C=u(79061),P=u(26136),J=u(4931);class se{constructor(c,m,g){this._texture=null,this._lastTexture=null,this._fbos={},this.texelSize=4;const{buffer:_,pixelType:F,textureOnly:O}=c,w=(0,M.Qz)(F);this.blockIndex=g,this.pixelType=F,this.size=m,this.textureOnly=O,O||(this.data=new w(_)),this._resetRange()}destroy(){this._texture?.dispose();for(const c in this._fbos){const m=this._fbos[c];m&&("0"===c&&m.detachColorTexture(),m.dispose()),this._fbos[c]=null}this._texture=null}get _textureDesc(){const c=new J.R;return c.wrapMode=A.pF.CLAMP_TO_EDGE,c.samplingMode=A.Cj.NEAREST,c.dataType=this.pixelType,c.width=this.size,c.height=this.size,c}setData(c,m,g){const _=(0,V.Q4)(c),F=this.data,O=_*this.texelSize+m;!F||O>=F.length||(F[O]=g,this.dirtyStart=Math.min(this.dirtyStart,_),this.dirtyEnd=Math.max(this.dirtyEnd,_))}getData(c,m){if(null==this.data)return null;const g=(0,V.Q4)(c)*this.texelSize+m;return!this.data||g>=this.data.length?null:this.data[g]}getTexture(c){return this._texture??this._initTexture(c)}getFBO(c,m=0){if(!this._fbos[m]){const g=0===m?this.getTexture(c):this._textureDesc;this._fbos[m]=new C.H(c,g)}return this._fbos[m]}get hasDirty(){return this.dirtyEnd>=this.dirtyStart}updateTexture(c,m){try{const g=this.dirtyStart,_=this.dirtyEnd;if(!this.hasDirty)return;(0,S.A)("esri-2d-update-debug")&&console.debug(`Version[${m}] AttributeStoreView.updateTexture`,{start:g,end:_,firstBytes:new Uint8Array(this.data.buffer.slice(0,16)),block:this}),this._resetRange();const F=this.data.buffer,O=this.getTexture(c),w=4,U=(g-g%this.size)/this.size,L=U,q=(_-_%this.size)/this.size,N=U*this.size*w,G=(this.size+q*this.size)*w-N,X=(0,M.Qz)(this.pixelType),ne=new X(F,N*X.BYTES_PER_ELEMENT,G),j=this.size,Z=q-L+1;if(Z>this.size)return void z.A.getLogger("esri.views.2d.engine.webgl.AttributeStoreView").error(new b.A("mapview-webgl","Out-of-bounds index when updating AttributeData"));O.updateData(0,0,L,j,Z,ne)}catch{}}update(c){const{data:m,start:g,end:_}=c;if(null!=m&&null!=this.data){const F=this.data,O=g*this.texelSize;for(let w=0;w<m.length;w++)c.layout&1<<w%this.texelSize&&(F[O+w]=m[w])}this.dirtyStart=Math.min(this.dirtyStart,g),this.dirtyEnd=Math.max(this.dirtyEnd,_)}resize(c,m){const g=this.size;if(this.size=m,this.textureOnly)return void(g!==this.size&&(this._lastTexture=this._texture,this._texture=null));const _=(0,M.Qz)(this.pixelType);this.destroy(),this.data=new _(c.buffer)}_resetRange(){this.dirtyStart=2147483647,this.dirtyEnd=0}_initTexture(c){const m=new P.g(c,this._textureDesc,this.data??void 0);if(null!=this._lastTexture&&this._fbos[0]){const g=this._lastTexture.descriptor.width,_=this._lastTexture.descriptor.height,F=this._lastTexture.descriptor.dataType,O=this._lastTexture.descriptor.pixelFormat,w=this.getFBO(c),U=(0,M.AV)(F),D=new((0,M.Qz)(F))(new ArrayBuffer(g*_*U*this.texelSize)),L=c.getBoundFramebufferObject(),{x:T,y:q,width:N,height:G}=c.getViewport();c.bindFramebuffer(w),w.readPixels(0,0,g,_,O,F,D),m.updateData(0,0,0,2*g,_/2,D),c.setViewport(T,q,N,G),c.bindFramebuffer(L)}return this.destroy(),this._texture=m,this._texture}}class ue{constructor(){this.size=0,this._pendingAttributeUpdates=[],this._version=0,this._epoch=0,this._locked=!1}_initialize(c){if(!c)throw new Error("InternalError: initArgs must be defined");const m=c.blockDescriptors;if(this.size=c.blockSize,(0,S.A)("esri-2d-update-debug")&&console.debug("AttributeStoreView.initialize",{message:c}),null==this._data)this._data=m.map((g,_)=>null!=g?new se(g,this.size,_):null);else for(let g=0;g<this._data.length;g++){const _=this._data[g],F=m[g];null!=F&&(null==_?this._data[g]=new se(F,this.size,g):_.resize(F,this.size))}}destroy(){for(const c of this._data??[])c?.destroy();this._defaultTexture?.dispose(),this._pendingAttributeUpdates=[]}isEmpty(){return null==this._data}getBlock(c){return null==this._data?null:this._data[c]}setLabelMinZoom(c,m){this.setData(c,0,1,m)}getLabelMinZoom(c){return this.getData(c,0,1,255)}getFilterFlags(c){return this.getData(c,0,0,0)}getVVSize(c){return this.getData(c,f.dV.VV,0,0)}getData(c,m,g,_){if(!this._data)return 0;const F=this._data[m];return null==F?0:F.getData(c,g)??_}setData(c,m,g,_){this._data[m].setData(c,g,_)}lockTextureUploads(){this._locked=!0}unlockTextureUploads(){this._locked=!1,this.update()}requestUpdate(c){this._version=c.version,this._pendingAttributeUpdates.push(c),(0,S.A)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] AttributeStoreView.requestUpdate`,{message:c})}get currentEpoch(){return this._epoch}update(){if(this._locked)return;const c=this._pendingAttributeUpdates;this._pendingAttributeUpdates=[];for(const m of c){const{blockData:g,initArgs:_,sendUpdateEpoch:F,version:O}=m;(0,S.A)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] Epoch[${F}] AttributeStoreView.applyUpdate`),this._version=O,this._epoch=F,null!=_&&this._initialize(_);const w=this._data;for(let U=0;U<g.length;U++){const D=g[U],L=w[U];null!=L&&null!=D&&((0,S.A)("esri-2d-update-debug")&&console.debug(`Version[${this._version}] CpuBlock[${U}] AttributeStoreView.update`,{block:D}),L.update(D))}}}getUniforms(c){return{filterFlags:{texture:this._getTexture(c,f.dV.FilterFlags),unit:f.uM},animation:{texture:this._getTexture(c,f.dV.Animation),unit:f.z2},gpgpu:{texture:this._getTexture(c,f.dV.GPGPU),unit:f.Sr},visualVariableData:{texture:this._getTexture(c,f.dV.VV),unit:f.nM},dataDriven0:{texture:this._getTexture(c,f.dV.DD0),unit:f.lL},dataDriven1:{texture:this._getTexture(c,f.dV.DD1),unit:f.sn},dataDriven2:{texture:this._getTexture(c,f.dV.DD2),unit:f.n9},size:this.size}}_getTexture(c,m){const g=this._data?.[m];return g?(g.updateTexture(c,this._version),g.getTexture(c)):this._getDefaultTexture(c)}_getDefaultTexture(c){if(null==this._defaultTexture){const m=new J.R;m.wrapMode=A.pF.CLAMP_TO_EDGE,m.samplingMode=A.Cj.NEAREST,m.width=1,m.height=1,this._defaultTexture=new P.g(c,m,new Uint8Array(4))}return this._defaultTexture}}var ye=u(37188);class I extends ye.A{constructor(c){super(c),this._statisticsByLevel=new Map,this.attributeView=new ue}destroy(){this.children.forEach(c=>c.destroy()),this.removeAllChildren(),this.attributeView.destroy()}doRender(c){c.context.capabilities.enable("textureFloatLinear"),super.doRender(c)}createRenderParams(c){const m=super.createRenderParams(c);return m.attributeView=this.attributeView,m.instanceStore=this._instanceStore,m.statisticsByLevel=this._statisticsByLevel,m}}},37188:(oe,k,u)=>{u.d(k,{A:()=>A});var b=u(3248),S=u(69473),z=u(54382),f=u(89298),V=u(99065);const M=(C,P)=>C.key.level-P.key.level!=0?C.key.level-P.key.level:C.key.row-P.key.row!=0?C.key.row-P.key.row:C.key.col-P.key.col;class A extends z.A{constructor(P){super(),this._tileInfoView=P}renderChildren(P){this.sortChildren(M),this.setStencilReference(P),super.renderChildren(P)}createRenderParams(P){const{state:J}=P,Q=super.createRenderParams(P);return Q.requiredLevel=this._tileInfoView.getClosestInfoForScale(J.scale).level,Q.displayLevel=this._tileInfoView.tileInfo.scaleToZoom(J.scale),Q}prepareRenderPasses(P){const J=super.prepareRenderPasses(P);return J.push(P.registerRenderPass({name:"stencil",brushes:[f.A],drawPhase:S.S5.DEBUG|S.S5.MAP|S.S5.HIGHLIGHT|S.S5.LABEL,target:()=>this.getStencilTarget()})),(0,b.A)("esri-tiles-debug")&&J.push(P.registerRenderPass({name:"tileInfo",brushes:[V.A],drawPhase:S.S5.DEBUG,target:()=>this.children})),J}getStencilTarget(){return this.children}setStencilReference(P){let J=1;for(const Q of this.children)Q.stencilRef=J++}}},87250:(oe,k,u)=>{u.d(k,{c:()=>S});var b=u(69522);class S{constructor(f,V,M){this._instanceId=f,this.techniqueRef=V,this._input=M}get instanceId(){return(0,b.P)(this._instanceId)}createMeshInfo(f){return{id:(0,b.P)(this._instanceId),techniqueType:this.techniqueRef.type,inputParams:f,optionalAttributes:this._input.optionalAttributes}}getInput(){return this._input}setInput(f){this._input=f}}},69522:(oe,k,u)=>{function b(z){return z}function S(z){return z}u.d(k,{P:()=>b,U:()=>S})},79285:(oe,k,u)=>{u.r(k),u.d(k,{default:()=>ai});var b=u(10467),S=u(8189),z=u(81098),f=u(85211),V=u(3248),M=u(35150),C=(u(40707),u(76576));let P=class extends z.A{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(r=!1){if(this.popupTemplate)return this.popupTemplate;const e=this.sourceLayer?.featureReduction;return e&&"popupTemplate"in e&&e.popupEnabled?e.popupTemplate:null}getObjectId(){return this.attributes.aggregateId}};(0,S._)([(0,f.MZ)({type:Boolean})],P.prototype,"isAggregate",void 0),P=(0,S._)([(0,C.$)("esri.AggregateGraphic")],P);const J=P;u(21152);var se=u(89952),ue=u(31178),ye=u(69690),I=u(5922),x=u(17715),c=u(11432),m=u(89221),g=u(56492),_=u(48900),F=u(98877),O=u(40702);let w=class extends F.A{constructor(r){super(r),this._filter=null,this.duration=(0,V.A)("mapview-transitions-duration"),this._excludedEffectView=new O.$B(r),this._includedEffectView=new O.$B(r)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(r){this._get("featureEffect")!==r&&this._transitionTo(r)}get filter(){return this._filter||this.featureEffect?.filter||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(r){this._set("scale",r),this._excludedEffectView.scale=r,this._includedEffectView.scale=r}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}transitionStep(r,e){this._set("scale",e),this.transitioning?(this._includedEffectView.transitionStep(r,e),this._excludedEffectView.transitionStep(r,e),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=e,this._includedEffectView.scale=e)}endTransitions(){this._includedEffectView.endTransitions(),this._excludedEffectView.endTransitions(),this._filter=null}_transitionTo(r){const e=this._get("featureEffect"),t=r,s=t?.includedEffect,a=t?.excludedEffect,o=this._includedEffectView.canTransitionTo(s)&&this._excludedEffectView.canTransitionTo(a);this._includedEffectView.effect=s,this._excludedEffectView.effect=a,this._set("featureEffect",t),this._filter=t?.filter||e?.filter||null,o||this.endTransitions()}};(0,S._)([(0,f.MZ)()],w.prototype,"_filter",void 0),(0,S._)([(0,f.MZ)()],w.prototype,"_excludedEffectView",void 0),(0,S._)([(0,f.MZ)()],w.prototype,"_includedEffectView",void 0),(0,S._)([(0,f.MZ)()],w.prototype,"duration",void 0),(0,S._)([(0,f.MZ)()],w.prototype,"excludedEffects",null),(0,S._)([(0,f.MZ)()],w.prototype,"featureEffect",null),(0,S._)([(0,f.MZ)()],w.prototype,"filter",null),(0,S._)([(0,f.MZ)()],w.prototype,"hasEffects",null),(0,S._)([(0,f.MZ)()],w.prototype,"includedEffects",null),(0,S._)([(0,f.MZ)({value:0})],w.prototype,"scale",null),(0,S._)([(0,f.MZ)()],w.prototype,"transitioning",null),w=(0,S._)([(0,C.$)("esri.layers.effects.FeatureEffectView")],w);const U=w;var D=u(31732),L=u(95877),T=u(86300),q=u(58443),N=u(31876),G=u(17221),X=u(93327),ne=u(32034);let j=class extends X.A{constructor(){super(...arguments),this.features=[]}readFeatures(r,e){const t=ne.A.fromJSON(e.spatialReference),s=[];for(let a=0;a<r.length;a++){const o=r[a],l=J.fromJSON(o),d=o.geometry?.spatialReference;null==l.geometry||d||(l.geometry.spatialReference=t);const h=o.aggregateGeometries,p=l.aggregateGeometries;if(h&&null!=p)for(const y in p){const v=p[y],E=h[y],R=E?.spatialReference;null==v||R||(v.spatialReference=t)}s.push(l)}return s}};(0,S._)([(0,f.MZ)({type:[J],json:{write:!0}})],j.prototype,"features",void 0),(0,S._)([(0,G.w)("features")],j.prototype,"readFeatures",null),j=(0,S._)([(0,C.$)("esri.rest.support.AggregateFeatureSet")],j);const Z=j;var K=u(87086),$=u(25735),Ie=u(29459),Re=u(56985),Me=u(66803),ee=u(69473),De=u(1119),me=u(87250),ge=u(69522);class Ve{constructor(){this._instanceById=new Map}destroy(){this._instanceById.clear()}get size(){return this._instanceById.size}entries(){return this._instanceById.entries()}updateStart(){this._instanceByIdNext=new Map}updateEnd(){if(!this._instanceByIdNext)throw new Error("InternalError: Found updateEnd call without corresponding updateStart");for(const e of this._instanceById.keys())this._instanceByIdNext.has(e)||this._instanceById.delete(e);for(const[e,t]of this._instanceByIdNext.entries()){const s=this._instanceById.get(e);s?s.setInput(t.getInput()):this._instanceById.set(e,t)}this._instanceByIdNext=null}values(){return this._instanceById.values()}ensureInstance(e,t){const s=(0,De.Wm)(`${e.type}.${JSON.stringify(t)}`);if(this._instanceByIdNext){const a=new me.c((0,ge.U)(s),e,t);return this._instanceByIdNext.set(s,a),a}if(!this._instanceById.has(s)){const a=new me.c((0,ge.U)(s),e,t);this._instanceById.set(s,a)}return this._instanceById.get(s)}getInstance(e){return this._instanceById.get(e)}}var qe=u(15590),Je=u(51995),Le=(u(54290),u(74847)),Pt=(u(67347),u(77031),u(38093)),Ut=u(36952);class Lt{constructor(e,t,s){this.getStage=e,this.version=t,this._tileInfoView=s,this._pendingUpdates=new qe.A(1e3),this._locked=!1,this._tiles=new Map}destroy(){for(const e of this.tiles())e.destroy();this._pendingUpdates.clear(),this._tiles.clear()}tiles(){return this._tiles.values()}size(){return this._tiles.size}setTiles(e){this._tiles.clear();for(const t of e)this._tiles.set(t.key.id,t)}lockUploads(){this._locked=!0}unlockUploads(){this._locked=!1,this.flush()}enqueueUpdate(e){this._pendingUpdates.enqueue(e)}update(e){if(!this._locked)for(;this._pendingUpdates.size;){const t=this._pendingUpdates.peek();if(null==t||t.attributeEpoch>e)break;this._updateTile(t),this._pendingUpdates.dequeue()}}removeTile(e){const t=this._tiles.get(e);(0,V.A)("esri-2d-update-debug")&&console.debug(`Tile[${e}] RenderState.removeTile`),t?.destroy(),this._tiles.delete(e)}isTileDone(e){const t=this._tiles.get(e.id);return!!t&&t.isReady}flush(){for(;this._pendingUpdates.size;){const e=this._pendingUpdates.dequeue();null!=e&&this._updateTile(e)}}_updateTile(e){(0,V.A)("esri-2d-update-debug")&&console.debug(`Version[${e.version}] Tile[${e.id}] Chunk[${e.debugInfo?.chunkId??"<EnsureEnd>"}] RenderState.updateTile [${e.type}]`,e);const t=this._ensureTile(e.id);if("update"===e.type){const[o,...l]=e.modify;t.onMessage({type:"update",modify:o,remove:e.remove,end:e.end,attributeEpoch:e.attributeEpoch});for(const d of l){const h=this._tiles.get(d.tileId);h&&h.onMessage({type:"update",modify:d,remove:e.remove,end:!1,isPixelBuffer:!0,attributeEpoch:null})}return}if(null==e.append)return void t.onMessage({type:"append",clear:e.clear,debugInfo:e.debugInfo,end:e.end,attributeEpoch:e.attributeEpoch});const[s,...a]=e.append;t.onMessage({type:"append",clear:e.clear,append:s,debugInfo:e.debugInfo,end:e.end,attributeEpoch:e.attributeEpoch});for(const o of a){const l=this._tiles.get(o.tileId);l&&l.onMessage({type:"update",modify:o,remove:[],sort:!1,end:!1,isPixelBuffer:!0,attributeEpoch:null})}}_ensureTile(e){if(!this._tiles.has(e)){const t=this._createTile(e);this._copyPixelBufferedEntitiesInto(t),this._tiles.set(e,t)}return this._tiles.get(e)}_createTile(e){(0,V.A)("esri-2d-update-debug")&&console.debug(`Version[${this.version}] Tile[${e}] RenderState.createTile`);const t=new Le.A(e),s=this._tileInfoView.getTileBounds((0,Je.vt)(),t),a=this._tileInfoView.getTileResolution(t.level),o=new Pt.R(t,a,s[0],s[3],!0);if(o.stage=this.getStage(),!o.stage){const l=new I.A("featurelayerview:webgl","Cannot create tile with empty stage");M.A.getLogger("esri.views.2d.layers.features.RenderState").error(l)}return o}_copyPixelBufferedEntitiesInto(e){let t=7;for(let s=-1;s<=1;s++)for(let a=-1;a<=1;a++){if(0===s&&0===a)continue;const l=(0,Ut.K)(e.key,a,s,this._tileInfoView.tileInfo.isWrappable).id,d=this._tiles.get(l);null!=d&&e.copyPixelBufferedEntitesFrom(d,1<<t,a,s),t--}}}var Et=u(62931);class Bt{constructor(e,t){this.id=e,this.version=t,this._resolver=(0,g.Tw)(),this._done=!1}get done(){return this._done}get promise(){return this._resolver.promise}end(){this._resolver.resolve(),this._done=!0}destroy(){this._resolver.reject()}}class Nt extends Me.j{constructor(e){super(e.view.featuresTilingScheme),this.updatingHandles=new Re.U,this._hitTestsRequests=[],this._store=new Ve,this._visibleTiles=new Set,this._subscriptions=new Map,this._updateStatisticsRequests=[],this._lockStatisticUpdates=!1,this._layerView=e}renderChildren(e){if(this.attributeView.update(),this._renderState?.update(this.attributeView.currentEpoch),this._renderState){const t=Array.from(this._renderState.tiles()).filter(s=>s.needsUpload);t.length&&(t[Math.floor(Math.random()*t.length)].upload(),t.length>=2&&this.requestRender());for(const s of this._renderState.tiles())s.tryReady(this.attributeView.currentEpoch)&&(this._subscriptions.get(s.key.id)?.end(),this._layerView.requestUpdate(),this.hasLabels&&this._layerView.view.labelManager.requestUpdate(),this.requestRender())}for(const t of this.children)t.setTransform(e.state);switch(this.hasAnimation&&e.painter.effects.integrate.draw(e,e.attributeView),super.renderChildren(e),e.drawPhase){case ee.S5.MAP:return this._renderMapPhase(e);case ee.S5.HIGHLIGHT:return this._renderHighlightPhase(e);case ee.S5.LABEL:return this._renderLabelPhase(e)}}subscriptions(){return this._subscriptions.values()}get _instanceStore(){return this._store}get instanceStore(){return this._store}get layerView(){return this._layerView}get hasLabels(){return this._layerView.labelingCollisionInfos.length>0}get hasHighlight(){return this._layerView.hasHighlight()}get _layer(){return this._layerView.layer}_getExclusivePostprocessingInstance({drawPhase:e}){if(null==this._instanceStore)return null;let t=0,s=null;for(const a of this._instanceStore.values())a.techniqueRef.drawPhase&e&&(t++,a.techniqueRef.postProcessingEnabled&&(s=a));return t>1?null:s}_getOverrideStencilRef({drawPhase:e}){if(null==this._instanceStore)return null;let t=null;for(const s of this._instanceStore.values()){if(!(s.techniqueRef.drawPhase&e))continue;const{overrideStencilRef:a}=s.techniqueRef;if(null==t)t=a;else if(t!==a){t=null;break}}return t}get children(){return this._renderState?Array.from(this._renderState.tiles()).filter(e=>this._visibleTiles.has(e.key.id)):[]}updateAttributeView(e){this.requestRender(),this.attributeView.requestUpdate(e),this.hasLabels&&this._layerView.view.labelManager.requestUpdate()}updateSubscriptions(e){for(const{tileId:t,version:s}of e.subscribe)if(this._subscriptions.has(t))this._subscriptions.get(t).version=s;else{const a=new Bt(t,s);this._subscriptions.set(t,a),this.updatingHandles.addPromise(a.promise)}for(const t of e.unsubscribe)this._subscriptions.get(t)?.destroy(),this._subscriptions.delete(t),this.removeTile(t)}isDone(e){return!!this._renderState&&this._renderState.isTileDone(e)}updateRenderState(e){var t=this;return(0,b.A)(function*(){(0,V.A)("esri-2d-update-debug")&&console.debug(`Version[${e}] FeatureContainer.updateRenderState`),t._renderStateNext=new Lt(()=>t._stage,e,t._tileInfoView)})()}getDisplayStatistics(e,t){const s=this._statisticsByLevel.get(e);return s?s.get(t):null}updateStatistics(e,t){if(this._lockStatisticUpdates)return void this._updateStatisticsRequests.push({level:e,statistics:t});let s=this._statisticsByLevel.get(e);s||(s=new Map,this._statisticsByLevel.set(e,s));for(const a of t)s.set(a.fieldName,{minValue:a.minValue,maxValue:a.maxValue})}editStart(){this._renderState?.lockUploads(),this.attributeView.lockTextureUploads(),this._lockStatisticUpdates=!0}editEnd(){this._renderState?.unlockUploads(),this.attributeView.unlockTextureUploads(),this._lockStatisticUpdates=!1;for(const e of this._updateStatisticsRequests)this.updateStatistics(e.level,e.statistics);this._updateStatisticsRequests=[],this.requestRender()}swapRenderState(){this._renderStateNext&&((0,V.A)("esri-2d-update-debug")&&console.debug(`Version[${this._renderStateNext.version}] FeatureContainer.update.swapRenderState`),this._renderState?.destroy(),this._renderState=this._renderStateNext,this._renderStateNext=null),this._renderState&&this._renderState.flush(),this.requestRender()}setVisibleTiles(e){this._visibleTiles=e}onMessage(e,t){var s=this;return(0,b.A)(function*(){(0,g.Te)(t);const a=e.inner;if(!s._subscriptions.has(a.id))return;const o=s._subscriptions.get(a.id);if(o.version!==a.subscriptionVesrion)return void((0,V.A)("esri-2d-update-debug")&&console.debug(`Version[${a.subscriptionVesrion} != ${o.version}] Tile[${a.id}] FeatureContainer - Dropping message, outdated version]`,a));const l=s._renderStateNext??s._renderState;if(!l)throw new Error("InternalError: No renderState defined");l.version!==a.version&&console.error(`InternalError: Version mismatch. [renderState: ${l.version}, message: ${a.version}]`),l.enqueueUpdate(a),s.requestRender(),s._layerView.view.labelManager.requestUpdate(),s._layerView.requestUpdate()})()}removeTile(e){(this._renderState||this._renderStateNext)&&(this._renderState&&this._renderState.removeTile(e),this._renderStateNext&&this._renderStateNext.removeTile(e))}hitTest(e){let t=this._hitTestsRequests.find(({x:a,y:o})=>a===e.x&&o===e.y);const s=(0,g.Tw)();return t?t.resolvers.push(s):(t={x:e.x,y:e.y,resolvers:[s]},this._hitTestsRequests.push(t)),this.requestRender(),s.promise}getSortKeys(e){const t=new Set(e),s=new Map;for(const a of this.children)if(a.getSortKeys(t).forEach((o,l)=>s.set(l,o)),s.size===t.size)break;return s}get hasAnimation(){return this.hasLabels}updateTransitionProperties(e,t){super.updateTransitionProperties(e,t),this._layerView.featureEffectView.transitionStep(e,t),this._layerView.featureEffectView.transitioning&&this.requestRender()}doRender(e){const{minScale:t,maxScale:s}=this._layer.effectiveScaleRange,a=e.state.scale;a<=(t||1/0)&&a>=s&&super.doRender(e)}afterRender(e){super.afterRender(e),this._hitTestsRequests.length&&this.requestRender()}setStencilReference(e){const t=this._getOverrideStencilRef(e);if(null==t)super.setStencilReference(e);else for(const s of this.children)s.stencilRef=t(s)}_renderMapPhase(e){this._layerView.featureEffectView.hasEffects?(this._renderOutsideEffect(e),this._renderInsideEffect(e)):this._renderFeatures(e,ee.RI.All),this._hitTestsRequests.length>0&&this._renderHittest(e)}_renderHighlightPhase(e){this.hasHighlight&&(0,Et.lB)(e,!1,t=>{this._renderFeatures(t,ee.RI.Highlight)})}_renderLabelPhase(e){this._renderFeatures(e,ee.RI.All)}_renderInsideEffect(e){const t=e.painter.effects.insideEffect;t.bind(e),this._renderFeatures(e,ee.RI.InsideEffect),t.draw(e,this._layerView.featureEffectView.includedEffects),t.unbind()}_renderOutsideEffect(e){const t=e.painter.effects.outsideEffect;t.bind(e),this._renderFeatures(e,ee.RI.OutsideEffect),t.draw(e,this._layerView.featureEffectView.excludedEffects),t.unbind()}_renderHittest(e){const{context:t}=e,s=e.painter.effects.hittest,a=t.getBoundFramebufferObject(),o=t.getViewport(),l=e.passOptions,d=e.drawPhase;s.bind(e),e.passOptions=s.createOptions(e,this._hitTestsRequests),e.drawPhase=ee.S5.HITTEST;const{distance:h,smallSymbolDistance:p}=e.passOptions,y=Math.max(h,p);for(const v of this.children)v.visible&&v.containsScreenPoint(e.state,e.passOptions.position,2*y)&&this._renderTile(v,e,ee.RI.All);s.draw(e),s.unbind(),t.bindFramebuffer(a),t.restoreViewport(o),e.passOptions=l,e.drawPhase=d}_renderFeatures(e,t){for(const a of this.children)a.visible&&this._renderTile(a,e,t);const s=this._getExclusivePostprocessingInstance(e);s?.techniqueRef.postProcess(e,s)}_renderTile(e,t,s){const a=(0,V.A)("featurelayer-force-marker-text-draw-order")?ee.ch.STRICT_MARKERS_AND_TEXT:ee.ch.BATCHING,o=e.getDisplayList(this._instanceStore,a);t.selection=s,o?.render(t)}}var jt=u(19284);function Xe(){return(Xe=(0,b.A)(function*(r){const e=yield(0,jt.ho)("FeaturePipelineWorker",{client:r,strategy:"dedicated"});return new qt(e)})).apply(this,arguments)}class qt{constructor(e){this._connection=e,this.pipeline=this._connection.createInvokeProxy(),this.features=this._connection.createInvokeProxy("features"),this.aggregates=this._connection.createInvokeProxy("aggregates"),this.streamMessenger=this._connection.createInvokeProxy("streamMessenger")}destroy(){this._connection.destroy()}get closed(){return this._connection.closed}}var Jt=u(42425),Qt=u(12619);let de=class extends F.A{constructor(){super(...arguments),this.events=new Jt.A,this._updatingStrategy=!0,this._tileToEvent=new Qt.A,this._fetchStatus={outstanding:0,done:0}}get hasAllFeatures(){return this._hasAllData()&&(this._strategyInfo?.willQueryAllFeatures??!1)}get hasAllFeaturesInView(){return this._hasAllData()}get hasFullGeometries(){return this._hasAllData()&&(this._strategyInfo?.willQueryFullResolutionGeometry??!1)}onEvent(r){switch(r.type){case"subscribe":case"unsubscribe":case"loaded":case"error":this._handleTileEvent(r);break;case"updateStrategyStart":this._updatingStrategy=!0,this._fetchStatus={done:0,outstanding:0},this._strategyInfo=r.about;break;case"updateStrategyEnd":this._updatingStrategy=!1;break;case"updateFieldsStart":this._fetchStatus={done:0,outstanding:0};break;case"updateFieldsEnd":break;case"updateFieldsError":this.events.emit("error",r);break;case"fetchStart":this._fetchStatus.outstanding+=1,this.events.emit("status",this._fetchStatus);break;case"fetchEnd":this._fetchStatus.done+=1,this.events.emit("status",this._fetchStatus),r.done&&(this._fetchStatus={done:0,outstanding:0})}}_hasAllData(){return!this._updatingStrategy&&this._hasAllTileData()}_hasAllTileData(){for(const r of this._tileToEvent.values())if("loaded"!==r[r.length-1].type)return!1;return!0}_handleTileEvent(r){switch(r.type){case"subscribe":this._tileToEvent.set(r.tile,[r]);break;case"unsubscribe":this._tileToEvent.delete(r.tile);break;case"loaded":{const e=this._tileToEvent.get(r.tile);if(!e)return;e.push(r),this._tileToEvent.set(r.tile,e);break}case"error":{const e=this._tileToEvent.get(r.tile);if(!e)return;e.push(r),this._tileToEvent.set(r.tile,e),this.events.emit("error",r);break}}}};(0,S._)([(0,f.MZ)({readOnly:!0})],de.prototype,"hasAllFeatures",null),(0,S._)([(0,f.MZ)({readOnly:!0})],de.prototype,"hasAllFeaturesInView",null),(0,S._)([(0,f.MZ)({readOnly:!0})],de.prototype,"hasFullGeometries",null),(0,S._)([(0,f.MZ)()],de.prototype,"_updatingStrategy",void 0),(0,S._)([(0,f.MZ)()],de.prototype,"_strategyInfo",void 0),(0,S._)([(0,f.MZ)()],de.prototype,"_tileToEvent",void 0),de=(0,S._)([(0,C.$)("esri.views.2d.layers.features.FeatureSourceEventLog")],de);var Be=u(77806),Qe=u(68438);function pe(r){switch(r.geometryType){case"point":return"esriGeometryPoint";case"polyline":return"esriGeometryPolyline";case"polygon":case"multipatch":return"esriGeometryPolygon";case"multipoint":return"esriGeometryMultipoint";default:return null}}var Te=u(67685);function ae(r,e){const t=r.featureReduction;return t&&"selection"!==t.type&&(!("maxScale"in t)||!t.maxScale||t.maxScale<e.scale)?t:null}var Ge=u(69287),Gt=u(48716),be=u(64765);const Ht=Math.PI;function Ft(r,e){switch(e.transformationType){case be._w.Additive:return function $t(r,e){return r+(le(e.minSize,r)||e.minDataValue)}(r,e);case be._w.Constant:return function Wt(r,e){const t=r.stops;let s=t?.length&&t[0].size;return null==s&&(s=r.minSize),le(s,e)}(e,r);case be._w.ClampedLinear:return function Zt(r,e){const t=e.minDataValue,s=e.maxDataValue,a=(r-t)/(s-t),o=le(e.minSize,r),l=le(e.maxSize,r);return r<=t?o:r>=s?l:o+a*(l-o)}(r,e);case be._w.Proportional:return function Kt(r,e){const t=r/e.minDataValue,s=le(e.minSize,r),a=le(e.maxSize,r);let o=null;return o=t*s,(0,Ge.qE)(o,s,a)}(r,e);case be._w.Stops:return function Yt(r,e){const[t,s,a]=function er(r,e){if(!e)return;let t=0,s=e.length-1;return e.some((a,o)=>r<a?(s=o,!0):(t=o,!1)),[t,s,(r-e[t])/(e[s]-e[t])]}(r,e.cache.ipData);if(t===s)return le(e.stops[t].size,r);{const o=le(e.stops[t].size,r);return o+(le(e.stops[s].size,r)-o)*a}}(r,e);case be._w.RealWorldSize:return function Xt(r,e){const t=Gt.j[e.valueUnit],s=le(e.minSize,r),a=le(e.maxSize,r),{valueRepresentation:o}=e;let l=null;return l="area"===o?2*Math.sqrt(r/Ht)/t:"radius"===o||"distance"===o?2*r/t:r/t,(0,Ge.qE)(l,s,a)}(r,e);case be._w.Identity:return r;case be._w.Unknown:return null}}function le(r,e){return"number"==typeof r?r:Ft(e,r)}function Se(r){return(r.labelsVisible&&r.labelingInfo?.every(e=>"none"!==e.deconflictionStrategy))??!1}function Ce(r,e){const t=ae(r,e);if(t?.labelsVisible&&t.labelingInfo?.length)return t.labelingInfo.every(s=>"none"!==s.deconflictionStrategy)}function tr(r){return e=>(0,Te.Lz)(Ft(e,r))}function Ee(r){const e=null!=r&&"visualVariables"in r&&r.visualVariables;if(!e)return null;for(const t of e)if("size"===t.type)return tr(t);return null}var et=u(63484);function Fe(r,e,t,s){const o=(0,et.m)(r.definitionExpression,null!=r.subtypeCode?`${r.subtypeField} = ${r.subtypeCode}`:null),l=r.customParameters??{};return s&&(l.token=s),{type:"feature",mutable:{sourceRefreshVersion:t,availableFields:e.availableFields,dataFilter:{queryScaleRanges:r.queryScaleRanges??[],definitionExpression:o,gdbVersion:r.gdbVersion,historicMoment:r.historicMoment?.getTime(),timeExtent:r.timeExtent?.toJSON(),customParameters:l}}}}var rr=u(15848),ir=u(73975),sr=(u(47280),u(78592)),ve=u(26747),ce=u(65374),nr=u(54935),ar=u(30365);function or(r,e,t=0){if(null==e)return r[t]=0,r[t+1]=0,r[t+2]=0,void(r[t+3]=0);const{r:s,g:a,b:o,a:l}=e;r[t]=s*l/255,r[t+1]=a*l/255,r[t+2]=o*l/255,r[t+3]=l}u(97550);var He=u(47669),te=u(22818),$e=u(29822),H=u(13220),We=u(34155),_e=u(99845),lr=u(88521);function he(r,e){return tt.apply(this,arguments)}function tt(){return tt=(0,b.A)(function*(r,e){if(!r)return[];switch(r.type){case"simple-fill":return wt(r,e);case"picture-fill":return function Sr(r,e){const{outline:t}=r,{uniforms:s,schemaOptions:a}=e,{store:o}=a,l=[],d=ve.wp.createPictureFillRasterizationParam(r);if(!d)return[];const{width:h,height:p,xoffset:y,yoffset:v,xscale:E,yscale:R}=r,B={color:[255,255,255,255],sprite:d,height:p,aspectRatio:h/p,offsetX:y,offsetY:v,scaleX:E,scaleY:R,angle:0,applyRandomOffset:!1,sampleAlphaOnly:!1,scaleProportionally:!1,effects:null,scaleInfo:null};if("solid"===t?.style)return[o.ensureInstance(te.YS.complexOutlineFill,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeScaleStops:s.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({...B,...nt(t,!!s.visualVariableSizeOutlineScaleStops)})];const re=o.ensureInstance(te.YS.complexFill,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity},optionalAttributes:{zoomRange:!1}});return l.push(re.createMeshInfo(B)),t&&l.push(...Ne(t,e,!0)),l}(r,e);case"simple-marker":return function pr(r,e){return st.apply(this,arguments)}(r,e);case"picture-marker":return function hr(r,e){const{uniforms:t,schemaOptions:s}=e,{store:a}=s,o=a.ensureInstance(te.YS.marker,{uniforms:{visualVariableColor:t.visualVariableColor,visualVariableOpacity:t.visualVariableOpacity,visualVariableSizeMinMaxValue:t.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:t.visualVariableSizeScaleStops,visualVariableSizeStops:t.visualVariableSizeStops,visualVariableSizeUnitValue:t.visualVariableSizeUnitValue,visualVariableRotation:t.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),l=ve.wp.createPictureMarkerRasterizationParam(r);return l?[o.createMeshInfo({type:"picture",color:[255,255,255,255],height:r.height,width:r.width,offsetX:r.xoffset,offsetY:r.yoffset,angle:r.angle,alignment:(0,_e.N)(t)?ce.C1.MAP:ce.C1.SCREEN,outlineColor:null,outlineSize:0,referenceSize:r.height,sprite:l,overrideOutlineColor:!1,hasSizeVV:(0,_e.I)(t),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:(0,H.j0)(t)})]:[]}(r,e);case"simple-line":return Ne(r,e,!1);case"text":return function yr(r,e){const{uniforms:t,schemaOptions:s}=e,{store:a}=s;return[a.ensureInstance(te.YS.text,{uniforms:{visualVariableColor:t.visualVariableColor,visualVariableOpacity:t.visualVariableOpacity,visualVariableRotation:t.visualVariableRotation,visualVariableSizeMinMaxValue:t.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:t.visualVariableSizeScaleStops,visualVariableSizeStops:t.visualVariableSizeStops,visualVariableSizeUnitValue:t.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1,clipAngle:!1,referenceSymbol:!1}}).createMeshInfo({boxBackgroundColor:r.backgroundColor?.toArray(),boxBorderLineColor:r.borderLineColor?.toArray(),boxBorderLineSize:r.borderLineSize??0,color:r.color?.toArray()??[0,0,0,0],offsetX:r.xoffset,offsetY:r.yoffset,postAngle:r.angle,fontSize:r.font.size,decoration:r.font.decoration,haloColor:r.haloColor?.toArray()??[0,0,0,0],haloFontSize:r.haloSize??0,lineWidth:r.lineWidth,lineHeightRatio:r.lineHeight,horizontalAlignment:r.horizontalAlignment,verticalAlignment:r.verticalAlignment,useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:r.font.toJSON(),textString:r.text,symbol:ve.wp.createCIMTextSymbolfromTextSymbol(r)},overrides:[]},referenceSize:null,effects:null,placement:null,scaleInfo:null,transforms:null,scaleFactor:1,minPixelBuffer:(0,H.j0)(t),repeatLabel:null,repeatLabelDistance:null,allowOverrun:null,labelPosition:null,isLineLabel:!1})]}(r,e);case"label":return function mr(r,e){const{schemaOptions:t,uniforms:s}=e,{store:a}=t,o=r.symbol,{allowOverrun:l,repeatLabel:d,repeatLabelDistance:h}=r,p={maxScale:r.maxScale??0,minScale:r.minScale??0},y=a.ensureInstance(te.YS.label,{uniforms:{visualVariableColor:null,visualVariableOpacity:null,visualVariableRotation:s.visualVariableRotation,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!0,clipAngle:!0,referenceSymbol:!0}}),v=r.labelPlacement,[E,R]=(0,ar.fO)(v);return[y.createMeshInfo({boxBackgroundColor:o.backgroundColor?.toArray(),boxBorderLineColor:o.borderLineColor?.toArray(),boxBorderLineSize:o.borderLineSize??0,color:o.color?.toArray()??[0,0,0,0],offsetX:o.xoffset,offsetY:o.yoffset,postAngle:o.angle,fontSize:o.font.size,decoration:o.font.decoration,haloColor:o.haloColor?.toArray()??[0,0,0,0],haloFontSize:o.haloSize??0,lineWidth:o.lineWidth,lineHeightRatio:o.lineHeight,horizontalAlignment:E,verticalAlignment:R,repeatLabel:d,repeatLabelDistance:(0,Te.Lz)(h),allowOverrun:l,labelPosition:r.labelPosition,scaleInfo:p,minPixelBuffer:(0,H.j0)(s),useCIMAngleBehavior:!1,glyphs:{type:"text-rasterization-param",resource:{type:"text",font:o.font.toJSON(),textString:o.text,symbol:ve.wp.createCIMTextSymbolfromTextSymbol(o),primitiveName:"label-override"},useLegacyLabelEvaluationRules:null==r.labelExpressionInfo?.expression,overrides:[{type:"CIMPrimitiveOverride",valueExpressionInfo:{type:"CIMExpressionInfo",expression:r.labelExpressionInfo?.expression??r.labelExpression,returnType:"String"},primitiveName:"label-override",propertyName:"textString",defaultValue:""}]},referenceSize:null,effects:null,placement:null,transforms:null,scaleFactor:1,isLineLabel:!1})]}(r,e);case"cim":return(0,We.Jk)(r.data,e);case"web-style":{const t=yield r.fetchCIMSymbol();return(0,We.Jk)(t.data,e)}default:throw new Error(`symbol not supported ${r.type}`)}}),tt.apply(this,arguments)}function ur(r,e){return rt.apply(this,arguments)}function rt(){return(rt=(0,b.A)(function*(r,e){const{schemaOptions:t}=e,{store:s}=t,a=new Array(He.ju),o=new Array(He.ju/4);for(let p=0;p<He.ju;p++){const y=p<r.attributes.length?r.attributes[p].color:null;a[p]=[0,0,0,0],or(a[p],y)}for(let p=0;p<He.ju/4;p++)o[p]=[0,0,0,0],o[p][0]=4*p<r.attributes.length?1:0,o[p][1]=4*p+1<r.attributes.length?1:0,o[p][2]=4*p+2<r.attributes.length?1:0,o[p][3]=4*p+3<r.attributes.length?1:0;const d=s.ensureInstance(te.YS.dotDensity,{uniforms:{isActive:o,colors:a,dotValue:r.dotValue,dotScale:r.referenceScale,blending:r.dotBlendingEnabled,dotSize:r.dotSize,seed:r.seed},optionalAttributes:{}}).createMeshInfo({effects:null}),h=[];if(r.backgroundColor){const p=new lr.A({color:r.backgroundColor,outline:null}),y=yield he(p,e);h.push(...y)}if(h.push(d),r.outline){const p=Ne(r.outline,e,!0);h.push(...p)}return h})).apply(this,arguments)}function cr(r,e){return it.apply(this,arguments)}function it(){return(it=(0,b.A)(function*(r,e){const{store:t}=e,{radius:s,minDensity:a,maxDensity:o,referenceScale:l,field:d,valueExpression:h,colorStops:p}=r,y=(0,sr.O3)(p);return[t.ensureInstance(te.YS.heatmap,{uniforms:{radius:(0,Te.Lz)(s),minDensity:a,maxDensity:o,referenceScale:l,isFieldActive:!(!d&&!h),gradient:y,gradientHash:y.join(",")},optionalAttributes:{}}).createMeshInfo({effects:null})]})).apply(this,arguments)}function dr(r,e){const{store:t}=e,s=r.outline?.width||0,a=(0,H.K4)(r),o=t.ensureInstance(te.YS.pieChart,{uniforms:{shader:{outlineWidth:Math.round((0,Te.Lz)(s)),defaultColor:(0,$e.p)(r.defaultColor),outlineColor:(0,$e.p)(r.outline?.color),othersColor:(0,$e.p)(r.othersCategory?.color),donutRatio:r.holePercentage,sectorThreshold:r.othersCategory?.threshold||0,colors:r.attributes.map(l=>(0,$e.p)(l.color)),visualVariableOpacity:a.visualVariableOpacity,visualVariableSizeMinMaxValue:a.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:a.visualVariableSizeScaleStops,visualVariableSizeStops:a.visualVariableSizeStops,visualVariableSizeUnitValue:a.visualVariableSizeUnitValue,hittestUniforms:null},numberOfFields:r.attributes.length},optionalAttributes:{}}).createMeshInfo({size:r.size,outlineWidth:s,effects:null,scaleInfo:null,minPixelBuffer:(0,H.j0)(a)});return[...r.backgroundFillSymbol?wt(r.backgroundFillSymbol,{schemaOptions:e,path:"",uniforms:H.Dk}):[],o]}function At(r){if("path"===r.style){if(null==r.path)throw new Error("Symbol with a style of type path must define a path");return{type:"sprite-rasterization-param",overrides:[],resource:{type:"path",path:r.path,asFill:!0}}}const e=ve.wp.fromSimpleMarker(r);if("outline"in r&&r.outline&&"none"!==r.outline.style&&"solid"!==r.outline.style){if(!e||!e.symbolLayers)throw new Error("Error handling marker! ");return{type:"sprite-rasterization-param",resource:e.symbolLayers[0],overrides:[]}}return{type:"sprite-rasterization-param",resource:(0,nr.eR)(e),overrides:[]}}function st(){return(st=(0,b.A)(function*(r,e){const{uniforms:t,schemaOptions:s}=e,{store:a}=s;if("path"===r.style||r.outline&&"solid"!==r.outline.style&&"none"!==r.outline.style){const E=ve.wp.fromSimpleMarker(r);if(!E||!E.symbolLayers)throw new Error("Error handling marker! ");if(t.visualVariableRotation&&(E.angleAlignment="Map"),"path"!==r.style){const R=E.symbolLayers[0];if((0,_e.I)(e.uniforms)){const B=(0,H.j0)(e.uniforms,0,1);if(B>R.size){const re=B/R.size;R.size=B;const W=R.markerGraphics?.[0].symbol;(W.symbolLayers&&W.symbolLayers[0]).width*=re}}}return(0,We.Jk)({type:"CIMSymbolReference",symbol:E},e)}const o=a.ensureInstance(te.YS.marker,{uniforms:{visualVariableColor:t.visualVariableColor,visualVariableOpacity:t.visualVariableOpacity,visualVariableSizeMinMaxValue:t.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:t.visualVariableSizeScaleStops,visualVariableSizeStops:t.visualVariableSizeStops,visualVariableSizeUnitValue:t.visualVariableSizeUnitValue,visualVariableRotation:t.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),l=At(r);let d=r.color?.toArray()??[0,0,0,0];"CIMVectorMarker"===l.resource.type&&(d=[255,255,255,255]);const p=r.size,v=null!=t.visualVariableColor&&("cross"===r.style||"x"===r.style);return[o.createMeshInfo({type:"simple",color:d,height:p,width:p*("triangle"===r.style?124/116:1),offsetX:r.xoffset,offsetY:r.yoffset,angle:r.angle,alignment:(0,_e.N)(t)?ce.C1.MAP:ce.C1.SCREEN,outlineColor:r.outline?.color?.toArray()??[0,0,0,0],outlineSize:r.outline?.width??1,referenceSize:p,sprite:l,overrideOutlineColor:v,hasSizeVV:(0,_e.I)(t),placement:null,effects:null,transforms:null,scaleInfo:null,minPixelBuffer:(0,H.j0)(t)})]})).apply(this,arguments)}function nt(r,e){const t=r.width;return{outlineColor:r.color?.toArray()||[0,0,0,1],width:t,referenceWidth:t,capType:r.cap??"round",joinType:r.join??"round",miterLimit:r.miterLimit,hasSizeVV:e}}function wt(r,e){const{style:t}=r;return t&&"none"!==t&&"solid"!==t?function gr(r,e){const{uniforms:t,schemaOptions:s}=e,{store:a}=s,o=r.color?.toArray()??[0,0,0,0],l={type:"sprite-rasterization-param",resource:{type:"fill-style",style:r.style},overrides:[]};if("solid"===r.outline?.style)return[a.ensureInstance(te.YS.patternOutlineFill,{uniforms:{visualVariableColor:t.visualVariableColor,visualVariableOpacity:t.visualVariableOpacity,visualVariableSizeScaleStops:t.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:o,...nt(r.outline,!!t.visualVariableSizeOutlineScaleStops),sprite:l,scaleInfo:null,effects:null})];const d=[],h=a.ensureInstance(te.YS.patternFill,{uniforms:{visualVariableColor:t.visualVariableColor,visualVariableOpacity:t.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:r.color?.toArray()??[0,0,0,0],sprite:l,scaleInfo:null,effects:null});return d.push(h),r.outline&&d.push(...Ne(r.outline,e,!0)),d}(r,e):function br(r,e){const{uniforms:t,schemaOptions:s}=e,{store:a}=s,o=r.color?.toArray()??[0,0,0,0];if("none"!==r.style&&"solid"===r.outline?.style)return[a.ensureInstance(te.YS.outlineFill,{uniforms:{visualVariableColor:t.visualVariableColor,visualVariableOpacity:t.visualVariableOpacity,visualVariableSizeScaleStops:t.visualVariableSizeOutlineScaleStops,visualVariableSizeMinMaxValue:null,visualVariableSizeStops:null,visualVariableSizeUnitValue:null},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:o,...nt(r.outline,!!t.visualVariableSizeOutlineScaleStops),scaleInfo:null,effects:null})];const l=[];if("none"!==r.style){const d=a.ensureInstance(te.YS.fill,{uniforms:{visualVariableColor:t.visualVariableColor,visualVariableOpacity:t.visualVariableOpacity},optionalAttributes:{zoomRange:!1}}).createMeshInfo({color:o,scaleInfo:null,effects:null});l.push(d)}return r.outline&&l.push(...Ne(r.outline,e,!0)),l}(r,e)}function Ne(r,e,t){const{color:s,style:a,width:o,cap:l,join:d}=r,{schemaOptions:h}=e,{store:p}=h,y=[],v=t?{...H.Dk,visualVariableSizeScaleStops:e.uniforms.visualVariableSizeOutlineScaleStops}:e.uniforms,E={uniforms:{visualVariableColor:v.visualVariableColor,visualVariableOpacity:v.visualVariableOpacity,visualVariableSizeMinMaxValue:v.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:v.visualVariableSizeScaleStops,visualVariableSizeStops:v.visualVariableSizeStops,visualVariableSizeUnitValue:v.visualVariableSizeUnitValue},optionalAttributes:{zoomRange:!1}},R={color:s?.toArray()??[0,0,0,0],width:o,referenceWidth:o,capType:l,joinType:d,miterLimit:r.miterLimit,hasSizeVV:(0,_e.I)(v),effects:null,scaleInfo:null};if(null==a||"solid"===a){const B=p.ensureInstance(te.YS.line,E).createMeshInfo(R);y.push(B)}else if("none"!==a){const B=p.ensureInstance(te.YS.texturedLine,E).createMeshInfo({...R,shouldScaleDash:!0,shouldSampleAlphaOnly:!1,isSDF:!0,sprite:{type:"sprite-rasterization-param",resource:{type:"dash",dashTemplate:(0,ve.BW)(a,l),capStyle:(0,ve.ni)(l)},overrides:[]}});y.push(B)}return null!=r.marker&&y.push(...function fr(r,e,t){const{uniforms:s,schemaOptions:a}=t,{store:o}=a,l=o.ensureInstance(te.YS.marker,{uniforms:{visualVariableColor:s.visualVariableColor,visualVariableOpacity:s.visualVariableOpacity,visualVariableSizeMinMaxValue:s.visualVariableSizeMinMaxValue,visualVariableSizeScaleStops:s.visualVariableSizeScaleStops,visualVariableSizeStops:s.visualVariableSizeStops,visualVariableSizeUnitValue:s.visualVariableSizeUnitValue,visualVariableRotation:s.visualVariableRotation},optionalAttributes:{zoomRange:!1}}),d=At(r),p=6*e.width,y=p,v=r.color?.toArray()??e.color?.toArray()??[0,0,0,0],E="cross"===r.style||"x"===r.style;let R;switch(r.placement){case"begin-end":R=ce.$2.Both;break;case"begin":R=ce.$2.JustBegin;break;case"end":R=ce.$2.JustEnd;break;default:R=ce.$2.None}const B={type:"cim-marker-placement-param",placement:{type:"CIMMarkerPlacementAtExtremities",angleToLine:!0,offset:0,extremityPlacement:R,offsetAlongLine:0},overrides:[]};return[l.createMeshInfo({type:"simple",color:v,height:y,width:p,offsetX:0,offsetY:0,angle:0,alignment:(0,_e.N)(s)?ce.C1.MAP:ce.C1.SCREEN,outlineColor:v,outlineSize:E?e.width:0,referenceSize:y/6,sprite:d,overrideOutlineColor:E&&null!=s.visualVariableColor,hasSizeVV:(0,_e.I)(s),placement:B,transforms:null,effects:null,scaleInfo:null,minPixelBuffer:(0,H.j0)(s)})]}(r.marker,r,e)),y}function je(r,e,t){return at.apply(this,arguments)}function at(){return at=(0,b.A)(function*(r,e,t){const s=e.labelsVisible&&e.labelingInfo||[],a=pe(e),o=(0,ir.z)(s,a);return{type:"label",classes:yield Promise.all(o.map((l,d)=>function vr(r,e,t,s){return ot.apply(this,arguments)}(r,l,d,t)))}}),at.apply(this,arguments)}function ot(){return(ot=(0,b.A)(function*(r,e,t,s){const a=yield he(e,{path:`${t}`,schemaOptions:r,uniforms:s});return{maxScale:e.maxScale,minScale:e.minScale,expression:e.labelExpressionInfo?.expression??e.labelExpression,where:e.where,meshes:a}})).apply(this,arguments)}function ke(r,e){return lt.apply(this,arguments)}function lt(){return lt=(0,b.A)(function*(r,e){if(!e)return{type:"simple",meshes:[]};switch(e.type){case"simple":return function _r(r,e){return ct.apply(this,arguments)}(r,e);case"dot-density":return function xr(r,e){return dt.apply(this,arguments)}(r,e);case"class-breaks":return function Ir(r,e){return pt.apply(this,arguments)}(r,e);case"unique-value":return function Vr(r,e){return ht.apply(this,arguments)}(r,e);case"dictionary":return function Er(r){const e=(0,H.K4)(r),t=r.scaleExpression;return{type:"dictionary",fieldMap:r.fieldMap,scaleExpression:null!=t&&"1"!==t?{valueExpressionInfo:{type:"CIMExpressionInfo",expression:r.scaleExpression,returnType:"Numeric"},defaultValue:1}:void 0,visualVariableUniforms:e}}(e);case"heatmap":return function Fr(r,e){return ft.apply(this,arguments)}(r,e);case"pie-chart":return function Ar(r,e){return yt.apply(this,arguments)}(r,e)}}),lt.apply(this,arguments)}function ct(){return(ct=(0,b.A)(function*(r,e){const t=e.getSymbols(),s=t.length?t[0]:null,a=(0,H.K4)(e);return{type:"simple",meshes:yield he(s,{schemaOptions:r,uniforms:a,path:"renderer.symbol"})}})).apply(this,arguments)}function dt(){return(dt=(0,b.A)(function*(r,e){const t=(0,H.K4)(e);return{type:"dot-density",meshes:yield ur(e,{schemaOptions:r,uniforms:t,path:"renderer.symbol"})}})).apply(this,arguments)}function pt(){return pt=(0,b.A)(function*(r,e){const t=(0,H.K4)(e),s=e.backgroundFillSymbol,a=e.normalizationType,o="log"===a?"esriNormalizeByLog":"percent-of-total"===a?"esriNormalizeByPercentOfTotal":"field"===a?"esriNormalizeByField":null,l=e.classBreakInfos.map(function(){var y=(0,b.A)(function*(v){return{meshes:yield he(v.symbol,{path:`renderer-stop-${v.minValue}-${v.maxValue}`,schemaOptions:r,uniforms:t}),min:v.minValue,max:v.maxValue}});return function(v){return y.apply(this,arguments)}}()),d=(yield Promise.all(l)).sort((y,v)=>y.min-v.min),h=yield he(s,{schemaOptions:r,path:"renderer.backgroundFill",uniforms:{...H.Dk,visualVariableSizeOutlineScaleStops:t.visualVariableSizeOutlineScaleStops}}),p=yield he(e.defaultSymbol,{schemaOptions:r,path:"renderer.defaultSymbol",uniforms:t});return{type:"interval",field:e.field,expression:e.valueExpression,backgroundFill:h,defaultSymbol:p,intervals:d,normalizationField:e.normalizationField,normalizationTotal:e.normalizationTotal,normalizationType:o,isMaxInclusive:e.isMaxInclusive}}),pt.apply(this,arguments)}function ht(){return(ht=(0,b.A)(function*(r,e){const t=[],s=(0,H.K4)(e),a=yield he(e.backgroundFillSymbol,{schemaOptions:r,path:"renderer.backgroundFill",uniforms:{...H.Dk,visualVariableSizeOutlineScaleStops:s.visualVariableSizeOutlineScaleStops}}),o=yield he(e.defaultSymbol,{schemaOptions:r,path:"renderer.defaultSymbol",uniforms:s});for(const l of e.uniqueValueInfos??[]){const d=yield he(l.symbol,{path:`renderer-unique-value-${l.value}`,schemaOptions:r,uniforms:s});t.push({value:""+l.value,symbol:d})}return{type:"map",field:e.field,expression:e.valueExpression,field2:e.field2,field3:e.field3,fieldDelimiter:e.fieldDelimiter,backgroundFill:a,defaultSymbol:o,map:t}})).apply(this,arguments)}function ft(){return(ft=(0,b.A)(function*(r,e){return{type:"heatmap",meshes:yield cr(e,r)}})).apply(this,arguments)}function yt(){return(yt=(0,b.A)(function*(r,e){return{type:"pie-chart",meshes:dr(e,r)}})).apply(this,arguments)}var Ze=u(84836);function mt(){return(mt=(0,b.A)(function*(r,e){const t=e.renderer,s=(0,H.K4)(t);return{symbology:yield ke(r,t),labels:yield je(r,e,s)}})).apply(this,arguments)}function Ae(r,e,t,s){return gt.apply(this,arguments)}function gt(){return gt=(0,b.A)(function*(r,e,t,s){const a=t.featureReduction;if(a)switch(a.type){case"binning":return function Mr(r,e,t,s,a){return bt.apply(this,arguments)}(a,r,e,t,s);case"cluster":return function Tr(r,e,t,s,a){return St.apply(this,arguments)}(a,r,e,t,s)}const o=function Cr(r,e,t){const s=null!=e&&"unique-value"===e.type&&e.orderByClassesEnabled;if("default"!==r||s||(r=[new rr.A({field:t,order:"descending"})]),"default"!==r&&r.length){const a=r[0],o="ascending"===a.order?"asc":"desc";return a.field?{field:a.field,order:o}:a.valueExpression?{expression:a.valueExpression,order:o}:null}return s?{byRenderer:!0,order:"asc"}:null}(t.orderBy,t.renderer,t.objectIdField),l=(0,Ze.T9)(t.renderer,e.filters),d=yield function wr(r,e){return mt.apply(this,arguments)}(r,t);return{storage:l,mesh:{properties:{sortKey:o,timeZone:e.timeZone,returnMeshObjectId:!1,displayRefreshVersion:s},strategy:{type:"feature"},factory:d}}}),gt.apply(this,arguments)}function Rt(r,e){return r.fields.map(t=>({...t.toJSON(),type:Rr(t,e)}))}function Rr(r,e){const{onStatisticExpression:t,onStatisticField:s,statisticType:a}=r;switch(a){case"min":case"max":case"avg":case"avg_angle":case"sum":case"count":return"esriFieldTypeDouble";case"mode":{if(t){const{returnType:l}=t;return l?"string"===l?"esriFieldTypeString":"esriFieldTypeDouble":"esriFieldTypeString"}const o=e.find(l=>l.name===s);return o?o.type:"esriFieldTypeString"}}}function bt(){return(bt=(0,b.A)(function*(r,e,t,s,a){const o=Rt(r,s.fields),l=r.renderer,d=yield ke(e,l),h=(0,Ze.T9)(l,[null,null]),p=(0,H.K4)(l),y=yield je(e,{geometryType:"polygon",labelingInfo:r.labelingInfo,labelsVisible:r.labelsVisible},p),E="geohash"===r.binType?{type:"geohash",fixBinLevel:r.fixedBinLevel??3}:{type:"grid",size:(0,Te.Lz)(r.size),fixedBinLevel:r.fixedBinLevel};return{storage:h,mesh:{properties:{sortKey:null,timeZone:t.timeZone,returnMeshObjectId:!1,displayRefreshVersion:a},strategy:{type:"binning",fields:o,index:E,featureFilter:t.filters[0]},factory:{labels:y,symbology:d}}}})).apply(this,arguments)}function St(){return(St=(0,b.A)(function*(r,e,t,s,a){const o=Rt(r,s.fields),l={type:"cluster",feature:yield ke(e,r.effectiveFeatureRenderer),cluster:yield ke(e,r.effectiveClusterRenderer)},d=(0,H.K4)(r.effectiveFeatureRenderer),h={type:"cluster",feature:yield je(e,s,d),cluster:yield je(e,{geometryType:"point",labelingInfo:r.labelingInfo,labelsVisible:r.labelsVisible},d)};return{storage:(0,Ze.T9)(r.effectiveFeatureRenderer,[null,null]),mesh:{properties:{sortKey:null,timeZone:t.timeZone,displayRefreshVersion:a,returnMeshObjectId:!1},strategy:{type:"cluster",fields:o,featureFilter:t.filters[0],clusterRadius:(0,Te.Lz)(r.clusterRadius/2)},factory:{labels:h,symbology:l}}}})).apply(this,arguments)}var we=u(79213);class Or{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=Se(t);return[{vvEvaluators:{0:Ee(t.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var t=this;return(0,b.A)(function*(){const s=t.layer,{capabilities:a,editingInfo:o,objectIdField:l,globalIdField:d,datesInUnknownTimezone:h,orderBy:p,parsedUrl:y}=s,v=s.fieldsIndex.toJSON(),E=pe(s),R=s.timeInfo?.toJSON(),B=s.spatialReference.toJSON(),re=(0,Be.o8)(y);let W=l;if(p?.length){const fe=!p[0].valueExpression&&p[0].field;fe&&(W=fe)}return{type:"feature-service",source:re,isSourceHosted:(0,Qe.Wo)(re.path),orderByFields:W,outSpatialReference:e.spatialReference.toJSON(),metadata:{timeReferenceUnknownClient:h,globalIdField:d,fieldsIndex:v,geometryType:E,objectIdField:l,timeInfo:R,spatialReference:B,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:a.query.maxRecordCount,supportsCompactGeometry:a.query.supportsCompactGeometry,supportsDefaultSpatialReference:a.query.supportsDefaultSpatialReference,supportsFormatPBF:a.query.supportsFormatPBF,supportsMaxRecordCountFactor:a.query.supportsMaxRecordCountFactor,supportsQuantization:a.query.supportsQuantization,lastEditDate:o?.lastEditDate?.getTime(),snapshotInfo:null}}})()}createSourceSchema(e,t){const{definitionExpression:s,customParameters:a,timeExtent:o,apiKey:l}=this.layer;return Fe({definitionExpression:s,customParameters:a,timeExtent:o},e,t,l)}createProcessorSchema(e,t,s){const{fields:a,geometryType:o,orderBy:l,objectIdField:d,renderer:h,labelingInfo:p,labelsVisible:y}=this.layer;return Ae(e,t,{featureReduction:null,fields:a.map(E=>E.toJSON()),geometryType:o,labelingInfo:p,labelsVisible:y,objectIdField:d,orderBy:l??"default",renderer:h?.clone()},s)}get hasRequiredSupport(){return(0,we.e)(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,apiKey:a,renderer:o}=t,l=this.layer.labelsVisible?this.layer.labelingInfo:null,d=JSON.stringify(t.customParameters),h=JSON.stringify(t.orderBy);return{outFields:this.layer.outFields,apiKey:a,customParameters:d,definitionExpression:s,labelingInfo:l,orderBy:h,renderer:o}}setGraphicOrigin(e){e.origin={type:"catalog",layer:this.layer}}}function vt(r,e){const t=r.extent,s=e?.clone().intersection(t),o=e?e.width*e.height:0,l=0===o?0:(null!=s?s.width*s.height:0)/o,d=(0,V.A)("featurelayer-snapshot-point-coverage");return!isNaN(l)&&l>=d}function Oe(r,e){return null!=r.floorInfo&&(r.floorInfo.viewAllLevelIds.length>0||e.floors.length>0)}function _t(r,e,t){const s=function zr(r,e,t){if(null==r.floorInfo||!t.floors?.length)return e;let s=t.floors;const{floorField:a,viewAllLevelIds:o}=r.floorInfo;o.length&&(s=o);const l=s.filter(h=>""!==h).map(h=>"'"+h+"'");if(l.push("''"),e?.includes(a)){let h=new RegExp("AND \\("+a+".*NULL\\)","g");e=e.replace(h,""),h=new RegExp("\\("+a+".*NULL\\)","g"),e=(e=e.replace(h,"")).replaceAll(/\s+/g," ").trim()}let d="("+a+" IN ({ids}) OR "+a+" IS NULL)";return d=d.replace("{ids}",l.join(", ")),(0,et.m)(e,d)}(r,e?.where,t);return s&&(e??=new L.A,e.where=s),e}class Pr{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=Ce(t,e)??Se(t);return[{vvEvaluators:{0:Ee(t.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var t=this;return(0,b.A)(function*(){const s=t.layer,{capabilities:a,editingInfo:o,objectIdField:l,typeIdField:d,globalIdField:h,datesInUnknownTimezone:p,orderBy:y,subtypeField:v,refreshInterval:E}=s,R=s.fieldsIndex.toJSON(),B=R.fields,re=pe(s),W=s.timeInfo?.toJSON(),fe=s.spatialReference.toJSON(),Pe=s.types?.map(Ue=>Ue.toJSON()),xe=(0,Be.o8)(t.layer.parsedUrl);t.layer.dynamicDataSource&&(xe.query={layer:JSON.stringify({source:t.layer.dynamicDataSource})});let Ye=t.layer.objectIdField;if(y?.length){const Ue=!y[0].valueExpression&&y[0].field;Ue&&(Ye=Ue)}const oi=null==o?.lastEditDate&&E>0,zt=(0,V.A)("featurelayer-snapshot-enabled")&&"point"===s.geometryType&&a?.query.supportsPagination&&!a?.operations.supportsEditing&&!oi,li=zt&&vt(e,s.fullExtent);return{type:"feature-service",source:xe,isSourceHosted:(0,Qe.Wo)(xe.path),orderByFields:Ye,outSpatialReference:e.spatialReference.toJSON(),metadata:{typeIdField:d??void 0,types:Pe,timeReferenceUnknownClient:p,subtypeField:v,globalIdField:h,fields:B,fieldsIndex:R,geometryType:re,objectIdField:l,timeInfo:W,spatialReference:fe,subtypes:t.layer.subtypes?.map(Ue=>Ue.toJSON())},queryMetadata:{maxRecordCount:a.query.maxRecordCount,supportsCompactGeometry:a.query.supportsCompactGeometry,supportsDefaultSpatialReference:a.query.supportsDefaultSpatialReference,supportsFormatPBF:a.query.supportsFormatPBF,supportsMaxRecordCountFactor:a.query.supportsMaxRecordCountFactor,supportsQuantization:a.query.supportsQuantization,lastEditDate:o?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:zt,supportsSnapshotMaxThreshold:li,snapshotCountThresholds:{min:(0,V.A)("featurelayer-snapshot-point-min-threshold"),max:(0,V.A)("featurelayer-snapshot-point-max-threshold")}}}}})()}createSourceSchema(e,t){const{definitionExpression:s,customParameters:a,gdbVersion:o,historicMoment:l,subtypeCode:d,subtypeField:h,timeExtent:p,apiKey:y}=this.layer;return Fe({definitionExpression:s,customParameters:a,gdbVersion:o,historicMoment:l,subtypeCode:d,subtypeField:h,timeExtent:p},e,t,y)}createProcessorSchema(e,t,s){const{fields:a,renderer:o,geometryType:l,labelingInfo:d,labelsVisible:h,orderBy:p,objectIdField:y}=this.layer;return Ae(e,t,{fields:a.map(E=>E.toJSON()),renderer:o?.clone(),featureReduction:ae(this.layer,t),geometryType:l,labelingInfo:d,labelsVisible:h,objectIdField:y,orderBy:p??"default"},s)}get hasRequiredSupport(){return(0,we.e)(this.layer.renderer)}get timeOptions(){return this.layer}hasFilters(e){return Oe(this.layer,e)}addFilters(e,t){return _t(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:a,gdbVersion:o,apiKey:l,subtypeCode:d}=t,h=this.layer.labelsVisible?this.layer.labelingInfo:null,p=t.historicMoment?.getTime()??void 0,y=JSON.stringify(t.customParameters),v=ae(t,e),E=JSON.stringify(t.orderBy),R=Oe(this.layer,e)?e.floors:null;return{outFields:this.layer.outFields,apiKey:l,customParameters:y,definitionExpression:s,featureReduction:v,floors:R,gdbVersion:o,historicMoment:p,labelingInfo:h,orderBy:E,renderer:a,subtypeCode:d}}}class Mt{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=Ce(t,e)??Se(t);return[{vvEvaluators:{0:Ee(t.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var t=this;return(0,b.A)(function*(){const s=t.layer,{capabilities:a,objectIdField:o}=s,l=s.fieldsIndex.toJSON(),d=pe(s),h=s.timeInfo?.toJSON(),p=s.spatialReference.toJSON();return function Ur(r){if(!("openPorts"in r))throw new I.A("source-not-supported")}(s.source),{type:"memory",source:yield s.source.openPorts(),orderByFields:o,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:l,geometryType:d,objectIdField:o,timeInfo:h,spatialReference:p,subtypes:null,subtypeField:null,globalIdField:null,typeIdField:null,types:null,timeReferenceUnknownClient:null},queryMetadata:{maxRecordCount:a.query.maxRecordCount,supportsCompactGeometry:a.query.supportsCompactGeometry,supportsDefaultSpatialReference:a.query.supportsDefaultSpatialReference,supportsFormatPBF:a.query.supportsFormatPBF,supportsMaxRecordCountFactor:a.query.supportsMaxRecordCountFactor,supportsQuantization:a.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}})()}createSourceSchema(e,t){const{definitionExpression:s,timeExtent:a}=this.layer;return Fe({definitionExpression:s,timeExtent:a,customParameters:null},e,t,null)}createProcessorSchema(e,t,s){const{fields:a,renderer:o,geometryType:l,labelingInfo:d,labelsVisible:h,orderBy:p,objectIdField:y}=this.layer;return Ae(e,t,{fields:a.map(E=>E.toJSON()),renderer:o?.clone(),featureReduction:ae(this.layer,t),geometryType:l,labelingInfo:d,labelsVisible:h,objectIdField:y,orderBy:p??"default"},s)}get hasRequiredSupport(){return(0,we.e)(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:a}=t,o=this.layer.labelsVisible?this.layer.labelingInfo:null,l=ae(t,e);return{orderBy:JSON.stringify(t.orderBy),definitionExpression:s,renderer:a,labelingInfo:o,featureReduction:l}}}class Dr{constructor(e){this.layer=e,this.timeOptions=null}getLabelingDeconflictionInfo(e){const t=this.layer,s=Ce(t,e)??Se(t);return[{vvEvaluators:{0:Ee(t.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var t=this;return(0,b.A)(function*(){const s=t.layer,{capabilities:a,objectIdField:o}=s,l=s.fieldsIndex.toJSON(),d=pe(s),h=s.spatialReference.toJSON();return{type:"memory",source:yield s.source.openPorts(),orderByFields:o,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:l,geometryType:d,objectIdField:o,spatialReference:h,globalIdField:null,subtypeField:null,subtypes:null,timeInfo:null,timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:a.query.maxRecordCount,supportsCompactGeometry:a.query.supportsCompactGeometry,supportsDefaultSpatialReference:a.query.supportsDefaultSpatialReference,supportsFormatPBF:a.query.supportsFormatPBF,supportsMaxRecordCountFactor:a.query.supportsMaxRecordCountFactor,supportsQuantization:a.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}})()}createSourceSchema(e,t){const{definitionExpression:s}=this.layer;return Fe({definitionExpression:s,customParameters:null},e,t,null)}createProcessorSchema(e,t,s){const{fields:a,renderer:o,geometryType:l,labelingInfo:d,labelsVisible:h,objectIdField:p}=this.layer;return Ae(e,t,{fields:a.map(v=>v.toJSON()),renderer:o?.clone(),featureReduction:ae(this.layer,t),geometryType:l,labelingInfo:d,labelsVisible:h,objectIdField:p,orderBy:"default"},s)}get hasRequiredSupport(){return(0,we.e)(this.layer.renderer)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:a}=t;return{definitionExpression:s,renderer:a,labelingInfo:this.layer.labelsVisible?this.layer.labelingInfo:null,featureReduction:ae(t,e)}}}class Lr{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=Ce(t,e)??Se(t);return[{vvEvaluators:{0:Ee(t.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var t=this;return(0,b.A)(function*(){const s=t.layer,{capabilities:a,objectIdField:o}=s,l=s.fieldsIndex.toJSON(),d=pe(s),h=s.timeInfo?.toJSON(),p=s.spatialReference.toJSON(),y=s.source.getSource(),v=t.layer.objectIdField,E=(0,Be.o8)(a);return E.query.maxRecordCount=y.maxRecordCount,{type:"ogc",source:y,orderByFields:v,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:l,geometryType:d,objectIdField:o,timeInfo:h,spatialReference:p,globalIdField:null,subtypeField:null,subtypes:null,timeReferenceUnknownClient:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:E.query.maxRecordCount,supportsCompactGeometry:E.query.supportsCompactGeometry,supportsDefaultSpatialReference:E.query.supportsDefaultSpatialReference,supportsFormatPBF:E.query.supportsFormatPBF,supportsMaxRecordCountFactor:E.query.supportsMaxRecordCountFactor,supportsQuantization:E.query.supportsQuantization,lastEditDate:null,snapshotInfo:null}}})()}createSourceSchema(e,t){const{customParameters:s,timeExtent:a,apiKey:o}=this.layer;return Fe({customParameters:s,timeExtent:a},e,t,o)}createProcessorSchema(e,t,s){const{fields:a,renderer:o,geometryType:l,labelingInfo:d,labelsVisible:h,orderBy:p,objectIdField:y}=this.layer;return Ae(e,t,{fields:a.map(E=>E.toJSON()),renderer:o?.clone(),featureReduction:ae(this.layer,t),geometryType:l,labelingInfo:d,labelsVisible:h,objectIdField:y,orderBy:p??"default"},s)}get hasRequiredSupport(){return(0,we.e)(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{renderer:s,apiKey:a}=t,o=this.layer.labelsVisible?this.layer.labelingInfo:null;return{apiKey:a,customParameters:JSON.stringify(t.customParameters),featureReduction:ae(t,e),labelingInfo:o,orderBy:JSON.stringify(t.orderBy),renderer:s}}}class Br{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=Ce(t,e)??Se(t);return[{vvEvaluators:{0:Ee(t.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var t=this;return(0,b.A)(function*(){const s=t.layer,{capabilities:a,objectIdField:o,globalIdField:l,orderBy:d,refreshInterval:h}=s,p=s.fieldsIndex.toJSON(),y=p.fields,v=pe(s),E=s.timeInfo?.toJSON(),R=s.spatialReference.toJSON(),B=(0,Be.o8)(t.layer.parsedUrl);let re=t.layer.objectIdField;if(d?.length){const xe=!d[0].valueExpression&&d[0].field;xe&&(re=xe)}const W=h>0,fe=(0,V.A)("featurelayer-snapshot-enabled")&&"point"===s.geometryType&&a?.query.supportsPagination&&!a?.operations.supportsEditing&&!W,Pe=fe&&vt(e,s.fullExtent);return{type:"feature-service",source:B,isSourceHosted:(0,Qe.Wo)(B.path),orderByFields:re,outSpatialReference:e.spatialReference.toJSON(),metadata:{globalIdField:l,fields:y,fieldsIndex:p,geometryType:v,objectIdField:o,timeInfo:E,spatialReference:R,timeReferenceUnknownClient:!1,subtypeField:null,subtypes:null,typeIdField:null,types:null},queryMetadata:{maxRecordCount:a.query.maxRecordCount,supportsCompactGeometry:a.query.supportsCompactGeometry,supportsDefaultSpatialReference:a.query.supportsDefaultSpatialReference,supportsFormatPBF:a.query.supportsFormatPBF,supportsMaxRecordCountFactor:a.query.supportsMaxRecordCountFactor,supportsQuantization:a.query.supportsQuantization,lastEditDate:null,snapshotInfo:{supportsSnapshotMinThreshold:fe,supportsSnapshotMaxThreshold:Pe,snapshotCountThresholds:{min:(0,V.A)("featurelayer-snapshot-point-min-threshold"),max:(0,V.A)("featurelayer-snapshot-point-max-threshold")}}}}})()}createSourceSchema(e,t){const{definitionExpression:s,customParameters:a,timeExtent:o}=this.layer;return Fe({definitionExpression:s,customParameters:a,timeExtent:o},e,t,null)}createProcessorSchema(e,t,s){const{fields:a,renderer:o,geometryType:l,labelingInfo:d,labelsVisible:h,orderBy:p,objectIdField:y}=this.layer;return Ae(e,t,{fields:a.map(E=>E.toJSON()),renderer:o?.clone(),featureReduction:ae(this.layer,t),geometryType:l,labelingInfo:d,labelsVisible:h,objectIdField:y,orderBy:p??"default"},s)}get hasRequiredSupport(){return(0,we.e)(this.layer.renderer)}get timeOptions(){return this.layer}hasFilters(e){return Oe(this.layer,e)}addFilters(e,t){return _t(this.layer,e,t)}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:a,outFields:o}=t,l=this.layer.labelsVisible?this.layer.labelingInfo:null,d=JSON.stringify(t.customParameters),h=ae(t,e);return{outFields:o,orderBy:JSON.stringify(t.orderBy),definitionExpression:s,renderer:a,labelingInfo:l,featureReduction:h,customParameters:d,floors:Oe(this.layer,e)?e.floors:null}}}class Nr{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){const t=this.layer,s=Ce(t,e)??Se(t);return[{vvEvaluators:{0:Ee(t.renderer)},deconflictionEnabled:s}]}createServiceOptions(e){var t=this;return(0,b.A)(function*(){const s=t.layer,{objectIdField:a}=s,o=pe(s),l=s.timeInfo?.toJSON()||null,d=s.spatialReference?s.spatialReference.toJSON():null;return{type:"stream",source:t.layer.parsedUrl,outSpatialReference:e.spatialReference.toJSON(),metadata:{fieldsIndex:t.layer.fieldsIndex.toJSON(),geometryType:o,objectIdField:a,timeInfo:l,timeReferenceUnknownClient:null,spatialReference:d,subtypeField:null,subtypes:null,globalIdField:null,typeIdField:null,types:null}}})()}createSourceSchema(e,t){const{definitionExpression:s,geometryDefinition:a,customParameters:o}=this.layer;return{type:"stream",mutable:{sourceRefreshVersion:t,availableFields:e.availableFields,dataFilter:{geometryDefinition:a?.toJSON(),definitionExpression:s,customParameters:o??null,maxReconnectionAttempts:this.layer.maxReconnectionAttempts,maxReconnectionInterval:this.layer.maxReconnectionInterval,purgeOptions:this.layer.purgeOptions.toJSON()}}}}createProcessorSchema(e,t,s){const{fields:a,renderer:o,geometryType:l,labelingInfo:d,labelsVisible:h,objectIdField:p}=this.layer;return Ae(e,t,{fields:a.map(v=>v.toJSON()),renderer:o?.clone(),featureReduction:ae(this.layer,t),geometryType:l,labelingInfo:d,labelsVisible:h,objectIdField:p,orderBy:"default"},s)}get hasRequiredSupport(){return(0,we.e)(this.layer.renderer)}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,renderer:a}=t,o=this.layer.labelsVisible?this.layer.labelingInfo:null,l=JSON.stringify(t.customParameters);return{definitionExpression:s,renderer:a,labelingInfo:o,featureReduction:ae(t,e),customParameters:l,geometryDefinition:t.geometryDefinition,definitionExpressoin:t.definitionExpression}}}var jr=u(54551);function kr(r,e){return xt.apply(this,arguments)}function xt(){return(xt=(0,b.A)(function*(r,{subtypeField:e,sublayers:t}){const s=yield Promise.all(t.map(({renderer:a})=>ke(r,a)));return{type:"subtype",subtypeField:e,renderers:t.reduce((a,{subtypeCode:o},l)=>({...a,[o]:s[l]}),{})}})).apply(this,arguments)}function qr(r,e){const t=(0,jr.C)();return{type:"subtype",filters:r.filters,capabilities:{maxTextureSize:t.maxTextureSize},subtypeField:e.subtypeField,target:"feature",bindings:e.sublayers.reduce((s,{renderer:a,subtypeCode:o})=>{const l=(0,Ze.Jz)(a);return{...s,[o]:l}},{})}}function Jr(r,e){return It.apply(this,arguments)}function It(){return(It=(0,b.A)(function*(r,{subtypeField:e,sublayers:t}){const s=yield Promise.all(t.map(a=>{const o=(0,H.K4)(a.renderer),l={...a,geometryType:a.geometryType??null};return je(r,l,o)}));return{type:"subtype",subtypeField:e,renderers:t.reduce((a,{subtypeCode:o},l)=>({...a,[o]:s[l]}),{})}})).apply(this,arguments)}function Vt(){return(Vt=(0,b.A)(function*(r,e,t,s){return{storage:qr(e,t),mesh:{properties:{timeZone:e.timeZone,displayRefreshVersion:s,returnMeshObjectId:!1,sortKey:null},strategy:{type:"feature"},factory:{symbology:yield kr(r,t),labels:yield Jr(r,t)}}}})).apply(this,arguments)}class Gr{constructor(e){this.layer=e}getLabelingDeconflictionInfo(e){return[{vvEvaluators:{},deconflictionEnabled:this.layer.sublayers.every(t=>Se(t))}]}createServiceOptions(e){var t=this;return(0,b.A)(function*(){const s=t.layer,{capabilities:a,datesInUnknownTimezone:o,editingInfo:l,globalIdField:d,objectIdField:h,refreshInterval:p,subtypeField:y}=s,v=s.fieldsIndex.toJSON(),E=pe(s),R=s.timeInfo?.toJSON(),B=s.spatialReference.toJSON(),re=(0,Be.o8)(t.layer.parsedUrl),W=h,fe=null==l?.lastEditDate&&p>0,Pe=(0,V.A)("featurelayer-snapshot-enabled")&&"point"===s.geometryType&&a?.query.supportsPagination&&!a?.operations.supportsEditing&&!fe,xe=Pe&&vt(e,s.fullExtent);return{type:"feature-service",source:re,isSourceHosted:(0,Qe.Wo)(re.path),orderByFields:W,outSpatialReference:e.spatialReference.toJSON(),metadata:{timeReferenceUnknownClient:o,subtypeField:y,globalIdField:d,fieldsIndex:v,geometryType:E,objectIdField:h,timeInfo:R,spatialReference:B,subtypes:t.layer.subtypes?.map(Ye=>Ye.toJSON()),typeIdField:null,types:null},queryMetadata:{maxRecordCount:a.query.maxRecordCount,supportsCompactGeometry:a.query.supportsCompactGeometry,supportsDefaultSpatialReference:a.query.supportsDefaultSpatialReference,supportsFormatPBF:a.query.supportsFormatPBF,supportsMaxRecordCountFactor:a.query.supportsMaxRecordCountFactor,supportsQuantization:a.query.supportsQuantization,lastEditDate:l?.lastEditDate?.getTime(),snapshotInfo:{supportsSnapshotMinThreshold:Pe,supportsSnapshotMaxThreshold:xe,snapshotCountThresholds:{min:(0,V.A)("featurelayer-snapshot-point-min-threshold"),max:(0,V.A)("featurelayer-snapshot-point-max-threshold")}}}}})()}createSourceSchema(e,t){const{definitionExpression:s,customParameters:a,gdbVersion:o,historicMoment:l,subtypeField:d,timeExtent:h,apiKey:p}=this.layer;return Fe({queryScaleRanges:this.layer.sublayers.items.map(v=>({subtypeCode:v.subtypeCode,minScale:v.minScale,maxScale:v.maxScale})),definitionExpression:s,customParameters:a,gdbVersion:o,historicMoment:l,subtypeField:d,timeExtent:h},e,t,p)}createProcessorSchema(e,t,s){return function Qr(r,e,t,s){return Vt.apply(this,arguments)}(e,t,{subtypeField:this.layer.subtypeField,sublayers:Array.from(this.layer.sublayers,o=>({featureReduction:null,geometryType:this.layer.geometryType,labelingInfo:o.labelingInfo,labelsVisible:o.labelsVisible,renderer:o.renderer,subtypeCode:o.subtypeCode,orderBy:null}))},s)}hasFilters(e){return Oe(this.layer,e)||function Hr(r,e){return r.sublayers.some(t=>!Tt(t,e))}(this.layer,e)}addFilters(e,t){e=_t(this.layer,e,t);const s=this.layer.sublayers.filter(o=>!Tt(o,t)).map(o=>o.subtypeCode);if(!s.length)return e;e??=new L.A;const a=`NOT ${this.layer.subtypeField} IN (${s.join(",")})`;return e.where=(0,et.m)(e.where,a),e}get hasRequiredSupport(){return!0}get timeOptions(){return this.layer}getUpdateHashProperties(e){const t=this.layer,{definitionExpression:s,gdbVersion:a,apiKey:o}=t,l=t.historicMoment?.getTime()??void 0,d=JSON.stringify(t.customParameters),h=Oe(this.layer,e)?e.floors:null,p=this.layer.sublayers.map(({renderer:y,labelsVisible:v,labelingInfo:E,visible:R})=>({renderer:y,labelsVisible:v,labelingInfo:E,visible:R}));return{outFields:this.layer.outFields,gdbVersion:a,definitionExpression:s,historicMoment:l,customParameters:d,apiKey:o,sublayers:p,floors:h}}setGraphicOrigin(e){const t=this.layer.fieldsIndex.get(this.layer.subtypeField),s=e.attributes[t.name],a=this.layer.sublayers.find(o=>o.subtypeCode===s);e.layer=e.sourceLayer=a}}function Tt(r,e){return r.visible&&(0===r.minScale||(0,Ge.Sp)(e.scale,r.minScale)||e.scale<r.minScale)&&(0===r.maxScale||(0,Ge.Sp)(e.scale,r.maxScale)||e.scale>r.maxScale)}var $r=u(31411),Y=u(74238),Wr=u(43725);function ze(r,e){const t=new Set;for(const s of r instanceof Set?r.values():r.keys())e.has(s)||t.add(s);return t}class Zr{constructor(e){this.version=e}}class Kr{constructor(e){this._subscriptions=new Map,this._visible=new Set,this._paused=new Set,this._version=0,this._config=e}destroy(){}get _coverageSet(){const e=this._coverage?Array.from(this._coverage.keys()).map(t=>t.id):[];return new Set(e)}suspend(){this._suspendedOverage=this._coverage,this._coverage=null,this._updateSubscriptions()}resume(){null==this._coverage&&(this._coverage=this._suspendedOverage,this._suspendedOverage=null,this._updateSubscriptions())}update(e){return this._version=this._version+1%Number.MAX_SAFE_INTEGER,this._updateCoverage(e),this._updateSubscriptions(),new Set(this._visible)}_updateCoverage(e){this._coverage=this._config.tileInfoView.getTileCoverage(e.state,0,!0,"closest")}_updateSubscriptions(){const e=this._coverageSet,t=this._updateVisibility(),s=ze(t,e),a=ze(this._subscriptions,t),o=ze(e,this._subscriptions),l=ze(a,e),d=ze(s,l),h=ze(d,this._paused);this._visible=t;for(const p of o.values())this._subscriptions.set(p,new Zr(this._version));for(const p of h.values())this._paused.add(p);for(const p of l.values())this._subscriptions.delete(p),this._paused.delete(p);(o.size||l.size||h.size)&&this._sendUpdateSubscriptions(o,l,h)}_sendUpdateSubscriptions(e,t,s){const a=Array.from(e.values()).map(o=>({tileId:o,version:this._subscriptions.get(o).version}));this._config.updateSubscriptions({subscribe:a,unsubscribe:Array.from(t.values()),pause:Array.from(s.values())})}_updateVisibility(){const e=new Set,t=new Set;if(!this._coverage)return e;for(const o of this._coverage.keys())this._config.isDone(o)?e.add(o.id):this._addVisibleParent(e,t,o)||this._addVisibleChildren(e,o)||e.add(o.id);const s=new Le.A(0,0,0,0),a=new Le.A(0,0,0,0);for(const o of t){s.id=o;for(const l of e)a.id=l,s.containsChild(a)&&e.delete(l)}return e}_addVisibleParent(e,t,s){let a=!1;for(const o of this._visible.values())new Le.A(o).containsChild(s)&&(e.add(o),t.add(o),a=!0);return a}_addVisibleChildren(e,t){let s=!1;for(const a of this._visible.values()){const o=new Le.A(a);t.containsChild(o)&&(e.add(a),s=!0)}return s}}var Yr=u(66722),Ct=u(14916),Xr=u(48218),Ke=u(64935);const ei=r=>{let e=class extends r{constructor(...t){super(...t),this._updatingRequiredFieldsPromise=null,this.dataUpdating=!1,this.filter=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.addHandles([(0,_.wB)(()=>{const t=this.layer;return[t&&"elevationInfo"in t?t.elevationInfo?.featureExpressionInfo:null,t&&"displayField"in t?t.displayField:null,t&&"timeInfo"in t&&t.timeInfo,t&&"renderer"in t&&t.renderer,t&&"labelingInfo"in t&&t.labelingInfo,t&&"floorInfo"in t&&t.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),_.pc),(0,_.on)(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),(0,_.on)(()=>{const t=this.layer;return t&&"sublayers"in t?t.sublayers:null},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){if(!this.layer)return[];const{layer:t,layer:{fieldsIndex:s},requiredFields:a}=this;return(0,T.DB)(s,"outFields"in t&&t.outFields?[...(0,T.hL)(s,t.outFields),...a]:a)}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(t){this._override("featureEffect",t)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(t){M.A.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(t){throw new Error("missing implementation")}createQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},s=null!=this.filter?this.filter.createQuery(t):new K.A(t);if("floorInfo"in this.layer&&this.layer.floorInfo){const a=(0,Ct.E)(this);null!=a&&(s.where=s.where?`(${s.where}) AND (${a})`:a)}return null!=this.timeExtent&&(s.timeExtent=null!=s.timeExtent?s.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),s}createAggregateQuery(){return new K.A({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})}queryFeatures(t,s){throw new Error("missing implementation")}queryObjectIds(t,s){throw new Error("missing implementation")}queryFeatureCount(t,s){throw new Error("missing implementation")}queryExtent(t,s){throw new Error("missing implementation")}fetchPopupFeaturesFromGraphics(t,s){var a=this;return(0,b.A)(function*(){return a._validateFetchPopupFeatures(t,s),a._fetchPopupFeatures(t,s)})()}_loadArcadeModules(t){return t.expressionInfos?.length||Array.isArray(t.content)&&t.content.some(s=>"expression"===s.type)?(0,Xr.lw)():Promise.resolve()}_handleRequiredFieldsChange(){const t=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",t),t.then(()=>{this._updatingRequiredFieldsPromise===t&&this._set("_updatingRequiredFieldsPromise",null)})}_updateRequiredFields(){var t=this;return(0,b.A)(function*(){if(!t.layer||!t.view)return;const s="3d"===t.view.type,{layer:a,layer:{fieldsIndex:o,objectIdField:l}}=t,d="renderer"in a&&a.renderer,h="orderBy"in a&&a.orderBy,p="featureReduction"in a?a.featureReduction:null,y=new Set,v=yield Promise.allSettled([d?d.collectRequiredFields(y,o):null,(0,T.Im)(y,a),s&&"elevationInfo"in a?(0,T.NO)(y,a):null,null!=t.filter?(0,T.o)(y,a,t.filter):null,s||null==t.featureEffect?null:(0,T.o)(y,a,t.featureEffect.filter),!s&&p?(0,T.RP)(y,a,p):null,!s&&h?(0,T.f)(y,a,h):null]);if("timeInfo"in a&&a.timeInfo&&t.timeExtent&&(0,T._w)(y,a.fieldsIndex,[a.timeInfo.startField,a.timeInfo.endField]),"floorInfo"in a&&a.floorInfo&&(0,T._w)(y,a.fieldsIndex,[a.floorInfo.floorField]),"feature"===a.type&&s&&null!=a.infoFor3D&&(null==a.globalIdField&&M.A.getLogger(t).error("globalIdField missing on 3DObjectFeatureLayer"),(0,T._w)(y,a.fieldsIndex,[a.globalIdField])),"subtype-group"===a.type){(0,T.rq)(y,o,a.subtypeField);const R=a.sublayers.map(B=>Promise.all([B.renderer?.collectRequiredFields(y,o),(0,T.Im)(y,B)]));yield Promise.allSettled(R)}if("catalog-footprint"===a.type&&a.parent){const R=a.parent;(0,T._w)(y,o,[R.itemNameField,R.itemSourceField,R.itemTypeField,R.maxScaleField,R.minScaleField])}for(const R of v)"rejected"===R.status&&M.A.getLogger(t).error(R.reason);(0,T.rq)(y,o,l),s&&"displayField"in a&&a.displayField&&(0,T.rq)(y,o,a.displayField);const E=Array.from(y).sort();t._set("requiredFields",E)})()}_validateFetchPopupFeatures(t,s){if(null!=s)for(const a of t){const o=a.origin&&"layer"in a.origin?a.origin.layer:a.layer;if("popupEnabled"in o&&!o.popupEnabled)throw new I.A("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:o});if(a.isAggregate){const l="featureReduction"in o?o.featureReduction:null;if(!(l&&"popupTemplate"in l&&l.popupEnabled&&l.popupTemplate))throw new I.A("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:o})}else if("popupTemplate"in o&&!(0,Ke.D8)(o,s))throw new I.A("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:o})}}_popupFeatureHasRequiredFields(t,s){return(0,T.Kl)(s,t)}_fetchPopupFeatures(t,s){var a=this;return(0,b.A)(function*(){const o=new Array(t.length),l=new Map,d=yield a._createPopupQuery(t.map(h=>h.origin?.layer??h.layer),s);for(let h=0;h<t.length;h++){const p=t[h];if(p.isAggregate){o[h]=p;continue}const y=p.origin?.layer??p.layer;if(!y||!("popupEnabled"in y))continue;const v=(0,T.hL)(a.layer.fieldsIndex,d.outFields),E=(0,Ke.D8)(y,s);if(null==E)continue;const R=yield a._loadArcadeModules(E);(0,g.Te)(s),R&&R.arcadeUtils.hasGeometryOperations(E)||!a._popupFeatureHasRequiredFields(p,v)?l.set(p.getObjectId(),{graphic:p,index:h}):o[h]=p}if("stream"===a.layer.type||0===l.size)return o.filter(Boolean);d.objectIds=Array.from(l.keys());try{const h=yield a.layer.queryFeatures(d,s);for(const p of h.features){const{graphic:{geometry:y,origin:v},index:E}=l.get(p.getObjectId());p.geometry||=y,p.origin=v,o[E]=p}}catch{}return o.filter(Boolean)})()}_createPopupQuery(t,s){var a=this;return(0,b.A)(function*(){const o=a.layer.createQuery(),l=new Set;let d=!1;const h=t??[a.layer];for(const p of h){if(!("popupEnabled"in p))continue;const y=(0,Ke.D8)(p,s);if(null==y)continue;const v=yield a._loadArcadeModules(y);(0,g.Te)(s);const E=v&&v.arcadeUtils.hasGeometryOperations(y);d=!("point"!==a.layer.geometryType&&!E);const R=yield(0,Ke.TO)(a.layer,y);(0,g.Te)(s);for(const B of R)l.add(B)}if(o.returnGeometry=d,o.returnZ=d,o.returnM=d,o.outFields=Array.from(l),o.outSpatialReference=a.view.spatialReference,"floorInfo"in a.layer&&a.layer.floorInfo){const p=(0,Ct.E)(a);null!=p&&(o.where=o.where?`(${o.where}) AND (${p})`:p)}return o})()}canResume(){return!(!super.canResume()||null!=this.timeExtent&&this.timeExtent.isEmpty)}getTest(){}get test(){}};return(0,S._)([(0,f.MZ)()],e.prototype,"_updatingRequiredFieldsPromise",void 0),(0,S._)([(0,f.MZ)({readOnly:!0})],e.prototype,"availableFields",null),(0,S._)([(0,f.MZ)({readOnly:!0})],e.prototype,"dataUpdating",void 0),(0,S._)([(0,f.MZ)({type:Yr.A})],e.prototype,"featureEffect",null),(0,S._)([(0,f.MZ)({type:L.A})],e.prototype,"filter",void 0),(0,S._)([(0,f.MZ)()],e.prototype,"layer",void 0),(0,S._)([(0,f.MZ)({type:Number})],e.prototype,"maximumNumberOfFeatures",null),(0,S._)([(0,f.MZ)({readOnly:!0,type:Boolean})],e.prototype,"maximumNumberOfFeaturesExceeded",null),(0,S._)([(0,f.MZ)({readOnly:!0})],e.prototype,"requiredFields",void 0),(0,S._)([(0,f.MZ)()],e.prototype,"suspended",void 0),(0,S._)([(0,f.MZ)()],e.prototype,"view",void 0),e=(0,S._)([(0,C.$)("esri.views.layers.FeatureLayerView")],e),e};var ti=u(41474),ri=u(96081),ii=u(28067);const Ot=4294967294;let ie=class extends(ei((0,ri.A)((0,Ie.e)(ti.A)))){constructor(){super(...arguments),this._commandsQueue=new $r.A({process:r=>{switch(r.type){case"edit-by-feature":case"edit-by-id":return this._doEdit(r);case"update":return this._doUpdate();case"highlight":return this._updateHighlights()}}}),this._visibilityOverrides=new Set,this._highlightCounter=new Wr.t,this._lastAvailableFields=[],this.eventLog=new de,this._sourceRefreshVersion=1,this._displayRefreshVersion=1,this._pipelineUpdating=!1,this._fields=null,this.featureEffectView=new U}destroy(){this._workerProxy?.destroy(),this._workerAttached.reject((0,g.NK)()),this._commandsQueue.destroy()}initialize(){this._workerAttached=(0,g.Tw)(),(0,g.QZ)(this._workerAttached.promise),this.addResolvingPromise(this._initProxy()),this.featureEffectView.featureEffect=this.featureEffect,this.featureEffectView.endTransitions()}_initProxy(){var r=this;return(0,b.A)(function*(){const e=r.layer;if("isTable"in e&&e.isTable)throw new I.A("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:e});if("mesh"===e.geometryType)throw new I.A("featurelayerview:geometry-type-not-supported",`Geometry type of ${e.geometryType} is not supported`,{layer:e});if(("feature"===e.type||"subtype-group"===e.type)&&!1===(0,q.BR)(e)?.operations.supportsQuery)throw new I.A("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e});r._workerProxy&&r._workerProxy.destroy();const t=r._createClientOptions();r._workerProxy=yield function kt(r){return Xe.apply(this,arguments)}(t)})()}_attachProxy(){var r=this;return(0,b.A)(function*(){const e={service:yield r.layerAdapter.createServiceOptions(r.view),tileInfoJSON:r.view.featuresTilingScheme.tileInfo.toJSON()};let t=[];Array.isArray(e.service.source)&&(t=e.service.source);try{yield r._workerProxy.pipeline.onAttach(e,{transferList:t}),r._workerAttached.resolve()}catch(s){r._workerAttached.reject((0,g.NK)()),(0,g.jH)(s)}})()}_detachProxy(){var r=this;return(0,b.A)(function*(){return r._workerProxy.pipeline.onDetach()})()}getWorker(){var r=this;return(0,b.A)(function*(){return yield r._workerAttached.promise,r._workerProxy})()}get hasAllFeatures(){return this.layer.visible&&this.eventLog.hasAllFeatures}get hasAllFeaturesInView(){return this.layer.visible&&this.eventLog.hasAllFeaturesInView}get hasFullGeometries(){return this.layer.visible&&this.eventLog.hasFullGeometries}get labelingCollisionInfos(){const r=this.layerAdapter.getLabelingDeconflictionInfo(this.view),e=this.layer.geometryType,t=!this.suspended;return r.map(({vvEvaluators:s,deconflictionEnabled:a})=>({container:this.featureContainer,vvEvaluators:s,deconflictionEnabled:a,geometryType:e,visible:t}))}get layerAdapter(){switch(this.layer.type){case"feature":return"memory"===this.layer.source.type?new Mt(this.layer):new Pr(this.layer);case"geojson":case"csv":case"wfs":return new Mt(this.layer);case"subtype-group":return new Gr(this.layer);case"ogc-feature":return new Lr(this.layer);case"stream":return new Nr(this.layer);case"oriented-imagery":return new Br(this.layer);case"knowledge-graph-sublayer":return new Dr(this.layer);case"catalog-footprint":return new Or(this.layer);default:(0,ye.Xb)(this.layer)}return null}get timeExtent(){return(0,N.F)(this.layerAdapter.timeOptions,this.view?.timeExtent,this._get("timeExtent"))}getDisplayStatistics(r,e){return this.featureContainer?.getDisplayStatistics(r,e)}queryHeatmapStatistics(r){var e=this;return(0,b.A)(function*(){return(yield e.getWorker()).pipeline.queryHeatmapStatistics(r)})()}highlight(r,e="highlight"){let t;r instanceof z.A?t=[r.getObjectId()]:"number"==typeof r||"string"==typeof r?t=[r]:ue.A.isCollection(r)&&r.length>0?t=r.map(a=>a?.getObjectId()).toArray():Array.isArray(r)&&r.length>0&&(t="number"==typeof r[0]||"string"==typeof r[0]?r:r.map(a=>a?.getObjectId()));const s=t?.filter(se.Ru);return s?.length?(this._addHighlights(s,e),(0,x.hA)(()=>this._removeHighlights(s,e))):(0,x.hA)()}getHighlightIds(){return Array.from(this._highlightCounter.ids())}hasHighlight(){return!this._highlightCounter.empty}hitTest(r,e){var t=this;return(0,b.A)(function*(){const s=yield t.featureContainer.hitTest(e);if(0===s.length)return null;const a=yield t.getWorker(),{features:o,aggregates:l}=yield a.pipeline.getDisplayFeatures(s),d=t.featureContainer.getSortKeys(s),h=({displayId:p},{displayId:y})=>d.has(p)&&d.has(y)?d.get(p)-d.get(y):p-y;return o.sort(h).reverse(),l.sort(h).reverse(),[...l.map(p=>t._createGraphicHit(r,J.fromJSON(p))),...o.map(p=>t._createGraphicHit(r,z.A.fromJSON(p)))]})()}queryStatistics(){var r=this;return(0,b.A)(function*(){const e=yield r.getWorker();return(0,Y.E)(e.pipeline.queryStatistics(),{featureCount:0,ringCount:0,vertexCount:0})})()}querySummaryStatistics(r,e,t){var s=this;return(0,b.A)(function*(){const a=yield s.getWorker(),o={...e,scale:s.view.scale},l=a.features.executeQueryForSummaryStatistics(s._cleanUpQuery(r),o,t);return(0,Y.E)(l,{})})()}queryAggregateSummaryStatistics(r,e,t){var s=this;return(0,b.A)(function*(){const a={...e,scale:s.view.scale},o=(yield s.getWorker()).aggregates.executeQueryForSummaryStatistics(s._cleanUpAggregateQuery(r),a,t);return(0,Y.E)(o,{})})()}queryUniqueValues(r,e,t){var s=this;return(0,b.A)(function*(){const a=yield s.getWorker(),o={...e,scale:s.view.scale},l=a.features.executeQueryForUniqueValues(s._cleanUpQuery(r),o,t);return(0,Y.E)(l,{uniqueValueInfos:[]})})()}queryAggregateUniqueValues(r,e,t){var s=this;return(0,b.A)(function*(){const a=yield s.getWorker(),o={...e,scale:s.view.scale},l=a.aggregates.executeQueryForUniqueValues(s._cleanUpAggregateQuery(r),o,t);return(0,Y.E)(l,{uniqueValueInfos:[]})})()}queryClassBreaks(r,e,t){var s=this;return(0,b.A)(function*(){const a=yield s.getWorker(),o={...e,scale:s.view.scale},l=a.features.executeQueryForClassBreaks(s._cleanUpQuery(r),o,t);return(0,Y.E)(l,{classBreakInfos:[]})})()}queryAggregateClassBreaks(r,e,t){var s=this;return(0,b.A)(function*(){const a=yield s.getWorker(),o={...e,scale:s.view.scale},l=a.aggregates.executeQueryForClassBreaks(s._cleanUpAggregateQuery(r),o,t);return(0,Y.E)(l,{classBreakInfos:[]})})()}queryHistogram(r,e,t){var s=this;return(0,b.A)(function*(){const a=yield s.getWorker(),o={...e,scale:s.view.scale},l=a.features.executeQueryForHistogram(s._cleanUpQuery(r),o,t);return(0,Y.E)(l,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})})()}queryAggregateHistogram(r,e,t){var s=this;return(0,b.A)(function*(){const a=yield s.getWorker(),o={...e,scale:s.view.scale},l=a.aggregates.executeQueryForHistogram(s._cleanUpAggregateQuery(r),o,t);return(0,Y.E)(l,{bins:[],maxValue:null,minValue:null,normalizationTotal:null})})()}queryFeatures(r,e){return this.queryFeaturesJSON(r,e).then(t=>{const s=X.A.fromJSON(t);return s.features.forEach(a=>this._setLayersForFeature(a)),s})}queryVisibleFeatures(r,e){var t=this;return(0,b.A)(function*(){const s=(yield t.getWorker()).pipeline.queryVisibleFeatures(t._cleanUpQuery(r),e),a=yield(0,Y.E)(s,{features:[]}),o=X.A.fromJSON(a);return o.features.forEach(l=>t._setLayersForFeature(l)),o})()}queryAggregates(r,e){var t=this;return(0,b.A)(function*(){const s=(yield t.getWorker()).aggregates.executeQuery(t._cleanUpAggregateQuery(r),e),a=yield(0,Y.E)(s,{features:[]}),o=Z.fromJSON(a);return o.features.forEach(l=>t._setLayersForFeature(l)),o})()}queryAggregateIds(r,e){var t=this;return(0,b.A)(function*(){const s=(yield t.getWorker()).aggregates.executeQueryForIds(t._cleanUpAggregateQuery(r),e);return(0,Y.E)(s,[])})()}queryAggregateCount(r,e){var t=this;return(0,b.A)(function*(){const s=(yield t.getWorker()).aggregates.executeQueryForCount(t._cleanUpAggregateQuery(r),e);return(0,Y.E)(s,0)})()}queryAggregateJSON(r,e){var t=this;return(0,b.A)(function*(){const s=(yield t.getWorker()).aggregates.executeQuery(t._cleanUpAggregateQuery(r),e);return(0,Y.E)(s,{features:[]})})()}queryFeaturesJSON(r,e){var t=this;return(0,b.A)(function*(){const s=(yield t.getWorker()).features.executeQuery(t._cleanUpQuery(r),e);return(0,Y.E)(s,{features:[]})})()}queryObjectIds(r,e){var t=this;return(0,b.A)(function*(){const s=(yield t.getWorker()).features.executeQueryForIds(t._cleanUpQuery(r),e);return(0,Y.E)(s,[])})()}queryFeatureCount(r,e){var t=this;return(0,b.A)(function*(){const s=(yield t.getWorker()).features.executeQueryForCount(t._cleanUpQuery(r),e);return(0,Y.E)(s,0)})()}queryExtent(r,e){var t=this;return(0,b.A)(function*(){const s=(yield t.getWorker()).features.executeQueryForExtent(t._cleanUpQuery(r),e),a=yield(0,Y.E)(s,{count:0,extent:null});return{count:a.count,extent:ii.A.fromJSON(a.extent)}})()}getSampleFeatures(r){var e=this;return(0,b.A)(function*(){return(yield e.getWorker()).pipeline.getSampleFeatures(r)})()}setVisibility(r,e){e?this._visibilityOverrides.delete(r):this._visibilityOverrides.add(r),this._update()}update(r){if(!this._subscriptionManager)return;const e=this._subscriptionManager.update(r);this.featureContainer.setVisibleTiles(e)}attach(){(0,V.A)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.attach"),(0,g.QZ)(this._updatingHandles.addPromise(this._workerAttached.promise)),(0,g.QZ)(this._attachProxy()),this.featureContainer=new Nt(this),this.container.addChild(this.featureContainer),this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._subscriptionManager=new Kr({tileInfoView:this.view.featuresTilingScheme,updateSubscriptions:r=>{this.featureContainer.updateSubscriptions(r),(0,g.QZ)(this._updatingHandles.addPromise(this.getWorker().then(e=>e.pipeline.updateSubscriptions(r))))},isDone:r=>this.featureContainer.isDone(r)}),this.requestUpdate(),this.addAttachHandles([(0,_.wB)(()=>JSON.stringify({displayRefreshVersion:this._displayRefreshVersion,timeExtent:this.timeExtent,clips:this.clips,filter:this.filter,featureEffect:this.featureEffect,sourceRefreshVersion:this._sourceRefreshVersion,timeZone:this.view.timeZone,effect:this.featureEffect,...this.layerAdapter.getUpdateHashProperties(this.view)}),()=>this._update(),_.Vh),(0,_.wB)(()=>this.updateSuspended,r=>{r||(this._subscriptionManager.resume(),this.view.labelManager.requestUpdate())})]),"stream"!==this.layer.type&&"catalog-footprint"!==this.layer.type&&this.addAttachHandles(this.layer.on("edits",r=>this._edit(r)))}detach(){(0,V.A)("esri-2d-update-debug")&&console.debug("FeatureLayerView2D.detach"),this._detachProxy(),this._fields=null,this.featureContainer.destroy(),this._commandsQueue.clear(),this.container.removeAllChildren(),this._subscriptionManager=(0,c.pR)(this._subscriptionManager),this._workerProxy.pipeline.onDetach(),this._workerAttached=(0,g.Tw)(),(0,g.QZ)(this._workerAttached.promise),this._lastAvailableFields=[],this._lastSchema=null}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){const r="renderer"in this.layer&&null!=this.layer.renderer,e=this._commandsQueue.updateTracking.updating,t=null!=this._updatingRequiredFieldsPromise,s=this.featureContainer.updatingHandles.updating,a=this.updateRequested||r&&(e||t)||s||this._pipelineUpdating||this.dataUpdating;if((0,V.A)("esri-2d-log-updating")){console.log(`Updating FLV2D (${this.layer.id}): ${a}\n  -> updateRequested ${this.updateRequested}\n  -> hasRenderer ${r}\n  -> updatingRequiredFields ${t}\n  -> hasPendingCommand ${e}\n  -> dataUpdating ${this.dataUpdating}\n  -> processing ${this._pipelineUpdating}\n  -> updatingContainer ${s}\n`);for(const o of this.featureContainer.subscriptions())console.log(`    -> Tile[${o.id}] Done: ${o.done}`)}return a}_createClientOptions(){const r=this;return{get container(){return r.featureContainer},setUpdating:e=>{this._set("_pipelineUpdating",e.pipeline),this._set("dataUpdating",e.data)},emitEvent:e=>{this.emit(e.name,e.event)},get eventLog(){return r.eventLog},fetch:e=>Promise.all(e.map(t=>r.view.stage.painter.textureManager.rasterizeItem(t))),fetchDictionary:e=>Promise.all(e.map(t=>this._fetchDictionaryRequest(t)))}}_fetchDictionaryRequest(r){var e=this;return(0,b.A)(function*(){try{if("subtype-group"===e.layer.type)throw new Error("InternalError: SubtypeGroupLayer does not support dictionary renderer");const t=e.layer.renderer;if(!t||"dictionary"!==t.type)throw new Error("InternalError: Expected layer to have a DictionaryRenderer");const s=e._lastSchema.processor.mesh.factory.symbology;if("dictionary"!==s.type)throw new Error("InternalError: Expected schema to be of type 'dictionary'");const a={cimAnalyzer:e.view.stage.cimAnalyzer,cimResourceManager:e.view.stage.painter.textureManager.resourceManager,store:e.featureContainer.instanceStore,scaleExpression:s.scaleExpression};e._fields||(e._fields=e.layer.fields.map(d=>d.toJSON()));const o=s.visualVariableUniforms,l=yield t.getSymbolAsync(r.feature,{fields:e._fields});return l&&l.data?{type:"dictionary-response",meshes:yield(0,We.Jk)(l.data,{uniforms:o,path:"renderer",schemaOptions:a})}:{type:"dictionary-response",meshes:[]}}catch{return{type:"dictionary-response",meshes:[]}}})()}_cleanUpQuery(r){const e=K.A.from(r)||this.createQuery();return e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference),e.toJSON()}_cleanUpAggregateQuery(r){const e=K.A.from(r)||this.createAggregateQuery();e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference);const t=e.objectIds??[];for(const s of e.aggregateIds??[])t.push(s);return e.objectIds=t,e.aggregateIds=[],e.toJSON()}_update(){var r=this;return(0,b.A)(function*(){return r._commandsQueue.push({type:"update"})})()}_edit(r){var e=this;return(0,b.A)(function*(){if(e.updateSuspended)return void e._subscriptionManager.suspend();const t=e._getEffectiveEdit(r);return t?e._commandsQueue.push(t).catch(g.jH):void 0})()}doRefresh(r){var e=this;return(0,b.A)(function*(){e.attached&&(e.updateSuspended&&r||(r?e.incrementSourceRefreshVersion():e.incrementDisplayRefreshVersion()))})()}incrementSourceRefreshVersion(){this._sourceRefreshVersion=(this._sourceRefreshVersion+1)%Ot+1}incrementDisplayRefreshVersion(){this._displayRefreshVersion=(this._displayRefreshVersion+1)%Ot+1}_getEffectiveEdit(r){const e="globalIdField"in this.layer&&this.layer.globalIdField,t=r.deletedFeatures.some(d=>-1===d.objectId||!d.objectId),s=e&&this.availableFields.includes(e);if(t&&!s)return M.A.getLogger(this).error(new I.A("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${e} to be included the layer's outFields for updates to be reflected on the map`)),null;const a=this.layer,o=r.historicMoment?.getTime()??null,l="layerId"in a&&r.editedFeatures?.find(d=>d.layerId===a.layerId);if(l){const p=(0,Et.eh)(this.layer.geometryType),{adds:y,deletes:v,updates:E}=l.editedFeatures,R=this.layer.objectIdField,B=y.map(W=>(0,D.E2)(W,p,!1,!1)),re=E.map(W=>(0,D.E2)(W.current,p,!1,!1));return{type:"edit-by-feature",added:B,removed:v.map(W=>"attributes"in W?{globalId:e?W.attributes[e]:null,objectIdField:R?W.attributes[R]:null}:W),updated:re,historicMoment:o}}return{type:"edit-by-id",added:r.addedFeatures,updated:r.updatedFeatures,removed:r.deletedFeatures,historicMoment:o}}_doUpdate(){var r=this;return(0,b.A)(function*(){"featureReduction"in r.layer&&r.layer.featureReduction&&r.layer.featureReduction!==r._lastFeatureReduction&&(r.layer.featureReduction=r.layer.featureReduction?.clone(),r._lastFeatureReduction=r.layer.featureReduction);try{if(yield r._updateRequiredFields(),r.destroyed||!r.layerAdapter?.hasRequiredSupport||!r._subscriptionManager)return;const e=r.featureContainer.instanceStore;r.featureContainer.attributeView.lockTextureUploads(),e.updateStart();const t=r.featureEffect,s={store:e,cimAnalyzer:r.view.stage.cimAnalyzer,cimResourceManager:r.view.stage.painter.textureManager.resourceManager,scaleExpression:void 0},a=r._createViewSchemaConfig(),o={source:r.layerAdapter.createSourceSchema(a,r._sourceRefreshVersion),processor:yield r.layerAdapter.createProcessorSchema(s,a,r._displayRefreshVersion)},l=(0,m.bD)(r._lastSchema?.source.mutable,o.source.mutable)||(0,m.bD)(r._lastSchema?.processor,o.processor);if(!l)return r.featureContainer.requestRender(),r.featureContainer.attributeView.unlockTextureUploads(),e.updateEnd(),void(r.featureEffectView.featureEffect=t);r._lastSchema=o,r._fields=null;const d=Math.round(performance.now());(0,V.A)("esri-2d-update-debug")&&console.debug(`Id[${r.layer.uid}] Version[${d}] FeatureLayerView2D._doUpdate`,{changes:l}),yield(yield r.getWorker()).pipeline.updateSchema(o,d),e.updateEnd(),r.featureEffectView.featureEffect=t,r.featureEffectView.endTransitions(),r.featureContainer.attributeView.unlockTextureUploads(),r.featureContainer.swapRenderState(),r.featureContainer.requestRender(),(0,V.A)("esri-2d-update-debug")&&console.debug(`Version[${d}] FeatureLayerView2D.updateEnd`),r.requestUpdate()}catch(e){(0,V.A)("esri-2d-update-debug")&&console.error("Encountered an error during update",e)}})()}_doEdit(r){var e=this;return(0,b.A)(function*(){const t=yield e.getWorker();try{e.featureContainer.editStart(),yield t.pipeline.onEdits(r),e.featureContainer.editEnd()}catch(s){(0,g.zf)(s)}})()}get hasFilter(){const r=this.layerAdapter.hasFilters?.(this.view)??!1;return null!=this.filter||null!=this.timeExtent||this._visibilityOverrides.size>0||r}_getEffectiveAvailableFields(r){const e=function si(r,e){const t=new Set;return r&&r.forEach(s=>t.add(s)),e&&e.forEach(s=>t.add(s)),t.has("*")?["*"]:Array.from(t)}(this._lastAvailableFields,r);return this._lastAvailableFields=e,(0,T.hW)(this.layer.fieldsIndex,e)}_createViewSchemaConfig(){const r=[ni(this.view,this.layerAdapter,this.timeExtent,this._visibilityOverrides,this.filter),this.featureEffect?.filter?.toJSON()??null];return{availableFields:this._getEffectiveAvailableFields(this.availableFields),filters:r,scale:this.view.scale,timeZone:this.view.timeZone}}_addHighlights(r,e){this._highlightCounter.addReason(r,e),this._commandsQueue.push({type:"highlight"})}_removeHighlights(r,e){this._highlightCounter.deleteReason(r,e),this._commandsQueue.push({type:"highlight"})}_updateHighlights(){var r=this;return(0,b.A)(function*(){const e=[];for(const a of r._highlightCounter.ids()){const o=r._highlightCounter.getHighlightReason(a),l=(0,$.$r)(o);e.push({objectId:a,highlightFlags:l})}const t=yield r.getWorker();if(r.destroyed)return;const s=t.pipeline.updateHighlight({highlights:e}).catch(a=>{(0,g.zf)(a)||M.A.getLogger(r).error(a)});r._updatingHandles.addPromise(s)})()}_setLayersForFeature(r){r.layer=r.sourceLayer=this.layer,this.layerAdapter.setGraphicOrigin&&this.layerAdapter.setGraphicOrigin(r)}_createGraphicHit(r,e){return this._setLayersForFeature(e),null!=e.geometry&&(e.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:e,layer:this.layer,mapPoint:r}}};function ni(r,e,t,s,a){a&&(a=a.clone());const o=null!=a?a.timeExtent:null,l=null!=t&&null!=o?t.intersection(o):t||o;l&&(a??=new L.A,a.timeExtent=l),a=e.addFilters?.(a,r)??a;let d=a?.toJSON()??null;return s.size&&(d??=(new L.A).toJSON(),d.hiddenIds=Array.from(s)),d}(0,S._)([(0,f.MZ)()],ie.prototype,"_commandsQueue",void 0),(0,S._)([(0,f.MZ)()],ie.prototype,"_sourceRefreshVersion",void 0),(0,S._)([(0,f.MZ)()],ie.prototype,"_displayRefreshVersion",void 0),(0,S._)([(0,f.MZ)({readOnly:!0})],ie.prototype,"_pipelineUpdating",void 0),(0,S._)([(0,f.MZ)({readOnly:!0})],ie.prototype,"hasAllFeatures",null),(0,S._)([(0,f.MZ)({readOnly:!0})],ie.prototype,"hasAllFeaturesInView",null),(0,S._)([(0,f.MZ)({readOnly:!0})],ie.prototype,"hasFullGeometries",null),(0,S._)([(0,f.MZ)()],ie.prototype,"featureEffectView",void 0),(0,S._)([(0,f.MZ)()],ie.prototype,"labelingCollisionInfos",null),(0,S._)([(0,f.MZ)()],ie.prototype,"layerAdapter",null),(0,S._)([(0,f.MZ)({readOnly:!0})],ie.prototype,"timeExtent",null),(0,S._)([(0,f.MZ)()],ie.prototype,"updating",void 0),ie=(0,S._)([(0,C.$)("esri.views.2d.layers.FeatureLayerView2D")],ie);const ai=ie},36952:(oe,k,u)=>{function b(S,z,f,V){const M=S.clone(),A=1<<M.level,C=M.col+z,P=M.row+f;return V&&C<0?(M.col=C+A,M.world-=1):C>=A?(M.col=C-A,M.world+=1):M.col=C,M.row=P,M}u.d(k,{K:()=>b})},43725:(oe,k,u)=>{u.d(k,{t:()=>S});var b=u(25735);class S{constructor(){this._idToCounters=new Map}get empty(){return 0===this._idToCounters.size}addReason(f,V){for(const M of f){let A=this._idToCounters.get(M);A||(A=new Map,this._idToCounters.set(M,A)),A.set(V,(A.get(V)||0)+1)}}deleteReason(f,V){for(const M of f){const A=this._idToCounters.get(M);if(!A)continue;let C=A.get(V);if(null==C)return;C--,C>0?A.set(V,C):A.delete(V),0===A.size&&this._idToCounters.delete(M)}}getHighlightReason(f){const V=this._idToCounters.get(f);if(!V)return null;let M=null;for(const A of b.M$)V.get(A)&&(M=A);return M||null}ids(){return this._idToCounters.keys()}}},74238:(oe,k,u)=>{u.d(k,{E:()=>S});var b=u(10467);function S(f,V){return z.apply(this,arguments)}function z(){return(z=(0,b.A)(function*(f,V){try{return yield f}catch(M){if("no-queryEngine"!==M.name)throw M;return V}})).apply(this,arguments)}},64935:(oe,k,u)=>{u.d(k,{D8:()=>V,TO:()=>z});var b=u(10467),S=u(86300);function z(A){return f.apply(this,arguments)}function f(){return(f=(0,b.A)(function*(A,C=A.popupTemplate){if(null==C)return[];const P=yield C.getRequiredFields(A.fieldsIndex),{lastEditInfoEnabled:J}=C,{objectIdField:Q,typeIdField:se,globalIdField:ue,relationships:ye}=A;if(P.includes("*"))return["*"];const I=J?(0,S.eX)(A):[],x=(0,S.DB)(A.fieldsIndex,[...P,...I]);return se&&x.push(se),x&&Q&&A.fieldsIndex?.has(Q)&&!x.includes(Q)&&x.push(Q),x&&ue&&A.fieldsIndex?.has(ue)&&!x.includes(ue)&&x.push(ue),ye&&ye.forEach(c=>{const{keyField:m}=c;x&&m&&A.fieldsIndex?.has(m)&&!x.includes(m)&&x.push(m)}),x})).apply(this,arguments)}function V(A,C){return A.popupTemplate?A.popupTemplate:null!=C&&C.defaultPopupTemplateEnabled&&null!=A.defaultPopupTemplate?A.defaultPopupTemplate:null}}}]);