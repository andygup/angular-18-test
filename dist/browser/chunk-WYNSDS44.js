import{a as se,c as fe,d as ie,f as le,g as ue,i as h,j as ce,k as pe,l as de}from"./chunk-OGG5EF6C.js";import{b as me}from"./chunk-CE56NTX4.js";import{a as ne,b as ae}from"./chunk-5P55LZ7U.js";import{a as re,b as te,d as oe}from"./chunk-6CK56SXG.js";import"./chunk-OW7DVBQB.js";import"./chunk-X2T2CBLR.js";import"./chunk-IFFYADB3.js";import{a as K}from"./chunk-2NH7HOKA.js";import{l as w}from"./chunk-ZAQLF7TN.js";import"./chunk-FJAXVFKU.js";import{d as A,f as ee}from"./chunk-PDBE4PO2.js";import"./chunk-6CNLUW6T.js";import"./chunk-AWF4Z7TU.js";import"./chunk-IT6EB7VG.js";import{a as Y,c as Z,d as _}from"./chunk-NILEV7NP.js";import"./chunk-SQNW6FUV.js";import{a as H,c as J,e as F,h as X}from"./chunk-Z6XPPWSB.js";import"./chunk-T6U45BGW.js";import"./chunk-AIOXCJIZ.js";import"./chunk-BVW6ULEA.js";import{a as R}from"./chunk-7C6Z24SS.js";import{b as N,c as M,d as S,k as U,o as C,p as E,s as q,t as k}from"./chunk-3M7QKELQ.js";import"./chunk-MNGFITIF.js";import"./chunk-2E6TO2WI.js";import"./chunk-I3S324BU.js";import{a as O}from"./chunk-XDRSKFBJ.js";import"./chunk-63TUJPJR.js";import{a as Q,n as W}from"./chunk-MJ4RSERD.js";import"./chunk-GDTXLKQK.js";import"./chunk-YNFZN34N.js";import"./chunk-SHSMFEO2.js";import"./chunk-J57HR4DB.js";import"./chunk-SAOUSUZE.js";import{b as D}from"./chunk-Z5Q76SB7.js";import"./chunk-RU7UW4IO.js";import"./chunk-5QLB7ZJ7.js";import"./chunk-2ETW6ZBA.js";import"./chunk-6K7P7RRW.js";import"./chunk-7LRMKXZV.js";import"./chunk-BCREO4Q5.js";import"./chunk-E5R4OI7X.js";import{g as z,n as V}from"./chunk-BNUHB4AP.js";import{c as G}from"./chunk-ZGLJFDS6.js";import"./chunk-RSDQHAJX.js";import"./chunk-KVCIO4DX.js";import"./chunk-NWBXT4EB.js";import"./chunk-ZHAVTBSG.js";import"./chunk-UHTPPTOJ.js";import"./chunk-LP5GLSKB.js";import"./chunk-LTDZH3EN.js";import"./chunk-3SBMUUA6.js";import"./chunk-X7Z55FTO.js";import"./chunk-B66V4PSA.js";import"./chunk-A4HCVMB4.js";import{_ as j}from"./chunk-AANS6QE5.js";import"./chunk-RMOOROEO.js";import{t as b}from"./chunk-ZP7G4HN4.js";import"./chunk-W3WDPWBE.js";import"./chunk-43GG6PFR.js";import"./chunk-MLSR6YE6.js";import"./chunk-JPDAKIWT.js";import"./chunk-D62JNIRP.js";import{u as P}from"./chunk-3DV77WOO.js";import"./chunk-NJG4JJ4L.js";import{a as I,b as L,g as B}from"./chunk-3T7TAUC2.js";function Te(e,r,t){let i=e.typedBuffer,n=e.typedBufferStride,s=r.typedBuffer,u=r.typedBufferStride,f=t?t.count:r.count,a=(t?.dstIndex??0)*n,m=(t?.srcIndex??0)*u;for(let l=0;l<f;++l){for(let o=0;o<9;++o)i[a+o]=s[m+o];a+=n,m+=u}}var ye=Object.freeze(Object.defineProperty({__proto__:null,copy:Te},Symbol.toStringTag,{value:"Module"}));function we(e,r,t){let i=e.typedBuffer,n=e.typedBufferStride,s=r.typedBuffer,u=r.typedBufferStride,f=t?t.count:r.count,a=(t?.dstIndex??0)*n,m=(t?.srcIndex??0)*u;for(let l=0;l<f;++l){for(let o=0;o<16;++o)i[a+o]=s[m+o];a+=n,m+=u}}var he=Object.freeze(Object.defineProperty({__proto__:null,copy:we},Symbol.toStringTag,{value:"Module"}));function d(e,r){return new e(new ArrayBuffer(r*e.ElementCount*K(e.ElementType)))}function Br(e,r,t){return B(this,null,function*(){let i=new ce(Be(t)),n=(yield pe(i,r,t,!0)).model,s=n.lods.shift(),u=new Map,f=new Map;n.textures.forEach((T,v)=>u.set(v,Me(T))),n.materials.forEach((T,v)=>f.set(v,Se(T,u)));let a=Ve(s);for(let T of a.parts)Ce(a,T,f);let{position:m,normal:l,tangent:o,color:c,texCoord0:p}=a.vertexAttributes,g=A(e,t),ge=e.spatialReference.isGeographic?A(e):g,$=ee({vertexAttributes:{position:m.typedBuffer,normal:l?.typedBuffer,tangent:o?.typedBuffer},vertexSpace:ge,spatialReference:e.spatialReference},g,{allowBufferReuse:!0,sourceUnit:"meters"});if(!$)throw new P("loadGLTFMesh()","Failed to load mesh from glTF due to projection errors");return{transform:null,vertexSpace:g,components:a.components,spatialReference:e.spatialReference,vertexAttributes:new ne(L(I({},$),{color:c?.typedBuffer,uv:p?.typedBuffer}))}})}function Be(e){let r=e?.resolveFile;return r?{busy:!1,request:(t,i,n)=>B(this,null,function*(){let s=r?.(t)??t;return(yield j(s,{responseType:i==="image"?"image":i==="binary"||i==="image+type"?"array-buffer":"json",signal:n?.signal,timeout:0})).data})}:null}function y(e,r){if(e==null)return"-";let t=e.typedBuffer;return`${b(r,t.buffer,()=>r.size)}/${t.byteOffset}/${t.byteLength}`}function be(e){return e!=null?e.toString():"-"}function Ve(e){let r=0,t={color:!1,tangent:!1,normal:!1,texCoord0:!1},i=new Map,n=new Map,s=[];for(let u of e.parts){let{attributes:{position:f,normal:a,color:m,tangent:l,texCoord0:o}}=u,c=`
      ${y(f,i)}/
      ${y(a,i)}/
      ${y(m,i)}/
      ${y(l,i)}/
      ${y(o,i)}/
      ${be(u.transform)}
    `,p=!1,g=b(n,c,()=>(p=!0,{start:r,length:f.count}));p&&(r+=f.count),a&&(t.normal=!0),m&&(t.color=!0),l&&(t.tangent=!0),o&&(t.texCoord0=!0),s.push({gltf:u,writeVertices:p,region:g})}return{vertexAttributes:{position:d(U,r),normal:t.normal?d(M,r):null,tangent:t.tangent?d(S,r):null,color:t.color?d(E,r):null,texCoord0:t.texCoord0?d(N,r):null},parts:s,components:[]}}function Me(e){return new re({data:(me(e.data),e.data),wrap:Ae(e.parameters.wrap)})}function Se(e,r){let t=new O(Fe(e.color,e.opacity)),i=e.emissiveFactor?new O(_e(e.emissiveFactor)):null,n=s=>s?new te({scale:s.scale?[s.scale[0],s.scale[1]]:[1,1],rotation:z(s.rotation??0),offset:s.offset?[s.offset[0],s.offset[1]]:[0,0]}):null;return new oe({color:t,colorTexture:r.get(e.textureColor),normalTexture:r.get(e.textureNormal),emissiveColor:i,emissiveTexture:r.get(e.textureEmissive),occlusionTexture:r.get(e.textureOcclusion),alphaMode:Re(e.alphaMode),alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,metallic:e.metallicFactor,roughness:e.roughnessFactor,metallicRoughnessTexture:r.get(e.textureMetallicRoughness),colorTextureTransform:n(e.colorTextureTransform),normalTextureTransform:n(e.normalTextureTransform),occlusionTextureTransform:n(e.occlusionTextureTransform),emissiveTextureTransform:n(e.emissiveTextureTransform),metallicRoughnessTextureTransform:n(e.metallicRoughnessTextureTransform)})}function Ce(e,r,t){r.writeVertices&&Ee(e,r);let{indices:i,attributes:n,primitiveType:s,material:u}=r.gltf,f=de(i||n.position.count,s),a=r.region.start;if(a){let m=new Uint32Array(f);for(let l=0;l<f.length;l++)m[l]+=a;f=m}e.components.push(new ae({name:r.gltf.name,faces:f,material:t.get(u),shading:n.normal?"source":"flat",trustSourceNormals:!0}))}function Ee(e,r){let{position:t,normal:i,tangent:n,color:s,texCoord0:u}=e.vertexAttributes,f=r.region.start,{attributes:a,transform:m}=r.gltf,l=a.position.count;if(H(t.slice(f,l),a.position,m),a.normal!=null&&i!=null){let o=W(R(),m),c=i.slice(f,l);J(c,a.normal,o),V(o)&&X(c,c)}else i!=null&&le(i,0,0,1,{dstIndex:f,count:l});if(a.tangent!=null&&n!=null){let o=Q(R(),m),c=n.slice(f,l);Y(c,a.tangent,o),V(o)&&Z(c,c)}else n!=null&&h(n,0,0,1,1,{dstIndex:f,count:l});if(a.texCoord0!=null&&u!=null?se(u.slice(f,l),a.texCoord0):u!=null&&fe(u,0,0,{dstIndex:f,count:l}),a.color!=null&&s!=null){let o=a.color,c=s.slice(f,l);if(o.elementCount===4)o instanceof S?_(c,o,255):o instanceof E?ue(c,o):o instanceof k&&_(c,o,1/256);else{h(c,255,255,255,255);let p=C.fromTypedArray(c.typedBuffer,c.typedBufferStride);o instanceof M?F(p,o,255):o instanceof C?ie(p,o):o instanceof q&&F(p,o,1/256)}}else s!=null&&h(s.slice(f,l),255,255,255,255)}function Re(e){switch(e){case"OPAQUE":return"opaque";case"MASK":return"mask";case"BLEND":return"blend"}}function Ae(e){return{horizontal:xe(e.s),vertical:xe(e.t)}}function xe(e){switch(e){case w.CLAMP_TO_EDGE:return"clamp";case w.MIRRORED_REPEAT:return"mirror";case w.REPEAT:return"repeat"}}function x(e){return e**(1/2.1)*255}function Fe(e,r){return D(x(e[0]),x(e[1]),x(e[2]),r)}function _e(e){return G(x(e[0]),x(e[1]),x(e[2]))}export{Br as loadGLTFMesh};
