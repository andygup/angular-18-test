import{c as L}from"./chunk-V2KSICSA.js";import{a as A}from"./chunk-Y4PMIX35.js";import{_ as H}from"./chunk-AANS6QE5.js";import{S as U}from"./chunk-ZP7G4HN4.js";import{a as j}from"./chunk-W3WDPWBE.js";import{z as S}from"./chunk-43GG6PFR.js";import{b as u}from"./chunk-3DV77WOO.js";import{g}from"./chunk-3T7TAUC2.js";var C=L(),I=new Map,_=new Map;function q(e,r,o){return g(this,null,function*(){if(!e||!o)return!1;if(!r)return!0;let i=new URL(e).host,s=I.get(i);if(!s){let t=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,"");s=(yield H(t,{responseType:"json",query:{f:"json"}})).data.defaultVersionName}return s===r})}function G(e,r,o=!1){return g(this,null,function*(){if(!e||!r)return!0;let i=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),s=_.get(i)?.entries();if(s){for(let[t,d]of s)if(d.name===r){let a=!d.stack?.hasForwardEdits();if(!a&&o){let[{deleteForwardEdits:m},{default:h}]=yield Promise.all([import("./chunk-7SYPXM6L.js"),import("./chunk-HGA3B5LF.js")]),c=yield m(i,t,new h({sessionId:C,moment:d.moment}));return c.success&&d.stack?.clearForwardEdits(),c.success}return a}}return!0})}function k(e,r){if(!e)return!1;let o=e.replace(/\/FeatureServer/i,"/VersionManagementServer").replace(/\/\d*$/,""),i=_.get(o)?.entries();if(i){for(let[s,t]of i)if(t.name===r)return t.lockType==="edit"}return!1}var y=new A.EventEmitter;function N(e){return y.on("apply-edits",new WeakRef(e))}function W(e){return y.on("update-moment",new WeakRef(e))}function se(e,r,o=null,i=!1){let s=S();return i=r==null||i,y.emit("apply-edits",{serviceUrl:e,layerId:r,gdbVersion:o,mayReceiveServiceEdits:i,result:s.promise}),s}var R=Symbol();function ie(e){return e!=null&&typeof e=="object"&&R in e}function p(e){return e!=null&&typeof e=="object"&&"gdbVersion"in e}function M(e,r,o){let i=new URL(e).host,s=I.get(i),t=d=>!d||d===s;return t(r)&&t(o)||r===o}var ne=e=>{var r;let o=class extends e{constructor(...i){super(...i),this[r]=!0,this._applyEditsHandler=s=>{let{serviceUrl:t,layerId:d,gdbVersion:a,mayReceiveServiceEdits:m,result:h}=s,c=t===this.url,f=d!=null&&this.layerId!=null&&d===this.layerId,x=p(this),B=p(this)&&M(t,a,this.gdbVersion);if(!c||x&&!B||!f&&!m)return;let T=h.then(n=>{if(f&&(n.addedFeatures.length||n.updatedFeatures.length||n.deletedFeatures.length||n.addedAttachments.length||n.updatedAttachments.length||n.deletedAttachments.length))return this.emit("edits",u(n)),n;let v=n.editedFeatures?.find(({layerId:b})=>b===this.layerId);if(v){let{adds:b,updates:E,deletes:V}=v.editedFeatures,w={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:b?b.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],deletedFeatures:V?V.map(({attributes:l})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],updatedFeatures:E?E.map(({current:{attributes:l}})=>({objectId:this.objectIdField&&l[this.objectIdField],globalId:this.globalIdField&&l[this.globalIdField]})):[],editedFeatures:u(n.editedFeatures),exceededTransferLimit:!1,historicMoment:u(n.historicMoment)};return this.emit("edits",w),w}let F={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:u(n.editedFeatures),exceededTransferLimit:!1,historicMoment:u(n.historicMoment)};return"historicMoment"in this&&this._shouldUpdateHistoricMoment(t,a,F.historicMoment)&&this.emit("edits",F),F}).then(n=>("historicMoment"in this&&this._shouldUpdateHistoricMoment(t,a,n.historicMoment)&&(this.historicMoment=n.historicMoment),n));this.emit("apply-edits",{result:T})},this._updateMomentHandler=s=>{let{serviceUrl:t,gdbVersion:d,moment:a}=s,m=t===this.url,h=p(this),c=p(this)&&M(t,d,this.gdbVersion),f=p(this)&&!M(t,this.gdbVersion,null);m&&h&&c&&f&&"historicMoment"in this&&this.historicMoment!==a&&(this.historicMoment=a)},this.when().then(()=>{this.addHandles(N(this._applyEditsHandler)),"historicMoment"in this&&this.addHandles(W(this._updateMomentHandler))},()=>{})}_shouldUpdateHistoricMoment(i,s,t){return"historicMoment"in this&&this.historicMoment!==t&&k(i,s)}};return r=R,o=j([U("esri.layers.mixins.EditBusLayer")],o),o};export{C as a,q as b,G as c,k as d,N as e,W as f,se as g,ie as h,M as i,ne as j};
