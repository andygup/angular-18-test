import{b as K,c as P,i as x,j as h}from"./chunk-3TDEI2FR.js";import{h as U}from"./chunk-U56UFVKE.js";import"./chunk-ZF6FJDSM.js";import"./chunk-ULNH2ZSH.js";import"./chunk-GRP2WCXF.js";import"./chunk-EA2LMY6Q.js";import"./chunk-66ZNG6BY.js";import"./chunk-LEB2YUKN.js";import"./chunk-EFTTQFHG.js";import"./chunk-HHJJPMV6.js";import"./chunk-CMV4MTCP.js";import"./chunk-7QY3BMVN.js";import"./chunk-UQRO7IE7.js";import"./chunk-TNPL7MIN.js";import"./chunk-ET2LYRZL.js";import"./chunk-IG7WMIAW.js";import"./chunk-MYC65FI6.js";import"./chunk-JUYSZ3TW.js";import"./chunk-C5NQJ2VI.js";import"./chunk-F4RAGEGI.js";import"./chunk-IZXGJHBR.js";import"./chunk-FYZRIMPP.js";import"./chunk-TM435WPY.js";import"./chunk-ZVQ6WPUX.js";import"./chunk-RZU6EEB3.js";import{a as R}from"./chunk-TQ3JEA47.js";import"./chunk-WNDRUC36.js";import"./chunk-GBR6VCK5.js";import"./chunk-QVGNQ4QU.js";import"./chunk-FLGQJSPM.js";import"./chunk-PNQOUNPC.js";import"./chunk-7Q7N656Y.js";import"./chunk-ZSMLWXCC.js";import"./chunk-JOF5BLB6.js";import"./chunk-BDQSEOPW.js";import"./chunk-XFWB7ADZ.js";import"./chunk-2PAJT2T6.js";import"./chunk-LFJ4NQ4O.js";import{a as O}from"./chunk-CKBOXNTL.js";import{a as E}from"./chunk-KM4AMTZA.js";import{c as k}from"./chunk-6ZXTJQND.js";import"./chunk-DDNVXGXG.js";import"./chunk-2TKGGTPN.js";import{a as G}from"./chunk-ME7KOLYX.js";import{a as z}from"./chunk-DGXL7ZQL.js";import{e as j}from"./chunk-SYNRDAMR.js";import{a as F}from"./chunk-VSMVTOQ2.js";import{a as C}from"./chunk-O3JFLEEW.js";import"./chunk-PDLAJXIO.js";import"./chunk-FVB5KK7E.js";import"./chunk-RDFYI3QE.js";import"./chunk-FOMR7EMA.js";import"./chunk-UAPVW6JM.js";import"./chunk-PVAWONWD.js";import"./chunk-VOMQSOTD.js";import"./chunk-VYW7XM4C.js";import"./chunk-AMCDNN62.js";import"./chunk-B5IFP6FP.js";import"./chunk-LXGJGX5J.js";import"./chunk-MNGFITIF.js";import"./chunk-P5F6DDDU.js";import"./chunk-SHSBHV6F.js";import"./chunk-ASFBXFQ5.js";import"./chunk-2XS3ER2F.js";import"./chunk-YRMBB4SJ.js";import"./chunk-LOEAA5XF.js";import"./chunk-37Z33WA5.js";import"./chunk-NI2H25WT.js";import"./chunk-67EKH3Q4.js";import"./chunk-2FWBXOKU.js";import"./chunk-M6ZEQBQT.js";import"./chunk-3FUKLVTW.js";import"./chunk-SEBAYBYC.js";import"./chunk-VI3FHFCE.js";import"./chunk-W2FNMTJT.js";import"./chunk-KLIUUY5R.js";import"./chunk-CGEI3ID7.js";import"./chunk-I3S324BU.js";import"./chunk-JVM3RNQL.js";import"./chunk-OUB3GINH.js";import"./chunk-3ZAISB5N.js";import"./chunk-L3CFPONE.js";import"./chunk-AKHHPLWL.js";import"./chunk-LJMIV7GW.js";import"./chunk-WSHEBM2J.js";import"./chunk-3UBRSNPL.js";import"./chunk-XDRSKFBJ.js";import"./chunk-WFFOXC2W.js";import"./chunk-MGUWZFOE.js";import"./chunk-JXUTKJIX.js";import"./chunk-MUZSZ4YH.js";import"./chunk-ZOEN7TLV.js";import"./chunk-YF3AUCDJ.js";import"./chunk-TUM5YCRC.js";import"./chunk-O5CPPU3T.js";import"./chunk-6KRFVLII.js";import"./chunk-ZGGYJV33.js";import"./chunk-63TUJPJR.js";import"./chunk-U6WVZEYH.js";import"./chunk-GDTXLKQK.js";import"./chunk-YNFZN34N.js";import"./chunk-SHSMFEO2.js";import{a as v}from"./chunk-V2KSICSA.js";import"./chunk-6A4M7X3R.js";import"./chunk-YRTOHBUA.js";import"./chunk-Y3PZSOWT.js";import"./chunk-KLDBOMH5.js";import"./chunk-USX74UBG.js";import"./chunk-OQ4BFXF7.js";import"./chunk-LDBOA2H7.js";import"./chunk-CXUCQMGY.js";import"./chunk-3CS3BPVL.js";import"./chunk-DFTBSFIN.js";import"./chunk-WOZZR3L4.js";import"./chunk-LW5IAFEX.js";import"./chunk-AQ74ANSJ.js";import"./chunk-R2K3CL3U.js";import"./chunk-SAOUSUZE.js";import"./chunk-VNBPSOCW.js";import"./chunk-F7Q25XKV.js";import"./chunk-CPGZIEVH.js";import"./chunk-L2DEVDHE.js";import"./chunk-Z5Q76SB7.js";import"./chunk-RU7UW4IO.js";import"./chunk-5QLB7ZJ7.js";import"./chunk-2ETW6ZBA.js";import"./chunk-6K7P7RRW.js";import"./chunk-7LRMKXZV.js";import"./chunk-BCREO4Q5.js";import"./chunk-E5R4OI7X.js";import"./chunk-BNUHB4AP.js";import"./chunk-ZGLJFDS6.js";import"./chunk-RSDQHAJX.js";import"./chunk-PSYXGXKI.js";import"./chunk-Q6TYOK45.js";import"./chunk-QMDBAMTG.js";import{b as m}from"./chunk-RZA5H63B.js";import"./chunk-Y4PMIX35.js";import"./chunk-KVCIO4DX.js";import"./chunk-NWBXT4EB.js";import"./chunk-4R2OFZPD.js";import"./chunk-WBI2AIMN.js";import"./chunk-FKQYBEPG.js";import{a as N,b as g}from"./chunk-ZHAVTBSG.js";import"./chunk-SBO2F6VY.js";import"./chunk-MMYIAMQR.js";import"./chunk-UHTPPTOJ.js";import{a as I}from"./chunk-LP5GLSKB.js";import{a as A}from"./chunk-LTDZH3EN.js";import"./chunk-3SBMUUA6.js";import"./chunk-II7TJXWX.js";import"./chunk-X7Z55FTO.js";import"./chunk-B66V4PSA.js";import"./chunk-A4HCVMB4.js";import{s as D,u as L}from"./chunk-AANS6QE5.js";import{H as r,j as y,l as w,m as T}from"./chunk-RMOOROEO.js";import{S,t as _}from"./chunk-ZP7G4HN4.js";import{a as n}from"./chunk-W3WDPWBE.js";import"./chunk-43GG6PFR.js";import"./chunk-MLSR6YE6.js";import"./chunk-JPDAKIWT.js";import"./chunk-D62JNIRP.js";import"./chunk-VU5W7W6Y.js";import{s as f,u}from"./chunk-3DV77WOO.js";import"./chunk-NJG4JJ4L.js";import{g as l}from"./chunk-3T7TAUC2.js";var o=class extends k(G(E(R(z(C(O(F))))))){constructor(e){super(e),this._graphTypeLookup=new Map,this._namedTypesModified=!1,this.dataManager=null,this.definitionSetMap=null,this.knowledgeGraph=null,this.layers=new(m.ofType(h)),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.operationalLayerType="KnowledgeGraphLayer",this.sublayerIdsCache=new Map,this.tables=new(m.ofType(h)),this.type="knowledge-graph",this.url=null}load(){return this.addResolvingPromise(this._doLoad()),Promise.resolve(this)}_doLoad(){return l(this,null,function*(){yield this._fetchMetadata(),yield this._initializeLayerProperties(),this.loadLayerAssumingLocalCache()})}_fetchMetadata(){return l(this,null,function*(){if(!this.url)throw new u("knowledge-graph:missing-url","KnowledgeGraphLayer must be created with a url");let e=yield U(this.url);this.knowledgeGraph=e,this._forEachGraphType(i=>{i.name&&this._graphTypeLookup.set(i.name,i)})})}_initializeLayerProperties(){return l(this,null,function*(){this.originIdOf("inclusionModeDefinition")===y.USER?this._validateInclusionModeDefinition():yield this._initializeInclusionModeDefinition(),this._setMemberTypes(),this.dataManager=new x({knowledgeGraph:this.knowledgeGraph,inclusionModeDefinition:this.inclusionModeDefinition})})}_initializeInclusionModeDefinition(){return l(this,null,function*(){let e=this.definitionSetMap?yield K(this.definitionSetMap,!0):{generateAllSublayers:!0,namedTypeDefinitions:new Map};[...this.layers.toArray(),...this.tables.toArray()].forEach(i=>{let t=this._graphTypeLookup.get(i.graphTypeName);t&&!e.namedTypeDefinitions.has(t.name)&&e.namedTypeDefinitions.set(t.name,{useAllData:!0})}),this.setAtOrigin("inclusionModeDefinition",e,T(this.originIdOf("definitionSetMap")))})}_validateInclusionModeDefinition(){let{inclusionModeDefinition:e}=this;if(!e)return;let{namedTypeDefinitions:i}=e;if(i?.size>0)i.forEach((t,a)=>{let s=this._graphTypeLookup.get(a);if(!s)return f.getLogger(this).warn(`A named type, ${a}, was in the inclusion list that wasn't in the data model and will be removed`),void i.delete(a);s.type!=="relationship"&&s.type!=="entity"&&(f.getLogger(this).warn(`A named type, ${a}, was in the inclusion list that wasn't properly modeled and will be removed`),i.delete(a))});else if(!e.generateAllSublayers)throw new u("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined")}_setMemberTypes(){let e=[],i=[],{inclusionModeDefinition:t}=this,a=t?.namedTypeDefinitions;!t||t.generateAllSublayers?(e=this.knowledgeGraph.dataModel?.entityTypes??[],i=this.knowledgeGraph.dataModel?.relationshipTypes??[]):a&&a.size>0&&a.forEach((s,d)=>{let p=this._graphTypeLookup.get(d);switch(p?.type){case"relationship":i.push(p);break;case"entity":e.push(p)}}),this.memberEntityTypes=e,this.memberRelationshipTypes=i}_forEachGraphType(e){[...this.knowledgeGraph.dataModel?.entityTypes??[],...this.knowledgeGraph.dataModel?.relationshipTypes??[]].forEach(i=>{e(i)})}_refreshNamedTypes(){this._namedTypesModified=!0;for(let e of this.layers)e.emit("refresh",{dataChanged:!0});for(let e of this.tables)e.emit("refresh",{dataChanged:!0})}_handleNewRecords(e){return l(this,null,function*(){let i=[];this.dataManager.addToLayer(e);for(let t of e)this.sublayerIdsCache.has(t.typeName)||(this.sublayerIdsCache.set(t.typeName,new Set),i.push(t.typeName)),this.sublayerIdsCache.get(t.typeName).add(t.id);for(let t of i){let a=this._graphTypeLookup.get(t);a&&(this._addSublayer(a).title=t,a.type==="entity"?this.dataManager.entityTypeNames.add(t):this.dataManager.relationshipTypeNames.add(t),this.dataManager.sublayerCaches.set(t,new Map))}this._refreshNamedTypes()})}_createSublayers(e,i,t){e.forEach(a=>{let s=this._createSublayer(a);t(s)&&i.push(s),this._updateSublayerCaches(a)})}_addSublayer(e){let i=this._createSublayer(e);return i.geometryType?this.layers.push(i):this.tables.push(i),i}_createSublayer(e){return new h({objectType:e,parentCompositeLayer:this,graphType:e.type,title:e.name})}_updateSublayers(e,i){i.forEach(t=>{t.parentCompositeLayer=this;let a=e.find(s=>s.type===t.graphType&&s.name===t.graphTypeName);a&&(t.objectType=a,t.read({title:a.name},{origin:"service"}),this._updateSublayerCaches(a))})}_updateSublayerCaches(e){let i=this.dataManager.sublayerCaches;i.has(e.name)||i.set(e.name,new Map)}_saveUrlAsNewResource(e,i,t,a){e[i]="<pending>",t.pendingOperations.push($(this.inclusionModeDefinition).then(s=>{let d=B(a);e[i]=d.itemRelativeUrl,t.toAdd.push({resource:d,content:{type:"blob",blob:s},compress:!1,finish:p=>{this.definitionSetMap=p.url}})}))}_displaysAllRecords(e){for(let[,{useAllData:i}]of e.namedTypeDefinitions)if(!i)return!1;return!0}readDefinitionSetMap(e,i,t){return N(e,t)}writeDefinitionSetMap(e,i,t,a){let s=a?.portalItem,d=a?.resources,p=w(a?.origin);if(!s||!d||p==null)return void(e&&(i[t]=g(e,a)));let{inclusionModeDefinition:M}=this;if(!M||this._displaysAllRecords(M))return void(this.definitionSetMap=null);let c=this.originIdOf("inclusionModeDefinition");if(c===y.USER||this._namedTypesModified||p<c)this._saveUrlAsNewResource(i,t,d,s);else if(p===c&&e){let b=g(e,a);L(b)?this._saveUrlAsNewResource(i,t,d,s):i[t]=b}}set inclusionModeDefinition(e){this.loadStatus!=="loaded"&&this.loadStatus!=="failed"?this._set("inclusionModeDefinition",e):f.getLogger(this).error("#inclusionModeDefinition","inclusionModeDefinition cannot be changed after the layer is loaded.")}loadLayerAssumingLocalCache(){let e=[...this.memberEntityTypes,...this.memberRelationshipTypes];this.originIdOf("layers")===y.DEFAULTS?this._createSublayers(e,this.layers,i=>!!i.geometryType):this._updateSublayers(e,this.layers),this.originIdOf("tables")===y.DEFAULTS?this._createSublayers(e,this.tables,i=>!i.geometryType):this._updateSublayers(e,this.tables),this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.forEach((i,t)=>{let a=_(this.sublayerIdsCache,t,()=>new Set);i.members?.forEach(s=>{a.add(s.id)})})}addRecords(e){return l(this,null,function*(){yield this._handleNewRecords(e)})}removeRecords(e){return l(this,null,function*(){let i=[];for(let t of e)this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.useAllData===!1&&this.dataManager.inclusionModeDefinition?.namedTypeDefinitions?.get(t.typeName)?.members?.has(t.id)&&i.push(t);this.dataManager.removeFromLayer(i);for(let t of i)this.sublayerIdsCache.get(t.typeName)?.delete(t.id);return this._refreshNamedTypes(),i})}};n([r()],o.prototype,"dataManager",void 0),n([r({json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],o.prototype,"definitionSetMap",void 0),n([I("definitionSetMap")],o.prototype,"readDefinitionSetMap",null),n([A("definitionSetMap")],o.prototype,"writeDefinitionSetMap",null),n([r()],o.prototype,"inclusionModeDefinition",null),n([r()],o.prototype,"knowledgeGraph",void 0),n([r({type:m.ofType(h),json:{write:{ignoreOrigin:!0}}})],o.prototype,"layers",void 0),n([r()],o.prototype,"memberEntityTypes",void 0),n([r()],o.prototype,"memberRelationshipTypes",void 0),n([r({type:["KnowledgeGraphLayer"]})],o.prototype,"operationalLayerType",void 0),n([r()],o.prototype,"sublayerIdsCache",void 0),n([r({type:m.ofType(h),json:{write:{ignoreOrigin:!0}}})],o.prototype,"tables",void 0),n([r({json:{read:!1}})],o.prototype,"type",void 0),n([r(j)],o.prototype,"url",void 0),o=n([S("esri.layers.KnowledgeGraphLayer")],o);var be=o;function $(e){return l(this,null,function*(){let i=yield P(e);return new Blob([i],{type:"application/x-protobuf"})})}function B(e){let i=`definitionSetMap-${v()}.dat`,t=D("knowledgeGraphLayer",i);return e.resourceFromPath(t)}export{be as default};
