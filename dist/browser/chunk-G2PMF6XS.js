import{b as L}from"./chunk-MSNPI7IT.js";import{a as f,b as d,c as v,d as y,e as F,f as w,g as M,h as D,i as P}from"./chunk-SBQMSVTA.js";import"./chunk-HPYHGJQC.js";import{a as T}from"./chunk-LASKJRNV.js";import{a as b}from"./chunk-NTH4WS56.js";import{a as x}from"./chunk-OAZUX7NT.js";import{a as S}from"./chunk-W4ZGXXVV.js";import{a as m}from"./chunk-N75S7AVH.js";import{b as g}from"./chunk-QW4FGXMK.js";import{b as I}from"./chunk-CGEI3ID7.js";import"./chunk-GDTXLKQK.js";import"./chunk-YNFZN34N.js";import"./chunk-SHSMFEO2.js";import"./chunk-F7Q25XKV.js";import"./chunk-2ETW6ZBA.js";import"./chunk-6K7P7RRW.js";import"./chunk-7LRMKXZV.js";import"./chunk-BCREO4Q5.js";import"./chunk-BNUHB4AP.js";import"./chunk-ZGLJFDS6.js";import"./chunk-RSDQHAJX.js";import"./chunk-RZA5H63B.js";import"./chunk-Y4PMIX35.js";import"./chunk-KVCIO4DX.js";import"./chunk-NWBXT4EB.js";import"./chunk-4R2OFZPD.js";import{c as k}from"./chunk-WBI2AIMN.js";import"./chunk-FKQYBEPG.js";import"./chunk-ZHAVTBSG.js";import"./chunk-SBO2F6VY.js";import"./chunk-UHTPPTOJ.js";import"./chunk-LP5GLSKB.js";import"./chunk-LTDZH3EN.js";import"./chunk-3SBMUUA6.js";import"./chunk-II7TJXWX.js";import"./chunk-X7Z55FTO.js";import"./chunk-B66V4PSA.js";import"./chunk-A4HCVMB4.js";import"./chunk-AANS6QE5.js";import"./chunk-RMOOROEO.js";import"./chunk-ZP7G4HN4.js";import"./chunk-W3WDPWBE.js";import"./chunk-43GG6PFR.js";import"./chunk-MLSR6YE6.js";import"./chunk-JPDAKIWT.js";import"./chunk-D62JNIRP.js";import{u as p}from"./chunk-3DV77WOO.js";import"./chunk-NJG4JJ4L.js";import{g as u}from"./chunk-3T7TAUC2.js";function oe(t,a){return u(this,null,function*(){let r=t.instance.portalItem;if(r?.id)return yield r.load(a),N(t),t.validateItem&&t.validateItem(r),O(t,a)})}function N(t){let a=t.instance.portalItem;if(!a?.type||!t.supportedTypes.includes(a.type))throw new p("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:a?.type,expectedType:t.supportedTypes.join(", ")})}function O(t,a){return u(this,null,function*(){let r=t.instance,e=r.portalItem;if(!e)return;let{url:o,title:s}=e,n=m(e,"portal-item");if(r.type==="group")return j(r,n,t);o&&r.type!=="media"&&r.read({url:o},n);let l=new f,i=yield C(t,l,a);return i&&r.read(i,n),r.resourceReferences={portalItem:e,paths:n.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:s},n),S(r,n)})}function j(t,a,r){return u(this,null,function*(){let e=t.portalItem;if(!t.sourceIsPortalItem)return;let{title:o,type:s}=e;if(s==="Group Layer"){if(!g(e,"Map"))throw new p("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return J(t)}return t.read({title:o},a),A(t,r)})}function J(t){return u(this,null,function*(){let a=t.portalItem,r=yield a.fetchData("json");if(!r)return;let e=m(a,"web-map");t.read(r,e),yield L(t,r,{context:e}),t.resourceReferences={portalItem:a,paths:e.readResourcePaths??[]}})}function A(t,a){return u(this,null,function*(){let r,{portalItem:e}=t;if(!e)return;let o=e.type,s=a.layerModuleTypeMap;switch(o){case"Feature Service":case"Feature Collection":r=s.FeatureLayer;break;case"Stream Service":r=s.StreamLayer;break;case"Scene Service":r=s.SceneLayer;break;default:throw new p("portal:unsupported-item-type-as-group",`The item type '${o}' is not supported as a 'IGroupLayer'`)}let n=new f,[l,i]=yield Promise.all([r(),C(a,n)]),c=()=>l;if(o==="Feature Service"){let E=y(i)?.customParameters;i=e.url?yield v(i,e.url,n):{},c=(yield Q(i,s))||c;let G=yield H(e.url,{customParameters:E,loadContext:n});return yield h(t,c,i,G)}return o==="Scene Service"&&e.url&&(i=yield P(e,i,n)),w(i)>0?yield h(t,c,i):yield $(t,c)})}function $(t,a){return u(this,null,function*(){let{portalItem:r}=t;if(!r?.url)return;let e=yield b(r.url);e&&h(t,a,{layers:e.layers?.map(d),tables:e.tables?.map(d)})})}function h(t,a,r,e){return u(this,null,function*(){let o=r.layers||[],s=r.tables||[];if(t.portalItem?.type==="Feature Collection"?(o.forEach((n,l)=>{n.id=l,n?.layerDefinition?.type==="Table"&&s.push(n)}),o=o.filter(n=>n?.layerDefinition?.type!=="Table")):(o.reverse(),s.reverse()),o.forEach(n=>{let l=e?.(n);if(l||!e){let i=R(t,a(n),r,n,l);t.add(i)}}),s.length){let n=yield x.FeatureLayer();s.forEach(l=>{let i=e?.(l);if(i||!e){let c=R(t,n,r,l,i);t.tables.add(c)}})}})}function R(t,a,r,e,o){let s=t.portalItem,n={portalItem:s.clone(),layerId:e.id};e.url!=null&&(n.url=e.url);let l=new a(n);if("sourceJSON"in l&&(l.sourceJSON=o),l.type!=="subtype-group"&&l.type!=="catalog"&&(l.sublayerTitleMode="service-name"),s.type==="Feature Collection"){let i={origin:"portal-item",portal:s.portal||k.getDefault()};l.read(e,i);let c=r.showLegend;c!=null&&l.read({showLegend:c},i)}return l}function C(t,a,r){return u(this,null,function*(){if(t.supportsData===!1)return;let e=t.instance,o=e.portalItem;if(!o)return;let s=null;try{s=yield o.fetchData("json",r)}catch{}if(q(e)){let n=null,l=yield B(o,s,a);if((s?.layers||s?.tables)&&l>0){if(e.layerId==null){let i=M(e.type),c=i?F(s,i)[0]:y(s);c&&(e.layerId=c.id)}n=K(s,e),n&&s.showLegend!=null&&(n.showLegend=s.showLegend)}return l>1&&"sublayerTitleMode"in e&&e.sublayerTitleMode!=="service-name"&&(e.sublayerTitleMode="item-title-and-service-name"),n}return s})}function B(t,a,r){return u(this,null,function*(){if(a?.layers&&a?.tables)return w(a);let e=I(t.url);if(!e)return 1;let o=yield r.fetchServiceMetadata(e.url.path,{customParameters:y(a)?.customParameters}).catch(()=>null);return(a?.layers?.length??o?.layers?.length??0)+(a?.tables?.length??o?.tables?.length??0)})}function K(t,a){let{layerId:r}=a,e=t.layers?.find(o=>o.id===r)||t.tables?.find(o=>o.id===r);return e&&z(e,a)?e:null}function q(t){return t.type!=="stream"&&"layerId"in t}function z(t,a){let r="layerType"in t&&t.layerType,{type:e}=a;return!(e==="feature"&&r||e==="catalog"&&!r||e==="oriented-imagery"&&!r||e==="subtype-group"&&!r)}function H(t,a){return u(this,null,function*(){let{layersJSON:r}=yield T(t,a);if(!r)return null;let e=[...r.layers,...r.tables];return o=>e.find(s=>s.id===o.id)})}function Q(t,a){return u(this,null,function*(){let{layers:r}=t;if(!r?.length)return;let e=new Set,o=[];for(let{layerType:l}of r){let i=l??"FeatureLayer";if(e.has(i))continue;e.add(i);let c=a[D(i)];o.push(c())}let s=yield Promise.all(o),n=new Map;return Array.from(e).forEach((l,i)=>{n.set(l,s[i])}),({layerType:l})=>{let i=l??"FeatureLayer";return n.get(i)}})}export{oe as load};
